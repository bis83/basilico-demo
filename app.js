(()=>{const F=e=>{const t=window.atob(e),o=new ArrayBuffer(t.length),s=new DataView(o);for(let a=0;a<t.length;++a)s.setUint8(a,t.charCodeAt(a));return o};const p=e=>e/180*Math.PI,W=(e,t)=>Math.sqrt(e*e+t*t),P=(e,t)=>{const o=W(e,t);return o!=0?[e/o,t/o]:[0,0]};const A=(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],K=e=>{const t=A(e,e);return Math.sqrt(t)},q=(e,t)=>[e[0]+t[0],e[1]+t[1],e[2]+t[2]],J=(e,t)=>[e[0]-t[0],e[1]-t[1],e[2]-t[2]];const G=e=>{const t=K(e);return[e[0]/t,e[1]/t,e[2]/t]},X=(e,t)=>[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]],Q=(e,t)=>{const o=p(e),s=p(t);return[Math.cos(s)*Math.cos(o),Math.sin(s),Math.cos(s)*Math.sin(o)]},O=(e,t,o)=>[e*2,o*.5,t*2];const Z=(e,t)=>[e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15]],Y=(e,t,o)=>[1,0,0,0,0,1,0,0,0,0,1,0,e,t,o,1],j=(e,t,o)=>[e,0,0,0,0,t,0,0,0,0,o,0,0,0,0,1],ee=(e,t,o)=>{const s=G(J(t,e)),a=G(X(o,s)),l=X(s,a),d=A(e,a),m=A(e,l),h=A(e,s);return[a[0],l[0],s[0],0,a[1],l[1],s[1],0,a[2],l[2],s[2],0,-d,-m,-h,1]},te=(e,t,o,s)=>{const a=1/Math.tan(e),l=a/t,d=s/(s-o),m=-(d*o);return[l,0,0,0,0,a,0,0,0,0,d,1,0,0,m,0]},oe=(e,t,o,s)=>{const a=2/e,l=2/t,d=1/(s-o),m=o/(o-s);return[a,0,0,0,0,l,0,0,0,0,d,0,0,0,m,1]},R=(e,t)=>e<<0|t<<16,E=e=>[e>>0&65535,e>>16&65535],y=0,x=1,v=2;var c=null;const i=(e,t,o)=>{e.addEventListener(t,o)},re=()=>{c={},c.timer={prevTime:performance.now(),deltaTime:0},c.input={mode:y,moveX:0,moveY:0,cameraX:0,cameraY:0,act:!1,sub:!1,actButton:!1,subButton:!1},c.input.gamepad={index:null,lx:0,ly:0,rx:0,ry:0,b0:!1,b1:!1,lt:!1,rt:!1},c.input.keyboard={w:!1,a:!1,s:!1,d:!1,up:!1,left:!1,down:!1,right:!1,space:!1,lctrl:!1},c.input.mouse={x:0,y:0,mx:0,my:0,lb:!1,rb:!1,mb:!1},c.input.touch=new Map,i(window,"focus",e=>{}),i(window,"blur",e=>{}),i(window,"resize",e=>{}),i(window,"gamepadconnected",e=>{c.input.gamepad.index=e.gamepad.index,c.input.mode=y}),i(window,"gamepaddisconnected",e=>{c.input.gamepad.index===e.gamepad.index&&(c.input.gamepad.index=null)}),i(document,"keydown",e=>{B(c.input.keyboard,e.code,!0)&&(c.input.mode=x,e.preventDefault())}),i(document,"keyup",e=>{B(c.input.keyboard,e.code,!1)&&(c.input.mode=x,e.preventDefault())}),i(document.body,"contextmenu",e=>{e.preventDefault()}),i(document.body,"mousedown",e=>{k(c.input.mouse,e)&&(c.input.mode=x,e.preventDefault())}),i(document.body,"mouseup",e=>{k(c.input.mouse,e)&&(c.input.mode=x,e.preventDefault())}),i(document.body,"mousemove",e=>{k(c.input.mouse,e)&&(c.input.mode=x,e.preventDefault())}),i(document.body,"touchstart",e=>{for(const t of e.changedTouches)c.input.touch.set(t.identifier,{x:t.clientX,y:t.clientY,sx:t.clientX,sy:t.clientY});c.input.mode=v}),i(document.body,"touchend",e=>{for(const t of e.changedTouches)c.input.touch.delete(t.identifier);c.input.mode=v}),i(document.body,"touchcancel",e=>{for(const t of e.changedTouches)c.input.touch.delete(t.identifier);c.input.mode=v}),i(document.body,"touchmove",e=>{for(const t of e.changedTouches){const o=c.input.touch.get(t.identifier);o&&(o.x=t.clientX,o.y=t.clientY)}c.input.mode=v})},B=(e,t,o)=>{switch(t){case"KeyW":e.w=o;break;case"KeyA":e.a=o;break;case"KeyS":e.s=o;break;case"KeyD":e.d=o;break;case"ArrowUp":e.up=o;break;case"ArrowLeft":e.left=o;break;case"ArrowDown":e.down=o;break;case"ArrowRight":e.right=o;break;case"Space":e.space=o;break;case"ControlLeft":e.lctrl=o;break;default:return!1}return!0},k=(e,t)=>(e.mx+=t.movementX||0,e.my+=t.movementY||0,e.x=t.x,e.y=t.y,e.lb=(t.buttons&1)!=0,e.rb=(t.buttons&2)!=0,e.mb=(t.buttons&4)!=0,!0),se=e=>{const t=performance.now();e.deltaTime=(t-e.prevTime)/1e3,e.prevTime=t},ne=e=>{if(e.gamepad.index!==null){const o=navigator.getGamepads()[e.gamepad.index];e.gamepad.lx=Math.trunc(o.axes[0]*4)/4,e.gamepad.ly=Math.trunc(o.axes[1]*4)/4,e.gamepad.rx=Math.trunc(o.axes[2]*4)/4,e.gamepad.ry=Math.trunc(o.axes[3]*4)/4,e.gamepad.b0=o.buttons[0].value>=.5,e.gamepad.b1=o.buttons[1].value>=.5,e.gamepad.lt=o.buttons[6].value>=.5,e.gamepad.rt=o.buttons[7].value>=.5,!!(e.gamepad.lx||e.gamepad.ly||e.gamepad.rx||e.gamepad.ry||e.gamepad.b0||e.gamepad.b1||e.gamepad.lt||e.gamepad.rt)&&(e.mode=y)}},ae=e=>{const t=e.mode;if(t===y)e.moveX=e.gamepad.lx,e.moveY=-e.gamepad.ly,e.cameraX=-e.gamepad.rx,e.cameraY=-e.gamepad.ry,e.act=!e.actButton&&e.gamepad.b0,e.sub=!e.subButton&&e.gamepad.b1,e.actButton=e.gamepad.b0,e.subButton=e.gamepad.b1;else if(t===x)e.moveX=e.keyboard.a?-1:e.keyboard.d?1:0,e.moveY=e.keyboard.w?1:e.keyboard.s?-1:0,e.cameraX=e.keyboard.right?-1:e.keyboard.left?1:0,e.cameraY=e.keyboard.up?1:e.keyboard.down?-1:0,e.mouse.mb&&(e.cameraX=-e.mouse.mx,e.cameraY=-e.mouse.my),e.act=!e.actButton&&e.mouse.lb,e.sub=!e.subButton&&e.mouse.rb,e.actButton=e.mouse.lb,e.subButton=e.mouse.rb;else if(t===v){e.moveX=0,e.moveY=0,e.cameraX=0,e.cameraY=0;for(const o of e.touch.values())o.sx<window.innerWidth/2?(e.moveX=o.x-o.sx,e.moveY=-(o.y-o.sy)):(e.cameraX=-(o.x-o.sx),e.cameraY=-(o.y-o.sy))}else e.moveX=0,e.moveY=0,e.cameraX=0,e.cameraY=0;[e.moveX,e.moveY]=P(e.moveX,e.moveY),[e.cameraX,e.cameraY]=P(e.cameraX,e.cameraY)},ce=e=>{const t=o=>Math.trunc(o/2);e.mx=t(e.mx),e.my=t(e.my)},le=()=>{se(c.timer),ne(c.input),ae(c.input),ce(c.input.mouse)};var r=null;const de=()=>{r=document.getElementById("main").getContext("webgl2")},N=0,C=1,V=2,H=3,me=e=>{let t=r.createTexture();return r.bindTexture(r.TEXTURE_2D,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e),r.bindTexture(r.TEXTURE_2D,null),t},ie=(e,t,o)=>{const s=document.createElement("canvas");if(!s)return null;s.width=t,s.height=o;const a=s.getContext("2d");return a?(a.fillStyle="white",a.textAlign="center",a.textBaseline="middle",a.font="24px monospace",a.fillText(e,s.width/2,s.height/2),s):null},z=(e,t)=>{const o=r.createShader(e);return r.shaderSource(o,t),r.compileShader(o),r.getShaderParameter(o,r.COMPILE_STATUS)?o:(r.deleteShader(o),null)},ue=(e,t)=>{const o=r.createProgram();return r.attachShader(o,e),r.attachShader(o,t),r.linkProgram(o),r.getProgramParameter(o,r.LINK_STATUS)?o:(r.deleteProgram(o),null)},$=(e,t)=>{let o=r.createBuffer();return r.bindBuffer(e,o),r.bufferData(e,t,r.STATIC_DRAW),o},M=(e,t,o,s,a,l)=>{r.enableVertexAttribArray(e),r.vertexAttribPointer(e,t,o,s,a,l)},he=()=>{const e=window.innerWidth;e!==r.canvas.width&&(r.canvas.width=e);const t=window.innerHeight;t!==r.canvas.height&&(r.canvas.height=t)},fe=()=>{r.viewport(0,0,r.canvas.width,r.canvas.height),r.clearColor(0,0,0,1),r.clearDepth(1),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT)},D=(e,t)=>{r.enable(r.CULL_FACE),e?(r.enable(r.DEPTH_TEST),r.depthFunc(r.LEQUAL)):r.disable(r.DEPTH_TEST),t?(r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA)):(r.disable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA))},b=(e,t)=>{t=t||0;const o=e.iv[t*3+0],s=e.iv[t*3+1],a=e.iv[t*3+2],l=[null,r.POINTS,r.LINES,r.TRIANGLES];e.i?r.drawElements(l[o],a,r.UNSIGNED_SHORT,2*s):r.drawArrays(l[o],s,a)};var ge=null;const _e=()=>{ge=new AudioContext};const xe=e=>{if(e.vao=r.createVertexArray(),r.bindVertexArray(e.vao),e.b&&(e.b=$(r.ARRAY_BUFFER,F(e.b)),e.bv))for(let t=0;t<e.bv.length;t+=2)switch(e.bv[t]){case N:M(N,3,r.FLOAT,!1,0,e.bv[t+1]);break;case C:M(C,3,r.HALF_FLOAT,!1,0,e.bv[t+1]);break;case V:M(V,4,r.UNSIGNED_BYTE,!0,0,e.bv[t+1]);break;case H:M(H,2,r.HALF_FLOAT,!1,0,e.bv[t+1]);break}return e.i&&(e.i=$(r.ELEMENT_ARRAY_BUFFER,F(e.i))),r.bindVertexArray(null),e},we=e=>{if(e.vs=z(r.VERTEX_SHADER,e.vs),e.fs=z(r.FRAGMENT_SHADER,e.fs),e.prog=ue(e.vs,e.fs),e.u){const t={};for(let o of e.u)t[o]=r.getUniformLocation(e.prog,o);e.u=t}if(e.ub){const t={};let o=0;for(let s of e.ub){const a=r.getUniformBlockIndex(e.prog,s);r.uniformBlockBinding(e.prog,a,o),t[s]=o,o+=1}e.ub=t}return e},pe=e=>(e.texture=me(ie(e.text,e.width,e.height)),e),u={index:null,pack:[]},ve=()=>u.index!=null&&u.pack.length>0,Te=()=>{fetch("data/index.json").then(t=>t.json()).then(t=>{u.index=t})},Ae=e=>{const t="data/pack"+e+".json";fetch(t).then(o=>o.json()).then(o=>{o.mesh&&(o.mesh=o.mesh.map(s=>xe(s))),o.texture&&(o.texture=o.texture.map(s=>pe(s))),o.shader&&(o.shader=o.shader.map(s=>we(s))),u.pack[e]=o})},I=e=>u.pack[0].mesh[e];const U=e=>u.pack[0].shader[e];var n={cam:{vp:new Float32Array(16),o:new Float32Array(16)},pos:{x:0,y:0,ha:0,va:0,h:0,eyeh:1.75},world:{w:0,h:0,s:[]}};const Ee=()=>{n.world.w=64,n.world.h=64,n.world.s.length=0,n.world.s.length=n.world.w*n.world.h;for(let e=0;e<n.world.s.length;++e){const t=1+Math.floor(Math.random()*10);n.world.s[e]=[],n.world.s[e].push(R(1,t))}n.pos.x=.5,n.pos.y=.5},S=(e,t)=>(e=Math.floor(e),t=Math.floor(t),e<0||n.world.w<=e||t<0||n.world.h<=t?null:n.world.s[e+t*n.world.h]),w=(e,t)=>{const o=S(e,t);if(!o)return 0;let s=0;for(const a of o){const[l,d]=E(a);s+=d}return s},ye=(e,t,o,s)=>{let a=e+o,l=t+s;const d=Math.floor(e),m=Math.floor(t),h=w(d+0,m+0),g=w(d-1,m+0),f=w(d+1,m+0),_=w(d+0,m-1),L=w(d+0,m+1),T=.25;return Math.abs(h-g)>1&&(a=Math.max(a,d+T)),Math.abs(h-f)>1&&(a=Math.min(a,d-T+1)),Math.abs(h-_)>1&&(l=Math.max(l,m+T)),Math.abs(h-L)>1&&(l=Math.min(l,m-T+1)),[a,l]},Me=()=>{const e=c.timer.deltaTime,t=90;n.pos.ha+=t*e*c.input.cameraX,n.pos.va+=t*e*c.input.cameraY,n.pos.va=Math.max(-60,Math.min(n.pos.va,80));const o=2,s=p(n.pos.ha-90),a=p(n.pos.ha),l=c.input.moveX,d=c.input.moveY,m=l*Math.cos(s)+d*Math.cos(a),h=l*Math.sin(s)+d*Math.sin(a),g=o*e*m,f=o*e*h;[n.pos.x,n.pos.y]=ye(n.pos.x,n.pos.y,g,f);const _=w(n.pos.x,n.pos.y);if(Math.abs(_-n.pos.h)>2)n.pos.h=_;else{const L=_-n.pos.h;n.pos.h+=10*e*L}},Se=()=>{const e=window.innerWidth,t=window.innerHeight,o=p(30),s=.1,a=1e3,l=Q(n.pos.ha,n.pos.va),d=O(n.pos.x,n.pos.y,n.pos.h);d[1]+=n.pos.eyeh;const m=q(d,l),g=ee(d,m,[0,1,0]),f=te(o,e/t,s,a);n.cam.vp.set(Z(g,f)),n.cam.o.set(oe(e,t,0,1))},Le=()=>{if(c.input.act){const e=S(n.pos.x,n.pos.y);if(e&&e.length>0){let[t,o]=E(e[e.length-1]);o+=1,e[e.length-1]=R(t,o)}}if(c.input.sub){const e=S(n.pos.x,n.pos.y);if(e&&e.length>0){let[t,o]=E(e[e.length-1]);o-=1,o>0?e[e.length-1]=R(t,o):e.pop()}}},Re=()=>{Me(),Se(),Le()},ke=()=>{he(),fe()},De=(e,t,o,s)=>{const a=S(o,s);if(!a)return;let l=0;for(const d of a){const[m,h]=E(d);for(let g=0;g<h;++g){const f=O(o,s,l),_=new Float32Array(16);_.set(Y(f[0],f[1],f[2])),r.uniformMatrix4fv(e.u.w,!1,_),b(t),++l}}},be=()=>{D(!0,!1);const e=U(u.index.data.mesh_pc);if(!e)return;r.useProgram(e.prog),r.uniformMatrix4fv(e.u.vp,!1,n.cam.vp);const t=I(u.index.data.stack);if(!!t){r.bindVertexArray(t.vao);for(let o=0;o<n.world.w;++o)for(let s=0;s<n.world.h;++s)De(e,t,o,s)}},Ie=()=>{D(!0,!1);const e=U(u.index.data.mesh_pc);if(!e)return;r.useProgram(e.prog),r.uniformMatrix4fv(e.u.vp,!1,n.cam.vp);const t=I(u.index.data.debug_grid);if(!t)return;r.bindVertexArray(t.vao);const o=new Float32Array(16);o.set(Y(0,0,0)),r.uniformMatrix4fv(e.u.w,!1,o),b(t)},Ue=()=>{D(!1,!0);const e=U(u.index.data.mesh_pc);if(!e)return;r.useProgram(e.prog),r.uniformMatrix4fv(e.u.vp,!1,n.cam.o);const t=I(u.index.data.reticle);if(!t)return;r.bindVertexArray(t.vao);const o=new Float32Array(16);o.set(j(4,4,1)),r.uniformMatrix4fv(e.u.w,!1,o),b(t)},Fe=()=>{ke(),be(),Ie(),Ue()};i(window,"load",()=>{de(),_e(),re(),Ee(),Te(),Ae(0);const e=()=>{le(),ve()&&(Re(),Fe()),requestAnimationFrame(e)};e()});})();
