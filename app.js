(()=>{const J=t=>{const e=window.atob(t),n=new ArrayBuffer(e.length),r=new DataView(n);for(let o=0;o<e.length;++o)r.setUint8(o,e.charCodeAt(o));return n};const Mt=(t,e)=>(t%e+e)%e,b=t=>t/180*Math.PI,Y=(t,e)=>Math.sqrt(t*t+e*e),S=(t,e)=>{const n=Y(t,e);return n!=0?[t/n,e/n]:[0,0]},St=([t,e])=>[-t,-e],bt=([t,e],n)=>[t*n,e*n],Rt=([t,e],n,r,o,c)=>n<=t&&t<=r&&o<=e&&e<=c,D=([t,e],n,[r,o])=>{const[c,i]=[r-t,o-e],l=Y(c,i);if(n<=l)return[t,e];const[a,f]=S(c,i),[x,w]=bt([a,f],l-n);return[t+x,e+w]},P=(t,e)=>t[0]*e[0]+t[1]*e[1]+t[2]*e[2],Ut=t=>{const e=P(t,t);return Math.sqrt(e)},kt=(t,e)=>[t[0]+e[0],t[1]+e[1],t[2]+e[2]],It=(t,e)=>[t[0]-e[0],t[1]-e[1],t[2]-e[2]];const Q=t=>{const e=Ut(t);return[t[0]/e,t[1]/e,t[2]/e]},Z=(t,e)=>[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]],Lt=(t,e)=>{const n=b(t),r=b(e);return[Math.cos(r)*Math.cos(n),Math.cos(r)*Math.sin(n),Math.sin(r)]},Dt=()=>[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Ft=(t,e)=>[t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15],t[4]*e[0]+t[5]*e[4]+t[6]*e[8]+t[7]*e[12],t[4]*e[1]+t[5]*e[5]+t[6]*e[9]+t[7]*e[13],t[4]*e[2]+t[5]*e[6]+t[6]*e[10]+t[7]*e[14],t[4]*e[3]+t[5]*e[7]+t[6]*e[11]+t[7]*e[15],t[8]*e[0]+t[9]*e[4]+t[10]*e[8]+t[11]*e[12],t[8]*e[1]+t[9]*e[5]+t[10]*e[9]+t[11]*e[13],t[8]*e[2]+t[9]*e[6]+t[10]*e[10]+t[11]*e[14],t[8]*e[3]+t[9]*e[7]+t[10]*e[11]+t[11]*e[15],t[12]*e[0]+t[13]*e[4]+t[14]*e[8]+t[15]*e[12],t[12]*e[1]+t[13]*e[5]+t[14]*e[9]+t[15]*e[13],t[12]*e[2]+t[13]*e[6]+t[14]*e[10]+t[15]*e[14],t[12]*e[3]+t[13]*e[7]+t[14]*e[11]+t[15]*e[15]],Pt=t=>{const e=t[0]*t[5]-t[1]*t[4],n=t[0]*t[6]-t[2]*t[4],r=t[0]*t[7]-t[3]*t[4],o=t[1]*t[6]-t[2]*t[5],c=t[1]*t[7]-t[3]*t[5],i=t[2]*t[7]-t[3]*t[6],l=t[8]*t[13]-t[9]*t[12],a=t[8]*t[14]-t[10]*t[12],f=t[8]*t[15]-t[11]*t[12],x=t[9]*t[14]-t[10]*t[13],w=t[9]*t[15]-t[11]*t[13],T=t[10]*t[15]-t[11]*t[14];let d=e*T-n*w+r*x+o*f-c*a+i*l;return d?(d=1/d,[(t[5]*T-t[6]*w+t[7]*x)*d,(t[2]*w-t[1]*T-t[3]*x)*d,(t[13]*i-t[14]*c+t[15]*o)*d,(t[10]*c-t[9]*i-t[11]*o)*d,(t[6]*f-t[4]*T-t[7]*a)*d,(t[0]*T-t[2]*f+t[3]*a)*d,(t[14]*r-t[12]*i-t[15]*n)*d,(t[8]*i-t[10]*r+t[11]*n)*d,(t[4]*w-t[5]*f+t[7]*l)*d,(t[1]*f-t[0]*w-t[3]*l)*d,(t[12]*c-t[13]*r+t[15]*e)*d,(t[9]*r-t[8]*c-t[11]*e)*d,(t[5]*a-t[4]*x-t[6]*l)*d,(t[0]*x-t[1]*a+t[2]*l)*d,(t[13]*n-t[12]*o-t[14]*e)*d,(t[8]*o-t[9]*n+t[10]*e)*d]):Dt()},V=(t,e,n)=>[1,0,0,0,0,1,0,0,0,0,1,0,t,e,n,1],z=(t,e,n,r)=>{t[12]=e,t[13]=n,t[14]=r},lt=(t,e)=>{const n=b(t),r=Math.sin(n),o=Math.cos(n);return[o,r,0,0,-r,o,0,0,0,0,1,0,0,0,0,1]},Nt=(t,e,n)=>[t,0,0,0,0,e,0,0,0,0,n,0,0,0,0,1],Bt=(t,e,n)=>{const r=Q(It(e,t)),o=Q(Z(n,r)),c=Z(r,o),i=P(t,o),l=P(t,c),a=P(t,r);return[o[0],c[0],r[0],0,o[1],c[1],r[1],0,o[2],c[2],r[2],0,-i,-l,-a,1]},Ot=(t,e,n,r)=>{const o=1/Math.tan(t),c=o/e,i=r/(r-n),l=-(i*n);return[c,0,0,0,0,o,0,0,0,0,i,1,0,0,l,0]},Xt=(t,e,n,r)=>{const o=2/t,c=2/e,i=1/(r-n),l=n/(n-r);return[o,0,0,0,0,c,0,0,0,0,i,0,0,0,l,1]},at=(t,e,n)=>[t*2,e*2,n*.5],X=(t,e,n)=>[Math.floor(t)*2+1,Math.floor(e)*2+1,n*.5];const U={t:performance.now(),dt:0,n:0},Ct=t=>{U.dt=(t-U.t)/1e3,U.t=t,U.n+=1};var m=null;const y=(t,e,n)=>{t.addEventListener(e,n)},Ht=()=>{const t=document.body;t.style.userSelect="none",t.style.webkitUserSelect="none",t.style.msUserSelect="none",t.style.mozUserSelect="none"},Gt=()=>{const t=document.body;t.style.touchAction="none"},Yt=()=>{Ht(),Gt(),m={},m.gamepad={index:null,lx:0,ly:0,rx:0,ry:0,b0:!1,b1:!1,b8:!1,b9:!1,lb:!1,rb:!1,lt:!1,rt:!1},m.keyboard={w:!1,a:!1,s:!1,d:!1,up:!1,left:!1,down:!1,right:!1,q:!1,e:!1,z:!1,x:!1,space:!1,lctrl:!1,esc:!1},m.touch=new Map,y(window,"focus",t=>{}),y(window,"blur",t=>{}),y(window,"resize",t=>{}),y(window,"gamepadconnected",t=>{m.gamepad.index=t.gamepad.index}),y(window,"gamepaddisconnected",t=>{m.gamepad.index===t.gamepad.index&&(m.gamepad.index=null)}),y(document,"keydown",t=>{j(m.keyboard,t.code,!0)&&t.preventDefault()}),y(document,"keyup",t=>{j(m.keyboard,t.code,!1)&&t.preventDefault()}),y(document.body,"contextmenu",t=>{t.preventDefault()}),y(document.body,"pointerdown",t=>{m.touch.set(t.pointerId,{x:t.clientX,y:t.clientY,sx:t.clientX,sy:t.clientY,time:performance.now()})}),y(document.body,"pointerup",t=>{m.touch.delete(t.pointerId)}),y(document.body,"pointerout",t=>{m.touch.delete(t.pointerId)}),y(document.body,"pointermove",t=>{const e=m.touch.get(t.pointerId);e&&(e.x=t.clientX,e.y=t.clientY)})},j=(t,e,n)=>{switch(e){case"KeyW":t.w=n;break;case"KeyA":t.a=n;break;case"KeyS":t.s=n;break;case"KeyD":t.d=n;break;case"ArrowUp":t.up=n;break;case"ArrowLeft":t.left=n;break;case"ArrowDown":t.down=n;break;case"ArrowRight":t.right=n;break;case"KeyQ":t.q=n;break;case"KeyE":t.e=n;break;case"KeyZ":t.z=n;break;case"KeyX":t.x=n;break;case"Space":t.space=n;break;case"ControlLeft":t.lctrl=n;break;case"Escape":t.esc=n;break;default:return!1}return!0},Vt=t=>{if(t.index!==null){const n=navigator.getGamepads()[t.index];t.lx=Math.trunc(n.axes[0]*4)/4,t.ly=Math.trunc(n.axes[1]*4)/4,t.rx=Math.trunc(n.axes[2]*4)/4,t.ry=Math.trunc(n.axes[3]*4)/4,t.b0=n.buttons[0].value>=.5,t.b1=n.buttons[1].value>=.5,t.b8=n.buttons[8].value>=.5,t.b9=n.buttons[9].value>=.5,t.lb=n.buttons[4].value>=.5,t.rb=n.buttons[5].value>=.5,t.lt=n.buttons[6].value>=.5,t.rt=n.buttons[7].value>=.5}},zt=()=>{Vt(m.gamepad)},$t=(t,e,n)=>{for(const r of m.touch.values())if(Rt([r.sx,r.sy],...t)){const o=r.x-r.sx,c=-(r.y-r.sy);return S(o,c)}if(e){if(e==="wasd"){const r=m.keyboard,o=r.a?-1:r.d?1:0,c=r.w?1:r.s?-1:0;if(o!==0||c!==0)return S(o,c)}else if(e==="arrow"){const r=m.keyboard,o=r.right?1:r.left?-1:0,c=r.up?1:r.down?-1:0;if(o!==0||c!==0)return S(o,c)}else if(m.keyboard[e])return[1,0]}if(n){if(n==="left-stick"){const r=m.gamepad;return S(r.lx,-r.ly)}else if(n==="right-stick"){const r=m.gamepad;return S(r.rx,-r.ry)}else if(m.gamepad[n])return[1,0]}return null},Kt=t=>{const e=localStorage.getItem(t);return e==null?null:JSON.parse(e)},Wt=(t,e)=>{const n=JSON.stringify(e);localStorage.setItem(t,n)};var s=null;const qt=()=>{s=document.getElementById("main").getContext("webgl2")},ut=(t,e)=>{let n=s.createTexture();return s.bindTexture(s.TEXTURE_2D,n),e==0&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST)),e==1&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR)),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,t),s.bindTexture(s.TEXTURE_2D,null),n},ft=(t,e)=>{s.bindTexture(s.TEXTURE_2D,t),s.texSubImage2D(s.TEXTURE_2D,0,0,0,s.RGBA,s.UNSIGNED_BYTE,e),s.bindTexture(s.TEXTURE_2D,null)},tt=(t,e)=>{const n=s.createShader(t);return s.shaderSource(n,e),s.compileShader(n),s.getShaderParameter(n,s.COMPILE_STATUS)?n:(s.deleteShader(n),null)},Jt=(t,e)=>{const n=s.createProgram();return s.attachShader(n,t),s.attachShader(n,e),s.linkProgram(n),s.getProgramParameter(n,s.LINK_STATUS)?n:(s.deleteProgram(n),null)},et=(t,e)=>{let n=s.createBuffer();return s.bindBuffer(t,n),s.bufferData(t,e,s.STATIC_DRAW),n},F=(t,e,n,r,o,c)=>{s.enableVertexAttribArray(t),s.vertexAttribPointer(t,e,n,r,o,c)},Qt=()=>{const t=window.innerWidth;t!==s.canvas.width&&(s.canvas.width=t);const e=window.innerHeight;e!==s.canvas.height&&(s.canvas.height=e)},Zt=()=>{s.viewport(0,0,s.canvas.width,s.canvas.height),s.clearColor(0,0,0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)},jt=t=>{t.cw?(s.enable(s.CULL_FACE),s.frontFace(s.CW)):(s.enable(s.CULL_FACE),s.frontFace(s.CCW)),t.d?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST),t.a?(s.enable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA)):(s.disable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA))},te=(t,e)=>{e=e||0;const n=t.iv[e*3+0],r=t.iv[e*3+1],o=t.iv[e*3+2],c=[null,s.POINTS,s.LINES,s.TRIANGLES];t.i?s.drawElements(c[n],o,s.UNSIGNED_SHORT,2*r):s.drawArrays(c[n],r,o)},C=(t,e)=>{s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,t),s.uniform1i(e,0)},ee=(t,e)=>{const n=document.createElement("canvas");return n?(n.width=t,n.height=e,n):null},$=(t,e)=>{const n=t.getContext("2d");if(!n)return null;n.clearRect(0,0,t.width,t.height),n.fillStyle="rgba(0 0 0 / 0.5)",n.fillRect(0,0,t.width,t.height),n.fillStyle="white",n.textAlign="left",n.textBaseline="top",n.font="14px monospace";const r=e.split(`
`);for(let o=0;o<r.length;++o)n.fillText(r[o],0,12*o)};var ne=null;const re=()=>{ne=new AudioContext},dt={},L=(t,e)=>{if(!!e)for(const n of e){const r=dt[n[0]];if(!r)continue;const o=n.slice(1);r(t,...o)}},g=(t,e)=>{dt[t]=e},nt=0,rt=1,ot=2,st=3,oe=(t,e)=>{if(t.vao=s.createVertexArray(),s.bindVertexArray(t.vao),t.b>=0&&(t.b=et(s.ARRAY_BUFFER,J(e[t.b])),t.bv))for(let n=0;n<t.bv.length;n+=2)switch(t.bv[n]){case nt:F(nt,3,s.FLOAT,!1,0,t.bv[n+1]);break;case rt:F(rt,3,s.HALF_FLOAT,!1,0,t.bv[n+1]);break;case ot:F(ot,4,s.UNSIGNED_BYTE,!0,0,t.bv[n+1]);break;case st:F(st,2,s.HALF_FLOAT,!1,0,t.bv[n+1]);break}return t.i>=0&&(t.i=et(s.ELEMENT_ARRAY_BUFFER,J(e[t.i]))),s.bindVertexArray(null),t},se=(t,e)=>{if(t.vs=tt(s.VERTEX_SHADER,e[t.vs]),t.fs=tt(s.FRAGMENT_SHADER,e[t.fs]),t.prog=Jt(t.vs,t.fs),t.u){const n={};for(let r of t.u)n[r]=s.getUniformLocation(t.prog,r);t.u=n}if(t.ub){const n={};let r=0;for(let o of t.ub){const c=s.getUniformBlockIndex(t.prog,o);s.uniformBlockBinding(t.prog,c,r),n[o]=r,r+=1}t.ub=n}return t};let H=0;const ce=(t,e)=>{t.tex=null;const n=new Image;return n.onload=()=>{t.tex=ut(n,t.s),H-=1},n.src="data:image/png;base64,"+e[t.b],H+=1,t},p={index:null,pack:[]},ie=()=>{fetch("index.json").then(e=>e.json()).then(e=>{p.index=e;for(const n of p.index.pack)le(n)})},le=t=>{const e="pack"+t+".json";fetch(e).then(n=>n.json()).then(n=>{n.mesh&&(n.mesh=n.mesh.map(r=>oe(r,n.content))),n.image&&(n.image=n.image.map(r=>ce(r,n.content))),n.shader&&(n.shader=n.shader.map(r=>se(r,n.content))),p.pack[t]=n})},_t=()=>!(p.index===null||p.pack.length<=0||H>0),v=(t,e)=>{if(e<=0)return null;const n=p.index[t];if(!n)return null;const r=n[e];if(!r)return null;const o=p.pack[r.p];return o?o[t][r.i]:null},ae=t=>v("mesh",t),ue=t=>v("image",t),fe=t=>v("shader",t),de=t=>v("draw",t),G=t=>v("item",t),_e=t=>v("base",t),B=t=>v("tile",t),M=t=>v("mob",t),mt=t=>v("hit",t),me=t=>v("grid",t),ht=t=>v("com",t),K=t=>v("view",t),O=(t,e)=>{const n=p.index[t];if(!n)return 0;const r=n.findIndex(o=>o&&o.n===e);return r<=0?0:r};const he=t=>O("base",t);const xe=t=>O("grid",t),ge=t=>O("com",t),we=t=>O("view",t),ye=()=>({base:[],no:0,ha:0}),xt=t=>t?t.base.length<=0&&t.no<=0:!0,W=t=>t?t.no>0:!1,A=(t,e)=>{if(xt(t)||W(t))return!0;const n=I(t);return Math.abs(e-n)>1},I=t=>t?t.base.length:0,ve=(t,e,n)=>{!t||(t.no=e,t.ha=n||0)},Ee=t=>{!t||(t.no=0,t.ha=0)},gt=(t,e)=>{!t||t.base.push(e)},Te=t=>{!t||t.base.pop()},pe=t=>{t=t||0;const e={s:[],i:0};return e.s.length=t,e.s.fill(null),e.i=0,e},wt=(t,e)=>t.s.findIndex(n=>n&&n.no===e),Ae=t=>t.s.findIndex(e=>!e),yt=(t,e)=>{const n=e??t.i;return t.s[n]},vt=(t,e)=>{const n=Mt(t.i+e,t.s.length);t.i=n},Et=(t,e,n)=>{let r=wt(t,e);if(r<0){if(r=Ae(t),r<0)return;t.s[r]={no:e,n};return}t.s[r].n+=n},Me=(t,e,n)=>{const r=wt(t,e);r<0||(t.s[r].n-=n,t.s[r].n<=0&&(t.s[r]=null))},Se=(t,e,n,r,o,c)=>{const i={no:t,x:e,y:n,h:r,ha:o||0,va:c||0,dmg:0,hit:Xe(),item:pe(8)},l=M(t);if(!l)return null;if(l.item)for(const a of l.item)Et(i.item,a.no,a.n);return i},be=t=>{const e=M(t.no);!e||(e.action&&L(t,e.action),Ue(t))},Re=t=>{He(t.hit,t)},Ue=t=>{const e=I(h(t.x,t.y));if(Math.abs(e-t.h)<=2){const n=U.dt,r=e-t.h;t.h+=10*n*r}else t.h=e},N=(t,e,n,r,o)=>{const c=Math.floor(e),i=Math.floor(n),l=I(h(c,i));let a=e+r,f=n+o;return A(h(c-1,i),l)&&(a=Math.max(a,c+t)),A(h(c+1,i),l)&&(a=Math.min(a,c-t+1)),A(h(c,i-1),l)&&(f=Math.max(f,i+t)),A(h(c,i+1),l)&&(f=Math.min(f,i-t+1)),A(h(c-1,i-1),l)&&([a,f]=D([a,f],t,[c,i])),A(h(c-1,i+1),l)&&([a,f]=D([a,f],t,[c,i+1])),A(h(c+1,i-1),l)&&([a,f]=D([a,f],t,[c+1,i])),A(h(c+1,i+1),l)&&([a,f]=D([a,f],t,[c+1,i+1])),[a,f]},ke=(t,e,n)=>{const r=M(t.no);if(!r)return;const o=U.dt;if(n&&(t.ha+=90*o*n[0],t.va+=90*o*n[1],t.va=Math.max(-60,Math.min(t.va,80))),e){const i=b(t.ha+90),l=b(t.ha),a=e[0],f=e[1],x=a*Math.cos(i)+f*Math.cos(l),w=a*Math.sin(i)+f*Math.sin(l),T=2*o*x,d=2*o*w;[t.x,t.y]=N(r.r,t.x,t.y,T,d)}else[t.x,t.y]=N(r.r,t.x,t.y,0,0)},Ie=t=>{for(let e=0;e<t.length;++e)for(let n=e+1;n<t.length;++n){const r=t[e],o=t[n],c=M(r.no);if(!c)continue;const i=M(o.no);if(!i)continue;const[l,a]=[o.x-r.x,o.y-r.y],f=Y(l,a),x=c.r+i.r-f;if(x<=0)continue;const w=S(l,a),T=St(w),d=c.m==0&&i.m==0?.5:c.m/(c.m+i.m),q=1-d;[r.x,r.y]=N(c.r,r.x,r.y,T[0]*d*x,T[1]*d*x),[o.x,o.y]=N(i.r,o.x,o.y,w[0]*q*x,w[1]*q*x)}},Le=t=>{const e=M(t.no);return e?e.hp==0||t.dmg<e.hp:!1},Tt=(t,e)=>{t.dmg+=e},De=0,Fe=0,ct=1,Pe=()=>({m:new Float32Array(16),rect:[0,0,0,0],value:null,state:De,img:null,cvs:null}),it=t=>{const e=ge(t);if(e<=0)return null;const n=u.com[e];return n?n.value:null},Ne=(t,e,n)=>{const r=t.rect.ox*e/2,o=t.rect.oy*n/2,c=Nt(t.rect.w/2,t.rect.h/2,1);return z(c,r+t.rect.x,-(o+t.rect.y),0),c},Be=(t,e,n)=>{const r=e/2+e/2*t.rect.ox,o=n/2+n/2*t.rect.oy,c=r+(t.rect.x-t.rect.w/2),i=r+(t.rect.x+t.rect.w/2),l=o+(t.rect.y-t.rect.h/2),a=o+(t.rect.y+t.rect.h/2);return[c,i,l,a]},Oe=(t,e)=>{if(e.rect&&(t.m.set(Ne(e,u.w,u.h)),t.rect=Be(e,u.w,u.h)),e.text&&t.img===null&&(t.cvs=ee(e.rect.w,e.rect.h),$(t.cvs,e.text.contents),t.img=ut(t.cvs,e.text.s)),e.touch){t.value=$t(t.rect,e.touch.keyboard,e.touch.gamepad);let n=!1;t.value!==null?t.state!==ct&&(t.state=ct,n=!0):t.state=Fe,n&&L(t,e.touch.action)}e.tick&&L(t,e.tick.action)},Xe=()=>({no:0,item:0,act:!1}),R=(t,e,n)=>{const r=Math.floor(t),o=Math.floor(e);let c=[];const i=b(n),l=Math.floor(t+Math.cos(i)*.8),a=Math.floor(e+Math.sin(i)*.8);return(r!=l||o!=a)&&c.push({x:l,y:a}),c},Ce=(t,e)=>{const n=yt(e);if(!n)return;const r=G(n.no);!r||!r.usable||(t.no=r.usable.hit,t.item=e.no)},He=(t,e)=>{if(Ce(t,e.item),t.no>0&&t.act){const n=mt(t.no);if(!n)return;n.action&&L(e,n.action),t.act=!1}},_={w:0,h:0,t:[],m:[]},pt=(t,e)=>{t=t||0,e=e||0,_.w=t,_.h=e,_.t=[],_.t.length=t*e;for(let n=0;n<_.t.length;++n)_.t[n]=ye();_.m=[]},Ge=t=>{const e=me(t);if(!!e){if(pt(e.w,e.h),e.b)for(const n of e.b)for(let r=n.x;r<n.x+n.w;++r)for(let o=n.y;o<n.y+n.h;++o)gt(h(r,o),n.no);if(e.t)for(const n of e.t)ve(h(n.x,n.y),n.no,n.ha);if(e.m)for(const n of e.m)$e(n.no,n.x+.5,n.y+.5,n.ha,n.va)}},Ye=(t,e)=>(t=Math.floor(t),e=Math.floor(e),t<0||_.w<=t||e<0||_.h<=e?-1:t+e*_.h),h=(t,e)=>_.t[Ye(t,e)],Ve=t=>_.m.find(e=>e.no===t),ze=t=>_.m.filter(e=>{const n=Math.floor(e.x),r=Math.floor(e.y);for(const o of t)if(o.x===n&&o.y===r)return!0;return!1}),$e=(t,e,n,r,o)=>{const c=I(h(e,n));_.m.push(Se(t,e,n,c,r,o))},Ke=()=>{for(const t of _.m)be(t);Ie(_.m);for(const t of _.m)Re(t);_.m=_.m.filter(t=>Le(t))},u={w:0,h:0,view:null,slot:0,com:[],cam:{eye:[0,0,0],vp:new Float32Array(16),ivp:new Float32Array(16),o:new Float32Array(16)},m:new Float32Array(16)},We=()=>{u.view=p.index.init,u.slot=0},E=()=>{const t=K(u.view);return!t||!t.grid||t.grid.cam<=0?null:Ve(t.grid.cam)},At=t=>{const e=we(t);e<0||(u.view=e)},qe=()=>{u.view===null&&We(),u.w=window.innerWidth,u.h=window.innerHeight},Je=()=>{const t=b(30),e=.1,n=1e3;let r=[1,0,0],o=[0,0,0];const c=E();c&&(r=Lt(c.ha,c.va),o=at(c.x,c.y,c.h),o[2]+=1.75);const i=kt(o,r),a=Bt(o,i,[0,0,1]),f=Ot(t,u.w/u.h,e,n),x=Ft(a,f);u.cam.vp.set(x),u.cam.ivp.set(Pt(x)),u.cam.eye=o,u.cam.o.set(Xt(u.w,u.h,0,1))},Qe=()=>{qe();const t=K(u.view);if(t){for(const e of u.com)e&&(e.value=null);if(t.com)for(let e of t.com){const n=ht(e);if(!n)continue;u.com[e]||(u.com[e]=Pe());const r=u.com[e];Oe(r,n)}t.grid&&Ke()}Je()},Ze=()=>{Qt(),Zt()},k=(t,e)=>{const n=de(t);if(!n)return;jt(n.state);const r=fe(n.shader);if(!r)return;s.useProgram(r.prog);const o=ae(n.mesh);if(!o)return;s.bindVertexArray(o.vao),s.uniformMatrix4fv(r.u.vp,!1,n.ortho?u.cam.o:u.cam.vp);const c=ue(n.image);C(c?c.tex:null,r.u.tex0),e(r.u),te(o)},je=(t,e)=>{const n=h(t,e);if(!n)return;for(let c=0;c<n.base.length;++c){const i=_e(n.base[c]);!i||k(i.draw,l=>{const a=X(t,e,c);u.m.set(V(a[0],a[1],a[2])),s.uniformMatrix4fv(l.w,!1,u.m)})}const r=B(n.no);if(!r)return;const o=I(n);k(r.draw,c=>{const i=X(t,e,o),l=lt(n.ha||0,n.va||0);z(l,i[0],i[1],i[2]),u.m.set(l),s.uniformMatrix4fv(c.w,!1,u.m)})},tn=t=>{const e=M(t.no);!e||e.draw<=0||k(e.draw,n=>{const r=at(t.x,t.y,t.h),o=lt(t.ha||0,t.va||0);z(o,r[0],r[1],r[2]),u.m.set(o),s.uniformMatrix4fv(n.w,!1,u.m)})},en=t=>{const e=mt(t.hit.no);if(!e)return;const n=R(t.x,t.y,t.ha);for(const r of n){const o=h(r.x,r.y);if(!o)return;const c=I(o);k(e.draw,i=>{const l=X(r.x,r.y,c);u.m.set(V(l[0],l[1],l[2])),s.uniformMatrix4fv(i.w,!1,u.m)})}},nn=()=>{for(let t=0;t<_.w;++t)for(let e=0;e<_.h;++e)je(t,e);for(const t of _.m)tn(t);for(const t of _.m)en(t)},rn=(t,e)=>{const n=ht(e);!n||!n.rect||n.rect.draw<=0||k(n.rect.draw,r=>{s.uniformMatrix4fv(r.w,!1,t.m),t.img&&C(t.img,r.tex0)})},on=()=>{const t=K(u.view);if(!!t){if(t.grid){if(t.grid.draw)for(let e of t.grid.draw)k(e,n=>{u.m.set(V(...u.cam.eye)),s.uniformMatrix4fv(n.w,!1,u.m)});nn()}if(t.com)for(let e of t.com){const n=u.com[e];n&&rn(n,e)}}},sn=t=>t,cn=t=>t,ln=()=>{pt()},an=()=>{const t=Kt(`data${u.slot}`);return t?(t.grid&&Object.assign(_,cn(t.grid)),!0):!1},un=()=>{const t={};t.grid=sn(_),Wt(`data${u.slot}`,t)};const fn=()=>{qt(),re(),Yt(),ie()},dn=t=>{Ct(t),zt(),_t()&&Qe()},_n=()=>{Ze(),_t()&&on()};y(window,"load",()=>{fn();const t=e=>{dn(e),_n(),requestAnimationFrame(t)};t()});g("nextview",(t,e)=>{At(e)});g("newgame",t=>{ln()});g("loadgame",t=>{an()});g("savegame",t=>{un()});g("fpsmove",(t,e,n)=>{const r=it(e),o=it(n);ke(t,r,o)});g("newgrid",(t,e)=>{const n=xe(e);n<=0||Ge(n)});g("inventory_next",t=>{const e=E();!e||vt(e.item,1)});g("inventory_prev",t=>{const e=E();!e||vt(e.item,-1)});g("inventory",t=>{let e="";const n=E();if(n){{const r=M(n.no);if(!r)return;const o=r.hp,c=Math.max(0,o-n.dmg);e+="HP: "+c+"/"+o,e+=`
`}e+=`
`;for(let r=0;r<n.item.s.length;++r){if(n.item.i===r?e+=">":e+=" ",e+="["+r+"]",n.item.s[r]!=null){const o=G(n.item.s[r].no);if(!o)continue;e+=o.text+":"+n.item.s[r].n}e+=`
`}e+=`
`;{const r=yt(n.item);if(r!=null){const o=G(r.no);o!=null&&(e+=o.desc+`
`)}}}$(t.cvs,e),ft(t.img,t.cvs)});g("hand",t=>{const e=E();!e||(e.hit.act=!0)});g("activate",t=>{const e=E();if(!e)return;const n=R(e.x,e.y,e.ha);for(const r of n){const o=h(r.x,r.y);if(!o)continue;const c=B(o.no);!c||c.device&&L(o,c.device.action)}});g("activate-target",t=>{let e="";const n=E();if(n){const r=R(n.x,n.y,n.ha);for(const o of r){const c=h(o.x,o.y);if(!c)continue;const i=B(c.no);!i||(e+=i.desc,e+=`
`)}}$(t.cvs,e),ft(t.img,t.cvs)});g("hit-mining",t=>{const e=E();if(!e)return;const n=R(t.x,t.y,t.ha);for(const r of n){const o=h(r.x,r.y);if(!o)continue;const c=B(o.no);!c||c.mine&&(Et(e.item,c.mine.item,c.mine.count),Ee(o))}});g("hit-dig",t=>{const e=R(t.x,t.y,t.ha);for(const n of e){const r=h(n.x,n.y);xt(r)||W(r)||Te(r)}});g("hit-put",(t,e)=>{const n=he(e);if(n<=0)return;const r=E();if(!r)return;const o=R(t.x,t.y,t.ha);let c=0;for(const i of o){const l=h(i.x,i.y);W(l)||(gt(l,n),c+=1)}t.hit.item>0&&c>0&&Me(r.item,t.hit.item,c)});g("hit-damage",t=>{const e=R(t.x,t.y,t.ha),n=ze(e);for(const r of n)Tt(r,1)});g("giveup",t=>{const e=E();!e||Tt(e,9999)});g("gameover",(t,e)=>{E()||At(e)});})();
