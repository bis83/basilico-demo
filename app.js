(()=>{const U=e=>{const t=window.atob(e),n=new ArrayBuffer(t.length),s=new DataView(n);for(let c=0;c<t.length;++c)s.setUint8(c,t.charCodeAt(c));return n};const w=e=>e/180*Math.PI,Q=(e,t)=>Math.sqrt(e*e+t*t),D=(e,t)=>{const n=Q(e,t);return n!=0?[e/n,t/n]:[0,0]};const Z=([e,t],n,s,c,i)=>n<=e&&e<=s&&c<=t&&t<=i,v=(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],j=e=>{const t=v(e,e);return Math.sqrt(t)},ee=(e,t)=>[e[0]+t[0],e[1]+t[1],e[2]+t[2]],te=(e,t)=>[e[0]-t[0],e[1]-t[1],e[2]-t[2]];const G=e=>{const t=j(e);return[e[0]/t,e[1]/t,e[2]/t]},P=(e,t)=>[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]],ne=(e,t)=>{const n=w(e),s=w(t);return[Math.cos(s)*Math.cos(n),Math.cos(s)*Math.sin(n),Math.sin(s)]},X=(e,t,n)=>[e*2,t*2,n*.5];const oe=(e,t)=>[e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15]],se=(e,t,n)=>[1,0,0,0,0,1,0,0,0,0,1,0,e,t,n,1],re=(e,t,n,s)=>{e[12]=t,e[13]=n,e[14]=s},ce=(e,t,n)=>[e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1],ae=(e,t,n)=>{const s=G(te(t,e)),c=G(P(n,s)),i=P(s,c),l=v(e,c),u=v(e,i),d=v(e,s);return[c[0],i[0],s[0],0,c[1],i[1],s[1],0,c[2],i[2],s[2],0,-l,-u,-d,1]},ie=(e,t,n,s)=>{const c=1/Math.tan(e),i=c/t,l=s/(s-n),u=-(l*n);return[i,0,0,0,0,c,0,0,0,0,l,1,0,0,u,0]},le=(e,t,n,s)=>{const c=2/e,i=2/t,l=1/(s-n),u=n/(n-s);return[c,0,0,0,0,i,0,0,0,0,l,0,0,0,u,1]},R=(e,t)=>e<<0|t<<16,A=e=>[e>>0&65535,e>>16&65535],g=0,E=1,k=2;var a=null;const f=(e,t,n)=>{e.addEventListener(t,n)},ue=()=>{const e=document.body;e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.msUserSelect="none",e.style.mozUserSelect="none"},de=()=>{const e=document.body;e.style.touchAction="none"},fe=()=>{ue(),de(),a={},a.mode=g,a.timer={prevTime:performance.now(),deltaTime:0},a.gamepad={index:null,lx:0,ly:0,rx:0,ry:0,b0:!1,b1:!1,lt:!1,rt:!1},a.keyboard={w:!1,a:!1,s:!1,d:!1,up:!1,left:!1,down:!1,right:!1,z:!1,x:!1,space:!1,lctrl:!1},a.click=[],a.touch=new Map,a.input={moveX:0,moveY:0,cameraX:0,cameraY:0},f(window,"focus",e=>{}),f(window,"blur",e=>{}),f(window,"resize",e=>{}),f(window,"gamepadconnected",e=>{a.gamepad.index=e.gamepad.index,a.mode=E}),f(window,"gamepaddisconnected",e=>{a.gamepad.index===e.gamepad.index&&(a.gamepad.index=null)}),f(document,"keydown",e=>{F(a.keyboard,e.code,!0)&&(a.mode=k,e.preventDefault())}),f(document,"keyup",e=>{F(a.keyboard,e.code,!1)&&(a.mode=k,e.preventDefault())}),f(document.body,"contextmenu",e=>{e.preventDefault()}),f(document.body,"pointerdown",e=>{a.touch.set(e.pointerId,{x:e.clientX,y:e.clientY,sx:e.clientX,sy:e.clientY,time:performance.now()}),a.mode=g}),f(document.body,"pointerup",e=>{const t=a.touch.get(e.pointerId);t&&performance.now()-t.time<250&&a.click.push({x:t.x,y:t.y}),a.touch.delete(e.pointerId),a.mode=g}),f(document.body,"pointerout",e=>{a.touch.delete(e.pointerId),a.mode=g}),f(document.body,"pointermove",e=>{const t=a.touch.get(e.pointerId);t&&(t.x=e.clientX,t.y=e.clientY,a.mode=g)})},F=(e,t,n)=>{switch(t){case"KeyW":e.w=n;break;case"KeyA":e.a=n;break;case"KeyS":e.s=n;break;case"KeyD":e.d=n;break;case"ArrowUp":e.up=n;break;case"ArrowLeft":e.left=n;break;case"ArrowDown":e.down=n;break;case"ArrowRight":e.right=n;break;case"KeyZ":e.z=n;break;case"KeyX":e.x=n;break;case"Space":e.space=n;break;case"ControlLeft":e.lctrl=n;break;default:return!1}return!0},he=e=>{const t=performance.now();e.deltaTime=(t-e.prevTime)/1e3,e.prevTime=t},me=e=>{if(e.index!==null){const n=navigator.getGamepads()[e.index];e.lx=Math.trunc(n.axes[0]*4)/4,e.ly=Math.trunc(n.axes[1]*4)/4,e.rx=Math.trunc(n.axes[2]*4)/4,e.ry=Math.trunc(n.axes[3]*4)/4,e.b0=n.buttons[0].value>=.5,e.b1=n.buttons[1].value>=.5,e.lt=n.buttons[6].value>=.5,e.rt=n.buttons[7].value>=.5,!!(e.lx||e.ly||e.rx||e.ry||e.b0||e.b1||e.lt||e.rt)&&(a.mode=E)}},_e=e=>{const t=a.mode;if(t===E){const n=a.gamepad;e.moveX=n.lx,e.moveY=-n.ly,e.cameraX=n.rx,e.cameraY=-n.ry}else if(t===k){const n=a.keyboard;e.moveX=n.a?-1:n.d?1:0,e.moveY=n.w?1:n.s?-1:0,e.cameraX=n.right?1:n.left?-1:0,e.cameraY=n.up?1:n.down?-1:0}else if(t===g){e.moveX=0,e.moveY=0,e.cameraX=0,e.cameraY=0;for(const n of a.touch.values())n.sx<window.innerWidth/2?(e.moveX=n.x-n.sx,e.moveY=-(n.y-n.sy)):(e.cameraX=n.x-n.sx,e.cameraY=-(n.y-n.sy))}else e.moveX=0,e.moveY=0,e.cameraX=0,e.cameraY=0;[e.moveX,e.moveY]=D(e.moveX,e.moveY),[e.cameraX,e.cameraY]=D(e.cameraX,e.cameraY)},ge=()=>{he(a.timer),me(a.gamepad),_e(a.input)},pe=()=>{a.click.length=0},xe=e=>{const t=localStorage.getItem(e);return t==null?null:JSON.parse(t)},we=(e,t)=>{const n=JSON.stringify(t);localStorage.setItem(e,n)};var o=null;const Te=()=>{o=document.getElementById("main").getContext("webgl2")},O=0,N=1,Y=2,B=3,ve=e=>{let t=o.createTexture();return o.bindTexture(o.TEXTURE_2D,t),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,e),o.bindTexture(o.TEXTURE_2D,null),t},Ae=(e,t,n)=>{const s=document.createElement("canvas");if(!s)return null;s.width=t,s.height=n;const c=s.getContext("2d");return c?(c.fillStyle="white",c.textAlign="center",c.textBaseline="middle",c.font="24px monospace",c.fillText(e,s.width/2,s.height/2),s):null},C=(e,t)=>{const n=o.createShader(e);return o.shaderSource(n,t),o.compileShader(n),o.getShaderParameter(n,o.COMPILE_STATUS)?n:(o.deleteShader(n),null)},Ee=(e,t)=>{const n=o.createProgram();return o.attachShader(n,e),o.attachShader(n,t),o.linkProgram(n),o.getProgramParameter(n,o.LINK_STATUS)?n:(o.deleteProgram(n),null)},b=(e,t)=>{let n=o.createBuffer();return o.bindBuffer(e,n),o.bufferData(e,t,o.STATIC_DRAW),n},y=(e,t,n,s,c,i)=>{o.enableVertexAttribArray(e),o.vertexAttribPointer(e,t,n,s,c,i)},ke=()=>{const e=window.innerWidth;e!==o.canvas.width&&(o.canvas.width=e);const t=window.innerHeight;t!==o.canvas.height&&(o.canvas.height=t)},ye=()=>{o.viewport(0,0,o.canvas.width,o.canvas.height),o.clearColor(0,0,0,1),o.clearDepth(1),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT)},V=(e,t)=>{o.enable(o.CULL_FACE),e?(o.enable(o.DEPTH_TEST),o.depthFunc(o.LEQUAL)):o.disable(o.DEPTH_TEST),t?(o.enable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA)):(o.disable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA))},H=(e,t)=>{t=t||0;const n=e.iv[t*3+0],s=e.iv[t*3+1],c=e.iv[t*3+2],i=[null,o.POINTS,o.LINES,o.TRIANGLES];e.i?o.drawElements(i[n],c,o.UNSIGNED_SHORT,2*s):o.drawArrays(i[n],s,c)};var Se=null;const Me=()=>{Se=new AudioContext};const Re=e=>{if(e.vao=o.createVertexArray(),o.bindVertexArray(e.vao),e.b&&(e.b=b(o.ARRAY_BUFFER,U(e.b)),e.bv))for(let t=0;t<e.bv.length;t+=2)switch(e.bv[t]){case O:y(O,3,o.FLOAT,!1,0,e.bv[t+1]);break;case N:y(N,3,o.HALF_FLOAT,!1,0,e.bv[t+1]);break;case Y:y(Y,4,o.UNSIGNED_BYTE,!0,0,e.bv[t+1]);break;case B:y(B,2,o.HALF_FLOAT,!1,0,e.bv[t+1]);break}return e.i&&(e.i=b(o.ELEMENT_ARRAY_BUFFER,U(e.i))),o.bindVertexArray(null),e},Le=e=>{if(e.vs=C(o.VERTEX_SHADER,e.vs),e.fs=C(o.FRAGMENT_SHADER,e.fs),e.prog=Ee(e.vs,e.fs),e.u){const t={};for(let n of e.u)t[n]=o.getUniformLocation(e.prog,n);e.u=t}if(e.ub){const t={};let n=0;for(let s of e.ub){const c=o.getUniformBlockIndex(e.prog,s);o.uniformBlockBinding(e.prog,c,n),t[s]=n,n+=1}e.ub=t}return e},Ie=e=>(e.texture=ve(Ae(e.text,e.width,e.height)),e),h={index:null,pack:[]},Ue=()=>h.index!=null&&h.pack.length>0,De=()=>{fetch("data/index.json").then(t=>t.json()).then(t=>{h.index=t})},Ge=e=>{const t="data/pack"+e+".json";fetch(t).then(n=>n.json()).then(n=>{n.mesh&&(n.mesh=n.mesh.map(s=>Re(s))),n.texture&&(n.texture=n.texture.map(s=>Ie(s))),n.shader&&(n.shader=n.shader.map(s=>Le(s))),h.pack[e]=n})},z=()=>h.index&&h.index.ui,$=e=>h.pack[0]&&h.pack[0].mesh[e];const K=e=>h.pack[0]&&h.pack[0].shader[e],W=e=>h.pack[0]&&h.pack[0].stack.find(t=>t.id==e);var r={cam:{vp:new Float32Array(16),o:new Float32Array(16)},init:!1,pos:{x:0,y:0,ha:0,va:0,h:0,eyeh:1.75},stack:{w:0,h:0,a:[]},ui:{}};const S=(e,t)=>(e=Math.floor(e),t=Math.floor(t),e<0||r.stack.w<=e||t<0||r.stack.h<=t?null:r.stack.a[e+t*r.stack.h]),L=(e,t)=>{const n=S(e,t);if(!n)return 0;let s=0;for(const c of n){const[i,l]=A(c),u=W(i);!u||(s+=l*u.height)}return s},q=e=>{const t=r.ui[e];return t?t.value:null},Pe=0,I=0,T=1,Xe=(e,t)=>{const n=window.innerWidth,s=window.innerHeight,c=n/2+e.offset[0]-e.width/2,i=n/2+e.offset[0]+e.width/2,l=s/2+e.offset[1]-e.height/2,u=s/2+e.offset[1]+e.height/2;return Z([t.x,t.y],c,i,l,u)},Fe=(e,t)=>{const n=a.mode;if(n===g){let s=!1;const c=a.click;for(let i of c)if(Xe(t,i)){s=!0;break}s?(e.value=!0,e.state=T):(e.value=!1,e.state=I)}else n===E?a.gamepad[t.gamepad]?e.state!==T?(e.value=!0,e.state=T):e.value=!1:(e.value=!1,e.state=I):n===k&&(a.keyboard[t.keyboard]?e.state!==T?(e.value=!0,e.state=T):e.value=!1:(e.value=!1,e.state=I))},Oe=()=>{const e=z();if(!!e)for(let t of e){r.ui[t.name]||(r.ui[t.name]={m:new Float32Array(16),value:null,state:Pe});const n=r.ui[t.name];switch(t.interact){case 1:Fe(n,t);break;default:break}const s=ce(t.width/2,t.height/2,1);re(s,t.offset[0],-t.offset[1],0),n.m.set(s)}},Ne=()=>{r.init||(Be()||Ye(),r.init=!0)},Ye=()=>{r.stack.w=64,r.stack.h=64,r.stack.a.length=0,r.stack.a.length=r.stack.w*r.stack.h;for(let e=0;e<r.stack.a.length;++e){const t=1+Math.floor(Math.random()*10);r.stack.a[e]=[],r.stack.a[e].push(R(1,t))}r.pos.x=.5,r.pos.y=.5},Be=()=>{const e=xe("data0");return e?(e.pos&&(r.pos=e.pos),e.stack&&(r.stack=e.stack),!0):!1},J=()=>{const e={};e.pos=r.pos,e.stack=r.stack,we("data0",e)},M=(e,t,n,s)=>{const c=L(e,t),i=L(e+n,t+s);return Math.abs(c-i)>1},Ce=(e,t,n,s)=>{let c=e+n,i=t+s;const l=Math.floor(e),u=Math.floor(t),d=.25;return M(l,u,-1,0)&&(c=Math.max(c,l+d)),M(l,u,1,0)&&(c=Math.min(c,l-d+1)),M(l,u,0,-1)&&(i=Math.max(i,u+d)),M(l,u,0,1)&&(i=Math.min(i,u-d+1)),[c,i]},be=()=>{const e=a.timer.deltaTime,t=90;r.pos.ha+=t*e*a.input.cameraX,r.pos.va+=t*e*a.input.cameraY,r.pos.va=Math.max(-60,Math.min(r.pos.va,80));const n=2,s=w(r.pos.ha+90),c=w(r.pos.ha),i=a.input.moveX,l=a.input.moveY,u=i*Math.cos(s)+l*Math.cos(c),d=i*Math.sin(s)+l*Math.sin(c),m=n*e*u,_=n*e*d;[r.pos.x,r.pos.y]=Ce(r.pos.x,r.pos.y,m,_);const p=L(r.pos.x,r.pos.y);if(Math.abs(p-r.pos.h)<=2){const x=p-r.pos.h;r.pos.h+=10*e*x}else r.pos.h=p},Ve=()=>{const e=window.innerWidth,t=window.innerHeight,n=w(30),s=.1,c=1e3,i=ne(r.pos.ha,r.pos.va),l=X(r.pos.x,r.pos.y,r.pos.h);l[2]+=r.pos.eyeh;const u=ee(l,i),m=ae(l,u,[0,0,1]),_=ie(n,e/t,s,c);r.cam.vp.set(oe(m,_)),r.cam.o.set(le(e,t,0,1))},He=()=>{if(q("button_act")){const e=S(r.pos.x,r.pos.y);if(e&&e.length>0){let[t,n]=A(e[e.length-1]);n+=1,e[e.length-1]=R(t,n)}J()}if(q("button_sub")){const e=S(r.pos.x,r.pos.y);if(e&&e.length>0){let[t,n]=A(e[e.length-1]);n-=1,n>0?e[e.length-1]=R(t,n):e.pop()}J()}},ze=()=>{Oe(),be(),Ve(),He()},$e=()=>{ke(),ye()},Ke=()=>{const e=new Float32Array(16);V(!0,!1);for(let t=0;t<r.stack.w;++t)for(let n=0;n<r.stack.h;++n){const s=S(t,n);if(!s)return;let c=0;for(const i of s){const[l,u]=A(i),d=W(l);if(!d)continue;const m=K(d.shader);if(!m)continue;o.useProgram(m.prog),o.uniformMatrix4fv(m.u.vp,!1,r.cam.vp);const _=$(d.mesh);if(!!_){o.bindVertexArray(_.vao);for(let p=0;p<u;++p){const x=X(t,n,c);e.set(se(x[0],x[1],x[2])),o.uniformMatrix4fv(m.u.w,!1,e),H(_),c+=d.height}}}}},We=()=>{const e=z();if(!!e){V(!1,!0);for(let t of e){const n=r.ui[t.name];if(!n)continue;const s=K(t.shader);if(!s)return;o.useProgram(s.prog),o.uniformMatrix4fv(s.u.vp,!1,r.cam.o);const c=$(t.mesh);if(!c)return;o.bindVertexArray(c.vao),o.uniformMatrix4fv(s.u.w,!1,n.m),H(c)}}},qe=()=>{$e(),Ke(),We()};f(window,"load",()=>{Te(),Me(),fe(),De(),Ge(0);const e=()=>{ge(),Ue()&&(Ne(),ze(),qe()),pe(),requestAnimationFrame(e)};e()});})();
