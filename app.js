(()=>{const R=(t,e,o)=>{t.addEventListener(e,o)},st=()=>document.getElementById("canvas"),H=()=>document.getElementById("message"),W=t=>{const e=H();e.style.display="",e.textContent=t},ct=()=>{const t=H();t.style.display="none"};const A=t=>t!==void 0,it=(t,e)=>Math.floor(t/e),at=(t,e)=>(t%e+e)%e,O=(t,e,o)=>Math.max(e,Math.min(t,o)),V=t=>t/180*Math.PI,Y=(t,e)=>Math.sqrt(t*t+e*e),dt=(t,e)=>{const o=Y(t,e);return o!=0?[t/o,e/o]:[0,0]};const L=(t,e)=>t[0]*e[0]+t[1]*e[1]+t[2]*e[2],ft=t=>{const e=L(t,t);return Math.sqrt(e)},lt=(t,e)=>[t[0]+e[0],t[1]+e[1],t[2]+e[2]],ut=(t,e)=>[t[0]-e[0],t[1]-e[1],t[2]-e[2]];const k=t=>{const e=ft(t);return[t[0]/e,t[1]/e,t[2]/e]},q=(t,e)=>[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]],N=(t,e)=>{const o=V(t),n=V(e);return[Math.cos(n)*Math.cos(o),Math.sin(n),Math.cos(n)*Math.sin(o)]},ht=()=>[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],mt=(t,e)=>[t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15],t[4]*e[0]+t[5]*e[4]+t[6]*e[8]+t[7]*e[12],t[4]*e[1]+t[5]*e[5]+t[6]*e[9]+t[7]*e[13],t[4]*e[2]+t[5]*e[6]+t[6]*e[10]+t[7]*e[14],t[4]*e[3]+t[5]*e[7]+t[6]*e[11]+t[7]*e[15],t[8]*e[0]+t[9]*e[4]+t[10]*e[8]+t[11]*e[12],t[8]*e[1]+t[9]*e[5]+t[10]*e[9]+t[11]*e[13],t[8]*e[2]+t[9]*e[6]+t[10]*e[10]+t[11]*e[14],t[8]*e[3]+t[9]*e[7]+t[10]*e[11]+t[11]*e[15],t[12]*e[0]+t[13]*e[4]+t[14]*e[8]+t[15]*e[12],t[12]*e[1]+t[13]*e[5]+t[14]*e[9]+t[15]*e[13],t[12]*e[2]+t[13]*e[6]+t[14]*e[10]+t[15]*e[14],t[12]*e[3]+t[13]*e[7]+t[14]*e[11]+t[15]*e[15]],bt=t=>{const e=t[0]*t[5]-t[1]*t[4],o=t[0]*t[6]-t[2]*t[4],n=t[0]*t[7]-t[3]*t[4],r=t[1]*t[6]-t[2]*t[5],c=t[1]*t[7]-t[3]*t[5],s=t[2]*t[7]-t[3]*t[6],i=t[8]*t[13]-t[9]*t[12],a=t[8]*t[14]-t[10]*t[12],l=t[8]*t[15]-t[11]*t[12],h=t[9]*t[14]-t[10]*t[13],f=t[9]*t[15]-t[11]*t[13],u=t[10]*t[15]-t[11]*t[14];let d=e*u-o*f+n*h+r*l-c*a+s*i;return d?(d=1/d,[(t[5]*u-t[6]*f+t[7]*h)*d,(t[2]*f-t[1]*u-t[3]*h)*d,(t[13]*s-t[14]*c+t[15]*r)*d,(t[10]*c-t[9]*s-t[11]*r)*d,(t[6]*l-t[4]*u-t[7]*a)*d,(t[0]*u-t[2]*l+t[3]*a)*d,(t[14]*n-t[12]*s-t[15]*o)*d,(t[8]*s-t[10]*n+t[11]*o)*d,(t[4]*f-t[5]*l+t[7]*i)*d,(t[1]*l-t[0]*f-t[3]*i)*d,(t[12]*c-t[13]*n+t[15]*e)*d,(t[9]*n-t[8]*c-t[11]*e)*d,(t[5]*a-t[4]*h-t[6]*i)*d,(t[0]*h-t[1]*a+t[2]*i)*d,(t[13]*o-t[12]*r-t[14]*e)*d,(t[8]*r-t[9]*o+t[10]*e)*d]):ht()};const X=(t,e,o,n)=>{t[12]=e,t[13]=o,t[14]=n},j=(t,e)=>{const o=V(t),n=Math.sin(o),r=Math.cos(o);return[r,0,n,0,0,1,0,0,-n,0,r,0,0,0,0,1]};const yt=(t,e,o)=>{const n=k(ut(e,t)),r=k(q(o,n)),c=q(n,r),s=L(t,r),i=L(t,c),a=L(t,n);return[r[0],c[0],n[0],0,r[1],c[1],n[1],0,r[2],c[2],n[2],0,-s,-i,-a,1]},vt=(t,e,o,n)=>{const r=1/Math.tan(t),c=r/e,s=n/(n-o),i=-(s*o);return[c,0,0,0,0,r,0,0,0,0,s,1,0,0,i,0]},gt=(t,e,o,n)=>{const r=2/t,c=2/e,s=1/(n-o),i=o/(o-n);return[r,0,0,0,0,c,0,0,0,0,s,0,0,0,i,1]},pt=async(t,e)=>{t.adapter=await navigator.gpu.requestAdapter(),t.device=await t.adapter.requestDevice(),t.canvasFormat=navigator.gpu.getPreferredCanvasFormat(),t.canvas=st(),t.context=t.canvas.getContext("webgpu"),t.context.configure({device:t.device,format:t.canvasFormat,alphaMode:"opaque"});const o=t.device;if(t.buffer)for(let r=0;r<t.buffer.length;++r){const c=t.buffer[r],s=await Nt(e[c.embed]),i=o.createBuffer({size:s.length,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.INDEX,mappedAtCreation:!0}),a=new DataView(i.getMappedRange());for(let l=0;l<s.length;++l)a.setUint8(l,s[l]);i.unmap(),t.buffer[r]=i}if(t.shader)for(let r=0;r<t.shader.length;++r){const c=t.shader[r],s=await Xt(e[c.embed]),i=o.createShaderModule({code:s});t.shader[r]=i}t.bindGroupLayout=[],t.pipelineLayout=[],t.pipeline=[],t.sampler=[],t.bindGroup=[],t.cbuffer=[],t.gbuffer=[];const n=(r,c,s)=>{t.cbuffer[r]=o.createBuffer({size:c,usage:s|GPUBufferUsage.COPY_DST})};n(0,512,GPUBufferUsage.UNIFORM),n(1,229376,GPUBufferUsage.STORAGE),n(2,65536,GPUBufferUsage.VERTEX),n(3,40960,GPUBufferUsage.INDIRECT),n(4,73728,GPUBufferUsage.VERTEX),n(5,24576,GPUBufferUsage.VERTEX),t.sampler[0]=o.createSampler({magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"}),t.bindGroupLayout[0]=o.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}]}),t.bindGroupLayout[1]=o.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"depth"}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:5,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),t.pipelineLayout[0]=o.createPipelineLayout({bindGroupLayouts:[t.bindGroupLayout[0]]}),t.pipelineLayout[1]=o.createPipelineLayout({bindGroupLayouts:[t.bindGroupLayout[1]]}),t.bindGroup[0]=o.createBindGroup({layout:t.bindGroupLayout[0],entries:[{binding:0,resource:{buffer:t.cbuffer[0]}},{binding:1,resource:{buffer:t.cbuffer[1]}}]}),Gt(t)},wt=t=>{const e=t.device,o=t.canvas;if(o.width!==o.clientWidth||o.height!==o.clientHeight){o.width=o.clientWidth,o.height=o.clientHeight;const c=i=>{A(t.gbuffer[i])&&(t.gbuffer[i].destroy(),delete t.gbuffer[i])};c(0),c(1),c(2),c(3),c(4);const s=i=>{A(t.bindGroup[i])&&delete t.bindGroup[i]};s(1),s(2),s(3)}const n=(c,s)=>{A(t.gbuffer[c])||(t.gbuffer[c]=e.createTexture({size:[o.width,o.height],format:s,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}))};n(0,"depth32float"),n(1,"rgb10a2unorm"),n(2,"rgba8unorm"),n(3,"rgba8unorm"),n(4,"rgba16float");const r=(c,s,i,a,l)=>{A(t.bindGroup[c])||(t.bindGroup[c]=e.createBindGroup({layout:t.bindGroupLayout[1],entries:[{binding:0,resource:{buffer:t.cbuffer[0]}},{binding:1,resource:t.gbuffer[s].createView()},{binding:2,resource:t.gbuffer[i].createView()},{binding:3,resource:t.gbuffer[a].createView()},{binding:4,resource:t.gbuffer[l].createView()},{binding:5,resource:t.sampler[0]}]}))};r(1,0,1,2,3),r(2,0,1,1,1),r(3,0,4,4,4)},xt=t=>{const e=t.data.gpu,o=e.device,n=new Float32Array(84);{const r=B(t).camera,c=e.canvas.width/e.canvas.height,s=V(r.fov),i=r.x,a=r.y,l=r.z,h=r.ha,f=r.va,u=N(h,f),d=[i,a,l],m=lt(d,u),b=yt(d,m,[0,1,0]),g=vt(s,c,r.near,r.far),v=mt(b,g),w=bt(v),_=gt(e.canvas.width,e.canvas.height,0,1);n.set(v,0),n.set(w,16),n.set(b,32),n.set(_,48),n.set(d,64)}{const r=B(t).light,c=r.ha,s=r.va,i=r.color,a=r.ambient0,l=r.ambient1,h=N(c,s);n.set(h,68),n.set(i,72),n.set(a,76),n.set(l,80)}o.queue.writeBuffer(e.cbuffer[0],0,n)},_t=t=>{const e=t.data.gpu,o=e.device,n=[];n.length=e.segment.length;for(let f=0;f<n.length;++f)n[f]=[];const r=new Float32Array(28),c=4*28;let s=0;for(const f of B(t).room){const u=Q(t,f.data);if(u&&u.layout)for(const d of u.layout)for(let m=0;m<d.indices.length;++m){const y=at(m,d.divisor),b=it(m,d.divisor),g=f.x+y*d.unit,v=f.y,w=f.z+b*d.unit,_=f.ha,P=f.va,x=d.node[d.indices[m]];if(x)for(const S of x.mesh){const p=u.mesh[S];if(!p)continue;const G=e.mesh[p.data];if(!G)continue;for(const rt of G.segment)n[rt].push(s);const $=g+p.x,E=v+p.y,U=w+p.z,z=_+p.ha,tt=P+p.va,I=j(z,tt);X(I,$,E,U);const et=p.factor0,nt=p.factor1,ot=p.factor2;r.set(I,0),r.set(et,16),r.set(nt,20),r.set(ot,24),o.queue.writeBuffer(e.cbuffer[1],s*c,r),s+=1}}}for(const f of B(t).mob){const u=D(t,f.data);if(!u)continue;const d=f.x,m=f.y,y=f.z,b=f.ha,g=f.va;for(const v of u.mesh){const w=e.mesh[v.data];if(!w)continue;for(const z of w.segment)n[z].push(s);const _=d+v.x,P=m+v.y,x=y+v.z,S=b+v.ha,p=g+v.va,G=j(S,p);X(G,_,P,x);const $=v.factor0,E=v.factor1,U=v.factor2;r.set(G,0),r.set($,16),r.set(E,20),r.set(U,24),o.queue.writeBuffer(e.cbuffer[1],s*c,r),s+=1}}const i=[];let a=0,l=0;const h=new Uint32Array(5);for(let f=0;f<n.length;++f){if(n[f].length<=0)continue;const u=e.segment[f],d=n[f].length;o.queue.writeBuffer(e.cbuffer[2],a*4,new Uint32Array(n[f])),h[0]=u.count,h[1]=d,h[2]=0,h[3]=0,h[4]=0,o.queue.writeBuffer(e.cbuffer[3],l,h),i.push({id:f,first:a,offset:l}),a+=d,l+=20}return i},St=t=>{const e=t.data.gpu,o=e.device;let n=0;for(const r of B(t).tile){const c=jt(t,r.data);if(!c||!c.content)continue;const s=e.canvas.width,i=e.canvas.height,a=(s<i?s:i)/100,l=r.x*a,h=r.y*a,f=r.w*a,u=r.h*a;for(const d of c.content)if(d.bg){const m=d.bg[0]*255,y=d.bg[1]*255,b=d.bg[2]*255,g=d.bg[3]*255,v=l-f/2,w=l+f/2,_=h-u/2,P=h+u/2,x=new Float32Array(2*6),S=new Uint8Array(4*6);x.set([v,_,v,P,w,P,v,_,w,P,w,_]),S.set([m,y,b,g,m,y,b,g,m,y,b,g,m,y,b,g,m,y,b,g,m,y,b,g]),o.queue.writeBuffer(e.cbuffer[4],n*8,x),o.queue.writeBuffer(e.cbuffer[5],n*4,S),n+=6;continue}}return n},Gt=t=>{const e=t.device;t.pipeline[0]=e.createRenderPipeline({layout:t.pipelineLayout[0],vertex:{module:t.shader[0],entryPoint:"VS",buffers:[{arrayStride:4,attributes:[{format:"uint32",offset:0,shaderLocation:0}],stepMode:"instance"},{arrayStride:12,attributes:[{format:"float32x3",offset:0,shaderLocation:1}]},{arrayStride:12,attributes:[{format:"float32x3",offset:0,shaderLocation:2}]}]},fragment:{module:t.shader[0],entryPoint:"FS",targets:[{format:"rgb10a2unorm"},{format:"rgba8unorm"},{format:"rgba8unorm"},{format:"rgba16float"}]},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth32float"},primitive:{cullMode:"back",frontFace:"cw"}}),t.pipeline[1]=e.createRenderPipeline({layout:t.pipelineLayout[1],vertex:{module:t.shader[1],entryPoint:"VS",buffers:[]},fragment:{module:t.shader[1],entryPoint:"FS_SSAO",targets:[{format:"rgba8unorm",blend:{color:{operation:"min",srcFactor:"one",dstFactor:"one"},alpha:{}},writeMask:GPUColorWrite.RED}]}}),t.pipeline[2]=e.createRenderPipeline({layout:t.pipelineLayout[1],vertex:{module:t.shader[1],entryPoint:"VS",buffers:[]},fragment:{module:t.shader[1],entryPoint:"FS_HDR",targets:[{format:"rgba16float",blend:{color:{operation:"add",srcFactor:"one",dstFactor:"one"},alpha:{}}}]},depthStencil:{depthWriteEnabled:!1,depthCompare:"not-equal",format:"depth32float"}}),t.pipeline[3]=e.createRenderPipeline({layout:t.pipelineLayout[1],vertex:{module:t.shader[1],entryPoint:"VS",buffers:[]},fragment:{module:t.shader[1],entryPoint:"FS_HDRSky",targets:[{format:"rgba16float",blend:{color:{operation:"add",srcFactor:"one",dstFactor:"one"},alpha:{}}}]},depthStencil:{depthWriteEnabled:!1,depthCompare:"equal",format:"depth32float"}}),t.pipeline[4]=e.createRenderPipeline({layout:t.pipelineLayout[1],vertex:{module:t.shader[1],entryPoint:"VS",buffers:[]},fragment:{module:t.shader[1],entryPoint:"FS_HDR2LDR",targets:[{format:t.canvasFormat}]},depthStencil:{depthWriteEnabled:!1,depthCompare:"always",format:"depth32float"}}),t.pipeline[5]=e.createRenderPipeline({layout:t.pipelineLayout[0],vertex:{module:t.shader[2],entryPoint:"VS",buffers:[{arrayStride:8,attributes:[{format:"float32x2",offset:0,shaderLocation:0}]},{arrayStride:4,attributes:[{format:"unorm8x4",offset:0,shaderLocation:1}]}]},fragment:{module:t.shader[2],entryPoint:"FS",targets:[{format:t.canvasFormat,blend:{color:{operation:"add",srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"},alpha:{operation:"add",srcFactor:"one",dstFactor:"zero"}}}]},depthStencil:{depthWriteEnabled:!1,depthCompare:"always",format:"depth32float"},primitive:{cullMode:"back",frontFace:"cw"}})},Pt=t=>{const e=t.data.gpu;wt(e)},Mt=t=>{xt(t);const e=_t(t),o=St(t),n=t.data.gpu,r=n.device,c=r.createCommandEncoder();Bt(c,n,e),Rt(c,n),Ft(c,n),$t(c,n,o),r.queue.submit([c.finish()])},Bt=(t,e,o)=>{const n=t.beginRenderPass({depthStencilAttachment:{view:e.gbuffer[0].createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"},colorAttachments:[{view:e.gbuffer[1].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"},{view:e.gbuffer[2].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"},{view:e.gbuffer[3].createView(),clearValue:{r:1,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"},{view:e.gbuffer[4].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}]});for(const r of o){n.setPipeline(e.pipeline[0]),n.setBindGroup(0,e.bindGroup[0]),n.setVertexBuffer(0,e.cbuffer[2],r.first*4);const c=e.segment[r.id];if(c.vb0){const[s,i,a]=c.vb0;n.setVertexBuffer(1,e.buffer[s],i,a)}if(c.vb1){const[s,i,a]=c.vb1;n.setVertexBuffer(2,e.buffer[s],i,a)}if(c.ib){const[s,i,a]=c.ib;n.setIndexBuffer(e.buffer[s],"uint16",i,a)}n.drawIndexedIndirect(e.cbuffer[3],r.offset)}n.end()},Rt=(t,e)=>{const o=t.beginRenderPass({colorAttachments:[{view:e.gbuffer[3].createView(),loadOp:"load",storeOp:"store"}]});o.setPipeline(e.pipeline[1]),o.setBindGroup(0,e.bindGroup[2]),o.draw(4),o.end()},Ft=(t,e)=>{const o=t.beginRenderPass({depthStencilAttachment:{view:e.gbuffer[0].createView(),depthReadOnly:!0},colorAttachments:[{view:e.gbuffer[4].createView(),loadOp:"load",storeOp:"store"}]});o.setPipeline(e.pipeline[2]),o.setBindGroup(0,e.bindGroup[1]),o.draw(4),o.setPipeline(e.pipeline[3]),o.draw(4),o.end()},$t=(t,e,o)=>{const n=t.beginRenderPass({depthStencilAttachment:{view:e.gbuffer[0].createView(),depthReadOnly:!0},colorAttachments:[{view:e.context.getCurrentTexture().createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}]});n.setPipeline(e.pipeline[4]),n.setBindGroup(0,e.bindGroup[3]),n.draw(4),n.setPipeline(e.pipeline[5]),n.setBindGroup(0,e.bindGroup[0]),n.setVertexBuffer(0,e.cbuffer[4]),n.setVertexBuffer(1,e.cbuffer[5]),n.draw(o),n.end()},J=(t,e)=>{t[e]||(t[e]={})},F=(t,e,o)=>{J(t,e),o=o||0;const n=t[e];n&&!n.hold&&(n.value=Math.max(0,o))},T=(t,e,o,n)=>{J(t,e),o=o||0,n=n||!1;const r=t[e];r&&(r.value=Math.max(0,o),r.hold=n)},Et=(t,e)=>{const o=t[e];o&&(o.history=o.value)},Ut=(t,e)=>{const o=t[e];return o&&o.value||0};const zt=t=>{if(!t)return!1;for(const e of t.buttons)if(e.value>.5)return!0;for(const e of t.axes)if(Math.abs(e)>.5)return!0;return!1},Vt=t=>{const e=t.hid,o=t.data.hid,n=()=>{for(const s in o.keyboard)T(e.map,o.keyboard[s],0,!1);for(const s of o.mouse.button)T(e.map,s,0,!1)},r=(s,i,a)=>{const l=o.keyboard[s.code];l&&(T(e.map,l,i,a),s.preventDefault(),e.last=-1)},c=(s,i,a)=>{const l=o.mouse.button[s.button];l&&(T(e.map,l,i,a),s.preventDefault(),e.last=-1)};R(document.body,"contextmenu",s=>{s.preventDefault()}),R(window,"blur",s=>{n()}),R(document,"keydown",s=>{r(s,1,!0)}),R(document,"keyup",s=>{r(s,0,!1)}),R(document,"mousedown",s=>{c(s,1,!0)}),R(document,"mouseup",s=>{c(s,0,!1)}),R(document,"mousemove",s=>{if(!(s.buttons&2))return;const i=.25,a=o.mouse.movementX;a&&(F(e.map,a[0],-s.movementX*i),F(e.map,a[1],s.movementX*i));const l=o.mouse.movementY;l&&(F(e.map,l[0],-s.movementY*i),F(e.map,l[1],s.movementY*i)),s.preventDefault(),e.last=-1}),n()},At=t=>{const e=t.hid,o=t.data.hid;{const n=navigator.getGamepads();for(let c=0;c<n.length;++c)if(zt(n[c])){e.last=c;break}const r=n[e.last];if(r){const c=o.gamepad;for(let s=0;s<r.buttons.length;++s){const i=c.buttons[s];i&&F(e.map,i,r.buttons[s].value)}for(let s=0;s<r.axes.length;++s){const i=c.axes[s];if(!i)continue;const a=Math.trunc(r.axes[s]*4)/4;F(e.map,i[0],-a),F(e.map,i[1],a)}}}},Tt=t=>{const e=t.hid;for(const o in e.map)Et(e.map,o),F(e.map,o,0)},K={},Lt=t=>{const e=B(t);if(!e)return;const o=Z(t,e.data);if(!o)return;const n=K[e.data]||{},r=o.step||[],c=i=>{for(let a=0;a<r.length;++a)if(r[a].label&&r[a].label===i)return a;return-1};let s=!1;for(;!s;){const i=r[e.step];if(i){if(i.event){const a=n[i.event];a&&a(t)}i.solve&&Ct(t),i.goto?e.step=c(i.goto):e.step+=1,i.yield&&(s=!0)}else e.step=-1,s=!0}e.step<0&&t.stage.pop()},Ot=(t,e)=>{const o=Z(t,e);if(!o)return;const n={data:e,step:0,tile:[],room:[],mob:[],camera:{},light:{}};if(o.content)for(const r of o.content)r.tile&&n.tile.push(structuredClone(r.tile)),r.room&&n.room.push(structuredClone(r.room)),r.mob&&n.mob.push(structuredClone(r.mob)),r.camera&&(n.camera=structuredClone(r.camera)),r.light&&(n.light=structuredClone(r.light));t.stage.push(n)},Ct=t=>{const e=B(t).mob;for(let n=0;n<e.length;++n)for(let r=n+1;r<e.length;++r)Dt(t,e[n],e[r]);const o=B(t).room;for(let n=0;n<e.length;++n)for(let r=0;r<o.length;++r)It(t,e[n],o[r])},Dt=(t,e,o)=>{const[n,r,c,s,i,a]=C(t,e),[l,h,f,u,d,m]=C(t,o);if(r+i<=h||h+d<=r)return;const y=Y(l-n,f-c)-(s+u);if(y>=0)return;const b=a/(a+m),[g,v]=dt(l-n,f-c);e.x=n+y*g*b,e.z=c+y*v*b,o.x=l-y*g*(1-b),o.z=f-y*v*(1-b)},It=(t,e,o)=>{const[n,r,c,s,i,a]=C(t,e),l=Q(t,o.data);if(!l)return;const h=o.x,f=o.y,u=o.z;for(const d of l.layout){const m=($,E)=>{if($<0||E<0||d.divisor<=$)return 0;const U=$+E*d.divisor;if(d.indices.length<=U)return 0;const z=d.node[d.indices[U]];return z?f+(z.height||0):0},y=Math.round((n-h)/d.unit),b=Math.round((c-u)/d.unit),g=m(y,b);e.y=g;const v=m(y-1,b),w=m(y+1,b),_=m(y,b-1),P=m(y,b+1),x=h+y*d.unit,S=u+b*d.unit,p=d.unit,G=p/2-s;e.x=O(n,Math.abs(v-g)<=.5?x-p:x-G,Math.abs(w-g)<=.5?x+p:x+G),e.z=O(c,Math.abs(_-g)<=.5?S-p:S-G,Math.abs(P-g)<=.5?S+p:S+G)}},C=(t,e)=>{const o=D(t,e.data);if(!o)return[0,0,0,0,0,0];const n=e.x,r=e.y,c=e.z,s=o.radius||0,i=o.height||0,a=(o.mass||0)+.01;return[n,r,c,s,i,a]},kt=(t,e)=>{t.data.loading+=1,(async()=>{const r=await(await fetch("app.json")).json(),c=t.data;Object.assign(c,r),Vt(t),c.gpu&&await pt(c.gpu,c.embed),Ot(t,e),delete c.embed,c.loading-=1})()},qt=t=>t.data.loading<=0,Nt=async t=>{const e=window.atob(t),o=new Uint8Array(e.length);for(let c=0;c<e.length;++c)o[c]=e.charCodeAt(c);const n=new Blob([o]).stream().pipeThrough(new DecompressionStream("deflate-raw")),r=await new Response(n).arrayBuffer();return new Uint8Array(r)},Xt=async t=>{const e=window.atob(t),o=new Uint8Array(e.length);for(let c=0;c<e.length;++c)o[c]=e.charCodeAt(c);const n=new Blob([o]).stream().pipeThrough(new DecompressionStream("deflate-raw"));return await new Response(n).text()};const jt=(t,e)=>t.data.tile[e],Q=(t,e)=>t.data.room[e],D=(t,e)=>t.data.mob[e],Z=(t,e)=>t.data.stage[e],M=(t,e)=>Ut(t.hid.map,e);const B=t=>t.stage.at(-1),Ht=(t,e)=>{K[t]=e},Wt=async t=>{if(!navigator.gpu){W("ERROR: WebGPU not supported.");return}const e={dt:0,now:0,data:{loading:0},hid:{map:{},last:0},stage:[]};kt(e,t);const o=n=>{e.dt=(n-e.now)/1e3,e.now=n,qt(e)&&(At(e),Pt(e),Lt(e),Mt(e),Tt(e)),requestAnimationFrame(o)};requestAnimationFrame(o)};Ht("main",{setup:t=>{ct()},update:t=>{const e=t.dt,o=B(t),n=o.mob.find(c=>c.data==="p000");if(n){const c=D(t,n.data),s=[0,0];s[0]+=-M(t,"l0"),s[0]+=M(t,"l1"),s[1]+=M(t,"l2"),s[1]+=-M(t,"l3");const i=[0,0];i[0]+=-M(t,"r0"),i[0]+=M(t,"r1"),i[1]+=M(t,"r2"),i[1]+=-M(t,"r3");const a=M(t,"b1");if(i){const f=-i[0],u=i[1];n.ha+=90*e*f,n.va+=90*e*u,n.va=O(n.va,-60,80)}if(s){const h=a?4:2,f=V(n.ha+90),u=V(n.ha),d=-s[0],m=s[1],y=d*Math.cos(f)+m*Math.cos(u),b=d*Math.sin(f)+m*Math.sin(u),g=h*e*y,v=h*e*b;n.x+=g,n.z+=v}const l=o.camera;l.x=n.x,l.y=n.y+c.height,l.z=n.z,l.ha=n.ha,l.va=n.va}const r=o.light;r.ha+=45*e}});R(window,"load",()=>{W("Welcome Basilico."),Wt("main")});})();
