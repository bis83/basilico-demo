(()=>{const P=t=>{const e=window.atob(t),n=new ArrayBuffer(e.length),s=new DataView(n);for(let c=0;c<e.length;++c)s.setUint8(c,e.charCodeAt(c));return n};const T=t=>t/180*Math.PI,tt=(t,e)=>Math.sqrt(t*t+e*e),g=(t,e)=>{const n=tt(t,e);return n!=0?[t/n,e/n]:[0,0]};const et=([t,e],n,s,c,a)=>n<=t&&t<=s&&c<=e&&e<=a,v=(t,e)=>t[0]*e[0]+t[1]*e[1]+t[2]*e[2],nt=t=>{const e=v(t,t);return Math.sqrt(e)},st=(t,e)=>[t[0]+e[0],t[1]+e[1],t[2]+e[2]],ot=(t,e)=>[t[0]-e[0],t[1]-e[1],t[2]-e[2]];const F=t=>{const e=nt(t);return[t[0]/e,t[1]/e,t[2]/e]},O=(t,e)=>[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]],ct=(t,e)=>{const n=T(t),s=T(e);return[Math.cos(s)*Math.cos(n),Math.cos(s)*Math.sin(n),Math.sin(s)]},N=(t,e,n)=>[t*2,e*2,n*.5];const rt=(t,e)=>[t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15],t[4]*e[0]+t[5]*e[4]+t[6]*e[8]+t[7]*e[12],t[4]*e[1]+t[5]*e[5]+t[6]*e[9]+t[7]*e[13],t[4]*e[2]+t[5]*e[6]+t[6]*e[10]+t[7]*e[14],t[4]*e[3]+t[5]*e[7]+t[6]*e[11]+t[7]*e[15],t[8]*e[0]+t[9]*e[4]+t[10]*e[8]+t[11]*e[12],t[8]*e[1]+t[9]*e[5]+t[10]*e[9]+t[11]*e[13],t[8]*e[2]+t[9]*e[6]+t[10]*e[10]+t[11]*e[14],t[8]*e[3]+t[9]*e[7]+t[10]*e[11]+t[11]*e[15],t[12]*e[0]+t[13]*e[4]+t[14]*e[8]+t[15]*e[12],t[12]*e[1]+t[13]*e[5]+t[14]*e[9]+t[15]*e[13],t[12]*e[2]+t[13]*e[6]+t[14]*e[10]+t[15]*e[14],t[12]*e[3]+t[13]*e[7]+t[14]*e[11]+t[15]*e[15]],at=(t,e,n)=>[1,0,0,0,0,1,0,0,0,0,1,0,t,e,n,1],it=(t,e,n,s)=>{t[12]=e,t[13]=n,t[14]=s},lt=(t,e,n)=>[t,0,0,0,0,e,0,0,0,0,n,0,0,0,0,1],ut=(t,e,n)=>{const s=F(ot(e,t)),c=F(O(n,s)),a=O(s,c),l=v(t,c),u=v(t,a),d=v(t,s);return[c[0],a[0],s[0],0,c[1],a[1],s[1],0,c[2],a[2],s[2],0,-l,-u,-d,1]},dt=(t,e,n,s)=>{const c=1/Math.tan(t),a=c/e,l=s/(s-n),u=-(l*n);return[a,0,0,0,0,c,0,0,0,0,l,1,0,0,u,0]},ft=(t,e,n,s)=>{const c=2/t,a=2/e,l=1/(s-n),u=n/(n-s);return[c,0,0,0,0,a,0,0,0,0,l,0,0,0,u,1]},I=(t,e)=>t<<0|e<<16,S=t=>[t>>0&65535,t>>16&65535],p=0,k=1,A=2;var i=null;const h=(t,e,n)=>{t.addEventListener(e,n)},ht=()=>{const t=document.body;t.style.userSelect="none",t.style.webkitUserSelect="none",t.style.msUserSelect="none",t.style.mozUserSelect="none"},mt=()=>{const t=document.body;t.style.touchAction="none"},pt=()=>{ht(),mt(),i={},i.mode=p,i.timer={prevTime:performance.now(),deltaTime:0},i.gamepad={index:null,lx:0,ly:0,rx:0,ry:0,b0:!1,b1:!1,lt:!1,rt:!1},i.keyboard={w:!1,a:!1,s:!1,d:!1,up:!1,left:!1,down:!1,right:!1,z:!1,x:!1,space:!1,lctrl:!1},i.touch=new Map,i.click=[],h(window,"focus",t=>{}),h(window,"blur",t=>{}),h(window,"resize",t=>{}),h(window,"gamepadconnected",t=>{i.gamepad.index=t.gamepad.index,i.mode=k}),h(window,"gamepaddisconnected",t=>{i.gamepad.index===t.gamepad.index&&(i.gamepad.index=null)}),h(document,"keydown",t=>{b(i.keyboard,t.code,!0)&&(i.mode=A,t.preventDefault())}),h(document,"keyup",t=>{b(i.keyboard,t.code,!1)&&(i.mode=A,t.preventDefault())}),h(document.body,"contextmenu",t=>{t.preventDefault()}),h(document.body,"pointerdown",t=>{i.touch.set(t.pointerId,{x:t.clientX,y:t.clientY,sx:t.clientX,sy:t.clientY,time:performance.now()}),i.mode=p}),h(document.body,"pointerup",t=>{_t(t.pointerId),i.touch.delete(t.pointerId),i.mode=p}),h(document.body,"pointerout",t=>{i.touch.delete(t.pointerId),i.mode=p}),h(document.body,"pointermove",t=>{const e=i.touch.get(t.pointerId);e&&(e.x=t.clientX,e.y=t.clientY,i.mode=p)})},b=(t,e,n)=>{switch(e){case"KeyW":t.w=n;break;case"KeyA":t.a=n;break;case"KeyS":t.s=n;break;case"KeyD":t.d=n;break;case"ArrowUp":t.up=n;break;case"ArrowLeft":t.left=n;break;case"ArrowDown":t.down=n;break;case"ArrowRight":t.right=n;break;case"KeyZ":t.z=n;break;case"KeyX":t.x=n;break;case"Space":t.space=n;break;case"ControlLeft":t.lctrl=n;break;default:return!1}return!0},_t=t=>{const e=i.touch.get(t);e&&performance.now()-e.time<250&&i.click.push({x:e.x,y:e.y})},gt=t=>{const e=performance.now();t.deltaTime=(e-t.prevTime)/1e3,t.prevTime=e},xt=t=>{if(t.index!==null){const n=navigator.getGamepads()[t.index];t.lx=Math.trunc(n.axes[0]*4)/4,t.ly=Math.trunc(n.axes[1]*4)/4,t.rx=Math.trunc(n.axes[2]*4)/4,t.ry=Math.trunc(n.axes[3]*4)/4,t.b0=n.buttons[0].value>=.5,t.b1=n.buttons[1].value>=.5,t.lt=n.buttons[6].value>=.5,t.rt=n.buttons[7].value>=.5,!!(t.lx||t.ly||t.rx||t.ry||t.b0||t.b1||t.lt||t.rt)&&(i.mode=k)}},wt=()=>{gt(i.timer),xt(i.gamepad)},Tt=()=>{i.click.length=0},kt=t=>{const e=localStorage.getItem(t);return e==null?null:JSON.parse(e)},At=(t,e)=>{const n=JSON.stringify(e);localStorage.setItem(t,n)};var o=null;const yt=()=>{o=document.getElementById("main").getContext("webgl2")},B=0,X=1,C=2,Y=3,Et=t=>{let e=o.createTexture();return o.bindTexture(o.TEXTURE_2D,e),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,t),o.bindTexture(o.TEXTURE_2D,null),e},vt=(t,e,n)=>{const s=document.createElement("canvas");if(!s)return null;s.width=e,s.height=n;const c=s.getContext("2d");return c?(c.fillStyle="white",c.textAlign="center",c.textBaseline="middle",c.font="24px monospace",c.fillText(t,s.width/2,s.height/2),s):null},V=(t,e)=>{const n=o.createShader(t);return o.shaderSource(n,e),o.compileShader(n),o.getShaderParameter(n,o.COMPILE_STATUS)?n:(o.deleteShader(n),null)},St=(t,e)=>{const n=o.createProgram();return o.attachShader(n,t),o.attachShader(n,e),o.linkProgram(n),o.getProgramParameter(n,o.LINK_STATUS)?n:(o.deleteProgram(n),null)},H=(t,e)=>{let n=o.createBuffer();return o.bindBuffer(t,n),o.bufferData(t,e,o.STATIC_DRAW),n},M=(t,e,n,s,c,a)=>{o.enableVertexAttribArray(t),o.vertexAttribPointer(t,e,n,s,c,a)},Mt=()=>{const t=window.innerWidth;t!==o.canvas.width&&(o.canvas.width=t);const e=window.innerHeight;e!==o.canvas.height&&(o.canvas.height=e)},Rt=()=>{o.viewport(0,0,o.canvas.width,o.canvas.height),o.clearColor(0,0,0,1),o.clearDepth(1),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT)},z=(t,e)=>{o.enable(o.CULL_FACE),t?(o.enable(o.DEPTH_TEST),o.depthFunc(o.LEQUAL)):o.disable(o.DEPTH_TEST),e?(o.enable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA)):(o.disable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA))},$=(t,e)=>{e=e||0;const n=t.iv[e*3+0],s=t.iv[e*3+1],c=t.iv[e*3+2],a=[null,o.POINTS,o.LINES,o.TRIANGLES];t.i?o.drawElements(a[n],c,o.UNSIGNED_SHORT,2*s):o.drawArrays(a[n],s,c)};var Lt=null;const It=()=>{Lt=new AudioContext};const Ut=t=>{if(t.vao=o.createVertexArray(),o.bindVertexArray(t.vao),t.b&&(t.b=H(o.ARRAY_BUFFER,P(t.b)),t.bv))for(let e=0;e<t.bv.length;e+=2)switch(t.bv[e]){case B:M(B,3,o.FLOAT,!1,0,t.bv[e+1]);break;case X:M(X,3,o.HALF_FLOAT,!1,0,t.bv[e+1]);break;case C:M(C,4,o.UNSIGNED_BYTE,!0,0,t.bv[e+1]);break;case Y:M(Y,2,o.HALF_FLOAT,!1,0,t.bv[e+1]);break}return t.i&&(t.i=H(o.ELEMENT_ARRAY_BUFFER,P(t.i))),o.bindVertexArray(null),t},Dt=t=>{if(t.vs=V(o.VERTEX_SHADER,t.vs),t.fs=V(o.FRAGMENT_SHADER,t.fs),t.prog=St(t.vs,t.fs),t.u){const e={};for(let n of t.u)e[n]=o.getUniformLocation(t.prog,n);t.u=e}if(t.ub){const e={};let n=0;for(let s of t.ub){const c=o.getUniformBlockIndex(t.prog,s);o.uniformBlockBinding(t.prog,c,n),e[s]=n,n+=1}t.ub=e}return t},Gt=t=>(t.texture=Et(vt(t.text,t.width,t.height)),t),f={index:null,pack:[]},Pt=()=>f.index!=null&&f.pack.length>0,Ft=()=>{fetch("data/index.json").then(e=>e.json()).then(e=>{f.index=e})},Ot=t=>{const e="data/pack"+t+".json";fetch(e).then(n=>n.json()).then(n=>{n.mesh&&(n.mesh=n.mesh.map(s=>Ut(s))),n.texture&&(n.texture=n.texture.map(s=>Gt(s))),n.shader&&(n.shader=n.shader.map(s=>Dt(s))),f.pack[t]=n})},K=t=>f.pack[0]&&f.pack[0].mesh[t];const W=t=>f.pack[0]&&f.pack[0].shader[t],q=t=>f.pack[0]&&f.pack[0].stack.find(e=>e.id==t),J=t=>f.index&&(t?f.index.ui_pause:f.index.ui_main),Q=t=>f.index&&f.index.ui[t];var r={cam:{vp:new Float32Array(16),o:new Float32Array(16)},init:!1,pause:!1,slot:null,pos:{x:0,y:0,ha:0,va:0,h:0,eyeh:1.75},stack:{w:0,h:0,a:[]},ui:{}};const R=(t,e)=>(t=Math.floor(t),e=Math.floor(e),t<0||r.stack.w<=t||e<0||r.stack.h<=e?null:r.stack.a[t+e*r.stack.h]),U=(t,e)=>{const n=R(t,e);if(!n)return 0;let s=0;for(const c of n){const[a,l]=S(c),u=q(a);!u||(s+=l*u.height)}return s},x=t=>{const e=r.ui[t];return e?e.value:null},Nt=0,D=0,y=1,G=(t,e)=>{const n=window.innerWidth,s=window.innerHeight,c=n/2+t.offset[0]-t.width/2,a=n/2+t.offset[0]+t.width/2,l=s/2+t.offset[1]-t.height/2,u=s/2+t.offset[1]+t.height/2;return et(e,c,a,l,u)},bt=(t,e)=>{const n=i.mode;if(n===p){let s=!1;const c=i.click;for(let a of c)if(G(e,[a.x,a.y])){s=!0;break}s?(t.value=!0,t.state=y):(t.value=!1,t.state=D)}else n===k?i.gamepad[e.gamepad]?t.state!==y?(t.value=!0,t.state=y):t.value=!1:(t.value=!1,t.state=D):n===A&&(i.keyboard[e.keyboard]?t.state!==y?(t.value=!0,t.state=y):t.value=!1:(t.value=!1,t.state=D))},Bt=(t,e)=>{const n=i.mode;if(n===p){t.value=[0,0];for(const s of i.touch.values())if(G(e,[s.sx,s.sy])){const c=s.x-s.sx,a=-(s.y-s.sy);t.value=g(c,a);break}}else if(n===k){const s=i.gamepad;t.value=g(s.lx,-s.ly)}else if(n===A){const s=i.keyboard,c=s.a?-1:s.d?1:0,a=s.w?1:s.s?-1:0;t.value=g(c,a)}},Xt=(t,e)=>{const n=i.mode;if(n===p){t.value=[0,0];for(const s of i.touch.values())if(G(e,[s.sx,s.sy])){const c=s.x-s.sx,a=-(s.y-s.sy);t.value=g(c,a);break}}else if(n===k){const s=i.gamepad;t.value=g(s.rx,-s.ry)}else if(n===A){const s=i.keyboard,c=s.right?1:s.left?-1:0,a=s.up?1:s.down?-1:0;t.value=g(c,a)}},Ct=()=>{const t=J(r.pause);if(!!t)for(let e of t){const n=Q(e);if(!n)continue;r.ui[n.name]||(r.ui[n.name]={m:new Float32Array(16),value:null,state:Nt});const s=r.ui[n.name];switch(n.interact){case 1:bt(s,n);break;case 2:Bt(s,n);break;case 3:Xt(s,n);break;default:break}const c=lt(n.width/2,n.height/2,1);it(c,n.offset[0],-n.offset[1],0),s.m.set(c)}},Yt=()=>{r.stack.w=64,r.stack.h=64,r.stack.a.length=0,r.stack.a.length=r.stack.w*r.stack.h;for(let t=0;t<r.stack.a.length;++t){const e=1+Math.floor(Math.random()*10);r.stack.a[t]=[],r.stack.a[t].push(I(1,e))}r.pos.x=.5,r.pos.y=.5},Vt=()=>{if(!r.slot)return!1;const t=kt(r.slot);return t?(t.pos&&(r.pos=t.pos),t.stack&&(r.stack=t.stack),!0):!1},Z=()=>{if(!r.slot)return;const t={};t.pos=r.pos,t.stack=r.stack,At(r.slot,t)},L=(t,e,n,s)=>{const c=U(t,e),a=U(t+n,e+s);return Math.abs(c-a)>1},j=(t,e,n,s)=>{let c=t+n,a=e+s;const l=Math.floor(t),u=Math.floor(e),d=.25;return L(l,u,-1,0)&&(c=Math.max(c,l+d)),L(l,u,1,0)&&(c=Math.min(c,l-d+1)),L(l,u,0,-1)&&(a=Math.max(a,u+d)),L(l,u,0,1)&&(a=Math.min(a,u-d+1)),[c,a]},Ht=()=>{const t=i.timer.deltaTime,e=x("right-stick");if(e){const c=90;r.pos.ha+=c*t*e[0],r.pos.va+=c*t*e[1],r.pos.va=Math.max(-60,Math.min(r.pos.va,80))}const n=x("left-stick");if(n){const c=2,a=T(r.pos.ha+90),l=T(r.pos.ha),u=n[0],d=n[1],m=u*Math.cos(a)+d*Math.cos(l),_=u*Math.sin(a)+d*Math.sin(l),E=c*t*m,w=c*t*_;[r.pos.x,r.pos.y]=j(r.pos.x,r.pos.y,E,w)}else[r.pos.x,r.pos.y]=j(r.pos.x,r.pos.y,0,0);const s=U(r.pos.x,r.pos.y);if(Math.abs(s-r.pos.h)<=2){const c=s-r.pos.h;r.pos.h+=10*t*c}else r.pos.h=s},zt=()=>{const t=window.innerWidth,e=window.innerHeight,n=T(30),s=.1,c=1e3,a=ct(r.pos.ha,r.pos.va),l=N(r.pos.x,r.pos.y,r.pos.h);l[2]+=r.pos.eyeh;const u=st(l,a),m=ut(l,u,[0,0,1]),_=dt(n,t/e,s,c);r.cam.vp.set(rt(m,_)),r.cam.o.set(ft(t,e,0,1))},$t=()=>{if(x("button-act")){const t=R(r.pos.x,r.pos.y);if(t&&t.length>0){let[e,n]=S(t[t.length-1]);n+=1,t[t.length-1]=I(e,n)}Z()}if(x("button-sub")){const t=R(r.pos.x,r.pos.y);if(t&&t.length>0){let[e,n]=S(t[t.length-1]);n-=1,n>0?t[t.length-1]=I(e,n):t.pop()}Z()}},Kt=()=>{x("button-newgame")&&(r.slot="data0",Yt(),r.pause=!1),x("button-loadgame")&&(r.slot="data0",Vt(),r.pause=!1)},Wt=()=>{r.slot===null&&(r.pause=!0),Ct(),r.pause?Kt():(Ht(),$t()),zt()},qt=()=>{Mt(),Rt()},Jt=()=>{const t=new Float32Array(16);z(!0,!1);for(let e=0;e<r.stack.w;++e)for(let n=0;n<r.stack.h;++n){const s=R(e,n);if(!s)return;let c=0;for(const a of s){const[l,u]=S(a),d=q(l);if(!d)continue;const m=W(d.shader);if(!m)continue;o.useProgram(m.prog),o.uniformMatrix4fv(m.u.vp,!1,r.cam.vp);const _=K(d.mesh);if(!!_){o.bindVertexArray(_.vao);for(let E=0;E<u;++E){const w=N(e,n,c);t.set(at(w[0],w[1],w[2])),o.uniformMatrix4fv(m.u.w,!1,t),$(_),c+=d.height}}}}},Qt=()=>{const t=J(r.pause);if(!!t){z(!1,!0);for(let e of t){const n=Q(e);if(!n)continue;const s=r.ui[n.name];if(!s)continue;const c=W(n.shader);if(!c)return;o.useProgram(c.prog),o.uniformMatrix4fv(c.u.vp,!1,r.cam.o);const a=K(n.mesh);if(!a)return;o.bindVertexArray(a.vao),o.uniformMatrix4fv(c.u.w,!1,s.m),$(a)}}},Zt=()=>{qt(),Jt(),Qt()};h(window,"load",()=>{yt(),It(),pt(),Ft(),Ot(0);const t=()=>{wt(),Pt()&&(Wt(),Zt()),Tt(),requestAnimationFrame(t)};t()});})();
