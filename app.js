(()=>{const P=t=>{const e=window.atob(t),n=new ArrayBuffer(e.length),s=new DataView(n);for(let c=0;c<e.length;++c)s.setUint8(c,e.charCodeAt(c));return n};const T=t=>t/180*Math.PI,j=(t,e)=>Math.sqrt(t*t+e*e),g=(t,e)=>{const n=j(t,e);return n!=0?[t/n,e/n]:[0,0]};const tt=([t,e],n,s,c,a)=>n<=t&&t<=s&&c<=e&&e<=a,y=(t,e)=>t[0]*e[0]+t[1]*e[1]+t[2]*e[2],et=t=>{const e=y(t,t);return Math.sqrt(e)},nt=(t,e)=>[t[0]+e[0],t[1]+e[1],t[2]+e[2]],st=(t,e)=>[t[0]-e[0],t[1]-e[1],t[2]-e[2]];const F=t=>{const e=et(t);return[t[0]/e,t[1]/e,t[2]/e]},O=(t,e)=>[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]],ot=(t,e)=>{const n=T(t),s=T(e);return[Math.cos(s)*Math.cos(n),Math.cos(s)*Math.sin(n),Math.sin(s)]},N=(t,e,n)=>[t*2,e*2,n*.5];const ct=(t,e)=>[t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15],t[4]*e[0]+t[5]*e[4]+t[6]*e[8]+t[7]*e[12],t[4]*e[1]+t[5]*e[5]+t[6]*e[9]+t[7]*e[13],t[4]*e[2]+t[5]*e[6]+t[6]*e[10]+t[7]*e[14],t[4]*e[3]+t[5]*e[7]+t[6]*e[11]+t[7]*e[15],t[8]*e[0]+t[9]*e[4]+t[10]*e[8]+t[11]*e[12],t[8]*e[1]+t[9]*e[5]+t[10]*e[9]+t[11]*e[13],t[8]*e[2]+t[9]*e[6]+t[10]*e[10]+t[11]*e[14],t[8]*e[3]+t[9]*e[7]+t[10]*e[11]+t[11]*e[15],t[12]*e[0]+t[13]*e[4]+t[14]*e[8]+t[15]*e[12],t[12]*e[1]+t[13]*e[5]+t[14]*e[9]+t[15]*e[13],t[12]*e[2]+t[13]*e[6]+t[14]*e[10]+t[15]*e[14],t[12]*e[3]+t[13]*e[7]+t[14]*e[11]+t[15]*e[15]],rt=(t,e,n)=>[1,0,0,0,0,1,0,0,0,0,1,0,t,e,n,1],at=(t,e,n,s)=>{t[12]=e,t[13]=n,t[14]=s},it=(t,e,n)=>[t,0,0,0,0,e,0,0,0,0,n,0,0,0,0,1],lt=(t,e,n)=>{const s=F(st(e,t)),c=F(O(n,s)),a=O(s,c),l=y(t,c),u=y(t,a),d=y(t,s);return[c[0],a[0],s[0],0,c[1],a[1],s[1],0,c[2],a[2],s[2],0,-l,-u,-d,1]},ut=(t,e,n,s)=>{const c=1/Math.tan(t),a=c/e,l=s/(s-n),u=-(l*n);return[a,0,0,0,0,c,0,0,0,0,l,1,0,0,u,0]},dt=(t,e,n,s)=>{const c=2/t,a=2/e,l=1/(s-n),u=n/(n-s);return[c,0,0,0,0,a,0,0,0,0,l,0,0,0,u,1]},I=(t,e)=>t<<0|e<<16,v=t=>[t>>0&65535,t>>16&65535],_=0,w=1,k=2;var i=null;const f=(t,e,n)=>{t.addEventListener(e,n)},ft=()=>{const t=document.body;t.style.userSelect="none",t.style.webkitUserSelect="none",t.style.msUserSelect="none",t.style.mozUserSelect="none"},ht=()=>{const t=document.body;t.style.touchAction="none"},mt=()=>{ft(),ht(),i={},i.mode=_,i.timer={prevTime:performance.now(),deltaTime:0},i.gamepad={index:null,lx:0,ly:0,rx:0,ry:0,b0:!1,b1:!1,lt:!1,rt:!1},i.keyboard={w:!1,a:!1,s:!1,d:!1,up:!1,left:!1,down:!1,right:!1,z:!1,x:!1,space:!1,lctrl:!1},i.touch=new Map,i.click=[],f(window,"focus",t=>{}),f(window,"blur",t=>{}),f(window,"resize",t=>{}),f(window,"gamepadconnected",t=>{i.gamepad.index=t.gamepad.index,i.mode=w}),f(window,"gamepaddisconnected",t=>{i.gamepad.index===t.gamepad.index&&(i.gamepad.index=null)}),f(document,"keydown",t=>{B(i.keyboard,t.code,!0)&&(i.mode=k,t.preventDefault())}),f(document,"keyup",t=>{B(i.keyboard,t.code,!1)&&(i.mode=k,t.preventDefault())}),f(document.body,"contextmenu",t=>{t.preventDefault()}),f(document.body,"pointerdown",t=>{i.touch.set(t.pointerId,{x:t.clientX,y:t.clientY,sx:t.clientX,sy:t.clientY,time:performance.now()}),i.mode=_}),f(document.body,"pointerup",t=>{_t(t.pointerId),i.touch.delete(t.pointerId),i.mode=_}),f(document.body,"pointerout",t=>{i.touch.delete(t.pointerId),i.mode=_}),f(document.body,"pointermove",t=>{const e=i.touch.get(t.pointerId);e&&(e.x=t.clientX,e.y=t.clientY,i.mode=_)})},B=(t,e,n)=>{switch(e){case"KeyW":t.w=n;break;case"KeyA":t.a=n;break;case"KeyS":t.s=n;break;case"KeyD":t.d=n;break;case"ArrowUp":t.up=n;break;case"ArrowLeft":t.left=n;break;case"ArrowDown":t.down=n;break;case"ArrowRight":t.right=n;break;case"KeyZ":t.z=n;break;case"KeyX":t.x=n;break;case"Space":t.space=n;break;case"ControlLeft":t.lctrl=n;break;default:return!1}return!0},_t=t=>{const e=i.touch.get(t);e&&performance.now()-e.time<250&&i.click.push({x:e.x,y:e.y})},pt=t=>{const e=performance.now();t.deltaTime=(e-t.prevTime)/1e3,t.prevTime=e},gt=t=>{if(t.index!==null){const n=navigator.getGamepads()[t.index];t.lx=Math.trunc(n.axes[0]*4)/4,t.ly=Math.trunc(n.axes[1]*4)/4,t.rx=Math.trunc(n.axes[2]*4)/4,t.ry=Math.trunc(n.axes[3]*4)/4,t.b0=n.buttons[0].value>=.5,t.b1=n.buttons[1].value>=.5,t.lt=n.buttons[6].value>=.5,t.rt=n.buttons[7].value>=.5,!!(t.lx||t.ly||t.rx||t.ry||t.b0||t.b1||t.lt||t.rt)&&(i.mode=w)}},xt=()=>{pt(i.timer),gt(i.gamepad)},Tt=()=>{i.click.length=0},wt=t=>{const e=localStorage.getItem(t);return e==null?null:JSON.parse(e)},kt=(t,e)=>{const n=JSON.stringify(e);localStorage.setItem(t,n)};var o=null;const At=()=>{o=document.getElementById("main").getContext("webgl2")},b=0,X=1,C=2,Y=3,Et=t=>{let e=o.createTexture();return o.bindTexture(o.TEXTURE_2D,e),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,t),o.bindTexture(o.TEXTURE_2D,null),e},yt=(t,e,n)=>{const s=document.createElement("canvas");if(!s)return null;s.width=e,s.height=n;const c=s.getContext("2d");return c?(c.fillStyle="white",c.textAlign="center",c.textBaseline="middle",c.font="24px monospace",c.fillText(t,s.width/2,s.height/2),s):null},V=(t,e)=>{const n=o.createShader(t);return o.shaderSource(n,e),o.compileShader(n),o.getShaderParameter(n,o.COMPILE_STATUS)?n:(o.deleteShader(n),null)},vt=(t,e)=>{const n=o.createProgram();return o.attachShader(n,t),o.attachShader(n,e),o.linkProgram(n),o.getProgramParameter(n,o.LINK_STATUS)?n:(o.deleteProgram(n),null)},H=(t,e)=>{let n=o.createBuffer();return o.bindBuffer(t,n),o.bufferData(t,e,o.STATIC_DRAW),n},S=(t,e,n,s,c,a)=>{o.enableVertexAttribArray(t),o.vertexAttribPointer(t,e,n,s,c,a)},St=()=>{const t=window.innerWidth;t!==o.canvas.width&&(o.canvas.width=t);const e=window.innerHeight;e!==o.canvas.height&&(o.canvas.height=e)},Mt=()=>{o.viewport(0,0,o.canvas.width,o.canvas.height),o.clearColor(0,0,0,1),o.clearDepth(1),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT)},z=(t,e)=>{o.enable(o.CULL_FACE),t?(o.enable(o.DEPTH_TEST),o.depthFunc(o.LEQUAL)):o.disable(o.DEPTH_TEST),e?(o.enable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA)):(o.disable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA))},$=(t,e)=>{e=e||0;const n=t.iv[e*3+0],s=t.iv[e*3+1],c=t.iv[e*3+2],a=[null,o.POINTS,o.LINES,o.TRIANGLES];t.i?o.drawElements(a[n],c,o.UNSIGNED_SHORT,2*s):o.drawArrays(a[n],s,c)};var Rt=null;const Lt=()=>{Rt=new AudioContext};const It=t=>{if(t.vao=o.createVertexArray(),o.bindVertexArray(t.vao),t.b&&(t.b=H(o.ARRAY_BUFFER,P(t.b)),t.bv))for(let e=0;e<t.bv.length;e+=2)switch(t.bv[e]){case b:S(b,3,o.FLOAT,!1,0,t.bv[e+1]);break;case X:S(X,3,o.HALF_FLOAT,!1,0,t.bv[e+1]);break;case C:S(C,4,o.UNSIGNED_BYTE,!0,0,t.bv[e+1]);break;case Y:S(Y,2,o.HALF_FLOAT,!1,0,t.bv[e+1]);break}return t.i&&(t.i=H(o.ELEMENT_ARRAY_BUFFER,P(t.i))),o.bindVertexArray(null),t},Ut=t=>{if(t.vs=V(o.VERTEX_SHADER,t.vs),t.fs=V(o.FRAGMENT_SHADER,t.fs),t.prog=vt(t.vs,t.fs),t.u){const e={};for(let n of t.u)e[n]=o.getUniformLocation(t.prog,n);t.u=e}if(t.ub){const e={};let n=0;for(let s of t.ub){const c=o.getUniformBlockIndex(t.prog,s);o.uniformBlockBinding(t.prog,c,n),e[s]=n,n+=1}t.ub=e}return t},Dt=t=>(t.texture=Et(yt(t.text,t.width,t.height)),t),h={index:null,pack:[]},Gt=()=>h.index!=null&&h.pack.length>0,Pt=()=>{fetch("data/index.json").then(e=>e.json()).then(e=>{h.index=e})},Ft=t=>{const e="data/pack"+t+".json";fetch(e).then(n=>n.json()).then(n=>{n.mesh&&(n.mesh=n.mesh.map(s=>It(s))),n.texture&&(n.texture=n.texture.map(s=>Dt(s))),n.shader&&(n.shader=n.shader.map(s=>Ut(s))),h.pack[t]=n})},K=()=>h.index&&h.index.ui,W=t=>h.pack[0]&&h.pack[0].mesh[t];const q=t=>h.pack[0]&&h.pack[0].shader[t],J=t=>h.pack[0]&&h.pack[0].stack.find(e=>e.id==t);var r={cam:{vp:new Float32Array(16),o:new Float32Array(16)},init:!1,pos:{x:0,y:0,ha:0,va:0,h:0,eyeh:1.75},stack:{w:0,h:0,a:[]},ui:{}};const M=(t,e)=>(t=Math.floor(t),e=Math.floor(e),t<0||r.stack.w<=t||e<0||r.stack.h<=e?null:r.stack.a[t+e*r.stack.h]),U=(t,e)=>{const n=M(t,e);if(!n)return 0;let s=0;for(const c of n){const[a,l]=v(c),u=J(a);!u||(s+=l*u.height)}return s},R=t=>{const e=r.ui[t];return e?e.value:null},Ot=0,D=0,A=1,G=(t,e)=>{const n=window.innerWidth,s=window.innerHeight,c=n/2+t.offset[0]-t.width/2,a=n/2+t.offset[0]+t.width/2,l=s/2+t.offset[1]-t.height/2,u=s/2+t.offset[1]+t.height/2;return tt(e,c,a,l,u)},Nt=(t,e)=>{const n=i.mode;if(n===_){let s=!1;const c=i.click;for(let a of c)if(G(e,[a.x,a.y])){s=!0;break}s?(t.value=!0,t.state=A):(t.value=!1,t.state=D)}else n===w?i.gamepad[e.gamepad]?t.state!==A?(t.value=!0,t.state=A):t.value=!1:(t.value=!1,t.state=D):n===k&&(i.keyboard[e.keyboard]?t.state!==A?(t.value=!0,t.state=A):t.value=!1:(t.value=!1,t.state=D))},Bt=(t,e)=>{const n=i.mode;if(n===_){t.value=[0,0];for(const s of i.touch.values())if(G(e,[s.sx,s.sy])){const c=s.x-s.sx,a=-(s.y-s.sy);t.value=g(c,a);break}}else if(n===w){const s=i.gamepad;t.value=g(s.lx,-s.ly)}else if(n===k){const s=i.keyboard,c=s.a?-1:s.d?1:0,a=s.w?1:s.s?-1:0;t.value=g(c,a)}},bt=(t,e)=>{const n=i.mode;if(n===_){t.value=[0,0];for(const s of i.touch.values())if(G(e,[s.sx,s.sy])){const c=s.x-s.sx,a=-(s.y-s.sy);t.value=g(c,a);break}}else if(n===w){const s=i.gamepad;t.value=g(s.rx,-s.ry)}else if(n===k){const s=i.keyboard,c=s.right?1:s.left?-1:0,a=s.up?1:s.down?-1:0;t.value=g(c,a)}},Xt=()=>{const t=K();if(!!t)for(let e of t){r.ui[e.name]||(r.ui[e.name]={m:new Float32Array(16),value:null,state:Ot});const n=r.ui[e.name];switch(e.interact){case 1:Nt(n,e);break;case 2:Bt(n,e);break;case 3:bt(n,e);break;default:break}const s=it(e.width/2,e.height/2,1);at(s,e.offset[0],-e.offset[1],0),n.m.set(s)}},Ct=()=>{r.init||(Vt()||Yt(),r.init=!0)},Yt=()=>{r.stack.w=64,r.stack.h=64,r.stack.a.length=0,r.stack.a.length=r.stack.w*r.stack.h;for(let t=0;t<r.stack.a.length;++t){const e=1+Math.floor(Math.random()*10);r.stack.a[t]=[],r.stack.a[t].push(I(1,e))}r.pos.x=.5,r.pos.y=.5},Vt=()=>{const t=wt("data0");return t?(t.pos&&(r.pos=t.pos),t.stack&&(r.stack=t.stack),!0):!1},Q=()=>{const t={};t.pos=r.pos,t.stack=r.stack,kt("data0",t)},L=(t,e,n,s)=>{const c=U(t,e),a=U(t+n,e+s);return Math.abs(c-a)>1},Z=(t,e,n,s)=>{let c=t+n,a=e+s;const l=Math.floor(t),u=Math.floor(e),d=.25;return L(l,u,-1,0)&&(c=Math.max(c,l+d)),L(l,u,1,0)&&(c=Math.min(c,l-d+1)),L(l,u,0,-1)&&(a=Math.max(a,u+d)),L(l,u,0,1)&&(a=Math.min(a,u-d+1)),[c,a]},Ht=()=>{const t=i.timer.deltaTime,e=R("right-stick");if(e){const c=90;r.pos.ha+=c*t*e[0],r.pos.va+=c*t*e[1],r.pos.va=Math.max(-60,Math.min(r.pos.va,80))}const n=R("left-stick");if(n){const c=2,a=T(r.pos.ha+90),l=T(r.pos.ha),u=n[0],d=n[1],m=u*Math.cos(a)+d*Math.cos(l),p=u*Math.sin(a)+d*Math.sin(l),E=c*t*m,x=c*t*p;[r.pos.x,r.pos.y]=Z(r.pos.x,r.pos.y,E,x)}else[r.pos.x,r.pos.y]=Z(r.pos.x,r.pos.y,0,0);const s=U(r.pos.x,r.pos.y);if(Math.abs(s-r.pos.h)<=2){const c=s-r.pos.h;r.pos.h+=10*t*c}else r.pos.h=s},zt=()=>{const t=window.innerWidth,e=window.innerHeight,n=T(30),s=.1,c=1e3,a=ot(r.pos.ha,r.pos.va),l=N(r.pos.x,r.pos.y,r.pos.h);l[2]+=r.pos.eyeh;const u=nt(l,a),m=lt(l,u,[0,0,1]),p=ut(n,t/e,s,c);r.cam.vp.set(ct(m,p)),r.cam.o.set(dt(t,e,0,1))},$t=()=>{if(R("button-act")){const t=M(r.pos.x,r.pos.y);if(t&&t.length>0){let[e,n]=v(t[t.length-1]);n+=1,t[t.length-1]=I(e,n)}Q()}if(R("button-sub")){const t=M(r.pos.x,r.pos.y);if(t&&t.length>0){let[e,n]=v(t[t.length-1]);n-=1,n>0?t[t.length-1]=I(e,n):t.pop()}Q()}},Kt=()=>{Xt(),Ht(),zt(),$t()},Wt=()=>{St(),Mt()},qt=()=>{const t=new Float32Array(16);z(!0,!1);for(let e=0;e<r.stack.w;++e)for(let n=0;n<r.stack.h;++n){const s=M(e,n);if(!s)return;let c=0;for(const a of s){const[l,u]=v(a),d=J(l);if(!d)continue;const m=q(d.shader);if(!m)continue;o.useProgram(m.prog),o.uniformMatrix4fv(m.u.vp,!1,r.cam.vp);const p=W(d.mesh);if(!!p){o.bindVertexArray(p.vao);for(let E=0;E<u;++E){const x=N(e,n,c);t.set(rt(x[0],x[1],x[2])),o.uniformMatrix4fv(m.u.w,!1,t),$(p),c+=d.height}}}}},Jt=()=>{const t=K();if(!!t){z(!1,!0);for(let e of t){const n=r.ui[e.name];if(!n)continue;const s=q(e.shader);if(!s)return;o.useProgram(s.prog),o.uniformMatrix4fv(s.u.vp,!1,r.cam.o);const c=W(e.mesh);if(!c)return;o.bindVertexArray(c.vao),o.uniformMatrix4fv(s.u.w,!1,n.m),$(c)}}},Qt=()=>{Wt(),qt(),Jt()};f(window,"load",()=>{At(),Lt(),mt(),Pt(),Ft(0);const t=()=>{xt(),Gt()&&(Ct(),Kt(),Qt()),Tt(),requestAnimationFrame(t)};t()});})();
