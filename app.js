(()=>{const J=t=>{const e=window.atob(t),n=new ArrayBuffer(e.length),o=new DataView(n);for(let r=0;r<e.length;++r)o.setUint8(r,e.charCodeAt(r));return n};const Mt=(t,e)=>(t%e+e)%e,b=t=>t/180*Math.PI,Y=(t,e)=>Math.sqrt(t*t+e*e),S=(t,e)=>{const n=Y(t,e);return n!=0?[t/n,e/n]:[0,0]},St=([t,e])=>[-t,-e],bt=([t,e],n)=>[t*n,e*n],Rt=([t,e],n,o,r,c)=>n<=t&&t<=o&&r<=e&&e<=c,D=([t,e],n,[o,r])=>{const[c,i]=[o-t,r-e],l=Y(c,i);if(n<=l)return[t,e];const[a,f]=S(c,i),[x,w]=bt([a,f],l-n);return[t+x,e+w]},P=(t,e)=>t[0]*e[0]+t[1]*e[1]+t[2]*e[2],Ut=t=>{const e=P(t,t);return Math.sqrt(e)},kt=(t,e)=>[t[0]+e[0],t[1]+e[1],t[2]+e[2]],It=(t,e)=>[t[0]-e[0],t[1]-e[1],t[2]-e[2]];const Q=t=>{const e=Ut(t);return[t[0]/e,t[1]/e,t[2]/e]},Z=(t,e)=>[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]],Lt=(t,e)=>{const n=b(t),o=b(e);return[Math.cos(o)*Math.cos(n),Math.cos(o)*Math.sin(n),Math.sin(o)]},Dt=()=>[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Ft=(t,e)=>[t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15],t[4]*e[0]+t[5]*e[4]+t[6]*e[8]+t[7]*e[12],t[4]*e[1]+t[5]*e[5]+t[6]*e[9]+t[7]*e[13],t[4]*e[2]+t[5]*e[6]+t[6]*e[10]+t[7]*e[14],t[4]*e[3]+t[5]*e[7]+t[6]*e[11]+t[7]*e[15],t[8]*e[0]+t[9]*e[4]+t[10]*e[8]+t[11]*e[12],t[8]*e[1]+t[9]*e[5]+t[10]*e[9]+t[11]*e[13],t[8]*e[2]+t[9]*e[6]+t[10]*e[10]+t[11]*e[14],t[8]*e[3]+t[9]*e[7]+t[10]*e[11]+t[11]*e[15],t[12]*e[0]+t[13]*e[4]+t[14]*e[8]+t[15]*e[12],t[12]*e[1]+t[13]*e[5]+t[14]*e[9]+t[15]*e[13],t[12]*e[2]+t[13]*e[6]+t[14]*e[10]+t[15]*e[14],t[12]*e[3]+t[13]*e[7]+t[14]*e[11]+t[15]*e[15]],Pt=t=>{const e=t[0]*t[5]-t[1]*t[4],n=t[0]*t[6]-t[2]*t[4],o=t[0]*t[7]-t[3]*t[4],r=t[1]*t[6]-t[2]*t[5],c=t[1]*t[7]-t[3]*t[5],i=t[2]*t[7]-t[3]*t[6],l=t[8]*t[13]-t[9]*t[12],a=t[8]*t[14]-t[10]*t[12],f=t[8]*t[15]-t[11]*t[12],x=t[9]*t[14]-t[10]*t[13],w=t[9]*t[15]-t[11]*t[13],T=t[10]*t[15]-t[11]*t[14];let d=e*T-n*w+o*x+r*f-c*a+i*l;return d?(d=1/d,[(t[5]*T-t[6]*w+t[7]*x)*d,(t[2]*w-t[1]*T-t[3]*x)*d,(t[13]*i-t[14]*c+t[15]*r)*d,(t[10]*c-t[9]*i-t[11]*r)*d,(t[6]*f-t[4]*T-t[7]*a)*d,(t[0]*T-t[2]*f+t[3]*a)*d,(t[14]*o-t[12]*i-t[15]*n)*d,(t[8]*i-t[10]*o+t[11]*n)*d,(t[4]*w-t[5]*f+t[7]*l)*d,(t[1]*f-t[0]*w-t[3]*l)*d,(t[12]*c-t[13]*o+t[15]*e)*d,(t[9]*o-t[8]*c-t[11]*e)*d,(t[5]*a-t[4]*x-t[6]*l)*d,(t[0]*x-t[1]*a+t[2]*l)*d,(t[13]*n-t[12]*r-t[14]*e)*d,(t[8]*r-t[9]*n+t[10]*e)*d]):Dt()},V=(t,e,n)=>[1,0,0,0,0,1,0,0,0,0,1,0,t,e,n,1],z=(t,e,n,o)=>{t[12]=e,t[13]=n,t[14]=o},lt=(t,e)=>{const n=b(t),o=Math.sin(n),r=Math.cos(n);return[r,o,0,0,-o,r,0,0,0,0,1,0,0,0,0,1]},Nt=(t,e,n)=>[t,0,0,0,0,e,0,0,0,0,n,0,0,0,0,1],Bt=(t,e,n)=>{const o=Q(It(e,t)),r=Q(Z(n,o)),c=Z(o,r),i=P(t,r),l=P(t,c),a=P(t,o);return[r[0],c[0],o[0],0,r[1],c[1],o[1],0,r[2],c[2],o[2],0,-i,-l,-a,1]},Ot=(t,e,n,o)=>{const r=1/Math.tan(t),c=r/e,i=o/(o-n),l=-(i*n);return[c,0,0,0,0,r,0,0,0,0,i,1,0,0,l,0]},Xt=(t,e,n,o)=>{const r=2/t,c=2/e,i=1/(o-n),l=n/(n-o);return[r,0,0,0,0,c,0,0,0,0,i,0,0,0,l,1]},at=(t,e,n)=>[t*2,e*2,n*.5],X=(t,e,n)=>[Math.floor(t)*2+1,Math.floor(e)*2+1,n*.5];const U={t:performance.now(),dt:0,n:0},Ct=t=>{U.dt=(t-U.t)/1e3,U.t=t,U.n+=1};var _=null;const y=(t,e,n)=>{t.addEventListener(e,n)},Ht=()=>{const t=document.body;t.style.userSelect="none",t.style.webkitUserSelect="none",t.style.msUserSelect="none",t.style.mozUserSelect="none"},Gt=()=>{const t=document.body;t.style.touchAction="none"},Yt=()=>{Ht(),Gt(),_={},_.gamepad={index:null,lx:0,ly:0,rx:0,ry:0,b0:!1,b1:!1,b8:!1,b9:!1,lb:!1,rb:!1,lt:!1,rt:!1},_.keyboard={w:!1,a:!1,s:!1,d:!1,up:!1,left:!1,down:!1,right:!1,q:!1,e:!1,z:!1,x:!1,space:!1,lctrl:!1,esc:!1},_.touch=new Map,y(window,"focus",t=>{}),y(window,"blur",t=>{}),y(window,"resize",t=>{}),y(window,"gamepadconnected",t=>{_.gamepad.index=t.gamepad.index}),y(window,"gamepaddisconnected",t=>{_.gamepad.index===t.gamepad.index&&(_.gamepad.index=null)}),y(document,"keydown",t=>{j(_.keyboard,t.code,!0)&&t.preventDefault()}),y(document,"keyup",t=>{j(_.keyboard,t.code,!1)&&t.preventDefault()}),y(document.body,"contextmenu",t=>{t.preventDefault()}),y(document.body,"pointerdown",t=>{_.touch.set(t.pointerId,{x:t.clientX,y:t.clientY,sx:t.clientX,sy:t.clientY,time:performance.now()})}),y(document.body,"pointerup",t=>{_.touch.delete(t.pointerId)}),y(document.body,"pointerout",t=>{_.touch.delete(t.pointerId)}),y(document.body,"pointermove",t=>{const e=_.touch.get(t.pointerId);e&&(e.x=t.clientX,e.y=t.clientY)})},j=(t,e,n)=>{switch(e){case"KeyW":t.w=n;break;case"KeyA":t.a=n;break;case"KeyS":t.s=n;break;case"KeyD":t.d=n;break;case"ArrowUp":t.up=n;break;case"ArrowLeft":t.left=n;break;case"ArrowDown":t.down=n;break;case"ArrowRight":t.right=n;break;case"KeyQ":t.q=n;break;case"KeyE":t.e=n;break;case"KeyZ":t.z=n;break;case"KeyX":t.x=n;break;case"Space":t.space=n;break;case"ControlLeft":t.lctrl=n;break;case"Escape":t.esc=n;break;default:return!1}return!0},Vt=t=>{if(t.index!==null){const n=navigator.getGamepads()[t.index];t.lx=Math.trunc(n.axes[0]*4)/4,t.ly=Math.trunc(n.axes[1]*4)/4,t.rx=Math.trunc(n.axes[2]*4)/4,t.ry=Math.trunc(n.axes[3]*4)/4,t.b0=n.buttons[0].value>=.5,t.b1=n.buttons[1].value>=.5,t.b8=n.buttons[8].value>=.5,t.b9=n.buttons[9].value>=.5,t.lb=n.buttons[4].value>=.5,t.rb=n.buttons[5].value>=.5,t.lt=n.buttons[6].value>=.5,t.rt=n.buttons[7].value>=.5}},zt=()=>{Vt(_.gamepad)},$t=(t,e,n)=>{for(const o of _.touch.values())if(Rt([o.sx,o.sy],...t)){const r=o.x-o.sx,c=-(o.y-o.sy);return S(r,c)}if(e){if(e==="wasd"){const o=_.keyboard,r=o.a?-1:o.d?1:0,c=o.w?1:o.s?-1:0;if(r!==0||c!==0)return S(r,c)}else if(e==="arrow"){const o=_.keyboard,r=o.right?1:o.left?-1:0,c=o.up?1:o.down?-1:0;if(r!==0||c!==0)return S(r,c)}else if(_.keyboard[e])return[1,0]}if(n){if(n==="left-stick"){const o=_.gamepad;return S(o.lx,-o.ly)}else if(n==="right-stick"){const o=_.gamepad;return S(o.rx,-o.ry)}else if(_.gamepad[n])return[1,0]}return null},Kt=t=>{const e=localStorage.getItem(t);return e==null?null:JSON.parse(e)},Wt=(t,e)=>{const n=JSON.stringify(e);localStorage.setItem(t,n)};var s=null;const qt=()=>{s=document.getElementById("main").getContext("webgl2")},Jt=()=>{const t=document.getElementById("message");t.style.display="none"},ut=(t,e)=>{let n=s.createTexture();return s.bindTexture(s.TEXTURE_2D,n),e==0&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST)),e==1&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR)),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,t),s.bindTexture(s.TEXTURE_2D,null),n},ft=(t,e)=>{s.bindTexture(s.TEXTURE_2D,t),s.texSubImage2D(s.TEXTURE_2D,0,0,0,s.RGBA,s.UNSIGNED_BYTE,e),s.bindTexture(s.TEXTURE_2D,null)},tt=(t,e)=>{const n=s.createShader(t);return s.shaderSource(n,e),s.compileShader(n),s.getShaderParameter(n,s.COMPILE_STATUS)?n:(s.deleteShader(n),null)},Qt=(t,e)=>{const n=s.createProgram();return s.attachShader(n,t),s.attachShader(n,e),s.linkProgram(n),s.getProgramParameter(n,s.LINK_STATUS)?n:(s.deleteProgram(n),null)},et=(t,e)=>{let n=s.createBuffer();return s.bindBuffer(t,n),s.bufferData(t,e,s.STATIC_DRAW),n},F=(t,e,n,o,r,c)=>{s.enableVertexAttribArray(t),s.vertexAttribPointer(t,e,n,o,r,c)},Zt=()=>{const t=window.innerWidth;t!==s.canvas.width&&(s.canvas.width=t);const e=window.innerHeight;e!==s.canvas.height&&(s.canvas.height=e)},jt=()=>{s.viewport(0,0,s.canvas.width,s.canvas.height),s.clearColor(0,0,0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)},te=t=>{t.cw?(s.enable(s.CULL_FACE),s.frontFace(s.CW)):(s.enable(s.CULL_FACE),s.frontFace(s.CCW)),t.d?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST),t.a?(s.enable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA)):(s.disable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA))},ee=(t,e)=>{e=e||0;const n=t.iv[e*3+0],o=t.iv[e*3+1],r=t.iv[e*3+2],c=[null,s.POINTS,s.LINES,s.TRIANGLES];t.i?s.drawElements(c[n],r,s.UNSIGNED_SHORT,2*o):s.drawArrays(c[n],o,r)},C=(t,e)=>{s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,t),s.uniform1i(e,0)},ne=(t,e)=>{const n=document.createElement("canvas");return n?(n.width=t,n.height=e,n):null},$=(t,e)=>{const n=t.getContext("2d");if(!n)return null;n.clearRect(0,0,t.width,t.height),n.fillStyle="rgba(0 0 0 / 0.5)",n.fillRect(0,0,t.width,t.height),n.fillStyle="white",n.textAlign="left",n.textBaseline="top",n.font="14px monospace";const o=e.split(`
`);for(let r=0;r<o.length;++r)n.fillText(o[r],0,12*r)};var oe=null;const re=()=>{oe=new AudioContext},dt={},L=(t,e)=>{if(!!e)for(const n of e){const o=dt[n[0]];if(!o)continue;const r=n.slice(1);o(t,...r)}},g=(t,e)=>{dt[t]=e},nt=0,ot=1,rt=2,st=3,se=(t,e)=>{if(t.vao=s.createVertexArray(),s.bindVertexArray(t.vao),t.b>=0&&(t.b=et(s.ARRAY_BUFFER,J(e[t.b])),t.bv))for(let n=0;n<t.bv.length;n+=2)switch(t.bv[n]){case nt:F(nt,3,s.FLOAT,!1,0,t.bv[n+1]);break;case ot:F(ot,3,s.HALF_FLOAT,!1,0,t.bv[n+1]);break;case rt:F(rt,4,s.UNSIGNED_BYTE,!0,0,t.bv[n+1]);break;case st:F(st,2,s.HALF_FLOAT,!1,0,t.bv[n+1]);break}return t.i>=0&&(t.i=et(s.ELEMENT_ARRAY_BUFFER,J(e[t.i]))),s.bindVertexArray(null),t},ce=(t,e)=>{if(t.vs=tt(s.VERTEX_SHADER,e[t.vs]),t.fs=tt(s.FRAGMENT_SHADER,e[t.fs]),t.prog=Qt(t.vs,t.fs),t.u){const n={};for(let o of t.u)n[o]=s.getUniformLocation(t.prog,o);t.u=n}if(t.ub){const n={};let o=0;for(let r of t.ub){const c=s.getUniformBlockIndex(t.prog,r);s.uniformBlockBinding(t.prog,c,o),n[r]=o,o+=1}t.ub=n}return t};let H=0;const ie=(t,e)=>{t.tex=null;const n=new Image;return n.onload=()=>{t.tex=ut(n,t.s),H-=1},n.src="data:image/png;base64,"+e[t.b],H+=1,t},p={index:null,pack:[]},le=()=>{fetch("index.json").then(e=>e.json()).then(e=>{p.index=e;for(const n of p.index.pack)ae(n)})},ae=t=>{const e="pack"+t+".json";fetch(e).then(n=>n.json()).then(n=>{n.mesh&&(n.mesh=n.mesh.map(o=>se(o,n.content))),n.image&&(n.image=n.image.map(o=>ie(o,n.content))),n.shader&&(n.shader=n.shader.map(o=>ce(o,n.content))),p.pack[t]=n})},mt=()=>!(p.index===null||p.pack.length<=0||H>0),v=(t,e)=>{if(e<=0)return null;const n=p.index[t];if(!n)return null;const o=n[e];if(!o)return null;const r=p.pack[o.p];return r?r[t][o.i]:null},ue=t=>v("mesh",t),fe=t=>v("image",t),de=t=>v("shader",t),me=t=>v("draw",t),G=t=>v("item",t),_e=t=>v("base",t),B=t=>v("tile",t),M=t=>v("mob",t),_t=t=>v("hit",t),he=t=>v("grid",t),ht=t=>v("com",t),K=t=>v("view",t),O=(t,e)=>{const n=p.index[t];if(!n)return 0;const o=n.findIndex(r=>r&&r.n===e);return o<=0?0:o};const xe=t=>O("base",t);const ge=t=>O("grid",t),we=t=>O("com",t),ye=t=>O("view",t),ve=()=>({base:[],no:0,ha:0}),xt=t=>t?t.base.length<=0&&t.no<=0:!0,W=t=>t?t.no>0:!1,A=(t,e)=>{if(xt(t)||W(t))return!0;const n=I(t);return Math.abs(e-n)>1},I=t=>t?t.base.length:0,Ee=(t,e,n)=>{!t||(t.no=e,t.ha=n||0)},Te=t=>{!t||(t.no=0,t.ha=0)},gt=(t,e)=>{!t||t.base.push(e)},pe=t=>{!t||t.base.pop()},Ae=t=>{t=t||0;const e={s:[],i:0};return e.s.length=t,e.s.fill(null),e.i=0,e},wt=(t,e)=>t.s.findIndex(n=>n&&n.no===e),Me=t=>t.s.findIndex(e=>!e),yt=(t,e)=>{const n=e??t.i;return t.s[n]},vt=(t,e)=>{const n=Mt(t.i+e,t.s.length);t.i=n},Et=(t,e,n)=>{let o=wt(t,e);if(o<0){if(o=Me(t),o<0)return;t.s[o]={no:e,n};return}t.s[o].n+=n},Se=(t,e,n)=>{const o=wt(t,e);o<0||(t.s[o].n-=n,t.s[o].n<=0&&(t.s[o]=null))},be=(t,e,n,o,r,c)=>{const i={no:t,x:e,y:n,h:o,ha:r||0,va:c||0,dmg:0,hit:Ce(),item:Ae(8)},l=M(t);if(!l)return null;if(l.item)for(const a of l.item)Et(i.item,a.no,a.n);return i},Re=t=>{const e=M(t.no);!e||(e.action&&L(t,e.action),ke(t))},Ue=t=>{Ge(t.hit,t)},ke=t=>{const e=I(h(t.x,t.y));if(Math.abs(e-t.h)<=2){const n=U.dt,o=e-t.h;t.h+=10*n*o}else t.h=e},N=(t,e,n,o,r)=>{const c=Math.floor(e),i=Math.floor(n),l=I(h(c,i));let a=e+o,f=n+r;return A(h(c-1,i),l)&&(a=Math.max(a,c+t)),A(h(c+1,i),l)&&(a=Math.min(a,c-t+1)),A(h(c,i-1),l)&&(f=Math.max(f,i+t)),A(h(c,i+1),l)&&(f=Math.min(f,i-t+1)),A(h(c-1,i-1),l)&&([a,f]=D([a,f],t,[c,i])),A(h(c-1,i+1),l)&&([a,f]=D([a,f],t,[c,i+1])),A(h(c+1,i-1),l)&&([a,f]=D([a,f],t,[c+1,i])),A(h(c+1,i+1),l)&&([a,f]=D([a,f],t,[c+1,i+1])),[a,f]},Ie=(t,e,n)=>{const o=M(t.no);if(!o)return;const r=U.dt;if(n&&(t.ha+=90*r*n[0],t.va+=90*r*n[1],t.va=Math.max(-60,Math.min(t.va,80))),e){const i=b(t.ha+90),l=b(t.ha),a=e[0],f=e[1],x=a*Math.cos(i)+f*Math.cos(l),w=a*Math.sin(i)+f*Math.sin(l),T=2*r*x,d=2*r*w;[t.x,t.y]=N(o.r,t.x,t.y,T,d)}else[t.x,t.y]=N(o.r,t.x,t.y,0,0)},Le=t=>{for(let e=0;e<t.length;++e)for(let n=e+1;n<t.length;++n){const o=t[e],r=t[n],c=M(o.no);if(!c)continue;const i=M(r.no);if(!i)continue;const[l,a]=[r.x-o.x,r.y-o.y],f=Y(l,a),x=c.r+i.r-f;if(x<=0)continue;const w=S(l,a),T=St(w),d=c.m==0&&i.m==0?.5:c.m/(c.m+i.m),q=1-d;[o.x,o.y]=N(c.r,o.x,o.y,T[0]*d*x,T[1]*d*x),[r.x,r.y]=N(i.r,r.x,r.y,w[0]*q*x,w[1]*q*x)}},De=t=>{const e=M(t.no);return e?e.hp==0||t.dmg<e.hp:!1},Tt=(t,e)=>{t.dmg+=e},Fe=0,Pe=0,ct=1,Ne=()=>({m:new Float32Array(16),rect:[0,0,0,0],value:null,state:Fe,img:null,cvs:null}),it=t=>{const e=we(t);if(e<=0)return null;const n=u.com[e];return n?n.value:null},Be=(t,e,n)=>{const o=t.rect.ox*e/2,r=t.rect.oy*n/2,c=Nt(t.rect.w/2,t.rect.h/2,1);return z(c,o+t.rect.x,-(r+t.rect.y),0),c},Oe=(t,e,n)=>{const o=e/2+e/2*t.rect.ox,r=n/2+n/2*t.rect.oy,c=o+(t.rect.x-t.rect.w/2),i=o+(t.rect.x+t.rect.w/2),l=r+(t.rect.y-t.rect.h/2),a=r+(t.rect.y+t.rect.h/2);return[c,i,l,a]},Xe=(t,e)=>{if(e.rect&&(t.m.set(Be(e,u.w,u.h)),t.rect=Oe(e,u.w,u.h)),e.text&&t.img===null&&(t.cvs=ne(e.rect.w,e.rect.h),$(t.cvs,e.text.contents),t.img=ut(t.cvs,e.text.s)),e.touch){t.value=$t(t.rect,e.touch.keyboard,e.touch.gamepad);let n=!1;t.value!==null?t.state!==ct&&(t.state=ct,n=!0):t.state=Pe,n&&L(t,e.touch.action)}e.tick&&L(t,e.tick.action)},Ce=()=>({no:0,item:0,act:!1}),R=(t,e,n)=>{const o=Math.floor(t),r=Math.floor(e);let c=[];const i=b(n),l=Math.floor(t+Math.cos(i)*.8),a=Math.floor(e+Math.sin(i)*.8);return(o!=l||r!=a)&&c.push({x:l,y:a}),c},He=(t,e)=>{const n=yt(e);if(!n)return;const o=G(n.no);!o||!o.usable||(t.no=o.usable.hit,t.item=e.no)},Ge=(t,e)=>{if(He(t,e.item),t.no>0&&t.act){const n=_t(t.no);if(!n)return;n.action&&L(e,n.action),t.act=!1}},m={w:0,h:0,t:[],m:[]},pt=(t,e)=>{t=t||0,e=e||0,m.w=t,m.h=e,m.t=[],m.t.length=t*e;for(let n=0;n<m.t.length;++n)m.t[n]=ve();m.m=[]},Ye=t=>{const e=he(t);if(!!e){if(pt(e.w,e.h),e.b)for(const n of e.b)for(let o=n.x;o<n.x+n.w;++o)for(let r=n.y;r<n.y+n.h;++r)gt(h(o,r),n.no);if(e.t)for(const n of e.t)Ee(h(n.x,n.y),n.no,n.ha);if(e.m)for(const n of e.m)Ke(n.no,n.x+.5,n.y+.5,n.ha,n.va)}},Ve=(t,e)=>(t=Math.floor(t),e=Math.floor(e),t<0||m.w<=t||e<0||m.h<=e?-1:t+e*m.h),h=(t,e)=>m.t[Ve(t,e)],ze=t=>m.m.find(e=>e.no===t),$e=t=>m.m.filter(e=>{const n=Math.floor(e.x),o=Math.floor(e.y);for(const r of t)if(r.x===n&&r.y===o)return!0;return!1}),Ke=(t,e,n,o,r)=>{const c=I(h(e,n));m.m.push(be(t,e,n,c,o,r))},We=()=>{for(const t of m.m)Re(t);Le(m.m);for(const t of m.m)Ue(t);m.m=m.m.filter(t=>De(t))},u={w:0,h:0,view:null,slot:0,com:[],cam:{eye:[0,0,0],vp:new Float32Array(16),ivp:new Float32Array(16),o:new Float32Array(16)},m:new Float32Array(16)},qe=()=>{u.view=p.index.init,u.slot=0},E=()=>{const t=K(u.view);return!t||!t.grid||t.grid.cam<=0?null:ze(t.grid.cam)},At=t=>{const e=ye(t);e<0||(u.view=e)},Je=()=>{u.view===null&&qe(),u.w=window.innerWidth,u.h=window.innerHeight},Qe=()=>{const t=b(30),e=.1,n=1e3;let o=[1,0,0],r=[0,0,0];const c=E();c&&(o=Lt(c.ha,c.va),r=at(c.x,c.y,c.h),r[2]+=1.75);const i=kt(r,o),a=Bt(r,i,[0,0,1]),f=Ot(t,u.w/u.h,e,n),x=Ft(a,f);u.cam.vp.set(x),u.cam.ivp.set(Pt(x)),u.cam.eye=r,u.cam.o.set(Xt(u.w,u.h,0,1))},Ze=()=>{Je();const t=K(u.view);if(t){for(const e of u.com)e&&(e.value=null);if(t.com)for(let e of t.com){const n=ht(e);if(!n)continue;u.com[e]||(u.com[e]=Ne());const o=u.com[e];Xe(o,n)}t.grid&&We()}Qe()},je=()=>{Zt(),jt()},k=(t,e)=>{const n=me(t);if(!n)return;te(n.state);const o=de(n.shader);if(!o)return;s.useProgram(o.prog);const r=ue(n.mesh);if(!r)return;s.bindVertexArray(r.vao),s.uniformMatrix4fv(o.u.vp,!1,n.ortho?u.cam.o:u.cam.vp);const c=fe(n.image);C(c?c.tex:null,o.u.tex0),e(o.u),ee(r)},tn=(t,e)=>{const n=h(t,e);if(!n)return;for(let c=0;c<n.base.length;++c){const i=_e(n.base[c]);!i||k(i.draw,l=>{const a=X(t,e,c);u.m.set(V(a[0],a[1],a[2])),s.uniformMatrix4fv(l.w,!1,u.m)})}const o=B(n.no);if(!o)return;const r=I(n);k(o.draw,c=>{const i=X(t,e,r),l=lt(n.ha||0,n.va||0);z(l,i[0],i[1],i[2]),u.m.set(l),s.uniformMatrix4fv(c.w,!1,u.m)})},en=t=>{const e=M(t.no);!e||e.draw<=0||k(e.draw,n=>{const o=at(t.x,t.y,t.h),r=lt(t.ha||0,t.va||0);z(r,o[0],o[1],o[2]),u.m.set(r),s.uniformMatrix4fv(n.w,!1,u.m)})},nn=t=>{const e=_t(t.hit.no);if(!e)return;const n=R(t.x,t.y,t.ha);for(const o of n){const r=h(o.x,o.y);if(!r)return;const c=I(r);k(e.draw,i=>{const l=X(o.x,o.y,c);u.m.set(V(l[0],l[1],l[2])),s.uniformMatrix4fv(i.w,!1,u.m)})}},on=()=>{for(let t=0;t<m.w;++t)for(let e=0;e<m.h;++e)tn(t,e);for(const t of m.m)en(t);for(const t of m.m)nn(t)},rn=(t,e)=>{const n=ht(e);!n||!n.rect||n.rect.draw<=0||k(n.rect.draw,o=>{s.uniformMatrix4fv(o.w,!1,t.m),t.img&&C(t.img,o.tex0)})},sn=()=>{const t=K(u.view);if(!!t){if(t.grid){if(t.grid.draw)for(let e of t.grid.draw)k(e,n=>{u.m.set(V(...u.cam.eye)),s.uniformMatrix4fv(n.w,!1,u.m)});on()}if(t.com)for(let e of t.com){const n=u.com[e];n&&rn(n,e)}}},cn=t=>t,ln=t=>t,an=()=>{pt()},un=()=>{const t=Kt(`data${u.slot}`);return t?(t.grid&&Object.assign(m,ln(t.grid)),!0):!1},fn=()=>{const t={};t.grid=cn(m),Wt(`data${u.slot}`,t)};const dn=()=>{qt(),re(),Yt(),le()},mn=t=>{Ct(t),zt(),mt()&&(Jt(),Ze())},_n=()=>{je(),mt()&&sn()};y(window,"load",()=>{dn();const t=e=>{mn(e),_n(),requestAnimationFrame(t)};t()});g("nextview",(t,e)=>{At(e)});g("newgame",t=>{an()});g("loadgame",t=>{un()});g("savegame",t=>{fn()});g("fpsmove",(t,e,n)=>{const o=it(e),r=it(n);Ie(t,o,r)});g("newgrid",(t,e)=>{const n=ge(e);n<=0||Ye(n)});g("inventory_next",t=>{const e=E();!e||vt(e.item,1)});g("inventory_prev",t=>{const e=E();!e||vt(e.item,-1)});g("inventory",t=>{let e="";const n=E();if(n){{const o=M(n.no);if(!o)return;const r=o.hp,c=Math.max(0,r-n.dmg);e+="HP: "+c+"/"+r,e+=`
`}e+=`
`;for(let o=0;o<n.item.s.length;++o){if(n.item.i===o?e+=">":e+=" ",e+="["+o+"]",n.item.s[o]!=null){const r=G(n.item.s[o].no);if(!r)continue;e+=r.text+":"+n.item.s[o].n}e+=`
`}e+=`
`;{const o=yt(n.item);if(o!=null){const r=G(o.no);r!=null&&(e+=r.desc+`
`)}}}$(t.cvs,e),ft(t.img,t.cvs)});g("hand",t=>{const e=E();!e||(e.hit.act=!0)});g("activate",t=>{const e=E();if(!e)return;const n=R(e.x,e.y,e.ha);for(const o of n){const r=h(o.x,o.y);if(!r)continue;const c=B(r.no);!c||c.device&&L(r,c.device.action)}});g("activate-target",t=>{let e="";const n=E();if(n){const o=R(n.x,n.y,n.ha);for(const r of o){const c=h(r.x,r.y);if(!c)continue;const i=B(c.no);!i||(e+=i.desc,e+=`
`)}}$(t.cvs,e),ft(t.img,t.cvs)});g("hit-mining",t=>{const e=E();if(!e)return;const n=R(t.x,t.y,t.ha);for(const o of n){const r=h(o.x,o.y);if(!r)continue;const c=B(r.no);!c||c.mine&&(Et(e.item,c.mine.item,c.mine.count),Te(r))}});g("hit-dig",t=>{const e=R(t.x,t.y,t.ha);for(const n of e){const o=h(n.x,n.y);xt(o)||W(o)||pe(o)}});g("hit-put",(t,e)=>{const n=xe(e);if(n<=0)return;const o=E();if(!o)return;const r=R(t.x,t.y,t.ha);let c=0;for(const i of r){const l=h(i.x,i.y);W(l)||(gt(l,n),c+=1)}t.hit.item>0&&c>0&&Se(o.item,t.hit.item,c)});g("hit-damage",t=>{const e=R(t.x,t.y,t.ha),n=$e(e);for(const o of n)Tt(o,1)});g("giveup",t=>{const e=E();!e||Tt(e,9999)});g("gameover",(t,e)=>{E()||At(e)});})();
