(()=>{const w=e=>{const t=window.atob(e),n=new ArrayBuffer(t.length),r=new DataView(n);for(let c=0;c<t.length;++c)r.setUint8(c,t.charCodeAt(c));return n},F=e=>new Float32Array(w(e));const P=e=>new Int32Array(w(e)),y=e=>e/180*Math.PI,ne=(e,t)=>Math.sqrt(e*e+t*t),L=(e,t)=>{const n=ne(e,t);return n!=0?[e/n,t/n]:[0,0]},oe=([e,t],n)=>[e*n,t*n],A=(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],Y=e=>{const t=A(e,e);return Math.sqrt(t)},re=(e,t)=>[e[0]+t[0],e[1]+t[1],e[2]+t[2]],ce=(e,t)=>[e[0]-t[0],e[1]-t[1],e[2]-t[2]];const B=e=>{const t=Y(e);return[e[0]/t,e[1]/t,e[2]/t]},b=(e,t)=>[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]],se=(e,t)=>{const n=y(e),r=y(t);return[Math.cos(r)*Math.cos(n),Math.sin(r),Math.cos(r)*Math.sin(n)]};const ae=(e,t)=>[e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15]];const ie=(e,t,n)=>[e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1],le=(e,t,n)=>{const r=B(ce(t,e)),c=B(b(n,r)),s=b(r,c),a=A(e,c),i=A(e,s),d=A(e,r);return[c[0],s[0],r[0],0,c[1],s[1],r[1],0,c[2],s[2],r[2],0,-a,-i,-d,1]},ue=(e,t,n,r)=>{const c=1/Math.tan(e),s=c/t,a=r/(r-n),i=-(a*n);return[s,0,0,0,0,c,0,0,0,0,a,1,0,0,i,0]},de=(e,t,n,r)=>{const c=2/e,s=2/t,a=1/(r-n),i=n/(n-r);return[c,0,0,0,0,s,0,0,0,0,a,0,0,0,i,1]};const me=[[1,0,0],[0,1,0],[0,0,1]],fe=[[1,1,1],[1,-1,-1],[1,-1,1],[1,1,-1]],he=[[1,1,0],[1,-1,0],[1,0,1],[1,0,-1],[0,1,1],[0,1,-1]];const ge=9.81,u=(e,t,n)=>{e.addEventListener(t,n)};var o=null;const _e=()=>{o=document.getElementById("main").getContext("webgl2")},N=0,C=1,V=2,z=3,pe=e=>{let t=o.createTexture();return o.bindTexture(o.TEXTURE_2D,t),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,e),o.bindTexture(o.TEXTURE_2D,null),t},xe=(e,t,n)=>{const r=document.createElement("canvas");if(!r)return null;r.width=t,r.height=n;const c=r.getContext("2d");return c?(c.fillStyle="white",c.textAlign="center",c.textBaseline="middle",c.font="24px monospace",c.fillText(e,r.width/2,r.height/2),r):null},H=(e,t)=>{const n=o.createShader(e);return o.shaderSource(n,t),o.compileShader(n),o.getShaderParameter(n,o.COMPILE_STATUS)?n:(o.deleteShader(n),null)},ve=(e,t)=>{const n=o.createProgram();return o.attachShader(n,e),o.attachShader(n,t),o.linkProgram(n),o.getProgramParameter(n,o.LINK_STATUS)?n:(o.deleteProgram(n),null)},U=(e,t)=>{let n=o.createBuffer();return o.bindBuffer(e,n),o.bufferData(e,t,o.STATIC_DRAW),n},M=(e,t,n,r,c,s)=>{o.enableVertexAttribArray(e),o.vertexAttribPointer(e,t,n,r,c,s)},Ae=()=>{const e=window.innerWidth;e!==o.canvas.width&&(o.canvas.width=e);const t=window.innerHeight;t!==o.canvas.height&&(o.canvas.height=t)},Te=()=>{o.viewport(0,0,o.canvas.width,o.canvas.height),o.clearColor(0,0,0,1),o.clearDepth(1),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT)},$=(e,t)=>{o.enable(o.CULL_FACE),e?(o.enable(o.DEPTH_TEST),o.depthFunc(o.LEQUAL)):o.disable(o.DEPTH_TEST),t?(o.enable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA)):(o.disable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA))},K=(e,t)=>{t=t||0;const n=e.iv[t*3+0],r=e.iv[t*3+1],c=e.iv[t*3+2],s=[null,o.POINTS,o.LINES,o.TRIANGLES];e.i?o.drawElements(s[n],c,o.UNSIGNED_SHORT,2*r):o.drawArrays(s[n],r,c)};var ye=null;const Ee=()=>{ye=new AudioContext};const we=e=>{if(e.matrix){const t=F(e.matrix);e.count=Math.floor(t.length/16);const n=new Float32Array(e.count*64);for(let r=0;r<e.count;++r)for(j=0;j<16;++j)n[r*64+j]=t[r*16+j];e.size=64,e.stride=256,e.matrix=U(o.UNIFORM_BUFFER,n)}return e},Me=e=>(e.static&&(e.static=e.static.map(t=>we(t))),e),Se=e=>{if(e.vao=o.createVertexArray(),o.bindVertexArray(e.vao),e.b&&(e.b=U(o.ARRAY_BUFFER,w(e.b)),e.bv))for(let t=0;t<e.bv.length;t+=2)switch(e.bv[t]){case N:M(N,3,o.FLOAT,!1,0,e.bv[t+1]);break;case C:M(C,3,o.HALF_FLOAT,!1,0,e.bv[t+1]);break;case V:M(V,4,o.UNSIGNED_BYTE,!0,0,e.bv[t+1]);break;case z:M(z,2,o.HALF_FLOAT,!1,0,e.bv[t+1]);break}return e.i&&(e.i=U(o.ELEMENT_ARRAY_BUFFER,w(e.i))),o.bindVertexArray(null),e},Re=e=>{if(e.vs=H(o.VERTEX_SHADER,e.vs),e.fs=H(o.FRAGMENT_SHADER,e.fs),e.prog=ve(e.vs,e.fs),e.u){const t={};for(let n of e.u)t[n]=o.getUniformLocation(e.prog,n);e.u=t}if(e.ub){const t={};let n=0;for(let r of e.ub){const c=o.getUniformBlockIndex(e.prog,r);o.uniformBlockBinding(e.prog,c,n),t[r]=n,n+=1}e.ub=t}return e},ke=e=>(e.texture=pe(xe(e.text,e.width,e.height)),e),De=e=>(e.b&&(e.b=F(e.b)),e.dop6&&(e.dop6=P(e.dop6)),e.dop8&&(e.dop8=P(e.dop8)),e.dop12&&(e.dop12=P(e.dop12)),e),Pe=e=>(e.ground&&(e.ground=e.ground.map(t=>De(t))),e),m={index:null,pack:[]},Le=()=>m.index!=null&&m.pack.length>0,Ue=()=>{fetch("data/index.json").then(t=>t.json()).then(t=>{m.index=t})},Ge=e=>{const t="data/pack"+e+".json";fetch(t).then(n=>n.json()).then(n=>{n.update&&(n.update=n.update.map(r=>Pe(r))),n.draw&&(n.draw=n.draw.map(r=>Me(r))),n.mesh&&(n.mesh=n.mesh.map(r=>Se(r))),n.texture&&(n.texture=n.texture.map(r=>ke(r))),n.shader&&(n.shader=n.shader.map(r=>Re(r))),m.pack[e]=n})},Ie=e=>m.pack[0].update[e],Oe=e=>m.pack[0].draw[e],W=e=>m.pack[0].mesh[e];const q=e=>m.pack[0].shader[e],G=(e,t,n)=>{const r=[];for(const c of n){const s=A(c,e),a=A(c,t);r.push(s),r.push(a)}return r},Xe=(e,t,n,r)=>{let c=(n-e)/t,s=(r-e)/t;return c>s&&([c,s]=[s,c]),[c,s]},Fe=(e,t)=>{const n=Math.min(e.length,t.length);let r=0,c=1;for(let s=0;s<n;s+=2)if(Math.abs(e[s+1])<=0){if(e[s]<t[s]||e[s]>t[s+1])return null}else{const[a,i]=Xe(e[s],e[s+1],t[s],t[s+1]);if(r=Math.max(a,r),c=Math.min(i,c),r>c)return null}return r},J=(e,t,n)=>{const r=Ie(e);if(!r||!r.ground||Y(n)<=0)return null;const c=G(t,n,me),s=G(t,n,fe),a=G(t,n,he);let i=1;const d=(l,f,g)=>{const x=f.b.slice(g,g+l.length),v=Fe(l,x);v!==null&&(i=Math.min(v,i))};for(const l of r.ground){if(l.dop6)for(const f of l.dop6)d(c,l,f);if(l.dop8)for(const f of l.dop8)d(s,l,f);if(l.dop12)for(const f of l.dop12)d(a,l,f)}return i>=1?null:i},Ye=e=>{e.input=e.input||{},e.input.mouse={x:0,y:0,mx:0,my:0,lb:!1,rb:!1}},I=(e,t)=>(e.mx+=t.movementX||0,e.my+=t.movementY||0,e.x=t.x,e.y=t.y,e.lb=(t.buttons&1)!=0,e.rb=(t.buttons&2)!=0,!0),Be=e=>{const t=n=>Math.trunc(n/2);e.mx=t(e.mx),e.my=t(e.my)},be=({input:e},t)=>{I(e.mouse,t)&&(e.mode=T,t.preventDefault())},Ne=({input:e},t)=>{I(e.mouse,t)&&(e.mode=T,t.preventDefault())},Ce=({input:e},t)=>{I(e.mouse,t)&&(e.mode=T,t.preventDefault())},Ve=e=>{e.input=e.input||{},e.input.keyboard={w:!1,a:!1,s:!1,d:!1,space:!1,lctrl:!1}},Q=(e,t,n)=>{switch(t){case"KeyW":e.w=n;break;case"KeyA":e.a=n;break;case"KeyS":e.s=n;break;case"KeyD":e.d=n;break;case"Space":e.space=n;break;case"ControlLeft":e.lctrl=n;break;default:return!1}return!0},ze=({input:e},t)=>{Q(e.keyboard,t.code,!0)&&(e.mode=T,t.preventDefault())},He=({input:e},t)=>{Q(e.keyboard,t.code,!1)&&(e.mode=T,t.preventDefault())},$e=e=>{e.input=e.input||{},e.input.gamepad={index:null,lx:0,ly:0,rx:0,ry:0,b0:!1,b1:!1,lt:!1,rt:!1}},Ke=({input:e},t)=>{e.gamepad.index=t.gamepad.index,e.mode=S},je=({input:e},t)=>{e.gamepad.index===t.gamepad.index&&(e.gamepad.index=null)},We=({input:e})=>{if(e.gamepad.index!==null){const n=navigator.getGamepads()[e.gamepad.index];e.gamepad.lx=Math.trunc(n.axes[0]*4)/4,e.gamepad.ly=Math.trunc(n.axes[1]*4)/4,e.gamepad.rx=Math.trunc(n.axes[2]*4)/4,e.gamepad.ry=Math.trunc(n.axes[3]*4)/4,e.gamepad.b0=n.buttons[0].value>=.5,e.gamepad.b1=n.buttons[1].value>=.5,e.gamepad.lt=n.buttons[6].value>=.5,e.gamepad.rt=n.buttons[7].value>=.5,!!(e.gamepad.lx||e.gamepad.ly||e.gamepad.rx||e.gamepad.ry||e.gamepad.b0||e.gamepad.b1||e.gamepad.lt||e.gamepad.rt)&&(e.mode=S)}},qe=e=>{e.input=e.input||{},e.input.touch=new Map},Je=({input:e},t)=>{for(const n of t.changedTouches)e.touch.set(n.identifier,{x:n.clientX,y:n.clientY,sx:n.clientX,sy:n.clientY});e.mode=R},Z=({input:e},t)=>{for(const n of t.changedTouches)e.touch.delete(n.identifier);e.mode=R},Qe=({input:e},t)=>{for(const n of t.changedTouches){const r=e.touch.get(n.identifier);r&&(r.x=n.clientX,r.y=n.clientY)}e.mode=R},S=0,T=1,R=2,Ze=e=>{e.input={mode:S,moveX:0,moveY:0,cameraX:0,cameraY:0,jump:!1,sneak:!1,jumpButton:!1,sneakButton:!1}},et=e=>{[e.moveX,e.moveY]=L(e.moveX,e.moveY),[e.cameraX,e.cameraY]=L(e.cameraX,e.cameraY)},tt=({input:e})=>{e.moveX=0,e.moveY=0,e.cameraX=0,e.cameraY=0},nt=({input:e})=>{e.moveX=e.gamepad.lx,e.moveY=-e.gamepad.ly,e.cameraX=-e.gamepad.rx,e.cameraY=-e.gamepad.ry,e.jump=!e.jumpButton&&e.gamepad.b0,e.sneak=!e.sneakButton&&e.gamepad.b1,e.jumpButton=e.gamepad.b0,e.sneakButton=e.gamepad.b1},ot=({input:e})=>{e.moveX=e.keyboard.a?-1:e.keyboard.d?1:0,e.moveY=e.keyboard.w?1:e.keyboard.s?-1:0,e.mouse.lb?(e.cameraX=-e.mouse.mx,e.cameraY=-e.mouse.my):(e.cameraX=0,e.cameraY=0),e.jump=!e.jumpButton&&e.keyboard.space,e.sneak=!e.sneakButton&&e.keyboard.lctrl,e.jumpButton=e.keyboard.space,e.sneakButton=e.keyboard.lctrl},rt=({input:e})=>{e.moveX=0,e.moveY=0,e.cameraX=0,e.cameraY=0;for(const t of e.touch.values())t.sx<window.innerWidth/2?(e.moveX=t.x-t.sx,e.moveY=-(t.y-t.sy)):(e.cameraX=-(t.x-t.sx),e.cameraY=-(t.y-t.sy))},ct=e=>{e.camera={viewProj:new Float32Array(16),ortho:new Float32Array(16)}},st=({camera:e},t,n,r,c,s)=>{const a=window.innerWidth,i=window.innerHeight,d=y(30),l=.1,f=1e3,g=[t,n,r],x=re(g,se(c,s)),E=le(g,x,[0,1,0]),h=ue(d,a/i,l,f);e.viewProj.set(ae(E,h)),e.ortho.set(de(a,i,0,1))},at=e=>{e.timer={prevTime:performance.now(),deltaTime:0}},it=({timer:e})=>{const t=performance.now();e.deltaTime=(t-e.prevTime)/1e3,e.prevTime=t},lt=e=>{e.save={scene:0,position:[0,0,0],angle:[0,0],sneak:!1,vy:0}},O=({save:e})=>e.sneak?.9:1.75,ut=({save:e},t)=>{e.scene=t},X=({save:e},t,n,r)=>{e.position=[t,n,r]},ee=({save:e},t,n)=>{e.angle=[t,n]},dt=({save:e},t)=>{e.sneak=t},te=({save:e},t)=>{e.vy=t},mt=e=>{const t=m.index.start.scene,[n,r,c]=m.index.start.position,[s,a]=m.index.start.angle;ut(e,t),X(e,n,r,c),ee(e,s,a)};var k=null;const ft=()=>{const e={};Ze(e),Ye(e),Ve(e),$e(e),qe(e),ct(e),at(e),lt(e),mt(e),u(window,"focus",t=>{}),u(window,"blur",t=>{}),u(window,"resize",t=>{}),u(window,"gamepadconnected",t=>{Ke(e,t)}),u(window,"gamepaddisconnected",t=>{je(e,t)}),u(document,"keydown",t=>{ze(e,t)}),u(document,"keyup",t=>{He(e,t)}),u(document.body,"contextmenu",t=>{t.preventDefault()}),u(document.body,"mousedown",t=>{be(e,t)}),u(document.body,"mouseup",t=>{Ne(e,t)}),u(document.body,"mousemove",t=>{Ce(e,t)}),u(document.body,"touchstart",t=>{Je(e,t)}),u(document.body,"touchend",t=>{Z(e,t)}),u(document.body,"touchcancel",t=>{Z(e,t)}),u(document.body,"touchmove",t=>{Qe(e,t)}),k=e},ht=e=>{it(e),We(e);const t=e.input.mode;t===S?nt(e):t===T?ot(e):t===R?rt(e):tt(e),et(e.input),Be(e.input.mouse)},gt=e=>{const t=e.timer.deltaTime;let[n,r]=e.save.angle;const c=e.input.cameraX,s=e.input.cameraY,a=90,i=a*t*c,d=a*t*s;n+=i,r+=d,ee(e,n,r)},_t=e=>{const t=e.timer.deltaTime;let[n,r,c]=e.save.position,[s,a]=e.save.angle;const i=e.input.moveX,d=e.input.moveY,l=O(e),f=4,g=y(s-90),x=y(s),v=f*(i*Math.cos(g)+d*Math.cos(x)),E=f*(i*Math.sin(g)+d*Math.sin(x));let h=L(v,E);h=oe(h,1);let _=v*t+h[0],p=E*t+h[1];const D=J(e.save.scene,[n,r+l/2,c],[_,0,p]);D!==null&&(_=D*_,p=D*p),Math.abs(_)>Math.abs(h[0])?_-=h[0]:_=0,Math.abs(p)>Math.abs(h[1])?p-=h[1]:p=0,n+=_,c+=p,X(e,n,r,c)},pt=e=>{const t=e.timer.deltaTime;let[n,r,c]=e.save.position;const s=O(e);let a=e.save.vy;a+=-ge*t,r+=s/2;let i=a*t-s/2;const d=J(e.save.scene,[n,r,c],[0,i,0]);d!==null&&(a=Math.max(0,a),i=d*i),r+=i,X(e,n,r,c),te(e,a)},xt=e=>{e.input.jump&&te(e,4),e.input.sneak&&dt(e,!e.save.sneak)},vt=e=>{gt(e),_t(e),pt(e),xt(e)},At=e=>{const[t,n,r]=e.save.position,[c,s]=e.save.angle,a=O(e);st(e,t,n+a,r,c,s)},Tt=e=>{ht(e),vt(e),At(e)},yt=()=>{Ae(),Te()},Et=e=>{$(!0,!1);const t=Oe(e.save.scene);if(!t)return;const n=q(m.index.data.mesh_pnc);if(!!n){o.useProgram(n.prog),o.uniformMatrix4fv(n.u.vp,!1,e.camera.viewProj);for(const r of t.static){const c=W(r.mesh);if(!!c){o.bindVertexArray(c.vao);for(let s=0;s<r.count;++s)o.bindBufferRange(o.UNIFORM_BUFFER,n.ub.a,r.matrix,s*r.stride,r.size),K(c)}}}},wt=e=>{$(!1,!0);const t=q(m.index.data.mesh_pc);if(!t)return;o.useProgram(t.prog),o.uniformMatrix4fv(t.u.vp,!1,e.camera.ortho);const n=W(m.index.data.reticle);if(!n)return;o.bindVertexArray(n.vao);const r=new Float32Array(16);r.set(ie(4,4,1)),o.uniformMatrix4fv(t.u.w,!1,r),K(n)},Mt=e=>{yt(e),Et(e),wt(e)};u(window,"load",()=>{_e(),Ee(),Ue(),Ge(0);const e=()=>{if(!Le()){requestAnimationFrame(e);return}k===null&&ft(),Tt(k),Mt(k),requestAnimationFrame(e)};e()});})();
