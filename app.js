(()=>{const b=e=>{const t=window.atob(e),n=new ArrayBuffer(t.length),s=new DataView(n);for(let c=0;c<t.length;++c)s.setUint8(c,t.charCodeAt(c));return n};const E=e=>e/180*Math.PI,ae=(e,t)=>Math.sqrt(e*e+t*t),T=(e,t)=>{const n=ae(e,t);return n!=0?[e/n,t/n]:[0,0]};const ie=([e,t],n,s,c,r)=>n<=e&&e<=s&&c<=t&&t<=r,R=(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],le=e=>{const t=R(e,e);return Math.sqrt(t)},ue=(e,t)=>[e[0]+t[0],e[1]+t[1],e[2]+t[2]],fe=(e,t)=>[e[0]-t[0],e[1]-t[1],e[2]-t[2]];const B=e=>{const t=le(e);return[e[0]/t,e[1]/t,e[2]/t]},X=(e,t)=>[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]],de=(e,t)=>{const n=E(e),s=E(t);return[Math.cos(s)*Math.cos(n),Math.cos(s)*Math.sin(n),Math.sin(s)]},C=(e,t,n)=>[e*2,t*2,n*.5];const he=(e,t)=>[e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15]],me=(e,t,n)=>[1,0,0,0,0,1,0,0,0,0,1,0,e,t,n,1],_e=(e,t,n,s)=>{e[12]=t,e[13]=n,e[14]=s},ge=(e,t,n)=>[e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1],xe=(e,t,n)=>{const s=B(fe(t,e)),c=B(X(n,s)),r=X(s,c),l=R(e,c),u=R(e,r),m=R(e,s);return[c[0],r[0],s[0],0,c[1],r[1],s[1],0,c[2],r[2],s[2],0,-l,-u,-m,1]},we=(e,t,n,s)=>{const c=1/Math.tan(e),r=c/t,l=s/(s-n),u=-(l*n);return[r,0,0,0,0,c,0,0,0,0,l,1,0,0,u,0]},ve=(e,t,n,s)=>{const c=2/e,r=2/t,l=1/(s-n),u=n/(n-s);return[c,0,0,0,0,r,0,0,0,0,l,0,0,0,u,1]},v=0,k=1,y=2;var a=null;const _=(e,t,n)=>{e.addEventListener(t,n)},pe=()=>{const e=document.body;e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.msUserSelect="none",e.style.mozUserSelect="none"},Te=()=>{const e=document.body;e.style.touchAction="none"},Ae=()=>{pe(),Te(),a={},a.mode=v,a.timer={prevTime:performance.now(),deltaTime:0},a.gamepad={index:null,lx:0,ly:0,rx:0,ry:0,b0:!1,b1:!1,b8:!1,b9:!1,lt:!1,rt:!1},a.keyboard={w:!1,a:!1,s:!1,d:!1,up:!1,left:!1,down:!1,right:!1,z:!1,x:!1,space:!1,lctrl:!1,esc:!1},a.touch=new Map,a.click=[],_(window,"focus",e=>{}),_(window,"blur",e=>{}),_(window,"resize",e=>{}),_(window,"gamepadconnected",e=>{a.gamepad.index=e.gamepad.index,a.mode=k}),_(window,"gamepaddisconnected",e=>{a.gamepad.index===e.gamepad.index&&(a.gamepad.index=null)}),_(document,"keydown",e=>{Y(a.keyboard,e.code,!0)&&(a.mode=y,e.preventDefault())}),_(document,"keyup",e=>{Y(a.keyboard,e.code,!1)&&(a.mode=y,e.preventDefault())}),_(document.body,"contextmenu",e=>{e.preventDefault()}),_(document.body,"pointerdown",e=>{a.touch.set(e.pointerId,{x:e.clientX,y:e.clientY,sx:e.clientX,sy:e.clientY,time:performance.now()}),a.mode=v}),_(document.body,"pointerup",e=>{Ee(e.pointerId),a.touch.delete(e.pointerId),a.mode=v}),_(document.body,"pointerout",e=>{a.touch.delete(e.pointerId),a.mode=v}),_(document.body,"pointermove",e=>{const t=a.touch.get(e.pointerId);t&&(t.x=e.clientX,t.y=e.clientY,a.mode=v)})},Y=(e,t,n)=>{switch(t){case"KeyW":e.w=n;break;case"KeyA":e.a=n;break;case"KeyS":e.s=n;break;case"KeyD":e.d=n;break;case"ArrowUp":e.up=n;break;case"ArrowLeft":e.left=n;break;case"ArrowDown":e.down=n;break;case"ArrowRight":e.right=n;break;case"KeyZ":e.z=n;break;case"KeyX":e.x=n;break;case"Space":e.space=n;break;case"ControlLeft":e.lctrl=n;break;case"Escape":e.esc=n;break;default:return!1}return!0},Ee=e=>{const t=a.touch.get(e);t&&performance.now()-t.time<250&&a.click.push({x:t.x,y:t.y})},ke=(e,t)=>{e.deltaTime=(t-e.prevTime)/1e3,e.prevTime=t},ye=e=>{if(e.index!==null){const n=navigator.getGamepads()[e.index];e.lx=Math.trunc(n.axes[0]*4)/4,e.ly=Math.trunc(n.axes[1]*4)/4,e.rx=Math.trunc(n.axes[2]*4)/4,e.ry=Math.trunc(n.axes[3]*4)/4,e.b0=n.buttons[0].value>=.5,e.b1=n.buttons[1].value>=.5,e.b8=n.buttons[8].value>=.5,e.b9=n.buttons[9].value>=.5,e.lt=n.buttons[6].value>=.5,e.rt=n.buttons[7].value>=.5,!!(e.lx||e.ly||e.rx||e.ry||e.b0||e.b1||e.b8||e.b9||e.lt||e.rt)&&(a.mode=k)}},Se=e=>{ke(a.timer,e),ye(a.gamepad)},Me=()=>{a.click.length=0},Re=e=>{const t=localStorage.getItem(e);return t==null?null:JSON.parse(t)},Le=(e,t)=>{const n=JSON.stringify(t);localStorage.setItem(e,n)};var o=null;const Ie=()=>{o=document.getElementById("main").getContext("webgl2")},V=0,H=1,$=2,z=3,Ue=e=>{let t=o.createTexture();return o.bindTexture(o.TEXTURE_2D,t),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,e),o.bindTexture(o.TEXTURE_2D,null),t},De=(e,t,n)=>{const s=document.createElement("canvas");if(!s)return null;s.width=t,s.height=n;const c=s.getContext("2d");return c?(c.fillStyle="white",c.textAlign="center",c.textBaseline="middle",c.font="24px monospace",c.fillText(e,s.width/2,s.height/2),s):null},K=(e,t)=>{const n=o.createShader(e);return o.shaderSource(n,t),o.compileShader(n),o.getShaderParameter(n,o.COMPILE_STATUS)?n:(o.deleteShader(n),null)},Ge=(e,t)=>{const n=o.createProgram();return o.attachShader(n,e),o.attachShader(n,t),o.linkProgram(n),o.getProgramParameter(n,o.LINK_STATUS)?n:(o.deleteProgram(n),null)},W=(e,t)=>{let n=o.createBuffer();return o.bindBuffer(e,n),o.bufferData(e,t,o.STATIC_DRAW),n},L=(e,t,n,s,c,r)=>{o.enableVertexAttribArray(e),o.vertexAttribPointer(e,t,n,s,c,r)},Pe=()=>{const e=window.innerWidth;e!==o.canvas.width&&(o.canvas.width=e);const t=window.innerHeight;t!==o.canvas.height&&(o.canvas.height=t)},Oe=()=>{o.viewport(0,0,o.canvas.width,o.canvas.height),o.clearColor(0,0,0,1),o.clearDepth(1),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT)},q=(e,t)=>{o.enable(o.CULL_FACE),e?(o.enable(o.DEPTH_TEST),o.depthFunc(o.LEQUAL)):o.disable(o.DEPTH_TEST),t?(o.enable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA)):(o.disable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA))},J=(e,t)=>{t=t||0;const n=e.iv[t*3+0],s=e.iv[t*3+1],c=e.iv[t*3+2],r=[null,o.POINTS,o.LINES,o.TRIANGLES];e.i?o.drawElements(r[n],c,o.UNSIGNED_SHORT,2*s):o.drawArrays(r[n],s,c)};var Fe=null;const Ne=()=>{Fe=new AudioContext};const be=e=>{if(e.vao=o.createVertexArray(),o.bindVertexArray(e.vao),e.b&&(e.b=W(o.ARRAY_BUFFER,b(e.b)),e.bv))for(let t=0;t<e.bv.length;t+=2)switch(e.bv[t]){case V:L(V,3,o.FLOAT,!1,0,e.bv[t+1]);break;case H:L(H,3,o.HALF_FLOAT,!1,0,e.bv[t+1]);break;case $:L($,4,o.UNSIGNED_BYTE,!0,0,e.bv[t+1]);break;case z:L(z,2,o.HALF_FLOAT,!1,0,e.bv[t+1]);break}return e.i&&(e.i=W(o.ELEMENT_ARRAY_BUFFER,b(e.i))),o.bindVertexArray(null),e},Be=e=>{if(e.vs=K(o.VERTEX_SHADER,e.vs),e.fs=K(o.FRAGMENT_SHADER,e.fs),e.prog=Ge(e.vs,e.fs),e.u){const t={};for(let n of e.u)t[n]=o.getUniformLocation(e.prog,n);e.u=t}if(e.ub){const t={};let n=0;for(let s of e.ub){const c=o.getUniformBlockIndex(e.prog,s);o.uniformBlockBinding(e.prog,c,n),t[s]=n,n+=1}e.ub=t}return e},Xe=e=>(e.texture=Ue(De(e.text,e.width,e.height)),e),f={index:null,pack:[]},Q=()=>f.index!=null&&f.pack.length>0,Ce=()=>{fetch("data/index.json").then(t=>t.json()).then(t=>{f.index=t})},Ye=e=>{const t="data/pack"+e+".json";fetch(t).then(n=>n.json()).then(n=>{n.mesh&&(n.mesh=n.mesh.map(s=>be(s))),n.texture&&(n.texture=n.texture.map(s=>Xe(s))),n.shader&&(n.shader=n.shader.map(s=>Be(s))),f.pack[e]=n})},Z=e=>f.pack[0]&&f.pack[0].view[e],Ve=e=>f.pack[0]&&f.pack[0].view.findIndex(t=>t.name===e),j=e=>f.pack[0]&&f.pack[0].mesh[e];const ee=e=>f.pack[0]&&f.pack[0].shader[e],te=e=>f.pack[0]&&f.pack[0].stack.find(t=>t.id===e),ne=e=>f.pack[0]&&f.pack[0].ui[e],He=e=>f.pack[0]&&f.pack[0].event[e],h={view:null,slot:null,cam:{vp:new Float32Array(16),o:new Float32Array(16)}},se=()=>{h.slot=null,h.view=f.index.initial_view},$e=e=>{const t=Ve(e);t<0||(h.view=t)},ze=()=>{h.view===null&&se()},Ke=()=>{const e=window.innerWidth,t=window.innerHeight,n=E(30),s=.1,c=1e3,r=de(i.ha,i.va),l=C(i.x,i.y,i.h);l[2]+=i.eyeh;const u=ue(l,r),g=xe(l,u,[0,0,1]),w=we(n,e/t,s,c);h.cam.vp.set(he(g,w)),h.cam.o.set(ve(e,t,0,1))},p={},G=e=>{const t=p[e];return t?t.value:null},We=0,P=0,S=1,O=(e,t)=>{const n=window.innerWidth,s=window.innerHeight,c=n/2+e.offset[0]-e.width/2,r=n/2+e.offset[0]+e.width/2,l=s/2+e.offset[1]-e.height/2,u=s/2+e.offset[1]+e.height/2;return ie(t,c,r,l,u)},qe=(e,t)=>{const n=a.mode;if(n===v){let s=!1;const c=a.click;for(let r of c)if(O(t,[r.x,r.y])){s=!0;break}s?(e.value=!0,e.state=S):(e.value=!1,e.state=P)}else n===k?a.gamepad[t.gamepad]?e.state!==S?(e.value=!0,e.state=S):e.value=!1:(e.value=!1,e.state=P):n===y&&(a.keyboard[t.keyboard]?e.state!==S?(e.value=!0,e.state=S):e.value=!1:(e.value=!1,e.state=P))},Je=(e,t)=>{const n=a.mode;if(n===v){e.value=[0,0];for(const s of a.touch.values())if(O(t,[s.sx,s.sy])){const c=s.x-s.sx,r=-(s.y-s.sy);e.value=T(c,r);break}}else if(n===k){const s=a.gamepad;e.value=T(s.lx,-s.ly)}else if(n===y){const s=a.keyboard,c=s.a?-1:s.d?1:0,r=s.w?1:s.s?-1:0;e.value=T(c,r)}},Qe=(e,t)=>{const n=a.mode;if(n===v){e.value=[0,0];for(const s of a.touch.values())if(O(t,[s.sx,s.sy])){const c=s.x-s.sx,r=-(s.y-s.sy);e.value=T(c,r);break}}else if(n===k){const s=a.gamepad;e.value=T(s.rx,-s.ry)}else if(n===y){const s=a.keyboard,c=s.right?1:s.left?-1:0,r=s.up?1:s.down?-1:0;e.value=T(c,r)}},Ze=e=>{for(const t in p)p[t].value=null;for(let t of e.ui){const n=ne(t);if(!n)continue;p[n.name]||(p[n.name]={m:new Float32Array(16),value:null,state:We});const s=p[n.name];switch(n.interact){case 1:qe(s,n);break;case 2:Je(s,n);break;case 3:Qe(s,n);break;default:break}const c=ge(n.width/2,n.height/2,1);_e(c,n.offset[0],-n.offset[1],0),s.m.set(c)}},d={w:0,h:0,a:[]},F=(e,t)=>e<<0|t<<16,I=e=>[e>>0&65535,e>>16&65535],U=(e,t)=>(e=Math.floor(e),t=Math.floor(t),e<0||d.w<=e||t<0||d.h<=t?null:d.a[e+t*d.h]),N=(e,t)=>{const n=U(e,t);if(!n)return 0;let s=0;for(const c of n){const[r,l]=I(c),u=te(r);!u||(s+=l*u.height)}return s},D=(e,t,n,s)=>{const c=N(e,t),r=N(e+n,t+s);return Math.abs(c-r)>1},i={x:0,y:0,ha:0,va:0,h:0,eyeh:1.75},x={},je=e=>{for(let t of e.event){const n=He(t);if(!n)continue;let s=!1;switch(n.trigger){case 0:s=!0;break;case 1:s=G(n.target);break}if(s)for(const c of n.action){const r=x[c[0]];if(!r)continue;const l=c.slice(1);r(...l)}}},et=()=>{d.w=64,d.h=64,d.a.length=0,d.a.length=d.w*d.h;for(let e=0;e<d.a.length;++e){const t=1+Math.floor(Math.random()*10);d.a[e]=[],d.a[e].push(F(1,t))}i.x=.5,i.y=.5,i.ha=0,i.va=0},tt=()=>{if(!h.slot)return!1;const e=Re(h.slot);return e?(e.pos&&Object.assign(i,e.pos),e.stack&&Object.assign(d,e.stack),!0):!1},nt=()=>{if(!h.slot)return;const e={};e.pos=i,e.stack=d,Le(h.slot,e)},st=()=>{Pe(),Oe()},ot=()=>{const e=new Float32Array(16);q(!0,!1);for(let t=0;t<d.w;++t)for(let n=0;n<d.h;++n){const s=U(t,n);if(!s)return;let c=0;for(const r of s){const[l,u]=I(r),m=te(l);if(!m)continue;const g=ee(m.shader);if(!g)continue;o.useProgram(g.prog),o.uniformMatrix4fv(g.u.vp,!1,h.cam.vp);const w=j(m.mesh);if(!!w){o.bindVertexArray(w.vao);for(let M=0;M<u;++M){const A=C(t,n,c);e.set(me(A[0],A[1],A[2])),o.uniformMatrix4fv(g.u.w,!1,e),J(w),c+=m.height}}}}},ct=e=>{q(!1,!0);for(let t of e.ui){const n=ne(t);if(!n)continue;const s=p[n.name];if(!s)continue;const c=ee(n.shader);if(!c)return;o.useProgram(c.prog),o.uniformMatrix4fv(c.u.vp,!1,h.cam.o);const r=j(n.mesh);if(!r)return;o.bindVertexArray(r.vao),o.uniformMatrix4fv(c.u.w,!1,s.m),J(r)}},rt=()=>{Ie(),Ne(),Ae(),Ce(),Ye(0)},at=e=>{if(Se(e),Q()){ze();const t=Z(h.view);if(!t)return;Ze(t),je(t)}Ke(),Me()},it=()=>{if(st(),Q()){const e=Z(h.view);if(!e)return;e.draw3d&&ot(),ct(e)}};_(window,"load",()=>{rt();const e=t=>{at(t),it(),requestAnimationFrame(e)};e()});x.nextview=e=>{$e(e)};x.resetview=()=>{se()};x.newgame=e=>{h.slot=e,et()};x.loadgame=e=>{h.slot=e,tt()};x.savegame=()=>{nt()};const oe=(e,t,n,s)=>{let c=e+n,r=t+s;const l=Math.floor(e),u=Math.floor(t),m=.25;return D(l,u,-1,0)&&(c=Math.max(c,l+m)),D(l,u,1,0)&&(c=Math.min(c,l-m+1)),D(l,u,0,-1)&&(r=Math.max(r,u+m)),D(l,u,0,1)&&(r=Math.min(r,u-m+1)),[c,r]},lt=(e,t)=>{const n=a.timer.deltaTime,s=G(t);if(s){const l=90;i.ha+=l*n*s[0],i.va+=l*n*s[1],i.va=Math.max(-60,Math.min(i.va,80))}const c=G(e);if(c){const l=2,u=E(i.ha+90),m=E(i.ha),g=c[0],w=c[1],M=g*Math.cos(u)+w*Math.cos(m),A=g*Math.sin(u)+w*Math.sin(m),ce=l*n*M,re=l*n*A;[i.x,i.y]=oe(i.x,i.y,ce,re)}else[i.x,i.y]=oe(i.x,i.y,0,0);const r=N(i.x,i.y);if(Math.abs(r-i.h)<=2){const l=r-i.h;i.h+=10*n*l}else i.h=r};x.fpsmove=(e,t)=>{lt(e,t)};x.pushstack=()=>{const e=U(i.x,i.y);if(e&&e.length>0){let[t,n]=I(e[e.length-1]);n+=1,e[e.length-1]=F(t,n)}};x.popstack=()=>{const e=U(i.x,i.y);if(e&&e.length>0){let[t,n]=I(e[e.length-1]);n-=1,n>0?e[e.length-1]=F(t,n):e.pop()}};})();
