(()=>{const M=(t,e,n)=>{t.addEventListener(e,n)},ct=()=>document.getElementById("canvas"),W=()=>document.getElementById("message"),Y=t=>{const e=W();e.style.display="",e.textContent=t},it=()=>{const t=W();t.style.display="none"};const R=t=>t!==void 0,at=(t,e)=>Math.floor(t/e),dt=(t,e)=>(t%e+e)%e,C=(t,e,n)=>Math.max(e,Math.min(t,n)),V=t=>t/180*Math.PI,J=(t,e)=>Math.sqrt(t*t+e*e),ft=(t,e)=>{const n=J(t,e);return n!=0?[t/n,e/n]:[0,0]};const O=(t,e)=>t[0]*e[0]+t[1]*e[1]+t[2]*e[2],lt=t=>{const e=O(t,t);return Math.sqrt(e)},ut=(t,e)=>[t[0]+e[0],t[1]+e[1],t[2]+e[2]],ht=(t,e)=>[t[0]-e[0],t[1]-e[1],t[2]-e[2]];const k=t=>{const e=lt(t);return[t[0]/e,t[1]/e,t[2]/e]},q=(t,e)=>[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]],X=(t,e)=>{const n=V(t),o=V(e);return[Math.cos(o)*Math.cos(n),Math.sin(o),Math.cos(o)*Math.sin(n)]},mt=()=>[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],yt=(t,e)=>[t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15],t[4]*e[0]+t[5]*e[4]+t[6]*e[8]+t[7]*e[12],t[4]*e[1]+t[5]*e[5]+t[6]*e[9]+t[7]*e[13],t[4]*e[2]+t[5]*e[6]+t[6]*e[10]+t[7]*e[14],t[4]*e[3]+t[5]*e[7]+t[6]*e[11]+t[7]*e[15],t[8]*e[0]+t[9]*e[4]+t[10]*e[8]+t[11]*e[12],t[8]*e[1]+t[9]*e[5]+t[10]*e[9]+t[11]*e[13],t[8]*e[2]+t[9]*e[6]+t[10]*e[10]+t[11]*e[14],t[8]*e[3]+t[9]*e[7]+t[10]*e[11]+t[11]*e[15],t[12]*e[0]+t[13]*e[4]+t[14]*e[8]+t[15]*e[12],t[12]*e[1]+t[13]*e[5]+t[14]*e[9]+t[15]*e[13],t[12]*e[2]+t[13]*e[6]+t[14]*e[10]+t[15]*e[14],t[12]*e[3]+t[13]*e[7]+t[14]*e[11]+t[15]*e[15]],bt=t=>{const e=t[0]*t[5]-t[1]*t[4],n=t[0]*t[6]-t[2]*t[4],o=t[0]*t[7]-t[3]*t[4],r=t[1]*t[6]-t[2]*t[5],c=t[1]*t[7]-t[3]*t[5],s=t[2]*t[7]-t[3]*t[6],i=t[8]*t[13]-t[9]*t[12],a=t[8]*t[14]-t[10]*t[12],l=t[8]*t[15]-t[11]*t[12],h=t[9]*t[14]-t[10]*t[13],f=t[9]*t[15]-t[11]*t[13],u=t[10]*t[15]-t[11]*t[14];let d=e*u-n*f+o*h+r*l-c*a+s*i;return d?(d=1/d,[(t[5]*u-t[6]*f+t[7]*h)*d,(t[2]*f-t[1]*u-t[3]*h)*d,(t[13]*s-t[14]*c+t[15]*r)*d,(t[10]*c-t[9]*s-t[11]*r)*d,(t[6]*l-t[4]*u-t[7]*a)*d,(t[0]*u-t[2]*l+t[3]*a)*d,(t[14]*o-t[12]*s-t[15]*n)*d,(t[8]*s-t[10]*o+t[11]*n)*d,(t[4]*f-t[5]*l+t[7]*i)*d,(t[1]*l-t[0]*f-t[3]*i)*d,(t[12]*c-t[13]*o+t[15]*e)*d,(t[9]*o-t[8]*c-t[11]*e)*d,(t[5]*a-t[4]*h-t[6]*i)*d,(t[0]*h-t[1]*a+t[2]*i)*d,(t[13]*n-t[12]*r-t[14]*e)*d,(t[8]*r-t[9]*n+t[10]*e)*d]):mt()};const j=(t,e,n,o)=>{t[12]=e,t[13]=n,t[14]=o},H=(t,e)=>{const n=V(t),o=Math.sin(n),r=Math.cos(n);return[r,0,o,0,0,1,0,0,-o,0,r,0,0,0,0,1]};const vt=(t,e,n)=>{const o=k(ht(e,t)),r=k(q(n,o)),c=q(o,r),s=O(t,r),i=O(t,c),a=O(t,o);return[r[0],c[0],o[0],0,r[1],c[1],o[1],0,r[2],c[2],o[2],0,-s,-i,-a,1]},gt=(t,e,n,o)=>{const r=1/Math.tan(t),c=r/e,s=o/(o-n),i=-(s*n);return[c,0,0,0,0,r,0,0,0,0,s,1,0,0,i,0]};const pt=async(t,e)=>{t.adapter=await navigator.gpu.requestAdapter(),t.device=await t.adapter.requestDevice(),t.canvasFormat=navigator.gpu.getPreferredCanvasFormat(),t.canvas=ct(),t.context=t.canvas.getContext("webgpu"),t.context.configure({device:t.device,format:t.canvasFormat,alphaMode:"opaque"});const n=t.device;if(t.buffer)for(let r=0;r<t.buffer.length;++r){const c=t.buffer[r],s=await kt(e[c.embed]),i=n.createBuffer({size:s.length,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.INDEX,mappedAtCreation:!0}),a=new DataView(i.getMappedRange());for(let l=0;l<s.length;++l)a.setUint8(l,s[l]);i.unmap(),t.buffer[r]=i}if(t.shader)for(let r=0;r<t.shader.length;++r){const c=t.shader[r],s=await qt(e[c.embed]),i=n.createShaderModule({code:s});t.shader[r]=i}t.bindGroupLayout=[],t.pipelineLayout=[],t.pipeline=[],t.sampler=[],t.bindGroup=[],t.cbuffer=[],t.gbuffer=[];const o=(r,c,s)=>{t.cbuffer[r]=n.createBuffer({size:c,usage:s|GPUBufferUsage.COPY_DST})};o(0,512,GPUBufferUsage.UNIFORM),o(1,229376,GPUBufferUsage.STORAGE),o(2,65536,GPUBufferUsage.VERTEX),o(3,40960,GPUBufferUsage.INDIRECT),t.sampler[0]=n.createSampler({magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"}),t.bindGroupLayout[0]=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}]}),t.bindGroupLayout[1]=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"depth"}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:5,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),t.pipelineLayout[0]=n.createPipelineLayout({bindGroupLayouts:[t.bindGroupLayout[0]]}),t.pipelineLayout[1]=n.createPipelineLayout({bindGroupLayouts:[t.bindGroupLayout[1]]}),t.bindGroup[0]=n.createBindGroup({layout:t.bindGroupLayout[0],entries:[{binding:0,resource:{buffer:t.cbuffer[0]}},{binding:1,resource:{buffer:t.cbuffer[1]}}]}),St(t)},wt=t=>{const e=t.device,n=t.canvas;if(n.width!==n.clientWidth||n.height!==n.clientHeight){n.width=n.clientWidth,n.height=n.clientHeight;const c=i=>{R(t.gbuffer[i])&&(t.gbuffer[i].destroy(),delete t.gbuffer[i])};c(0),c(1),c(2),c(3),c(4);const s=i=>{R(t.bindGroup[i])&&delete t.bindGroup[i]};s(1),s(2),s(3)}const o=(c,s)=>{R(t.gbuffer[c])||(t.gbuffer[c]=e.createTexture({size:[n.width,n.height],format:s,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}))};o(0,"depth32float"),o(1,"rgb10a2unorm"),o(2,"rgba8unorm"),o(3,"rgba8unorm"),o(4,"rgba16float");const r=(c,s,i,a,l)=>{R(t.bindGroup[c])||(t.bindGroup[c]=e.createBindGroup({layout:t.bindGroupLayout[1],entries:[{binding:0,resource:{buffer:t.cbuffer[0]}},{binding:1,resource:t.gbuffer[s].createView()},{binding:2,resource:t.gbuffer[i].createView()},{binding:3,resource:t.gbuffer[a].createView()},{binding:4,resource:t.gbuffer[l].createView()},{binding:5,resource:t.sampler[0]}]}))};r(1,0,1,2,3),r(2,0,1,1,1),r(3,0,4,4,4)},_t=t=>{const e=t.data.gpu,n=e.device,o=new Float32Array(68);{const r=$(t).camera,c=e.canvas.width/e.canvas.height,s=V(r.fov),i=r.x,a=r.y,l=r.z,h=r.ha,f=r.va,u=X(h,f),d=[i,a,l],y=ut(d,u),b=vt(d,y,[0,1,0]),p=gt(s,c,r.near,r.far),m=yt(b,p),G=bt(m);o.set(m,0),o.set(G,16),o.set(b,32),o.set(d,48)}{const r=$(t).light,c=r.ha,s=r.va,i=S(r.color,0,0,0,0),a=S(r.ambient0,0,0,0,0),l=S(r.ambient1,0,0,0,0),h=X(c,s);o.set(h,52),o.set(i,56),o.set(a,60),o.set(l,64)}n.queue.writeBuffer(e.cbuffer[0],0,o)},xt=t=>{const e=t.data.gpu,n=e.device,o=[];o.length=e.segment.length;for(let f=0;f<o.length;++f)o[f]=[];const r=new Float32Array(28),c=4*28;let s=0;for(const f of $(t).room){const u=Z(t,f.data);if(u&&u.layout)for(const d of u.layout)for(let y=0;y<d.indices.length;++y){const v=dt(y,d.divisor),b=at(y,d.divisor),p=f.x+v*d.unit,m=f.y,G=f.z+b*d.unit,A=f.ha,L=f.va,_=d.node[d.indices[y]];if(_)for(const P of _.mesh){const g=u.mesh[P];if(!g)continue;const w=e.mesh[g.data];if(!w)continue;for(const st of w.segment)o[st].push(s);const z=p+g.x,E=m+g.y,F=G+g.z,U=A+g.ha,et=L+g.va,N=H(U,et);j(N,z,E,F);const nt=S(g.factor0,1,1,1,1),ot=S(g.factor1,1,1,1,0),rt=S(g.factor2,0,0,0,0);r.set(N,0),r.set(nt,16),r.set(ot,20),r.set(rt,24),n.queue.writeBuffer(e.cbuffer[1],s*c,r),s+=1}}}for(const f of $(t).mob){const u=I(t,f.data);if(!u)continue;const d=f.x,y=f.y,v=f.z,b=f.ha,p=f.va;for(const m of u.mesh){const G=e.mesh[m.data];if(!G)continue;for(const U of G.segment)o[U].push(s);const A=d+m.x,L=y+m.y,_=v+m.z,P=b+m.ha,g=p+m.va,w=H(P,g);j(w,A,L,_);const z=S(m.factor0,1,1,1,1),E=S(m.factor1,1,1,1,0),F=S(m.factor2,0,0,0,0);r.set(w,0),r.set(z,16),r.set(E,20),r.set(F,24),n.queue.writeBuffer(e.cbuffer[1],s*c,r),s+=1}}const i=[];let a=0,l=0;const h=new Uint32Array(5);for(let f=0;f<o.length;++f){if(o[f].length<=0)continue;const u=e.segment[f],d=o[f].length;n.queue.writeBuffer(e.cbuffer[2],a*4,new Uint32Array(o[f])),h[0]=u.count,h[1]=d,h[2]=0,h[3]=0,h[4]=0,n.queue.writeBuffer(e.cbuffer[3],l,h),i.push({id:f,first:a,offset:l}),a+=d,l+=20}return i},St=t=>{const e=t.device;t.pipeline[0]=e.createRenderPipeline({layout:t.pipelineLayout[0],vertex:{module:t.shader[0],entryPoint:"VS",buffers:[{arrayStride:4,attributes:[{format:"uint32",offset:0,shaderLocation:0}],stepMode:"instance"},{arrayStride:12,attributes:[{format:"float32x3",offset:0,shaderLocation:1}]},{arrayStride:12,attributes:[{format:"float32x3",offset:0,shaderLocation:2}]}]},fragment:{module:t.shader[0],entryPoint:"FS",targets:[{format:"rgb10a2unorm"},{format:"rgba8unorm"},{format:"rgba8unorm"},{format:"rgba16float"}]},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth32float"},primitive:{cullMode:"back",frontFace:"cw"}}),t.pipeline[1]=e.createRenderPipeline({layout:t.pipelineLayout[1],vertex:{module:t.shader[1],entryPoint:"VS",buffers:[]},fragment:{module:t.shader[1],entryPoint:"FS_SSAO",targets:[{format:"rgba8unorm",blend:{color:{operation:"min",srcFactor:"one",dstFactor:"one"},alpha:{}},writeMask:GPUColorWrite.RED}]}}),t.pipeline[2]=e.createRenderPipeline({layout:t.pipelineLayout[1],vertex:{module:t.shader[1],entryPoint:"VS",buffers:[]},fragment:{module:t.shader[1],entryPoint:"FS_HDR",targets:[{format:"rgba16float",blend:{color:{operation:"add",srcFactor:"one",dstFactor:"one"},alpha:{}}}]},depthStencil:{depthWriteEnabled:!1,depthCompare:"not-equal",format:"depth32float"}}),t.pipeline[3]=e.createRenderPipeline({layout:t.pipelineLayout[1],vertex:{module:t.shader[1],entryPoint:"VS",buffers:[]},fragment:{module:t.shader[1],entryPoint:"FS_HDRSky",targets:[{format:"rgba16float",blend:{color:{operation:"add",srcFactor:"one",dstFactor:"one"},alpha:{}}}]},depthStencil:{depthWriteEnabled:!1,depthCompare:"equal",format:"depth32float"}}),t.pipeline[4]=e.createRenderPipeline({layout:t.pipelineLayout[1],vertex:{module:t.shader[1],entryPoint:"VS",buffers:[]},fragment:{module:t.shader[1],entryPoint:"FS_HDR2LDR",targets:[{format:t.canvasFormat}]},depthStencil:{depthWriteEnabled:!1,depthCompare:"always",format:"depth32float"}}),t.pipeline[5]=e.createRenderPipeline({layout:t.pipelineLayout[0],vertex:{module:t.shader[2],entryPoint:"VS",buffers:[{arrayStride:12,attributes:[{format:"float32x3",offset:0,shaderLocation:0}]},{arrayStride:4,attributes:[{format:"unorm8x4",offset:0,shaderLocation:1}]}]},fragment:{module:t.shader[2],entryPoint:"FS",targets:[{format:t.canvasFormat}]},depthStencil:{depthWriteEnabled:!1,depthCompare:"less",format:"depth32float"},primitive:{topology:"line-list"}})},Gt=t=>{const e=t.data.gpu;wt(e)},Pt=t=>{_t(t);const e=xt(t),n=t.data.gpu,o=n.device,r=o.createCommandEncoder();Mt(r,n,e),Rt(r,n),Bt(r,n),$t(r,n),o.queue.submit([r.finish()])},Mt=(t,e,n)=>{const o=t.beginRenderPass({depthStencilAttachment:{view:e.gbuffer[0].createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"},colorAttachments:[{view:e.gbuffer[1].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"},{view:e.gbuffer[2].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"},{view:e.gbuffer[3].createView(),clearValue:{r:1,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"},{view:e.gbuffer[4].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}]});for(const r of n){o.setPipeline(e.pipeline[0]),o.setBindGroup(0,e.bindGroup[0]),o.setVertexBuffer(0,e.cbuffer[2],r.first*4);const c=e.segment[r.id];if(c.vb0){const[s,i,a]=c.vb0;o.setVertexBuffer(1,e.buffer[s],i,a)}if(c.vb1){const[s,i,a]=c.vb1;o.setVertexBuffer(2,e.buffer[s],i,a)}if(c.ib){const[s,i,a]=c.ib;o.setIndexBuffer(e.buffer[s],"uint16",i,a)}o.drawIndexedIndirect(e.cbuffer[3],r.offset)}o.end()},Rt=(t,e)=>{const n=t.beginRenderPass({colorAttachments:[{view:e.gbuffer[3].createView(),loadOp:"load",storeOp:"store"}]});n.setPipeline(e.pipeline[1]),n.setBindGroup(0,e.bindGroup[2]),n.draw(4),n.end()},Bt=(t,e)=>{const n=t.beginRenderPass({depthStencilAttachment:{view:e.gbuffer[0].createView(),depthReadOnly:!0},colorAttachments:[{view:e.gbuffer[4].createView(),loadOp:"load",storeOp:"store"}]});n.setPipeline(e.pipeline[2]),n.setBindGroup(0,e.bindGroup[1]),n.draw(4),n.setPipeline(e.pipeline[3]),n.draw(4),n.end()},$t=(t,e)=>{const n=t.beginRenderPass({depthStencilAttachment:{view:e.gbuffer[0].createView(),depthReadOnly:!0},colorAttachments:[{view:e.context.getCurrentTexture().createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}]});n.setPipeline(e.pipeline[4]),n.setBindGroup(0,e.bindGroup[3]),n.draw(4),n.end()},K=(t,e)=>{t[e]||(t[e]={})},B=(t,e,n)=>{K(t,e),n=n||0;const o=t[e];o&&!o.hold&&(o.value=Math.max(0,n))},T=(t,e,n,o)=>{K(t,e),n=n||0,o=o||!1;const r=t[e];r&&(r.value=Math.max(0,n),r.hold=o)},zt=(t,e)=>{const n=t[e];n&&(n.history=n.value)},Et=(t,e)=>{const n=t[e];return n&&n.value||0};const Ft=t=>{if(!t)return!1;for(const e of t.buttons)if(e.value>.5)return!0;for(const e of t.axes)if(Math.abs(e)>.5)return!0;return!1},Ut=t=>{const e=t.hid,n=t.data.hid,o=()=>{for(const s in n.keyboard)T(e.map,n.keyboard[s],0,!1);for(const s of n.mouse.button)T(e.map,s,0,!1)},r=(s,i,a)=>{const l=n.keyboard[s.code];l&&(T(e.map,l,i,a),s.preventDefault(),e.last=-1)},c=(s,i,a)=>{const l=n.mouse.button[s.button];l&&(T(e.map,l,i,a),s.preventDefault(),e.last=-1)};M(document.body,"contextmenu",s=>{s.preventDefault()}),M(window,"blur",s=>{o()}),M(document,"keydown",s=>{r(s,1,!0)}),M(document,"keyup",s=>{r(s,0,!1)}),M(document,"mousedown",s=>{c(s,1,!0)}),M(document,"mouseup",s=>{c(s,0,!1)}),M(document,"mousemove",s=>{if(!(s.buttons&2))return;const i=.25,a=n.mouse.movementX;a&&(B(e.map,a[0],-s.movementX*i),B(e.map,a[1],s.movementX*i));const l=n.mouse.movementY;l&&(B(e.map,l[0],-s.movementY*i),B(e.map,l[1],s.movementY*i)),s.preventDefault(),e.last=-1}),o()},Vt=t=>{const e=t.hid,n=t.data.hid;{const o=navigator.getGamepads();for(let c=0;c<o.length;++c)if(Ft(o[c])){e.last=c;break}const r=o[e.last];if(r){const c=n.gamepad;for(let s=0;s<r.buttons.length;++s){const i=c.buttons[s];i&&B(e.map,i,r.buttons[s].value)}for(let s=0;s<r.axes.length;++s){const i=c.axes[s];if(!i)continue;const a=Math.trunc(r.axes[s]*4)/4;B(e.map,i[0],-a),B(e.map,i[1],a)}}}},At=t=>{const e=t.hid;for(const n in e.map)zt(e.map,n),B(e.map,n,0)},Q={},Lt=t=>{const e=$(t);if(!e)return;const n=tt(t,e.data);if(!n)return;const o=Q[e.data]||{},r=n.step||[],c=i=>{for(let a=0;a<r.length;++a)if(r[a].label&&r[a].label===i)return a;return-1};let s=!1;for(;!s;){const i=r[e.step];if(i){if(i.event){const a=o[i.event];a&&a(t)}i.solve&&Ot(t),i.goto?e.step=c(i.goto):e.step+=1,i.yield&&(s=!0)}else e.step=-1,s=!0}e.step<0&&t.stage.pop()},Tt=(t,e)=>{const n=tt(t,e);if(!n)return;const o={data:e,step:0,room:structuredClone(n.room)||[],mob:structuredClone(n.mob)||[],camera:structuredClone(n.camera[0]),light:structuredClone(n.light[0])};t.stage.push(o)},Ot=t=>{const e=$(t).mob;for(let o=0;o<e.length;++o)for(let r=o+1;r<e.length;++r)Ct(t,e[o],e[r]);const n=$(t).room;for(let o=0;o<e.length;++o)for(let r=0;r<n.length;++r)Dt(t,e[o],n[r])},Ct=(t,e,n)=>{const[o,r,c,s,i,a]=D(t,e),[l,h,f,u,d,y]=D(t,n);if(r+i<=h||h+d<=r)return;const v=J(l-o,f-c)-(s+u);if(v>=0)return;const b=a/(a+y),[p,m]=ft(l-o,f-c);e.x=o+v*p*b,e.z=c+v*m*b,n.x=l-v*p*(1-b),n.z=f-v*m*(1-b)},Dt=(t,e,n)=>{const[o,r,c,s,i,a]=D(t,e),l=Z(t,n.data);if(!l)return;const h=n.x,f=n.y,u=n.z;for(const d of l.layout){const y=(z,E)=>{if(z<0||E<0||d.divisor<=z)return 0;const F=z+E*d.divisor;if(d.indices.length<=F)return 0;const U=d.node[d.indices[F]];return U?f+(U.height||0):0},v=Math.round((o-h)/d.unit),b=Math.round((c-u)/d.unit),p=y(v,b);e.y=p;const m=y(v-1,b),G=y(v+1,b),A=y(v,b-1),L=y(v,b+1),_=h+v*d.unit,P=u+b*d.unit,g=d.unit,w=g/2-s;e.x=C(o,Math.abs(m-p)<=.5?_-g:_-w,Math.abs(G-p)<=.5?_+g:_+w),e.z=C(c,Math.abs(A-p)<=.5?P-g:P-w,Math.abs(L-p)<=.5?P+g:P+w)}},S=(t,e,n,o,r)=>(t&&(R(t.r)&&(e=t.r),R(t.g)&&(n=t.g),R(t.r)&&(o=t.b),R(t.a)&&(r=t.a)),[e,n,o,r]),D=(t,e)=>{const n=I(t,e.data);if(!n)return[0,0,0,0,0,0];const o=e.x,r=e.y,c=e.z,s=n.radius||0,i=n.height||0,a=(n.mass||0)+.01;return[o,r,c,s,i,a]},It=(t,e)=>{t.data.loading+=1,(async()=>{const r=await(await fetch("app.json")).json(),c=t.data;Object.assign(c,r),Ut(t),c.gpu&&await pt(c.gpu,c.embed),Tt(t,e),delete c.embed,c.loading-=1})()},Nt=t=>t.data.loading<=0,kt=async t=>{const e=window.atob(t),n=new Uint8Array(e.length);for(let c=0;c<e.length;++c)n[c]=e.charCodeAt(c);const o=new Blob([n]).stream().pipeThrough(new DecompressionStream("deflate-raw")),r=await new Response(o).arrayBuffer();return new Uint8Array(r)},qt=async t=>{const e=window.atob(t),n=new Uint8Array(e.length);for(let c=0;c<e.length;++c)n[c]=e.charCodeAt(c);const o=new Blob([n]).stream().pipeThrough(new DecompressionStream("deflate-raw"));return await new Response(o).text()};const Z=(t,e)=>t.data.room[e],I=(t,e)=>t.data.mob[e],tt=(t,e)=>t.data.stage[e],x=(t,e)=>Et(t.hid.map,e);const $=t=>t.stage.at(-1),Xt=(t,e)=>{Q[t]=e},jt=async t=>{if(!navigator.gpu){Y("ERROR: WebGPU not supported.");return}const e={dt:0,now:0,data:{loading:0},hid:{map:{},last:0},stage:[]};It(e,t);const n=o=>{e.dt=(o-e.now)/1e3,e.now=o,Nt(e)&&(Vt(e),Gt(e),Lt(e),Pt(e),At(e)),requestAnimationFrame(n)};requestAnimationFrame(n)};Xt("main",{setup:t=>{it()},update:t=>{const e=t.dt,n=$(t),o=n.mob.find(c=>c.data==="p000");if(o){const c=I(t,o.data),s=[0,0];s[0]+=-x(t,"l0"),s[0]+=x(t,"l1"),s[1]+=x(t,"l2"),s[1]+=-x(t,"l3");const i=[0,0];i[0]+=-x(t,"r0"),i[0]+=x(t,"r1"),i[1]+=x(t,"r2"),i[1]+=-x(t,"r3");const a=x(t,"b1");if(i){const f=-i[0],u=i[1];o.ha+=90*e*f,o.va+=90*e*u,o.va=C(o.va,-60,80)}if(s){const h=a?4:2,f=V(o.ha+90),u=V(o.ha),d=-s[0],y=s[1],v=d*Math.cos(f)+y*Math.cos(u),b=d*Math.sin(f)+y*Math.sin(u),p=h*e*v,m=h*e*b;o.x+=p,o.z+=m}const l=n.camera;l.x=o.x,l.y=o.y+c.height,l.z=o.z,l.ha=o.ha,l.va=o.va}const r=n.light;r.ha+=45*e}});M(window,"load",()=>{Y("Welcome Basilico."),jt("main")});})();
