(()=>{const X=e=>{const t=window.atob(e),n=new ArrayBuffer(t.length),o=new DataView(n);for(let c=0;c<t.length;++c)o.setUint8(c,t.charCodeAt(c));return n};const E=e=>e/180*Math.PI,ce=(e,t)=>Math.sqrt(e*e+t*t),A=(e,t)=>{const n=ce(e,t);return n!=0?[e/n,t/n]:[0,0]};const re=([e,t],n,o,c,r)=>n<=e&&e<=o&&c<=t&&t<=r,L=(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],ie=e=>{const t=L(e,e);return Math.sqrt(t)},le=(e,t)=>[e[0]+t[0],e[1]+t[1],e[2]+t[2]],ae=(e,t)=>[e[0]-t[0],e[1]-t[1],e[2]-t[2]];const C=e=>{const t=ie(e);return[e[0]/t,e[1]/t,e[2]/t]},Y=(e,t)=>[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]],ue=(e,t)=>{const n=E(e),o=E(t);return[Math.cos(o)*Math.cos(n),Math.cos(o)*Math.sin(n),Math.sin(o)]},H=(e,t,n)=>[e*2,t*2,n*.5],fe=()=>[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],de=(e,t)=>[e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15]],he=e=>{const t=e[0]*e[5]-e[1]*e[4],n=e[0]*e[6]-e[2]*e[4],o=e[0]*e[7]-e[3]*e[4],c=e[1]*e[6]-e[2]*e[5],r=e[1]*e[7]-e[3]*e[5],i=e[2]*e[7]-e[3]*e[6],u=e[8]*e[13]-e[9]*e[12],_=e[8]*e[14]-e[10]*e[12],g=e[8]*e[15]-e[11]*e[12],w=e[9]*e[14]-e[10]*e[13],v=e[9]*e[15]-e[11]*e[13],k=e[10]*e[15]-e[11]*e[14];let m=t*k-n*v+o*w+c*g-r*_+i*u;return m?(m=1/m,[(e[5]*k-e[6]*v+e[7]*w)*m,(e[2]*v-e[1]*k-e[3]*w)*m,(e[13]*i-e[14]*r+e[15]*c)*m,(e[10]*r-e[9]*i-e[11]*c)*m,(e[6]*g-e[4]*k-e[7]*_)*m,(e[0]*k-e[2]*g+e[3]*_)*m,(e[14]*o-e[12]*i-e[15]*n)*m,(e[8]*i-e[10]*o+e[11]*n)*m,(e[4]*v-e[5]*g+e[7]*u)*m,(e[1]*g-e[0]*v-e[3]*u)*m,(e[12]*r-e[13]*o+e[15]*t)*m,(e[9]*o-e[8]*r-e[11]*t)*m,(e[5]*_-e[4]*w-e[6]*u)*m,(e[0]*w-e[1]*_+e[2]*u)*m,(e[13]*n-e[12]*c-e[14]*t)*m,(e[8]*c-e[9]*n+e[10]*t)*m]):fe()},V=(e,t,n)=>[1,0,0,0,0,1,0,0,0,0,1,0,e,t,n,1],me=(e,t,n,o)=>{e[12]=t,e[13]=n,e[14]=o},_e=(e,t,n)=>[e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1],we=(e,t,n)=>{const o=C(ae(t,e)),c=C(Y(n,o)),r=Y(o,c),i=L(e,c),u=L(e,r),_=L(e,o);return[c[0],r[0],o[0],0,c[1],r[1],o[1],0,c[2],r[2],o[2],0,-i,-u,-_,1]},xe=(e,t,n,o)=>{const c=1/Math.tan(e),r=c/t,i=o/(o-n),u=-(i*n);return[r,0,0,0,0,c,0,0,0,0,i,1,0,0,u,0]},ge=(e,t,n,o)=>{const c=2/e,r=2/t,i=1/(o-n),u=n/(n-o);return[c,0,0,0,0,r,0,0,0,0,i,0,0,0,u,1]},T=0,S=1,R=2;var l=null;const x=(e,t,n)=>{e.addEventListener(t,n)},ve=()=>{const e=document.body;e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.msUserSelect="none",e.style.mozUserSelect="none"},pe=()=>{const e=document.body;e.style.touchAction="none"},Te=()=>{ve(),pe(),l={},l.mode=T,l.timer={prevTime:performance.now(),deltaTime:0},l.gamepad={index:null,lx:0,ly:0,rx:0,ry:0,b0:!1,b1:!1,b8:!1,b9:!1,lt:!1,rt:!1},l.keyboard={w:!1,a:!1,s:!1,d:!1,up:!1,left:!1,down:!1,right:!1,z:!1,x:!1,space:!1,lctrl:!1,esc:!1},l.touch=new Map,l.click=[],x(window,"focus",e=>{}),x(window,"blur",e=>{}),x(window,"resize",e=>{}),x(window,"gamepadconnected",e=>{l.gamepad.index=e.gamepad.index,l.mode=S}),x(window,"gamepaddisconnected",e=>{l.gamepad.index===e.gamepad.index&&(l.gamepad.index=null)}),x(document,"keydown",e=>{$(l.keyboard,e.code,!0)&&(l.mode=R,e.preventDefault())}),x(document,"keyup",e=>{$(l.keyboard,e.code,!1)&&(l.mode=R,e.preventDefault())}),x(document.body,"contextmenu",e=>{e.preventDefault()}),x(document.body,"pointerdown",e=>{l.touch.set(e.pointerId,{x:e.clientX,y:e.clientY,sx:e.clientX,sy:e.clientY,time:performance.now()}),l.mode=T}),x(document.body,"pointerup",e=>{ke(e.pointerId),l.touch.delete(e.pointerId),l.mode=T}),x(document.body,"pointerout",e=>{l.touch.delete(e.pointerId),l.mode=T}),x(document.body,"pointermove",e=>{const t=l.touch.get(e.pointerId);t&&(t.x=e.clientX,t.y=e.clientY,l.mode=T)})},$=(e,t,n)=>{switch(t){case"KeyW":e.w=n;break;case"KeyA":e.a=n;break;case"KeyS":e.s=n;break;case"KeyD":e.d=n;break;case"ArrowUp":e.up=n;break;case"ArrowLeft":e.left=n;break;case"ArrowDown":e.down=n;break;case"ArrowRight":e.right=n;break;case"KeyZ":e.z=n;break;case"KeyX":e.x=n;break;case"Space":e.space=n;break;case"ControlLeft":e.lctrl=n;break;case"Escape":e.esc=n;break;default:return!1}return!0},ke=e=>{const t=l.touch.get(e);t&&performance.now()-t.time<250&&l.click.push({x:t.x,y:t.y})},ye=(e,t)=>{e.deltaTime=(t-e.prevTime)/1e3,e.prevTime=t},Ae=e=>{if(e.index!==null){const n=navigator.getGamepads()[e.index];e.lx=Math.trunc(n.axes[0]*4)/4,e.ly=Math.trunc(n.axes[1]*4)/4,e.rx=Math.trunc(n.axes[2]*4)/4,e.ry=Math.trunc(n.axes[3]*4)/4,e.b0=n.buttons[0].value>=.5,e.b1=n.buttons[1].value>=.5,e.b8=n.buttons[8].value>=.5,e.b9=n.buttons[9].value>=.5,e.lt=n.buttons[6].value>=.5,e.rt=n.buttons[7].value>=.5,!!(e.lx||e.ly||e.rx||e.ry||e.b0||e.b1||e.b8||e.b9||e.lt||e.rt)&&(l.mode=S)}},Ee=e=>{ye(l.timer,e),Ae(l.gamepad)},Se=()=>{l.click.length=0},Re=e=>{const t=localStorage.getItem(e);return t==null?null:JSON.parse(t)},Me=(e,t)=>{const n=JSON.stringify(t);localStorage.setItem(e,n)};var s=null;const Le=()=>{s=document.getElementById("main").getContext("webgl2")},Ie=e=>{let t=s.createTexture();return s.bindTexture(s.TEXTURE_2D,t),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,e),s.bindTexture(s.TEXTURE_2D,null),t},be=(e,t,n)=>{const o=document.createElement("canvas");if(!o)return null;o.width=t,o.height=n;const c=o.getContext("2d");return c?(c.fillStyle="white",c.textAlign="center",c.textBaseline="middle",c.font="24px monospace",c.fillText(e,o.width/2,o.height/2),o):null},z=(e,t)=>{const n=s.createShader(e);return s.shaderSource(n,t),s.compileShader(n),s.getShaderParameter(n,s.COMPILE_STATUS)?n:(s.deleteShader(n),null)},Ue=(e,t)=>{const n=s.createProgram();return s.attachShader(n,e),s.attachShader(n,t),s.linkProgram(n),s.getProgramParameter(n,s.LINK_STATUS)?n:(s.deleteProgram(n),null)},K=(e,t)=>{let n=s.createBuffer();return s.bindBuffer(e,n),s.bufferData(e,t,s.STATIC_DRAW),n},I=(e,t,n,o,c,r)=>{s.enableVertexAttribArray(e),s.vertexAttribPointer(e,t,n,o,c,r)},De=()=>{const e=window.innerWidth;e!==s.canvas.width&&(s.canvas.width=e);const t=window.innerHeight;t!==s.canvas.height&&(s.canvas.height=t)},Ge=()=>{s.viewport(0,0,s.canvas.width,s.canvas.height),s.clearColor(0,0,0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)},Pe=(e,t)=>{s.enable(s.CULL_FACE),e?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST),t?(s.enable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA)):(s.disable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA))},Fe=(e,t)=>{t=t||0;const n=e.iv[t*3+0],o=e.iv[t*3+1],c=e.iv[t*3+2],r=[null,s.POINTS,s.LINES,s.TRIANGLES];e.i?s.drawElements(r[n],c,s.UNSIGNED_SHORT,2*o):s.drawArrays(r[n],o,c)},Oe=(e,t)=>{s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,e.texture),s.uniform1i(t,0)};var Ne=null;const Be=()=>{Ne=new AudioContext};const W=0,q=1,J=2,Q=3,Xe=e=>{if(e.vao=s.createVertexArray(),s.bindVertexArray(e.vao),e.b&&(e.b=K(s.ARRAY_BUFFER,X(e.b)),e.bv))for(let t=0;t<e.bv.length;t+=2)switch(e.bv[t]){case W:I(W,3,s.FLOAT,!1,0,e.bv[t+1]);break;case q:I(q,3,s.HALF_FLOAT,!1,0,e.bv[t+1]);break;case J:I(J,4,s.UNSIGNED_BYTE,!0,0,e.bv[t+1]);break;case Q:I(Q,2,s.HALF_FLOAT,!1,0,e.bv[t+1]);break}return e.i&&(e.i=K(s.ELEMENT_ARRAY_BUFFER,X(e.i))),s.bindVertexArray(null),e},Ce=e=>{if(e.vs=z(s.VERTEX_SHADER,e.vs),e.fs=z(s.FRAGMENT_SHADER,e.fs),e.prog=Ue(e.vs,e.fs),e.u){const t={};for(let n of e.u)t[n]=s.getUniformLocation(e.prog,n);e.u=t}if(e.ub){const t={};let n=0;for(let o of e.ub){const c=s.getUniformBlockIndex(e.prog,o);s.uniformBlockBinding(e.prog,c,n),t[o]=n,n+=1}e.ub=t}return e},Ye=e=>(e.texture=Ie(be(e.text,e.width,e.height)),e),f={index:null,pack:[]},Z=()=>f.index!=null&&f.pack.length>0,He=()=>{fetch("data/index.json").then(t=>t.json()).then(t=>{f.index=t})},Ve=e=>{const t="data/pack"+e+".json";fetch(t).then(n=>n.json()).then(n=>{n.mesh&&(n.mesh=n.mesh.map(o=>Xe(o))),n.texture&&(n.texture=n.texture.map(o=>Ye(o))),n.shader&&(n.shader=n.shader.map(o=>Ce(o))),f.pack[e]=n})},j=e=>f.pack[0]&&f.pack[0].view[e],$e=e=>f.pack[0]&&f.pack[0].view.findIndex(t=>t.name===e),ze=e=>f.pack[0]&&f.pack[0].mesh[e],Ke=e=>f.pack[0]&&f.pack[0].texture[e],We=e=>f.pack[0]&&f.pack[0].shader[e],qe=e=>f.pack[0]&&f.pack[0].draw[e],ee=e=>f.pack[0]&&f.pack[0].stack.find(t=>t.id===e),te=e=>f.pack[0]&&f.pack[0].ui[e],Je=e=>f.pack[0]&&f.pack[0].event[e],d={view:null,slot:null,cam:{eye:[0,0,0],vp:new Float32Array(16),ivp:new Float32Array(16),o:new Float32Array(16)},m:new Float32Array(16)},ne=()=>{d.slot=null,d.view=f.index.initial_view},Qe=e=>{const t=$e(e);t<0||(d.view=t)},Ze=()=>{d.view===null&&ne()},je=()=>{const e=window.innerWidth,t=window.innerHeight,n=E(30),o=.1,c=1e3,r=ue(a.ha,a.va),i=H(a.x,a.y,a.h);i[2]+=a.eyeh;const u=le(i,r),g=we(i,u,[0,0,1]),w=xe(n,e/t,o,c),v=de(g,w);d.cam.vp.set(v),d.cam.ivp.set(he(v)),d.cam.o.set(ge(e,t,0,1)),d.cam.eye=i},y={},P=e=>{const t=y[e];return t?t.value:null},et=0,F=0,M=1,O=(e,t)=>{const n=window.innerWidth,o=window.innerHeight,c=window.devicePixelRatio,r=n/2+(e.offset[0]-e.width/2)*c,i=n/2+(e.offset[0]+e.width/2)*c,u=o/2+(e.offset[1]-e.height/2)*c,_=o/2+(e.offset[1]+e.height/2)*c;return re(t,r,i,u,_)},tt=(e,t)=>{const n=l.mode;if(n===T){let o=!1;const c=l.click;for(let r of c)if(O(t,[r.x,r.y])){o=!0;break}o?(e.value=!0,e.state=M):(e.value=!1,e.state=F)}else n===S?l.gamepad[t.gamepad]?e.state!==M?(e.value=!0,e.state=M):e.value=!1:(e.value=!1,e.state=F):n===R&&(l.keyboard[t.keyboard]?e.state!==M?(e.value=!0,e.state=M):e.value=!1:(e.value=!1,e.state=F))},nt=(e,t)=>{const n=l.mode;if(n===T){e.value=[0,0];for(const o of l.touch.values())if(O(t,[o.sx,o.sy])){const c=o.x-o.sx,r=-(o.y-o.sy);e.value=A(c,r);break}}else if(n===S){const o=l.gamepad;e.value=A(o.lx,-o.ly)}else if(n===R){const o=l.keyboard,c=o.a?-1:o.d?1:0,r=o.w?1:o.s?-1:0;e.value=A(c,r)}},ot=(e,t)=>{const n=l.mode;if(n===T){e.value=[0,0];for(const o of l.touch.values())if(O(t,[o.sx,o.sy])){const c=o.x-o.sx,r=-(o.y-o.sy);e.value=A(c,r);break}}else if(n===S){const o=l.gamepad;e.value=A(o.rx,-o.ry)}else if(n===R){const o=l.keyboard,c=o.right?1:o.left?-1:0,r=o.up?1:o.down?-1:0;e.value=A(c,r)}},st=e=>{for(const t in y)y[t].value=null;for(let t of e.ui){const n=te(t);if(!n)continue;y[n.name]||(y[n.name]={m:new Float32Array(16),value:null,state:et});const o=y[n.name];switch(n.interact){case 1:tt(o,n);break;case 2:nt(o,n);break;case 3:ot(o,n);break;default:break}const c=window.devicePixelRatio,r=_e(n.width/2*c,n.height/2*c,1);me(r,n.offset[0]*c,-n.offset[1]*c,0),o.m.set(r)}},h={w:0,h:0,a:[]},b=(e,t)=>e<<0|t<<16,U=e=>[e>>0&65535,e>>16&65535],D=(e,t)=>(e=Math.floor(e),t=Math.floor(t),e<0||h.w<=e||t<0||h.h<=t?null:h.a[e+t*h.h]),N=(e,t)=>{const n=D(e,t);if(!n)return 0;let o=0;for(const c of n){const[r,i]=U(c),u=ee(r);!u||(o+=i*u.height)}return o},G=(e,t,n,o)=>{const c=N(e,t),r=N(e+n,t+o);return Math.abs(c-r)>1},a={x:0,y:0,ha:0,va:0,h:0,eyeh:1.75},p={},ct=e=>{for(let t of e.event){const n=Je(t);if(!n)continue;let o=!1;switch(n.trigger){case 0:o=!0;break;case 1:o=P(n.target);break}if(o)for(const c of n.action){const r=p[c[0]];if(!r)continue;const i=c.slice(1);r(...i)}}},rt=()=>{h.w=0,h.h=0,h.a.length=0,a.x=0,a.y=0,a.ha=0,a.va=0},it=()=>{if(!d.slot)return!1;const e=Re(d.slot);return e?(e.pos&&Object.assign(a,e.pos),e.stack&&Object.assign(h,e.stack),!0):!1},lt=()=>{if(!d.slot)return;const e={};e.pos=a,e.stack=h,Me(d.slot,e)},at=()=>{De(),Ge()},B=(e,t,n)=>{const o=qe(e);if(!o)return;Pe(o.depth,o.alpha);const c=We(o.shader);if(!c)return;s.useProgram(c.prog);const r=ze(o.mesh);if(!r)return;s.bindVertexArray(r.vao),s.uniformMatrix4fv(c.u.vp,!1,o.ortho?d.cam.o:d.cam.vp);const i=Ke(o.texture);i&&Oe(i,c.u.tex0);for(let u=0;u<t;++u)n(c.u,u),Fe(r)},ut=()=>{for(let e=0;e<h.w;++e)for(let t=0;t<h.h;++t){const n=D(e,t);if(!n)continue;let o=0;for(const c of n){const[r,i]=U(c),u=ee(r);!u||B(u.draw,i,(_,g)=>{const w=H(e,t,o);d.m.set(V(w[0],w[1],w[2])),s.uniformMatrix4fv(_.w,!1,d.m),o+=u.height})}}},ft=e=>{for(let t of e.ui){const n=te(t);if(!n)continue;const o=y[n.name];!o||B(n.draw,1,(c,r)=>{s.uniformMatrix4fv(c.w,!1,o.m)})}},dt=e=>{const t=e.skybox;t<0||B(t,1,(n,o)=>{d.m.set(V(...d.cam.eye)),s.uniformMatrix4fv(n.w,!1,d.m)})},ht=e=>{dt(e),e.draw3d&&ut(),ft(e)},mt=()=>{Le(),Be(),Te(),He(),Ve(0)},_t=e=>{if(Ee(e),Z()){Ze();const t=j(d.view);if(!t)return;st(t),ct(t)}je(),Se()},wt=()=>{if(at(),Z()){const e=j(d.view);if(!e)return;ht(e)}};x(window,"load",()=>{mt();const e=t=>{_t(t),wt(),requestAnimationFrame(e)};e()});p.nextview=e=>{Qe(e)};p.resetview=()=>{ne()};p.newgame=e=>{d.slot=e,rt()};p.loadgame=e=>{d.slot=e,it()};p.savegame=()=>{lt()};const oe=(e,t,n,o)=>{let c=e+n,r=t+o;const i=Math.floor(e),u=Math.floor(t),_=.25;return G(i,u,-1,0)&&(c=Math.max(c,i+_)),G(i,u,1,0)&&(c=Math.min(c,i-_+1)),G(i,u,0,-1)&&(r=Math.max(r,u+_)),G(i,u,0,1)&&(r=Math.min(r,u-_+1)),[c,r]},xt=(e,t)=>{const n=l.timer.deltaTime,o=P(t);if(o){const i=90;a.ha+=i*n*o[0],a.va+=i*n*o[1],a.va=Math.max(-60,Math.min(a.va,80))}const c=P(e);if(c){const i=2,u=E(a.ha+90),_=E(a.ha),g=c[0],w=c[1],v=g*Math.cos(u)+w*Math.cos(_),k=g*Math.sin(u)+w*Math.sin(_),m=i*n*v,se=i*n*k;[a.x,a.y]=oe(a.x,a.y,m,se)}else[a.x,a.y]=oe(a.x,a.y,0,0);const r=N(a.x,a.y);if(Math.abs(r-a.h)<=2){const i=r-a.h;a.h+=10*n*i}else a.h=r};p.fpsmove=(e,t)=>{xt(e,t)};p.makeworld=()=>{h.w=64,h.h=64,h.a.length=0,h.a.length=h.w*h.h;for(let e=0;e<h.a.length;++e)h.a[e]=[],h.a[e].push(b(1,1));a.x=h.w/2+.5,a.y=h.h/2+.5};p.pushstack=()=>{const e=D(a.x,a.y);if(!!e)if(e.length>0){let[t,n]=U(e[e.length-1]);n+=1,e[e.length-1]=b(t,n)}else e.push(b(1,1))};p.popstack=()=>{const e=D(a.x,a.y);if(!!e&&e.length>0){let[t,n]=U(e[e.length-1]);n-=1,n>0?e[e.length-1]=b(t,n):e.pop()}};})();
