(()=>{const R=(e,t,o)=>{e.addEventListener(t,o)},ce=()=>document.getElementById("canvas"),J=()=>document.getElementById("message"),K=e=>{const t=J();t.style.display="",t.textContent=e},ae=()=>{const e=J();e.style.display="none"};const B=e=>e!==void 0,fe=(e,t)=>Math.floor(e/t),de=(e,t)=>(e%t+t)%t,D=(e,t,o)=>Math.max(t,Math.min(e,o)),A=e=>e/180*Math.PI,Q=(e,t)=>Math.sqrt(e*e+t*t),le=(e,t)=>{const o=Q(e,t);return o!=0?[e/o,t/o]:[0,0]};const C=(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],ue=e=>{const t=C(e,e);return Math.sqrt(t)},me=(e,t)=>[e[0]+t[0],e[1]+t[1],e[2]+t[2]],he=(e,t)=>[e[0]-t[0],e[1]-t[1],e[2]-t[2]];const X=e=>{const t=ue(e);return[e[0]/t,e[1]/t,e[2]/t]},j=(e,t)=>[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]],H=(e,t)=>{const o=A(e),n=A(t);return[Math.cos(n)*Math.cos(o),Math.sin(n),Math.cos(n)*Math.sin(o)]},ye=()=>[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],be=(e,t)=>[e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15]],ge=e=>{const t=e[0]*e[5]-e[1]*e[4],o=e[0]*e[6]-e[2]*e[4],n=e[0]*e[7]-e[3]*e[4],s=e[1]*e[6]-e[2]*e[5],i=e[1]*e[7]-e[3]*e[5],r=e[2]*e[7]-e[3]*e[6],c=e[8]*e[13]-e[9]*e[12],f=e[8]*e[14]-e[10]*e[12],d=e[8]*e[15]-e[11]*e[12],m=e[9]*e[14]-e[10]*e[13],l=e[9]*e[15]-e[11]*e[13],u=e[10]*e[15]-e[11]*e[14];let a=t*u-o*l+n*m+s*d-i*f+r*c;return a?(a=1/a,[(e[5]*u-e[6]*l+e[7]*m)*a,(e[2]*l-e[1]*u-e[3]*m)*a,(e[13]*r-e[14]*i+e[15]*s)*a,(e[10]*i-e[9]*r-e[11]*s)*a,(e[6]*d-e[4]*u-e[7]*f)*a,(e[0]*u-e[2]*d+e[3]*f)*a,(e[14]*n-e[12]*r-e[15]*o)*a,(e[8]*r-e[10]*n+e[11]*o)*a,(e[4]*l-e[5]*d+e[7]*c)*a,(e[1]*d-e[0]*l-e[3]*c)*a,(e[12]*i-e[13]*n+e[15]*t)*a,(e[9]*n-e[8]*i-e[11]*t)*a,(e[5]*f-e[4]*m-e[6]*c)*a,(e[0]*m-e[1]*f+e[2]*c)*a,(e[13]*o-e[12]*s-e[14]*t)*a,(e[8]*s-e[9]*o+e[10]*t)*a]):ye()};const W=(e,t,o,n)=>{e[12]=t,e[13]=o,e[14]=n},Y=(e,t)=>{const o=A(e),n=Math.sin(o),s=Math.cos(o);return[s,0,n,0,0,1,0,0,-n,0,s,0,0,0,0,1]};const ve=(e,t,o)=>{const n=X(he(t,e)),s=X(j(o,n)),i=j(n,s),r=C(e,s),c=C(e,i),f=C(e,n);return[s[0],i[0],n[0],0,s[1],i[1],n[1],0,s[2],i[2],n[2],0,-r,-c,-f,1]},pe=(e,t,o,n)=>{const s=1/Math.tan(e),i=s/t,r=n/(n-o),c=-(r*o);return[i,0,0,0,0,s,0,0,0,0,r,1,0,0,c,0]};const we=async(e,t)=>{e.adapter=await navigator.gpu.requestAdapter(),e.device=await e.adapter.requestDevice(),e.canvasFormat=navigator.gpu.getPreferredCanvasFormat(),e.canvas=ce(),e.context=e.canvas.getContext("webgpu"),e.context.configure({device:e.device,format:e.canvasFormat,alphaMode:"opaque"});const o=e.device;if(e.buffer)for(let s=0;s<e.buffer.length;++s){const i=e.buffer[s],r=await qe(t[i.embed]),c=o.createBuffer({size:r.length,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.INDEX,mappedAtCreation:!0}),f=new DataView(c.getMappedRange());for(let d=0;d<r.length;++d)f.setUint8(d,r[d]);c.unmap(),e.buffer[s]=c}if(e.shader)for(let s=0;s<e.shader.length;++s){const i=e.shader[s],r=await Xe(t[i.embed]),c=o.createShaderModule({code:r});e.shader[s]=c}e.bindGroupLayout=[],e.pipelineLayout=[],e.pipeline=[],e.sampler=[],e.bindGroup=[],e.cbuffer=[],e.gbuffer=[];const n=(s,i,r)=>{e.cbuffer[s]=o.createBuffer({size:i,usage:r|GPUBufferUsage.COPY_DST})};n(0,512,GPUBufferUsage.UNIFORM),n(1,229376,GPUBufferUsage.STORAGE),n(2,65536,GPUBufferUsage.VERTEX),n(3,40960,GPUBufferUsage.INDIRECT),e.sampler[0]=o.createSampler({magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"}),e.bindGroupLayout[0]=o.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}]}),e.bindGroupLayout[1]=o.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"depth"}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:5,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),e.pipelineLayout[0]=o.createPipelineLayout({bindGroupLayouts:[e.bindGroupLayout[0]]}),e.pipelineLayout[1]=o.createPipelineLayout({bindGroupLayouts:[e.bindGroupLayout[1]]}),e.bindGroup[0]=o.createBindGroup({layout:e.bindGroupLayout[0],entries:[{binding:0,resource:{buffer:e.cbuffer[0]}},{binding:1,resource:{buffer:e.cbuffer[1]}}]}),Ge(e)},_e=e=>{const t=e.device,o=e.canvas;if(o.width!==o.clientWidth||o.height!==o.clientHeight){o.width=o.clientWidth,o.height=o.clientHeight;const i=c=>{B(e.gbuffer[c])&&(e.gbuffer[c].destroy(),delete e.gbuffer[c])};i(0),i(1),i(2),i(3),i(4);const r=c=>{B(e.bindGroup[c])&&delete e.bindGroup[c]};r(1),r(2),r(3)}const n=(i,r)=>{B(e.gbuffer[i])||(e.gbuffer[i]=t.createTexture({size:[o.width,o.height],format:r,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}))};n(0,"depth32float"),n(1,"rgb10a2unorm"),n(2,"rgba8unorm"),n(3,"rgba8unorm"),n(4,"rgba16float");const s=(i,r,c,f,d)=>{B(e.bindGroup[i])||(e.bindGroup[i]=t.createBindGroup({layout:e.bindGroupLayout[1],entries:[{binding:0,resource:{buffer:e.cbuffer[0]}},{binding:1,resource:e.gbuffer[r].createView()},{binding:2,resource:e.gbuffer[c].createView()},{binding:3,resource:e.gbuffer[f].createView()},{binding:4,resource:e.gbuffer[d].createView()},{binding:5,resource:e.sampler[0]}]}))};s(1,0,1,2,3),s(2,0,1,1,1),s(3,0,4,4,4)},xe=e=>{const t=e.data.gpu,o=t.device,n=new Float32Array(68);{const s=$(e).camera,i=t.canvas.width/t.canvas.height,r=A(s.fov),[c,f,d,m,l]=z(s.offset,0,0,0,0,0),u=H(m,l),a=[c,f,d],h=me(a,u),y=ve(a,h,[0,1,0]),v=pe(r,i,s.near,s.far),g=be(y,v),P=ge(g);n.set(g,0),n.set(P,16),n.set(y,32),n.set(a,48)}{const s=$(e).light,[i,r,c,f,d]=z(s.offset,0,0,0,0,0),m=S(s.color,0,0,0,0),l=S(s.ambient0,0,0,0,0),u=S(s.ambient1,0,0,0,0),a=H(f,d);n.set(a,52),n.set(m,56),n.set(l,60),n.set(u,64)}o.queue.writeBuffer(t.cbuffer[0],0,n)},Se=e=>{const t=e.data.gpu,o=t.device,n=[];n.length=t.segment.length;for(let l=0;l<n.length;++l)n[l]=[];const s=new Float32Array(28),i=4*28;let r=0;for(const l of $(e).room){const u=ee(e,l.data);if(u&&u.layout)for(const a of u.layout)for(let h=0;h<a.indices.length;++h){const b=de(h,a.divisor),y=fe(h,a.divisor),[v,g,P,L,T]=z(l.offset,b*a.unit,0,y*a.unit,0,0),_=a.node[a.indices[h]];if(_)for(const M of _.mesh){const p=u.mesh[M];if(!p)continue;const w=t.mesh[p.data];if(!w)continue;for(const ie of w.segment)n[ie].push(r);const[E,F,U,V,oe]=z(p.offset,v,g,P,L,T),q=Y(V,oe);W(q,E,F,U);const ne=S(p.factor0,1,1,1,1),se=S(p.factor1,1,1,1,0),re=S(p.factor2,0,0,0,0);s.set(q,0),s.set(ne,16),s.set(se,20),s.set(re,24),o.queue.writeBuffer(t.cbuffer[1],r*i,s),r+=1}}}for(const l of $(e).mob){const u=k(e,l.data);if(!u)continue;const[a,h,b,y,v]=z(l.offset,0,0,0,0,0);for(const g of u.mesh){const P=t.mesh[g.data];if(!P)continue;for(const V of P.segment)n[V].push(r);const[L,T,_,M,p]=z(g.offset,a,h,b,y,v),w=Y(M,p);W(w,L,T,_);const E=S(g.factor0,1,1,1,1),F=S(g.factor1,1,1,1,0),U=S(g.factor2,0,0,0,0);s.set(w,0),s.set(E,16),s.set(F,20),s.set(U,24),o.queue.writeBuffer(t.cbuffer[1],r*i,s),r+=1}}const c=[];let f=0,d=0;const m=new Uint32Array(5);for(let l=0;l<n.length;++l){if(n[l].length<=0)continue;const u=t.segment[l],a=n[l].length;o.queue.writeBuffer(t.cbuffer[2],f*4,new Uint32Array(n[l])),m[0]=u.count,m[1]=a,m[2]=0,m[3]=0,m[4]=0,o.queue.writeBuffer(t.cbuffer[3],d,m),c.push({id:l,first:f,offset:d}),f+=a,d+=20}return c},Ge=e=>{const t=e.device;e.pipeline[0]=t.createRenderPipeline({layout:e.pipelineLayout[0],vertex:{module:e.shader[0],entryPoint:"VS",buffers:[{arrayStride:4,attributes:[{format:"uint32",offset:0,shaderLocation:0}],stepMode:"instance"},{arrayStride:12,attributes:[{format:"float32x3",offset:0,shaderLocation:1}]},{arrayStride:12,attributes:[{format:"float32x3",offset:0,shaderLocation:2}]}]},fragment:{module:e.shader[0],entryPoint:"FS",targets:[{format:"rgb10a2unorm"},{format:"rgba8unorm"},{format:"rgba8unorm"},{format:"rgba16float"}]},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth32float"},primitive:{cullMode:"back",frontFace:"cw"}}),e.pipeline[1]=t.createRenderPipeline({layout:e.pipelineLayout[1],vertex:{module:e.shader[1],entryPoint:"VS",buffers:[]},fragment:{module:e.shader[1],entryPoint:"FS_SSAO",targets:[{format:"rgba8unorm",blend:{color:{operation:"min",srcFactor:"one",dstFactor:"one"},alpha:{}},writeMask:GPUColorWrite.RED}]}}),e.pipeline[2]=t.createRenderPipeline({layout:e.pipelineLayout[1],vertex:{module:e.shader[1],entryPoint:"VS",buffers:[]},fragment:{module:e.shader[1],entryPoint:"FS_HDR",targets:[{format:"rgba16float",blend:{color:{operation:"add",srcFactor:"one",dstFactor:"one"},alpha:{}}}]},depthStencil:{depthWriteEnabled:!1,depthCompare:"not-equal",format:"depth32float"}}),e.pipeline[3]=t.createRenderPipeline({layout:e.pipelineLayout[1],vertex:{module:e.shader[1],entryPoint:"VS",buffers:[]},fragment:{module:e.shader[1],entryPoint:"FS_HDRSky",targets:[{format:"rgba16float",blend:{color:{operation:"add",srcFactor:"one",dstFactor:"one"},alpha:{}}}]},depthStencil:{depthWriteEnabled:!1,depthCompare:"equal",format:"depth32float"}}),e.pipeline[4]=t.createRenderPipeline({layout:e.pipelineLayout[1],vertex:{module:e.shader[1],entryPoint:"VS",buffers:[]},fragment:{module:e.shader[1],entryPoint:"FS_HDR2LDR",targets:[{format:e.canvasFormat}]},depthStencil:{depthWriteEnabled:!1,depthCompare:"always",format:"depth32float"}}),e.pipeline[5]=t.createRenderPipeline({layout:e.pipelineLayout[0],vertex:{module:e.shader[2],entryPoint:"VS",buffers:[{arrayStride:12,attributes:[{format:"float32x3",offset:0,shaderLocation:0}]},{arrayStride:4,attributes:[{format:"unorm8x4",offset:0,shaderLocation:1}]}]},fragment:{module:e.shader[2],entryPoint:"FS",targets:[{format:e.canvasFormat}]},depthStencil:{depthWriteEnabled:!1,depthCompare:"less",format:"depth32float"},primitive:{topology:"line-list"}})},Pe=e=>{const t=e.data.gpu;_e(t)},Me=e=>{xe(e);const t=Se(e),o=e.data.gpu,n=o.device,s=n.createCommandEncoder();Re(s,o,t),Be(s,o),$e(s,o),Ee(s,o),n.queue.submit([s.finish()])},Re=(e,t,o)=>{const n=e.beginRenderPass({depthStencilAttachment:{view:t.gbuffer[0].createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"},colorAttachments:[{view:t.gbuffer[1].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"},{view:t.gbuffer[2].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"},{view:t.gbuffer[3].createView(),clearValue:{r:1,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"},{view:t.gbuffer[4].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}]});for(const s of o){n.setPipeline(t.pipeline[0]),n.setBindGroup(0,t.bindGroup[0]),n.setVertexBuffer(0,t.cbuffer[2],s.first*4);const i=t.segment[s.id];if(i.vb0){const[r,c,f]=i.vb0;n.setVertexBuffer(1,t.buffer[r],c,f)}if(i.vb1){const[r,c,f]=i.vb1;n.setVertexBuffer(2,t.buffer[r],c,f)}if(i.ib){const[r,c,f]=i.ib;n.setIndexBuffer(t.buffer[r],"uint16",c,f)}n.drawIndexedIndirect(t.cbuffer[3],s.offset)}n.end()},Be=(e,t)=>{const o=e.beginRenderPass({colorAttachments:[{view:t.gbuffer[3].createView(),loadOp:"load",storeOp:"store"}]});o.setPipeline(t.pipeline[1]),o.setBindGroup(0,t.bindGroup[2]),o.draw(4),o.end()},$e=(e,t)=>{const o=e.beginRenderPass({depthStencilAttachment:{view:t.gbuffer[0].createView(),depthReadOnly:!0},colorAttachments:[{view:t.gbuffer[4].createView(),loadOp:"load",storeOp:"store"}]});o.setPipeline(t.pipeline[2]),o.setBindGroup(0,t.bindGroup[1]),o.draw(4),o.setPipeline(t.pipeline[3]),o.draw(4),o.end()},Ee=(e,t)=>{const o=e.beginRenderPass({depthStencilAttachment:{view:t.gbuffer[0].createView(),depthReadOnly:!0},colorAttachments:[{view:t.context.getCurrentTexture().createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}]});o.setPipeline(t.pipeline[4]),o.setBindGroup(0,t.bindGroup[3]),o.draw(4),o.end()},Z=(e,t)=>{e[t]||(e[t]={})},G=(e,t,o)=>{Z(e,t),o=o||0;const n=e[t];n&&!n.hold&&(n.value=Math.max(0,o))},O=(e,t,o,n)=>{Z(e,t),o=o||0,n=n||!1;const s=e[t];s&&(s.value=Math.max(0,o),s.hold=n)},Fe=(e,t)=>{const o=e[t];o&&(o.history=o.value)},Ue=(e,t)=>{const o=e[t];return o&&o.value||0},Ve=(e,t)=>{const o=e[t];return o?(o.value||0)-(o.history||0):0},ze=e=>{if(!e)return!1;for(const t of e.buttons)if(t.value>.5)return!0;for(const t of e.axes)if(Math.abs(t)>.5)return!0;return!1},Ae=e=>{const t=e.hid,o=e.data.hid,n=()=>{for(const r in o.keyboard)O(t.map,o.keyboard[r],0,!1);for(const r of o.mouse.button)O(t.map,r,0,!1)},s=(r,c,f)=>{const d=o.keyboard[r.code];d&&(O(t.map,d,c,f),r.preventDefault(),t.last=-1)},i=(r,c,f)=>{const d=o.mouse.button[r.button];d&&(O(t.map,d,c,f),r.preventDefault(),t.last=-1)};R(document.body,"contextmenu",r=>{r.preventDefault()}),R(window,"blur",r=>{n()}),R(document,"keydown",r=>{s(r,1,!0)}),R(document,"keyup",r=>{s(r,0,!1)}),R(document,"mousedown",r=>{i(r,1,!0)}),R(document,"mouseup",r=>{i(r,0,!1)}),R(document,"mousemove",r=>{if(!(r.buttons&2))return;const c=.25,f=o.mouse.movementX;f&&(G(t.map,f[0],-r.movementX*c),G(t.map,f[1],r.movementX*c));const d=o.mouse.movementY;d&&(G(t.map,d[0],-r.movementY*c),G(t.map,d[1],r.movementY*c)),r.preventDefault(),t.last=-1}),n()},Le=(e,t)=>{const o=e.hid,n=e.data.hid;G(o.map,n.timer,t/1e3);{const s=navigator.getGamepads();for(let r=0;r<s.length;++r)if(ze(s[r])){o.last=r;break}const i=s[o.last];if(i){const r=n.gamepad;for(let c=0;c<i.buttons.length;++c){const f=r.buttons[c];f&&G(o.map,f,i.buttons[c].value)}for(let c=0;c<i.axes.length;++c){const f=r.axes[c];if(!f)continue;const d=Math.trunc(i.axes[c]*4)/4;G(o.map,f[0],-d),G(o.map,f[1],d)}}}},Te=e=>{const t=e.hid;for(const o in t.map)Fe(t.map,o),G(t.map,o,0)},N={},Oe=e=>{const t=$(e);if(!t)return;const o=te(e,t.data);if(!o)return;const n=o.step||[],s=r=>{for(let c=0;c<n.length;++c)if(n[c].label&&n[c].label===r)return c;return-1};let i=!1;for(;!i;){const r=n[t.step];if(r){if(r.event){const c=N[r.event];c&&c(e)}r.solve&&De(e),r.goto?t.step=s(r.goto):t.step+=1,r.yield&&(i=!0)}else t.step=-1,i=!0}t.step<0&&e.stage.pop()},Ce=(e,t)=>{const o=te(e,t);if(!o)return;const n={data:t,step:0,room:structuredClone(o.room)||[],mob:structuredClone(o.mob)||[],camera:structuredClone(o.camera[0]),light:structuredClone(o.light[0])};e.stage.push(n)},De=e=>{const t=$(e).mob;for(let n=0;n<t.length;++n)for(let s=n+1;s<t.length;++s)Ie(e,t[n],t[s]);const o=$(e).room;for(let n=0;n<t.length;++n)for(let s=0;s<o.length;++s)Ne(e,t[n],o[s])},Ie=(e,t,o)=>{const[n,s,i,r,c,f]=I(e,t),[d,m,l,u,a,h]=I(e,o);if(s+c<=m||m+a<=s)return;const b=Q(d-n,l-i)-(r+u);if(b>=0)return;const y=f/(f+h),[v,g]=le(d-n,l-i);t.offset.x=n+b*v*y,t.offset.z=i+b*g*y,o.offset.x=d-b*v*(1-y),o.offset.z=l-b*g*(1-y)},Ne=(e,t,o)=>{const[n,s,i,r,c,f]=I(e,t),d=ee(e,o.data);if(!d)return;const m=o.offset&&o.offset.x||0,l=o.offset&&o.offset.y||0,u=o.offset&&o.offset.z||0;for(const a of d.layout){const h=(E,F)=>{if(E<0||F<0||a.divisor<=E)return 0;const U=E+F*a.divisor;if(a.indices.length<=U)return 0;const V=a.node[a.indices[U]];return V?l+(V.height||0):0},b=Math.round((n-m)/a.unit),y=Math.round((i-u)/a.unit),v=h(b,y);t.offset.y=v;const g=h(b-1,y),P=h(b+1,y),L=h(b,y-1),T=h(b,y+1),_=m+b*a.unit,M=u+y*a.unit,p=a.unit,w=p/2-r;t.offset.x=D(n,Math.abs(g-v)<=.5?_-p:_-w,Math.abs(P-v)<=.5?_+p:_+w),t.offset.z=D(i,Math.abs(L-v)<=.5?M-p:M-w,Math.abs(T-v)<=.5?M+p:M+w)}},z=(e,t,o,n,s,i)=>(e&&(t+=e.x||0,o+=e.y||0,n+=e.z||0,s+=e.ha||0,i+=e.va||0),[t,o,n,s,i]),S=(e,t,o,n,s)=>(e&&(B(e.r)&&(t=e.r),B(e.g)&&(o=e.g),B(e.r)&&(n=e.b),B(e.a)&&(s=e.a)),[t,o,n,s]),I=(e,t)=>{const o=k(e,t.data);if(!o)return[0,0,0,0,0,0];const n=t.offset&&t.offset.x||0,s=t.offset&&t.offset.y||0,i=t.offset&&t.offset.z||0,r=o.radius||0,c=o.height||0,f=(o.mass||0)+.01;return[n,s,i,r,c,f]},ke=e=>{e.data.loading+=1,(async()=>{const n=await(await fetch("app.json")).json(),s=e.data;Object.assign(s,n),Ae(e),s.gpu&&await we(s.gpu,s.embed),Ce(e,"main"),delete s.embed,s.loading-=1})()},qe=async e=>{const t=window.atob(e),o=new Uint8Array(t.length);for(let i=0;i<t.length;++i)o[i]=t.charCodeAt(i);const n=new Blob([o]).stream().pipeThrough(new DecompressionStream("deflate-raw")),s=await new Response(n).arrayBuffer();return new Uint8Array(s)},Xe=async e=>{const t=window.atob(e),o=new Uint8Array(t.length);for(let i=0;i<t.length;++i)o[i]=t.charCodeAt(i);const n=new Blob([o]).stream().pipeThrough(new DecompressionStream("deflate-raw"));return await new Response(n).text()},je=async()=>{if(!navigator.gpu){K("ERROR: WebGPU not supported.");return}const e={data:{loading:0},hid:{map:{},last:0},stage:[]};ke(e);const t=o=>{He(e)&&(Le(e,o),Pe(e),Oe(e),Me(e),Te(e)),requestAnimationFrame(t)};requestAnimationFrame(t)},He=e=>e.data.loading<=0;const ee=(e,t)=>e.data.room[t],k=(e,t)=>e.data.mob[t],te=(e,t)=>e.data.stage[t],x=(e,t)=>Ue(e.hid.map,t),We=(e,t)=>Ve(e.hid.map,t),$=e=>e.stage.at(-1);N.setup=e=>{ae()};N.update=e=>{const t=We(e,"t"),o=$(e),n=o.mob.find(i=>i.data==="p000");if(n){const i=k(e,n.data),r=[0,0];r[0]+=-x(e,"l0"),r[0]+=x(e,"l1"),r[1]+=x(e,"l2"),r[1]+=-x(e,"l3");const c=[0,0];c[0]+=-x(e,"r0"),c[0]+=x(e,"r1"),c[1]+=x(e,"r2"),c[1]+=-x(e,"r3");const f=x(e,"b1");if(c){const l=-c[0],u=c[1];n.offset.ha+=90*t*l,n.offset.va+=90*t*u,n.offset.va=D(n.offset.va,-60,80)}if(r){const m=f?4:2,l=A(n.offset.ha+90),u=A(n.offset.ha),a=-r[0],h=r[1],b=a*Math.cos(l)+h*Math.cos(u),y=a*Math.sin(l)+h*Math.sin(u),v=m*t*b,g=m*t*y;n.offset.x+=v,n.offset.z+=g}const d=o.camera;d.offset.x=n.offset.x,d.offset.y=n.offset.y+i.height,d.offset.z=n.offset.z,d.offset.ha=n.offset.ha,d.offset.va=n.offset.va}const s=o.light;s.offset.ha+=45*t};R(window,"load",()=>{K("Welcome Basilico."),je()});})();
