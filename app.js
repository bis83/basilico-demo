(()=>{const p=e=>{const t=window.atob(e),n=new ArrayBuffer(t.length),o=new DataView(n);for(let r=0;r<t.length;++r)o.setUint8(r,t.charCodeAt(r));return n},G=e=>new Float32Array(p(e));const M=e=>new Int32Array(p(e)),f=e=>e/180*Math.PI,q=(e,t)=>Math.sqrt(e*e+t*t),U=(e,t)=>{const n=q(e,t);return n!=0?[e/n,t/n]:[0,0]},v=(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],J=e=>{const t=v(e,e);return Math.sqrt(t)},Q=(e,t)=>[e[0]+t[0],e[1]+t[1],e[2]+t[2]],Z=(e,t)=>[e[0]-t[0],e[1]-t[1],e[2]-t[2]];const I=e=>{const t=J(e);return[e[0]/t,e[1]/t,e[2]/t]},O=(e,t)=>[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]],$=(e,t)=>{const n=f(e),o=f(t);return[Math.cos(o)*Math.cos(n),Math.sin(o),Math.cos(o)*Math.sin(n)]};const ee=(e,t)=>[e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15]];const te=(e,t,n)=>[e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1],ne=(e,t,n)=>{const o=I(Z(t,e)),r=I(O(n,o)),s=O(o,r),c=v(e,r),i=v(e,s),d=v(e,o);return[r[0],s[0],o[0],0,r[1],s[1],o[1],0,r[2],s[2],o[2],0,-c,-i,-d,1]},oe=(e,t,n,o)=>{const r=1/Math.tan(e),s=r/t,c=o/(o-n),i=-(c*n);return[s,0,0,0,0,r,0,0,0,0,c,1,0,0,i,0]},re=(e,t,n,o)=>{const r=2/e,s=2/t,c=1/(o-n),i=n/(n-o);return[r,0,0,0,0,s,0,0,0,0,c,0,0,0,i,1]};const se=9.81,m={start:{scene:"sample",position:[2,0,2],angle:[45,0]}},a=(e,t,n)=>{e.addEventListener(t,n)};const k=0,X=1,F=2,Y=3,ce=(e,t)=>{let n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.bindTexture(e.TEXTURE_2D,null),n},ae=(e,t,n)=>{const o=document.createElement("canvas");if(!o)return null;o.width=t,o.height=n;const r=o.getContext("2d");return r?(r.fillStyle="white",r.textAlign="center",r.textBaseline="middle",r.font="24px monospace",r.fillText(e,o.width/2,o.height/2),o):null},B=(e,t,n)=>{const o=e.createShader(t);return e.shaderSource(o,n),e.compileShader(o),e.getShaderParameter(o,e.COMPILE_STATUS)?o:(e.deleteShader(o),null)},ie=(e,t,n)=>{const o=e.createProgram();return e.attachShader(o,t),e.attachShader(o,n),e.linkProgram(o),e.getProgramParameter(o,e.LINK_STATUS)?o:(e.deleteProgram(o),null)},R=(e,t,n)=>{let o=e.createBuffer();return e.bindBuffer(t,o),e.bufferData(t,n,e.STATIC_DRAW),o},x=(e,t,n,o,r,s,c)=>{e.enableVertexAttribArray(t),e.vertexAttribPointer(t,n,o,r,s,c)},me=e=>{const t=window.innerWidth;t!==e.canvas.width&&(e.canvas.width=t);const n=window.innerHeight;n!==e.canvas.height&&(e.canvas.height=n)},ue=e=>{e.viewport(0,0,e.canvas.width,e.canvas.height),e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)},N=(e,t,n)=>{e.enable(e.CULL_FACE),t?(e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL)):e.disable(e.DEPTH_TEST),n?(e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)):(e.disable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA))},C=(e,t,n)=>{n=n||0;const o=t.iv[n*3+0],r=t.iv[n*3+1],s=t.iv[n*3+2],c=[null,e.POINTS,e.LINES,e.TRIANGLES];t.i?e.drawElements(c[o],s,e.UNSIGNED_SHORT,2*r):e.drawArrays(c[o],r,s)};const de=e=>(e.b&&(e.b=G(e.b)),e.dop6&&(e.dop6=M(e.dop6)),e.dop8&&(e.dop8=M(e.dop8)),e.dop12&&(e.dop12=M(e.dop12)),e),le=e=>(e.ground&&(e.ground=e.ground.map(t=>de(t))),e),fe=(e,t)=>{if(t.matrix){const n=G(t.matrix);t.count=Math.floor(n.length/16);const o=new Float32Array(t.count*64);for(let r=0;r<t.count;++r)for(j=0;j<16;++j)o[r*64+j]=n[r*16+j];t.size=64,t.stride=256,t.matrix=R(e,e.UNIFORM_BUFFER,o)}return t},he=(e,t)=>(t.static&&(t.static=t.static.map(n=>fe(e,n))),t),_e=(e,t)=>{if(t.vao=e.createVertexArray(),e.bindVertexArray(t.vao),t.b&&(t.b=R(e,e.ARRAY_BUFFER,p(t.b)),t.bv))for(let n=0;n<t.bv.length;n+=2)switch(t.bv[n]){case k:x(e,k,3,e.FLOAT,!1,0,t.bv[n+1]);break;case X:x(e,X,3,e.HALF_FLOAT,!1,0,t.bv[n+1]);break;case F:x(e,F,4,e.UNSIGNED_BYTE,!0,0,t.bv[n+1]);break;case Y:x(e,Y,2,e.HALF_FLOAT,!1,0,t.bv[n+1]);break}return t.i&&(t.i=R(e,e.ELEMENT_ARRAY_BUFFER,p(t.i))),e.bindVertexArray(null),t},Ae=(e,t)=>(t.texture=ce(e,ae(t.text,t.width,t.height)),t),Te=(e,t)=>{if(t.vs=B(e,e.VERTEX_SHADER,t.vs),t.fs=B(e,e.FRAGMENT_SHADER,t.fs),t.prog=ie(e,t.vs,t.fs),t.u){const n={};for(let o of t.u)n[o]=e.getUniformLocation(t.prog,o);t.u=n}if(t.ub){const n={};let o=0;for(let r of t.ub){const s=e.getUniformBlockIndex(t.prog,r);e.uniformBlockBinding(t.prog,s,o),n[r]=o,o+=1}t.ub=n}return t},pe=e=>{e.bundle=[]},h=({bundle:e},t,n)=>{for(const o of e){if(!o[t])continue;const r=o[t].find(s=>s.name===n);if(!!r)return r}return null},ve=({gl:e,bundle:t},n)=>{const o="data/"+n+".json";fetch(o).then(r=>r.json()).then(r=>{r.update&&(r.update=r.update.map(s=>le(s))),r.draw&&(r.draw=r.draw.map(s=>he(e,s))),r.mesh&&(r.mesh=r.mesh.map(s=>_e(e,s))),r.texture&&(r.texture=r.texture.map(s=>Ae(e,s))),r.shader&&(r.shader=r.shader.map(s=>Te(e,s))),t.push(r)})},xe=e=>{e.input=e.input||{},e.input.mouse={x:0,y:0,mx:0,my:0,lb:!1,rb:!1}},D=(e,t)=>(e.mx+=t.movementX||0,e.my+=t.movementY||0,e.x=t.x,e.y=t.y,e.lb=(t.buttons&1)!=0,e.rb=(t.buttons&2)!=0,!0),Ee=e=>{const t=n=>Math.trunc(n/2);e.mx=t(e.mx),e.my=t(e.my)},we=({input:e},t)=>{D(e.mouse,t)&&(e.mode=u,t.preventDefault())},ye=({input:e},t)=>{D(e.mouse,t)&&(e.mode=u,t.preventDefault())},Se=({input:e},t)=>{D(e.mouse,t)&&(e.mode=u,t.preventDefault())},Me=e=>{e.input=e.input||{},e.input.keyboard={w:!1,a:!1,s:!1,d:!1,space:!1,lctrl:!1}},b=(e,t,n)=>{switch(t){case"KeyW":e.w=n;break;case"KeyA":e.a=n;break;case"KeyS":e.s=n;break;case"KeyD":e.d=n;break;case"Space":e.space=n;break;case"ControlLeft":e.lctrl=n;break;default:return!1}return!0},Re=({input:e},t)=>{b(e.keyboard,t.code,!0)&&(e.mode=u,t.preventDefault())},De=({input:e},t)=>{b(e.keyboard,t.code,!1)&&(e.mode=u,t.preventDefault())},Le=e=>{e.input=e.input||{},e.input.gamepad={index:null,lx:0,ly:0,rx:0,ry:0,b0:!1,b1:!1,lt:!1,rt:!1}},ge=({input:e},t)=>{e.gamepad.index=t.gamepad.index,e.mode=E},Pe=({input:e},t)=>{e.gamepad.index===t.gamepad.index&&(e.gamepad.index=null)},Ge=({input:e})=>{if(e.gamepad.index!==null){const n=navigator.getGamepads()[e.gamepad.index];e.gamepad.lx=Math.trunc(n.axes[0]*4)/4,e.gamepad.ly=Math.trunc(n.axes[1]*4)/4,e.gamepad.rx=Math.trunc(n.axes[2]*4)/4,e.gamepad.ry=Math.trunc(n.axes[3]*4)/4,e.gamepad.b0=n.buttons[0].value>=.5,e.gamepad.b1=n.buttons[1].value>=.5,e.gamepad.lt=n.buttons[6].value>=.5,e.gamepad.rt=n.buttons[7].value>=.5,!!(e.gamepad.lx||e.gamepad.ly||e.gamepad.rx||e.gamepad.ry||e.gamepad.b0||e.gamepad.b1||e.gamepad.lt||e.gamepad.rt)&&(e.mode=E)}},Ue=e=>{e.input=e.input||{},e.input.touch=new Map},Ie=({input:e},t)=>{for(const n of t.changedTouches)e.touch.set(n.identifier,{x:n.clientX,y:n.clientY,sx:n.clientX,sy:n.clientY});e.mode=w},V=({input:e},t)=>{for(const n of t.changedTouches)e.touch.delete(n.identifier);e.mode=w},Oe=({input:e},t)=>{for(const n of t.changedTouches){const o=e.touch.get(n.identifier);o&&(o.x=n.clientX,o.y=n.clientY)}e.mode=w},E=0,u=1,w=2,ke=e=>{e.input={mode:E,moveX:0,moveY:0,cameraX:0,cameraY:0,jump:!1,sneak:!1,jumpButton:!1,sneakButton:!1}},Xe=e=>{[e.moveX,e.moveY]=U(e.moveX,e.moveY),[e.cameraX,e.cameraY]=U(e.cameraX,e.cameraY)},Fe=({input:e})=>{e.moveX=0,e.moveY=0,e.cameraX=0,e.cameraY=0},Ye=({input:e})=>{e.moveX=e.gamepad.lx,e.moveY=-e.gamepad.ly,e.cameraX=-e.gamepad.rx,e.cameraY=-e.gamepad.ry,e.jump=!e.jumpButton&&e.gamepad.b0,e.sneak=!e.sneakButton&&e.gamepad.b1,e.jumpButton=e.gamepad.b0,e.sneakButton=e.gamepad.b1},Be=({input:e})=>{e.moveX=e.keyboard.a?-1:e.keyboard.d?1:0,e.moveY=e.keyboard.w?1:e.keyboard.s?-1:0,e.mouse.lb?(e.cameraX=-e.mouse.mx,e.cameraY=-e.mouse.my):(e.cameraX=0,e.cameraY=0),e.jump=!e.jumpButton&&e.keyboard.space,e.sneak=!e.sneakButton&&e.keyboard.lctrl,e.jumpButton=e.keyboard.space,e.sneakButton=e.keyboard.lctrl},Ne=({input:e})=>{e.moveX=0,e.moveY=0,e.cameraX=0,e.cameraY=0;for(const t of e.touch.values())t.sx<window.innerWidth/2?(e.moveX=t.x-t.sx,e.moveY=-(t.y-t.sy)):(e.cameraX=-(t.x-t.sx),e.cameraY=-(t.y-t.sy))},Ce=e=>{e.camera={viewProj:new Float32Array(16),ortho:new Float32Array(16)}},be=({camera:e},t,n,o,r,s)=>{const c=window.innerWidth,i=window.innerHeight,d=f(30),y=.1,_=1e3,l=[t,n,o],A=Q(l,$(r,s)),S=ne(l,A,[0,1,0]),T=oe(d,c/i,y,_);e.viewProj.set(ee(S,T)),e.ortho.set(re(c,i,0,1))},Ve=e=>{e.timer={prevTime:performance.now(),deltaTime:0}},He=({timer:e})=>{const t=performance.now();e.deltaTime=(t-e.prevTime)/1e3,e.prevTime=t},ze=e=>{e.save={scene:"",position:[0,0,0],angle:[0,0],sneak:!1,vy:0}},Ke=({save:e})=>e.sneak?.9:1.75,je=({save:e},t)=>{e.scene=t},H=({save:e},t,n,o)=>{e.position=[t,n,o]},z=({save:e},t,n)=>{e.angle=[t,n]},We=({save:e},t)=>{e.sneak=t},qe=({save:e},t)=>{e.vy=t},Je=()=>{const e=document.getElementById("main"),t=e.getContext("webgl2"),n=new AudioContext,o={gl:t,audio:n};return pe(o),ke(o),xe(o),Me(o),Le(o),Ue(o),Ce(o),Ve(o),ze(o),je(o,m.start.scene),H(o,m.start.position[0],m.start.position[1],m.start.position[2]),z(o,m.start.angle[0],m.start.angle[1]),ve(o,"core"),a(window,"focus",r=>{}),a(window,"blur",r=>{}),a(window,"resize",r=>{}),a(window,"gamepadconnected",r=>{ge(o,r)}),a(window,"gamepaddisconnected",r=>{Pe(o,r)}),a(document,"keydown",r=>{Re(o,r)}),a(document,"keyup",r=>{De(o,r)}),a(e,"contextmenu",r=>{r.preventDefault()}),a(e,"mousedown",r=>{we(o,r)}),a(e,"mouseup",r=>{ye(o,r)}),a(e,"mousemove",r=>{Se(o,r)}),a(e,"touchstart",r=>{Ie(o,r)}),a(e,"touchend",r=>{V(o,r)}),a(e,"touchcancel",r=>{V(o,r)}),a(e,"touchmove",r=>{Oe(o,r)}),o},Qe=e=>{He(e),Ge(e);const t=e.input.mode;t===E?Ye(e):t===u?Be(e):t===w?Ne(e):Fe(e),Xe(e.input),Ee(e.input.mouse)},Ze=e=>{const t=e.timer.deltaTime;let[n,o]=e.save.angle,[r,s,c]=e.save.position,i=e.save.vy;const d=e.input.cameraX,y=e.input.cameraY,_=e.input.moveX,l=e.input.moveY,A=90,L=A*t*d,S=A*t*y;n+=L,o+=S,s<=0&&e.input.jump&&(i=4),i+=-se*t;const T=4,g=f(n-90),P=f(n),K=T*(_*Math.cos(g)+l*Math.cos(P)),W=T*(_*Math.sin(g)+l*Math.sin(P));r+=K*t,s+=i*t,c+=W*t,s<=0&&(s=0,i=0),s<=0&&e.input.sneak&&We(e,!e.save.sneak),z(e,n,o),H(e,r,s,c),qe(e,i)},$e=e=>{const[t,n,o]=e.save.position,[r,s]=e.save.angle,c=Ke(e);be(e,t,n+c,o,r,s)},et=e=>{Qe(e),Ze(e),$e(e)},tt=({gl:e})=>{me(e),ue(e)},nt=e=>{N(e.gl,!0,!1);const t=h(e,"draw",e.save.scene);if(!t)return;const n=h(e,"shader","mesh_pnc");if(!!n){e.gl.useProgram(n.prog),e.gl.uniformMatrix4fv(n.u.vp,!1,e.camera.viewProj);for(const o of t.static){const r=h(e,"mesh",o.mesh);if(!!r){e.gl.bindVertexArray(r.vao);for(let s=0;s<o.count;++s)e.gl.bindBufferRange(e.gl.UNIFORM_BUFFER,n.ub.a,o.matrix,s*o.stride,o.size),C(e.gl,r)}}}},ot=e=>{N(e.gl,!1,!0);const t=h(e,"shader","mesh_pc");if(!t)return;e.gl.useProgram(t.prog),e.gl.uniformMatrix4fv(t.u.vp,!1,e.camera.ortho);const n=h(e,"mesh","reticle");if(!n)return;e.gl.bindVertexArray(n.vao);const o=new Float32Array(16);o.set(te(4,4,1)),e.gl.uniformMatrix4fv(t.u.w,!1,o),C(e.gl,n)},rt=e=>{tt(e),nt(e),ot(e)};a(window,"load",()=>{const e=Je(),t=()=>{et(e),rt(e),requestAnimationFrame(t)};t()});})();
