(()=>{const V=t=>{const e=window.atob(t),n=new ArrayBuffer(e.length),o=new DataView(n);for(let r=0;r<e.length;++r)o.setUint8(r,e.charCodeAt(r));return n};const Et=(t,e)=>(t%e+e)%e,P=t=>t/180*Math.PI,rt=(t,e)=>Math.sqrt(t*t+e*e),D=(t,e)=>{const n=rt(t,e);return n!=0?[t/n,e/n]:[0,0]},xt=([t,e],n)=>[t*n,e*n],At=([t,e],n,o,r,c)=>n<=t&&t<=o&&r<=e&&e<=c,O=([t,e],n,[o,r])=>{const[c,i]=[o-t,r-e],l=rt(c,i);if(n<=l)return[t,e];const[f,E]=D(c,i),[x,w]=xt([f,E],l-n);return[t+x,e+w]},k=(t,e)=>t[0]*e[0]+t[1]*e[1]+t[2]*e[2],wt=t=>{const e=k(t,t);return Math.sqrt(e)},gt=(t,e)=>[t[0]+e[0],t[1]+e[1],t[2]+e[2]],vt=(t,e)=>[t[0]-e[0],t[1]-e[1],t[2]-e[2]];const K=t=>{const e=wt(t);return[t[0]/e,t[1]/e,t[2]/e]},z=(t,e)=>[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]],Tt=(t,e)=>{const n=P(t),o=P(e);return[Math.cos(o)*Math.cos(n),Math.cos(o)*Math.sin(n),Math.sin(o)]},pt=()=>[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],yt=(t,e)=>[t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15],t[4]*e[0]+t[5]*e[4]+t[6]*e[8]+t[7]*e[12],t[4]*e[1]+t[5]*e[5]+t[6]*e[9]+t[7]*e[13],t[4]*e[2]+t[5]*e[6]+t[6]*e[10]+t[7]*e[14],t[4]*e[3]+t[5]*e[7]+t[6]*e[11]+t[7]*e[15],t[8]*e[0]+t[9]*e[4]+t[10]*e[8]+t[11]*e[12],t[8]*e[1]+t[9]*e[5]+t[10]*e[9]+t[11]*e[13],t[8]*e[2]+t[9]*e[6]+t[10]*e[10]+t[11]*e[14],t[8]*e[3]+t[9]*e[7]+t[10]*e[11]+t[11]*e[15],t[12]*e[0]+t[13]*e[4]+t[14]*e[8]+t[15]*e[12],t[12]*e[1]+t[13]*e[5]+t[14]*e[9]+t[15]*e[13],t[12]*e[2]+t[13]*e[6]+t[14]*e[10]+t[15]*e[14],t[12]*e[3]+t[13]*e[7]+t[14]*e[11]+t[15]*e[15]],Dt=t=>{const e=t[0]*t[5]-t[1]*t[4],n=t[0]*t[6]-t[2]*t[4],o=t[0]*t[7]-t[3]*t[4],r=t[1]*t[6]-t[2]*t[5],c=t[1]*t[7]-t[3]*t[5],i=t[2]*t[7]-t[3]*t[6],l=t[8]*t[13]-t[9]*t[12],f=t[8]*t[14]-t[10]*t[12],E=t[8]*t[15]-t[11]*t[12],x=t[9]*t[14]-t[10]*t[13],w=t[9]*t[15]-t[11]*t[13],y=t[10]*t[15]-t[11]*t[14];let h=e*y-n*w+o*x+r*E-c*f+i*l;return h?(h=1/h,[(t[5]*y-t[6]*w+t[7]*x)*h,(t[2]*w-t[1]*y-t[3]*x)*h,(t[13]*i-t[14]*c+t[15]*r)*h,(t[10]*c-t[9]*i-t[11]*r)*h,(t[6]*E-t[4]*y-t[7]*f)*h,(t[0]*y-t[2]*E+t[3]*f)*h,(t[14]*o-t[12]*i-t[15]*n)*h,(t[8]*i-t[10]*o+t[11]*n)*h,(t[4]*w-t[5]*E+t[7]*l)*h,(t[1]*E-t[0]*w-t[3]*l)*h,(t[12]*c-t[13]*o+t[15]*e)*h,(t[9]*o-t[8]*c-t[11]*e)*h,(t[5]*f-t[4]*x-t[6]*l)*h,(t[0]*x-t[1]*f+t[2]*l)*h,(t[13]*n-t[12]*r-t[14]*e)*h,(t[8]*r-t[9]*n+t[10]*e)*h]):pt()},F=(t,e,n)=>[1,0,0,0,0,1,0,0,0,0,1,0,t,e,n,1],Mt=(t,e,n,o)=>{t[12]=e,t[13]=n,t[14]=o},Rt=(t,e,n)=>[t,0,0,0,0,e,0,0,0,0,n,0,0,0,0,1],St=(t,e,n)=>{const o=K(vt(e,t)),r=K(z(n,o)),c=z(o,r),i=k(t,r),l=k(t,c),f=k(t,o);return[r[0],c[0],o[0],0,r[1],c[1],o[1],0,r[2],c[2],o[2],0,-i,-l,-f,1]},Pt=(t,e,n,o)=>{const r=1/Math.tan(t),c=r/e,i=o/(o-n),l=-(i*n);return[c,0,0,0,0,r,0,0,0,0,i,1,0,0,l,0]},Ot=(t,e,n,o)=>{const r=2/t,c=2/e,i=1/(o-n),l=n/(n-o);return[r,0,0,0,0,c,0,0,0,0,i,0,0,0,l,1]},B=(t,e,n)=>[t*2,e*2,n*.5];var u=null;const A=(t,e,n)=>{t.addEventListener(e,n)},It=()=>{const t=document.body;t.style.userSelect="none",t.style.webkitUserSelect="none",t.style.msUserSelect="none",t.style.mozUserSelect="none"},Gt=()=>{const t=document.body;t.style.touchAction="none"},kt=()=>{It(),Gt(),u={},u.mode=0,u.gamepad={index:null,lx:0,ly:0,rx:0,ry:0,b0:!1,b1:!1,b8:!1,b9:!1,lt:!1,rt:!1},u.keyboard={w:!1,a:!1,s:!1,d:!1,up:!1,left:!1,down:!1,right:!1,z:!1,x:!1,space:!1,lctrl:!1,esc:!1},u.touch=new Map,u.click=[],A(window,"focus",t=>{}),A(window,"blur",t=>{}),A(window,"resize",t=>{}),A(window,"gamepadconnected",t=>{u.gamepad.index=t.gamepad.index,u.mode=1}),A(window,"gamepaddisconnected",t=>{u.gamepad.index===t.gamepad.index&&(u.gamepad.index=null)}),A(document,"keydown",t=>{W(u.keyboard,t.code,!0)&&(u.mode=2,t.preventDefault())}),A(document,"keyup",t=>{W(u.keyboard,t.code,!1)&&(u.mode=2,t.preventDefault())}),A(document.body,"contextmenu",t=>{t.preventDefault()}),A(document.body,"pointerdown",t=>{u.touch.set(t.pointerId,{x:t.clientX,y:t.clientY,sx:t.clientX,sy:t.clientY,time:performance.now()}),u.mode=0}),A(document.body,"pointerup",t=>{bt(t.pointerId),u.touch.delete(t.pointerId),u.mode=0}),A(document.body,"pointerout",t=>{u.touch.delete(t.pointerId),u.mode=0}),A(document.body,"pointermove",t=>{const e=u.touch.get(t.pointerId);e&&(e.x=t.clientX,e.y=t.clientY,u.mode=0)})},W=(t,e,n)=>{switch(e){case"KeyW":t.w=n;break;case"KeyA":t.a=n;break;case"KeyS":t.s=n;break;case"KeyD":t.d=n;break;case"ArrowUp":t.up=n;break;case"ArrowLeft":t.left=n;break;case"ArrowDown":t.down=n;break;case"ArrowRight":t.right=n;break;case"KeyZ":t.z=n;break;case"KeyX":t.x=n;break;case"Space":t.space=n;break;case"ControlLeft":t.lctrl=n;break;case"Escape":t.esc=n;break;default:return!1}return!0},bt=t=>{const e=u.touch.get(t);e&&performance.now()-e.time<250&&u.click.push({x:e.x,y:e.y})},Lt=t=>{if(t.index!==null){const n=navigator.getGamepads()[t.index];t.lx=Math.trunc(n.axes[0]*4)/4,t.ly=Math.trunc(n.axes[1]*4)/4,t.rx=Math.trunc(n.axes[2]*4)/4,t.ry=Math.trunc(n.axes[3]*4)/4,t.b0=n.buttons[0].value>=.5,t.b1=n.buttons[1].value>=.5,t.b8=n.buttons[8].value>=.5,t.b9=n.buttons[9].value>=.5,t.lt=n.buttons[6].value>=.5,t.rt=n.buttons[7].value>=.5,!!(t.lx||t.ly||t.rx||t.ry||t.b0||t.b1||t.b8||t.b9||t.lt||t.rt)&&(u.mode=1)}},Ut=()=>{Lt(u.gamepad)},Nt=()=>{u.click.length=0},Ft=t=>{const e=localStorage.getItem(t);return e==null?null:JSON.parse(e)},Bt=(t,e)=>{const n=JSON.stringify(e);localStorage.setItem(t,n)};var s=null;const Xt=()=>{s=document.getElementById("main").getContext("webgl2")},q=(t,e)=>{let n=s.createTexture();return s.bindTexture(s.TEXTURE_2D,n),e==0&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST)),e==1&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR)),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,t),s.bindTexture(s.TEXTURE_2D,null),n},Yt=(t,e)=>{s.bindTexture(s.TEXTURE_2D,t),s.texSubImage2D(s.TEXTURE_2D,0,0,0,s.RGBA,s.UNSIGNED_BYTE,e),s.bindTexture(s.TEXTURE_2D,null)},J=(t,e)=>{const n=s.createShader(t);return s.shaderSource(n,e),s.compileShader(n),s.getShaderParameter(n,s.COMPILE_STATUS)?n:(s.deleteShader(n),null)},Ct=(t,e)=>{const n=s.createProgram();return s.attachShader(n,t),s.attachShader(n,e),s.linkProgram(n),s.getProgramParameter(n,s.LINK_STATUS)?n:(s.deleteProgram(n),null)},j=(t,e)=>{let n=s.createBuffer();return s.bindBuffer(t,n),s.bufferData(t,e,s.STATIC_DRAW),n},I=(t,e,n,o,r,c)=>{s.enableVertexAttribArray(t),s.vertexAttribPointer(t,e,n,o,r,c)},$t=()=>{const t=window.innerWidth;t!==s.canvas.width&&(s.canvas.width=t);const e=window.innerHeight;e!==s.canvas.height&&(s.canvas.height=e)},Ht=()=>{s.viewport(0,0,s.canvas.width,s.canvas.height),s.clearColor(0,0,0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)},Vt=(t,e)=>{s.enable(s.CULL_FACE),t?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST),e?(s.enable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA)):(s.disable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA))},Kt=(t,e)=>{e=e||0;const n=t.iv[e*3+0],o=t.iv[e*3+1],r=t.iv[e*3+2],c=[null,s.POINTS,s.LINES,s.TRIANGLES];t.i?s.drawElements(c[n],r,s.UNSIGNED_SHORT,2*o):s.drawArrays(c[n],o,r)},zt=(t,e)=>{s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,t.tex),s.uniform1i(e,0)},Wt=(t,e)=>{const n=document.createElement("canvas");return n?(n.width=t,n.height=e,n):null},ct=(t,e)=>{const n=t.getContext("2d");if(!n)return null;n.clearRect(0,0,t.width,t.height),n.fillStyle="rgba(0 0 0 / 0.5)",n.fillRect(0,0,t.width,t.height),n.fillStyle="white",n.textAlign="left",n.textBaseline="top",n.font="14px monospace";const o=e.split(`
`);for(let r=0;r<o.length;++r)n.fillText(o[r],0,12*r)};var qt=null;const Jt=()=>{qt=new AudioContext};const Q=0,Z=1,tt=2,et=3,jt=t=>{if(t.vao=s.createVertexArray(),s.bindVertexArray(t.vao),t.b&&(t.b=j(s.ARRAY_BUFFER,V(t.b)),t.bv))for(let e=0;e<t.bv.length;e+=2)switch(t.bv[e]){case Q:I(Q,3,s.FLOAT,!1,0,t.bv[e+1]);break;case Z:I(Z,3,s.HALF_FLOAT,!1,0,t.bv[e+1]);break;case tt:I(tt,4,s.UNSIGNED_BYTE,!0,0,t.bv[e+1]);break;case et:I(et,2,s.HALF_FLOAT,!1,0,t.bv[e+1]);break}return t.i&&(t.i=j(s.ELEMENT_ARRAY_BUFFER,V(t.i))),s.bindVertexArray(null),t},Qt=t=>{if(t.vs=J(s.VERTEX_SHADER,t.vs),t.fs=J(s.FRAGMENT_SHADER,t.fs),t.prog=Ct(t.vs,t.fs),t.u){const e={};for(let n of t.u)e[n]=s.getUniformLocation(t.prog,n);t.u=e}if(t.ub){const e={};let n=0;for(let o of t.ub){const r=s.getUniformBlockIndex(t.prog,o);s.uniformBlockBinding(t.prog,r,n),e[o]=n,n+=1}t.ub=e}return t};let X=0;const Zt=t=>{if(t.cvs){const e=Wt(t.cvs.width,t.cvs.height);ct(e,t.cvs.text),t.cvs=e,t.tex=q(t.cvs,t.s)}else{t.tex=null;const e=new Image;e.onload=()=>{t.tex=q(e,t.s),X-=1},e.src="img/"+t.src,X+=1}return t},g={index:null,pack:[]},te=()=>{fetch("data/index.json").then(e=>e.json()).then(e=>{g.index=e})},ee=t=>{const e="data/pack"+t+".json";fetch(e).then(n=>n.json()).then(n=>{n.mesh&&(n.mesh=n.mesh.map(o=>jt(o))),n.texture&&(n.texture=n.texture.map(o=>Zt(o))),n.shader&&(n.shader=n.shader.map(o=>Qt(o))),g.pack[t]=n})},T=(t,e)=>{if(e<0)return null;const n=g.index[t];if(!n)return null;const o=n[e];if(!o)return null;const r=g.pack[o.p];return r?r[t][o.i]:null},it=t=>T("view",t),ne=t=>T("mesh",t),lt=t=>T("texture",t),oe=t=>T("shader",t),se=t=>T("draw",t),nt=t=>T("item",t),b=t=>T("tile",t),ut=t=>T("ui",t),re=t=>T("event",t),ce=t=>g.index.view.findIndex(e=>e.n===t),ie=t=>g.index.texture.findIndex(e=>e.n===t),le=t=>g.index.item.findIndex(e=>e.n===t),ot=t=>g.index.tile.findIndex(e=>e.n===t),ue=t=>g.index.ui.findIndex(e=>e.n===t),at=()=>!(g.index===null||g.pack.length<=0||X>0),v={},ae=t=>{const e=v[t[0]];if(!e)return;const n=t.slice(1);e(...n)},S={t:performance.now(),dt:0,n:0},fe=t=>{S.dt=(t-S.t)/1e3,S.t=t,S.n+=1},M=[],Y=t=>{const e=ue(t);if(e<0)return null;const n=M[e];return n?n.value:null},de=0,N=0,R=1,$=(t,e)=>{const n=window.innerWidth,o=window.innerHeight,r=window.devicePixelRatio,c=n/2+n/2*t.ox,i=o/2+o/2*t.oy,l=c+(t.x-t.w/2)*r,f=c+(t.x+t.w/2)*r,E=i+(t.y-t.h/2)*r,x=i+(t.y+t.h/2)*r;return At(e,l,f,E,x)},_e=(t,e)=>{const n=u.mode;if(n===0){let o=!1;const r=u.click;for(let c of r)if($(e,[c.x,c.y])){o=!0;break}o?(t.value=!0,t.state=R):(t.value=!1,t.state=N)}else n===1?u.gamepad[e.gamepad]?t.state!==R?(t.value=!0,t.state=R):t.value=!1:(t.value=!1,t.state=N):n===2&&(u.keyboard[e.keyboard]?t.state!==R?(t.value=!0,t.state=R):t.value=!1:(t.value=!1,t.state=N))},he=(t,e)=>{const n=u.mode;if(n===0){t.value=[0,0];for(const o of u.touch.values())if($(e,[o.sx,o.sy])){const r=o.x-o.sx,c=-(o.y-o.sy);t.value=D(r,c);break}}else if(n===1){const o=u.gamepad;t.value=D(o.lx,-o.ly)}else if(n===2){const o=u.keyboard,r=o.a?-1:o.d?1:0,c=o.w?1:o.s?-1:0;t.value=D(r,c)}},me=(t,e)=>{const n=u.mode;if(n===0){t.value=[0,0];for(const o of u.touch.values())if($(e,[o.sx,o.sy])){const r=o.x-o.sx,c=-(o.y-o.sy);t.value=D(r,c);break}}else if(n===1){const o=u.gamepad;t.value=D(o.rx,-o.ry)}else if(n===2){const o=u.keyboard,r=o.right?1:o.left?-1:0,c=o.up?1:o.down?-1:0;t.value=D(r,c)}},Ee=t=>{const e=window.innerWidth,n=window.innerHeight;for(const o of M)o&&(o.value=null);for(let o of t.ui){const r=ut(o);if(!r)continue;M[o]||(M[o]={m:new Float32Array(16),value:null,state:de});const c=M[o];switch(r.interact){case 1:_e(c,r);break;case 2:he(c,r);break;case 3:me(c,r);break;default:break}const i=window.devicePixelRatio,l=r.ox*e/2,f=r.oy*n/2,E=Rt(r.w/2*i,r.h/2*i,1);Mt(E,l+r.x*i,-(f+r.y*i),0),c.m.set(E)}},_={w:0,h:0,a:[],b:[]},U=(t,e)=>(t=Math.floor(t),e=Math.floor(e),t<0||_.w<=t||e<0||_.h<=e?-1:t+e*_.h),H=(t,e)=>_.a[U(t,e)],ft=(t,e)=>_.b[U(t,e)],dt=(t,e)=>{const n=H(t,e);if(!n)return 0;const o=b(n.no);return o?o.height*n.count:0},xe=(t,e)=>{const n=ft(t,e);if(!n)return 0;const o=b(n.no);return o?o.height:0},C=(t,e)=>dt(t,e)+xe(t,e),Ae=(t,e)=>H(t,e)==null,p=(t,e,n,o)=>{if(Ae(t+n,e+o))return!0;const r=C(t,e),c=C(t+n,e+o);return Math.abs(r-c)>1},we=(t,e)=>{_.w=t,_.h=e,_.a=[],_.a.length=t*e,_.b=[],_.b.length=t*e},ge=(t,e,n)=>{const o=U(t,e);o<0||(_.a[o]={no:n,count:1})},G=(t,e,n)=>{const o=U(t,e);o<0||(_.b[o]={no:n,dir:0})},ve=t=>t,Te=t=>t,pe=1.75,a={x:0,y:0,ha:0,va:0,h:0},ye=(t,e,n,o)=>{a.x=t||0,a.y=e||0,a.ha=n||0,a.va=o||0,a.h=0},m={s:[],i:0},De=t=>m.s.findIndex(e=>e&&e.no===t),Me=()=>m.s.findIndex(t=>!t),Re=t=>{const e=t??m.i;return m.s[e]},_t=t=>{const e=Et(m.i+t,m.s.length);m.i=e},Se=(t,e)=>{let n=De(t);if(n<0){if(n=Me(),n<0)return;m.s[n]={no:t,num:e};return}m.s[n].num+=e};const Pe=t=>{m.s.length=t,m.s.fill(null),m.i=0},Oe=t=>t,Ie=t=>t,Ge=t=>{for(let e of t.event){const n=re(e);if(!n)continue;let o=!1;switch(n.trigger){case 0:o=!0;break;case 1:o=Y(n.target);break}if(!!o)for(const r of n.action)ae(r)}},d={view:null,slot:null,cam:{eye:[0,0,0],vp:new Float32Array(16),ivp:new Float32Array(16),o:new Float32Array(16)},m:new Float32Array(16)},ht=()=>{d.slot=null,d.view=g.index.initial_view},ke=t=>{const e=ce(t);e<0||(d.view=e)},be=()=>{d.view===null&&ht()},Le=()=>{const t=window.innerWidth,e=window.innerHeight,n=P(30),o=.1,r=1e3,c=Tt(a.ha,a.va),i=B(a.x,a.y,a.h);i[2]+=pe;const l=gt(i,c),E=St(i,l,[0,0,1]),x=Pt(n,t/e,o,r),w=yt(E,x);d.cam.vp.set(w),d.cam.ivp.set(Dt(w)),d.cam.o.set(Ot(t,e,0,1)),d.cam.eye=i},Ue=()=>{_.w=0,_.h=0,_.a.length=0,a.x=0,a.y=0,a.ha=0,a.va=0},Ne=()=>{if(!d.slot)return!1;const t=Ft(d.slot);return t?(t.pos&&Object.assign(a,t.pos),t.item&&Object.assign(m,Ie(t.item)),t.tile&&Object.assign(_,Te(t.tile)),!0):!1},Fe=()=>{if(!d.slot)return;const t={};t.pos=a,t.item=Oe(m),t.tile=ve(_),Bt(d.slot,t)},Be=()=>{$t(),Ht()},L=(t,e,n)=>{const o=se(t);if(!o)return;Vt(o.depth,o.alpha);const r=oe(o.shader);if(!r)return;s.useProgram(r.prog);const c=ne(o.mesh);if(!c)return;s.bindVertexArray(c.vao),s.uniformMatrix4fv(r.u.vp,!1,o.ortho?d.cam.o:d.cam.vp);const i=lt(o.texture);i&&zt(i,r.u.tex0);for(let l=0;l<e;++l)n(r.u,l),Kt(c)},Xe=()=>{for(let t=0;t<_.w;++t)for(let e=0;e<_.h;++e){const n=H(t,e);if(!n)continue;const o=b(n.no);!o||L(o.draw,n.count,(r,c)=>{const i=B(t,e,c*o.height);d.m.set(F(i[0],i[1],i[2])),s.uniformMatrix4fv(r.w,!1,d.m)})}for(let t=0;t<_.w;++t)for(let e=0;e<_.h;++e){const n=ft(t,e);if(!n)continue;const o=b(n.no);if(!o)continue;const r=dt(t,e);L(o.draw,1,(c,i)=>{const l=B(t,e,r);d.m.set(F(l[0],l[1],l[2])),s.uniformMatrix4fv(c.w,!1,d.m)})}},Ye=t=>{for(let e of t.ui){const n=ut(e);if(!n)continue;const o=M[e];!o||L(n.draw,1,(r,c)=>{s.uniformMatrix4fv(r.w,!1,o.m)})}},Ce=t=>{L(t.skybox,1,(e,n)=>{d.m.set(F(...d.cam.eye)),s.uniformMatrix4fv(e.w,!1,d.m)})},$e=t=>{Ce(t),t.draw3d&&Xe(),Ye(t)},He=()=>{Xt(),Jt(),kt(),te(),ee(0)},Ve=t=>{if(fe(t),Ut(),at()){be();const e=it(d.view);if(!e)return;Ee(e),Ge(e)}Le(),Nt()},Ke=()=>{if(Be(),at()){const t=it(d.view);if(!t)return;$e(t)}};A(window,"load",()=>{He();const t=e=>{Ve(e),Ke(),requestAnimationFrame(t)};t()});v.nextview=t=>{ke(t)};v.resetview=()=>{ht()};v.newgame=t=>{d.slot=t,Ue()};v.loadgame=t=>{d.slot=t,Ne()};v.savegame=()=>{Fe()};const st=(t,e,n,o)=>{const r=Math.floor(t),c=Math.floor(e),i=.25;let l=t+n,f=e+o;return p(r,c,-1,0)&&(l=Math.max(l,r+i)),p(r,c,1,0)&&(l=Math.min(l,r-i+1)),p(r,c,0,-1)&&(f=Math.max(f,c+i)),p(r,c,0,1)&&(f=Math.min(f,c-i+1)),p(r,c,-1,-1)&&([l,f]=O([l,f],i,[r,c])),p(r,c,-1,1)&&([l,f]=O([l,f],i,[r,c+1])),p(r,c,1,-1)&&([l,f]=O([l,f],i,[r+1,c])),p(r,c,1,1)&&([l,f]=O([l,f],i,[r+1,c+1])),[l,f]},ze=(t,e)=>{const n=S.dt,o=Y(e);o&&(a.ha+=90*n*o[0],a.va+=90*n*o[1],a.va=Math.max(-60,Math.min(a.va,80)));const r=Y(t);if(r){const l=P(a.ha+90),f=P(a.ha),E=r[0],x=r[1],w=E*Math.cos(l)+x*Math.cos(f),y=E*Math.sin(l)+x*Math.sin(f),h=2*n*w,mt=2*n*y;[a.x,a.y]=st(a.x,a.y,h,mt)}else[a.x,a.y]=st(a.x,a.y,0,0);const c=C(a.x,a.y);if(Math.abs(c-a.h)<=2){const i=c-a.h;a.h+=10*n*i}else a.h=c};v.fpsmove=(t,e)=>{ze(t,e)};v.makeworld=()=>{const t=ot("tile"),e=ot("mine");we(64,64);for(let n=24;n<=40;++n)for(let o=24;o<=40;++o)ge(n,o,t);G(29,29,e),G(35,29,e),G(29,35,e),G(35,35,e),ye(_.w/2+.5,_.h/2+.5),Pe(8),Se(le("pick"),1)};v.inventory_next=()=>{_t(1)};v.inventory_prev=()=>{_t(-1)};v.inventory=t=>{const e=lt(ie(t));if(!e)return;let n="";for(let o=0;o<m.s.length;++o){if(m.i===o?n+=">":n+=" ",n+="["+o+"]",m.s[o]!=null){const r=nt(m.s[o].no);if(!r)continue;n+=r.text+":"+m.s[o].num}n+=`
`}n+=`
`;{const o=Re();if(o!=null){const r=nt(o.no);r!=null&&(n+=r.desc+`
`)}}ct(e.cvs,n),Yt(e.tex,e.cvs)};})();
