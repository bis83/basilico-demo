(()=>{const P=t=>{const e=window.atob(t),n=new ArrayBuffer(e.length),s=new DataView(n);for(let r=0;r<e.length;++r)s.setUint8(r,e.charCodeAt(r));return n};const T=t=>t/180*Math.PI,tt=(t,e)=>Math.sqrt(t*t+e*e),x=(t,e)=>{const n=tt(t,e);return n!=0?[t/n,e/n]:[0,0]};const et=([t,e],n,s,r,a)=>n<=t&&t<=s&&r<=e&&e<=a,v=(t,e)=>t[0]*e[0]+t[1]*e[1]+t[2]*e[2],nt=t=>{const e=v(t,t);return Math.sqrt(e)},st=(t,e)=>[t[0]+e[0],t[1]+e[1],t[2]+e[2]],ot=(t,e)=>[t[0]-e[0],t[1]-e[1],t[2]-e[2]];const F=t=>{const e=nt(t);return[t[0]/e,t[1]/e,t[2]/e]},O=(t,e)=>[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]],ct=(t,e)=>{const n=T(t),s=T(e);return[Math.cos(s)*Math.cos(n),Math.cos(s)*Math.sin(n),Math.sin(s)]},N=(t,e,n)=>[t*2,e*2,n*.5];const rt=(t,e)=>[t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15],t[4]*e[0]+t[5]*e[4]+t[6]*e[8]+t[7]*e[12],t[4]*e[1]+t[5]*e[5]+t[6]*e[9]+t[7]*e[13],t[4]*e[2]+t[5]*e[6]+t[6]*e[10]+t[7]*e[14],t[4]*e[3]+t[5]*e[7]+t[6]*e[11]+t[7]*e[15],t[8]*e[0]+t[9]*e[4]+t[10]*e[8]+t[11]*e[12],t[8]*e[1]+t[9]*e[5]+t[10]*e[9]+t[11]*e[13],t[8]*e[2]+t[9]*e[6]+t[10]*e[10]+t[11]*e[14],t[8]*e[3]+t[9]*e[7]+t[10]*e[11]+t[11]*e[15],t[12]*e[0]+t[13]*e[4]+t[14]*e[8]+t[15]*e[12],t[12]*e[1]+t[13]*e[5]+t[14]*e[9]+t[15]*e[13],t[12]*e[2]+t[13]*e[6]+t[14]*e[10]+t[15]*e[14],t[12]*e[3]+t[13]*e[7]+t[14]*e[11]+t[15]*e[15]],at=(t,e,n)=>[1,0,0,0,0,1,0,0,0,0,1,0,t,e,n,1],lt=(t,e,n,s)=>{t[12]=e,t[13]=n,t[14]=s},it=(t,e,n)=>[t,0,0,0,0,e,0,0,0,0,n,0,0,0,0,1],ut=(t,e,n)=>{const s=F(ot(e,t)),r=F(O(n,s)),a=O(s,r),i=v(t,r),u=v(t,a),f=v(t,s);return[r[0],a[0],s[0],0,r[1],a[1],s[1],0,r[2],a[2],s[2],0,-i,-u,-f,1]},ft=(t,e,n,s)=>{const r=1/Math.tan(t),a=r/e,i=s/(s-n),u=-(i*n);return[a,0,0,0,0,r,0,0,0,0,i,1,0,0,u,0]},dt=(t,e,n,s)=>{const r=2/t,a=2/e,i=1/(s-n),u=n/(n-s);return[r,0,0,0,0,a,0,0,0,0,i,0,0,0,u,1]},I=(t,e)=>t<<0|e<<16,S=t=>[t>>0&65535,t>>16&65535],p=0,k=1,A=2;var l=null;const h=(t,e,n)=>{t.addEventListener(e,n)},ht=()=>{const t=document.body;t.style.userSelect="none",t.style.webkitUserSelect="none",t.style.msUserSelect="none",t.style.mozUserSelect="none"},mt=()=>{const t=document.body;t.style.touchAction="none"},pt=()=>{ht(),mt(),l={},l.mode=p,l.timer={prevTime:performance.now(),deltaTime:0},l.gamepad={index:null,lx:0,ly:0,rx:0,ry:0,b0:!1,b1:!1,b8:!1,b9:!1,lt:!1,rt:!1},l.keyboard={w:!1,a:!1,s:!1,d:!1,up:!1,left:!1,down:!1,right:!1,z:!1,x:!1,space:!1,lctrl:!1,esc:!1},l.touch=new Map,l.click=[],h(window,"focus",t=>{}),h(window,"blur",t=>{}),h(window,"resize",t=>{}),h(window,"gamepadconnected",t=>{l.gamepad.index=t.gamepad.index,l.mode=k}),h(window,"gamepaddisconnected",t=>{l.gamepad.index===t.gamepad.index&&(l.gamepad.index=null)}),h(document,"keydown",t=>{b(l.keyboard,t.code,!0)&&(l.mode=A,t.preventDefault())}),h(document,"keyup",t=>{b(l.keyboard,t.code,!1)&&(l.mode=A,t.preventDefault())}),h(document.body,"contextmenu",t=>{t.preventDefault()}),h(document.body,"pointerdown",t=>{l.touch.set(t.pointerId,{x:t.clientX,y:t.clientY,sx:t.clientX,sy:t.clientY,time:performance.now()}),l.mode=p}),h(document.body,"pointerup",t=>{_t(t.pointerId),l.touch.delete(t.pointerId),l.mode=p}),h(document.body,"pointerout",t=>{l.touch.delete(t.pointerId),l.mode=p}),h(document.body,"pointermove",t=>{const e=l.touch.get(t.pointerId);e&&(e.x=t.clientX,e.y=t.clientY,l.mode=p)})},b=(t,e,n)=>{switch(e){case"KeyW":t.w=n;break;case"KeyA":t.a=n;break;case"KeyS":t.s=n;break;case"KeyD":t.d=n;break;case"ArrowUp":t.up=n;break;case"ArrowLeft":t.left=n;break;case"ArrowDown":t.down=n;break;case"ArrowRight":t.right=n;break;case"KeyZ":t.z=n;break;case"KeyX":t.x=n;break;case"Space":t.space=n;break;case"ControlLeft":t.lctrl=n;break;case"Escape":t.esc=n;break;default:return!1}return!0},_t=t=>{const e=l.touch.get(t);e&&performance.now()-e.time<250&&l.click.push({x:e.x,y:e.y})},gt=t=>{const e=performance.now();t.deltaTime=(e-t.prevTime)/1e3,t.prevTime=e},xt=t=>{if(t.index!==null){const n=navigator.getGamepads()[t.index];t.lx=Math.trunc(n.axes[0]*4)/4,t.ly=Math.trunc(n.axes[1]*4)/4,t.rx=Math.trunc(n.axes[2]*4)/4,t.ry=Math.trunc(n.axes[3]*4)/4,t.b0=n.buttons[0].value>=.5,t.b1=n.buttons[1].value>=.5,t.b8=n.buttons[8].value>=.5,t.b9=n.buttons[9].value>=.5,t.lt=n.buttons[6].value>=.5,t.rt=n.buttons[7].value>=.5,!!(t.lx||t.ly||t.rx||t.ry||t.b0||t.b1||t.b8||t.b9||t.lt||t.rt)&&(l.mode=k)}},wt=()=>{gt(l.timer),xt(l.gamepad)},Tt=()=>{l.click.length=0},kt=t=>{const e=localStorage.getItem(t);return e==null?null:JSON.parse(e)},At=(t,e)=>{const n=JSON.stringify(e);localStorage.setItem(t,n)};var o=null;const Et=()=>{o=document.getElementById("main").getContext("webgl2")},B=0,X=1,C=2,Y=3,yt=t=>{let e=o.createTexture();return o.bindTexture(o.TEXTURE_2D,e),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,t),o.bindTexture(o.TEXTURE_2D,null),e},vt=(t,e,n)=>{const s=document.createElement("canvas");if(!s)return null;s.width=e,s.height=n;const r=s.getContext("2d");return r?(r.fillStyle="white",r.textAlign="center",r.textBaseline="middle",r.font="24px monospace",r.fillText(t,s.width/2,s.height/2),s):null},V=(t,e)=>{const n=o.createShader(t);return o.shaderSource(n,e),o.compileShader(n),o.getShaderParameter(n,o.COMPILE_STATUS)?n:(o.deleteShader(n),null)},St=(t,e)=>{const n=o.createProgram();return o.attachShader(n,t),o.attachShader(n,e),o.linkProgram(n),o.getProgramParameter(n,o.LINK_STATUS)?n:(o.deleteProgram(n),null)},H=(t,e)=>{let n=o.createBuffer();return o.bindBuffer(t,n),o.bufferData(t,e,o.STATIC_DRAW),n},M=(t,e,n,s,r,a)=>{o.enableVertexAttribArray(t),o.vertexAttribPointer(t,e,n,s,r,a)},Mt=()=>{const t=window.innerWidth;t!==o.canvas.width&&(o.canvas.width=t);const e=window.innerHeight;e!==o.canvas.height&&(o.canvas.height=e)},Rt=()=>{o.viewport(0,0,o.canvas.width,o.canvas.height),o.clearColor(0,0,0,1),o.clearDepth(1),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT)},z=(t,e)=>{o.enable(o.CULL_FACE),t?(o.enable(o.DEPTH_TEST),o.depthFunc(o.LEQUAL)):o.disable(o.DEPTH_TEST),e?(o.enable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA)):(o.disable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA))},$=(t,e)=>{e=e||0;const n=t.iv[e*3+0],s=t.iv[e*3+1],r=t.iv[e*3+2],a=[null,o.POINTS,o.LINES,o.TRIANGLES];t.i?o.drawElements(a[n],r,o.UNSIGNED_SHORT,2*s):o.drawArrays(a[n],s,r)};var Lt=null;const It=()=>{Lt=new AudioContext};const Ut=t=>{if(t.vao=o.createVertexArray(),o.bindVertexArray(t.vao),t.b&&(t.b=H(o.ARRAY_BUFFER,P(t.b)),t.bv))for(let e=0;e<t.bv.length;e+=2)switch(t.bv[e]){case B:M(B,3,o.FLOAT,!1,0,t.bv[e+1]);break;case X:M(X,3,o.HALF_FLOAT,!1,0,t.bv[e+1]);break;case C:M(C,4,o.UNSIGNED_BYTE,!0,0,t.bv[e+1]);break;case Y:M(Y,2,o.HALF_FLOAT,!1,0,t.bv[e+1]);break}return t.i&&(t.i=H(o.ELEMENT_ARRAY_BUFFER,P(t.i))),o.bindVertexArray(null),t},Dt=t=>{if(t.vs=V(o.VERTEX_SHADER,t.vs),t.fs=V(o.FRAGMENT_SHADER,t.fs),t.prog=St(t.vs,t.fs),t.u){const e={};for(let n of t.u)e[n]=o.getUniformLocation(t.prog,n);t.u=e}if(t.ub){const e={};let n=0;for(let s of t.ub){const r=o.getUniformBlockIndex(t.prog,s);o.uniformBlockBinding(t.prog,r,n),e[s]=n,n+=1}t.ub=e}return t},Gt=t=>(t.texture=yt(vt(t.text,t.width,t.height)),t),d={index:null,pack:[]},Pt=()=>d.index!=null&&d.pack.length>0,Ft=()=>{fetch("data/index.json").then(e=>e.json()).then(e=>{d.index=e})},Ot=t=>{const e="data/pack"+t+".json";fetch(e).then(n=>n.json()).then(n=>{n.mesh&&(n.mesh=n.mesh.map(s=>Ut(s))),n.texture&&(n.texture=n.texture.map(s=>Gt(s))),n.shader&&(n.shader=n.shader.map(s=>Dt(s))),d.pack[t]=n})},K=t=>d.pack[0]&&d.pack[0].mesh[t];const W=t=>d.pack[0]&&d.pack[0].shader[t],q=t=>d.pack[0]&&d.pack[0].stack.find(e=>e.id==t),J=t=>d.index&&(t?d.index.ui_pause:d.index.ui_main),Q=t=>d.index&&d.index.ui[t];var c={cam:{vp:new Float32Array(16),o:new Float32Array(16)},init:!1,pause:!1,slot:null,pos:{x:0,y:0,ha:0,va:0,h:0,eyeh:1.75},stack:{w:0,h:0,a:[]},ui:{}};const R=(t,e)=>(t=Math.floor(t),e=Math.floor(e),t<0||c.stack.w<=t||e<0||c.stack.h<=e?null:c.stack.a[t+e*c.stack.h]),U=(t,e)=>{const n=R(t,e);if(!n)return 0;let s=0;for(const r of n){const[a,i]=S(r),u=q(a);!u||(s+=i*u.height)}return s},g=t=>{const e=c.ui[t];return e?e.value:null},Nt=0,D=0,E=1,G=(t,e)=>{const n=window.innerWidth,s=window.innerHeight,r=n/2+t.offset[0]-t.width/2,a=n/2+t.offset[0]+t.width/2,i=s/2+t.offset[1]-t.height/2,u=s/2+t.offset[1]+t.height/2;return et(e,r,a,i,u)},bt=(t,e)=>{const n=l.mode;if(n===p){let s=!1;const r=l.click;for(let a of r)if(G(e,[a.x,a.y])){s=!0;break}s?(t.value=!0,t.state=E):(t.value=!1,t.state=D)}else n===k?l.gamepad[e.gamepad]?t.state!==E?(t.value=!0,t.state=E):t.value=!1:(t.value=!1,t.state=D):n===A&&(l.keyboard[e.keyboard]?t.state!==E?(t.value=!0,t.state=E):t.value=!1:(t.value=!1,t.state=D))},Bt=(t,e)=>{const n=l.mode;if(n===p){t.value=[0,0];for(const s of l.touch.values())if(G(e,[s.sx,s.sy])){const r=s.x-s.sx,a=-(s.y-s.sy);t.value=x(r,a);break}}else if(n===k){const s=l.gamepad;t.value=x(s.lx,-s.ly)}else if(n===A){const s=l.keyboard,r=s.a?-1:s.d?1:0,a=s.w?1:s.s?-1:0;t.value=x(r,a)}},Xt=(t,e)=>{const n=l.mode;if(n===p){t.value=[0,0];for(const s of l.touch.values())if(G(e,[s.sx,s.sy])){const r=s.x-s.sx,a=-(s.y-s.sy);t.value=x(r,a);break}}else if(n===k){const s=l.gamepad;t.value=x(s.rx,-s.ry)}else if(n===A){const s=l.keyboard,r=s.right?1:s.left?-1:0,a=s.up?1:s.down?-1:0;t.value=x(r,a)}},Ct=()=>{const t=J(c.pause);if(!!t)for(let e of t){const n=Q(e);if(!n)continue;c.ui[n.name]||(c.ui[n.name]={m:new Float32Array(16),value:null,state:Nt});const s=c.ui[n.name];switch(n.interact){case 1:bt(s,n);break;case 2:Bt(s,n);break;case 3:Xt(s,n);break;default:break}const r=it(n.width/2,n.height/2,1);lt(r,n.offset[0],-n.offset[1],0),s.m.set(r)}},Yt=()=>{c.stack.w=64,c.stack.h=64,c.stack.a.length=0,c.stack.a.length=c.stack.w*c.stack.h;for(let t=0;t<c.stack.a.length;++t){const e=1+Math.floor(Math.random()*10);c.stack.a[t]=[],c.stack.a[t].push(I(1,e))}c.pos.x=.5,c.pos.y=.5},Vt=()=>{if(!c.slot)return!1;const t=kt(c.slot);return t?(t.pos&&(c.pos=t.pos),t.stack&&(c.stack=t.stack),!0):!1},Z=()=>{if(!c.slot)return;const t={};t.pos=c.pos,t.stack=c.stack,At(c.slot,t)},L=(t,e,n,s)=>{const r=U(t,e),a=U(t+n,e+s);return Math.abs(r-a)>1},j=(t,e,n,s)=>{let r=t+n,a=e+s;const i=Math.floor(t),u=Math.floor(e),f=.25;return L(i,u,-1,0)&&(r=Math.max(r,i+f)),L(i,u,1,0)&&(r=Math.min(r,i-f+1)),L(i,u,0,-1)&&(a=Math.max(a,u+f)),L(i,u,0,1)&&(a=Math.min(a,u-f+1)),[r,a]},Ht=()=>{const t=l.timer.deltaTime,e=g("right-stick");if(e){const r=90;c.pos.ha+=r*t*e[0],c.pos.va+=r*t*e[1],c.pos.va=Math.max(-60,Math.min(c.pos.va,80))}const n=g("left-stick");if(n){const r=2,a=T(c.pos.ha+90),i=T(c.pos.ha),u=n[0],f=n[1],m=u*Math.cos(a)+f*Math.cos(i),_=u*Math.sin(a)+f*Math.sin(i),y=r*t*m,w=r*t*_;[c.pos.x,c.pos.y]=j(c.pos.x,c.pos.y,y,w)}else[c.pos.x,c.pos.y]=j(c.pos.x,c.pos.y,0,0);const s=U(c.pos.x,c.pos.y);if(Math.abs(s-c.pos.h)<=2){const r=s-c.pos.h;c.pos.h+=10*t*r}else c.pos.h=s},zt=()=>{const t=window.innerWidth,e=window.innerHeight,n=T(30),s=.1,r=1e3,a=ct(c.pos.ha,c.pos.va),i=N(c.pos.x,c.pos.y,c.pos.h);i[2]+=c.pos.eyeh;const u=st(i,a),m=ut(i,u,[0,0,1]),_=ft(n,t/e,s,r);c.cam.vp.set(rt(m,_)),c.cam.o.set(dt(t,e,0,1))},$t=()=>{if(g("button-act")){const t=R(c.pos.x,c.pos.y);if(t&&t.length>0){let[e,n]=S(t[t.length-1]);n+=1,t[t.length-1]=I(e,n)}Z()}if(g("button-sub")){const t=R(c.pos.x,c.pos.y);if(t&&t.length>0){let[e,n]=S(t[t.length-1]);n-=1,n>0?t[t.length-1]=I(e,n):t.pop()}Z()}g("button-escape")&&(c.pause=!0)},Kt=()=>{g("button-newgame")&&(c.slot="data0",Yt(),c.pause=!1),g("button-loadgame")&&(c.slot="data0",Vt(),c.pause=!1)},Wt=()=>{c.slot===null&&(c.pause=!0),Ct(),c.pause?Kt():(Ht(),$t()),zt()},qt=()=>{Mt(),Rt()},Jt=()=>{const t=new Float32Array(16);z(!0,!1);for(let e=0;e<c.stack.w;++e)for(let n=0;n<c.stack.h;++n){const s=R(e,n);if(!s)return;let r=0;for(const a of s){const[i,u]=S(a),f=q(i);if(!f)continue;const m=W(f.shader);if(!m)continue;o.useProgram(m.prog),o.uniformMatrix4fv(m.u.vp,!1,c.cam.vp);const _=K(f.mesh);if(!!_){o.bindVertexArray(_.vao);for(let y=0;y<u;++y){const w=N(e,n,r);t.set(at(w[0],w[1],w[2])),o.uniformMatrix4fv(m.u.w,!1,t),$(_),r+=f.height}}}}},Qt=()=>{const t=J(c.pause);if(!!t){z(!1,!0);for(let e of t){const n=Q(e);if(!n)continue;const s=c.ui[n.name];if(!s)continue;const r=W(n.shader);if(!r)return;o.useProgram(r.prog),o.uniformMatrix4fv(r.u.vp,!1,c.cam.o);const a=K(n.mesh);if(!a)return;o.bindVertexArray(a.vao),o.uniformMatrix4fv(r.u.w,!1,s.m),$(a)}}},Zt=()=>{qt(),c.pause===!1&&Jt(),Qt()};h(window,"load",()=>{Et(),It(),pt(),Ft(),Ot(0);const t=()=>{wt(),Pt()&&(Wt(),Zt()),Tt(),requestAnimationFrame(t)};t()});})();
