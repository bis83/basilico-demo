(()=>{const D=e=>{const t=window.atob(e),o=new ArrayBuffer(t.length),n=new DataView(o);for(let s=0;s<t.length;++s)n.setUint8(s,t.charCodeAt(s));return o};const p=e=>e/180*Math.PI,$=(e,t)=>Math.sqrt(e*e+t*t),I=(e,t)=>{const o=$(e,t);return o!=0?[e/o,t/o]:[0,0]};const A=(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],W=e=>{const t=A(e,e);return Math.sqrt(t)},j=(e,t)=>[e[0]+t[0],e[1]+t[1],e[2]+t[2]],K=(e,t)=>[e[0]-t[0],e[1]-t[1],e[2]-t[2]];const U=e=>{const t=W(e);return[e[0]/t,e[1]/t,e[2]/t]},F=(e,t)=>[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]],q=(e,t)=>{const o=p(e),n=p(t);return[Math.cos(n)*Math.cos(o),Math.sin(n),Math.cos(n)*Math.sin(o)]},P=(e,t,o)=>[e*2,o*.5,t*2];const J=(e,t)=>[e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15]],G=(e,t,o)=>[1,0,0,0,0,1,0,0,0,0,1,0,e,t,o,1],Q=(e,t,o)=>[e,0,0,0,0,t,0,0,0,0,o,0,0,0,0,1],Z=(e,t,o)=>{const n=U(K(t,e)),s=U(F(o,n)),l=F(n,s),d=A(e,s),m=A(e,l),u=A(e,n);return[s[0],l[0],n[0],0,s[1],l[1],n[1],0,s[2],l[2],n[2],0,-d,-m,-u,1]},ee=(e,t,o,n)=>{const s=1/Math.tan(e),l=s/t,d=n/(n-o),m=-(d*o);return[l,0,0,0,0,s,0,0,0,0,d,1,0,0,m,0]},te=(e,t,o,n)=>{const s=2/e,l=2/t,d=1/(n-o),m=o/(o-n);return[s,0,0,0,0,l,0,0,0,0,d,0,0,0,m,1]},oe=(e,t)=>e<<0|t<<16,X=e=>[e>>0&65535,e>>16&65535],E=0,x=1,v=2;var a=null;const i=(e,t,o)=>{e.addEventListener(t,o)},re=()=>{a={},a.timer={prevTime:performance.now(),deltaTime:0},a.input={mode:E,moveX:0,moveY:0,cameraX:0,cameraY:0,jump:!1,sneak:!1,jumpButton:!1,sneakButton:!1},a.input.gamepad={index:null,lx:0,ly:0,rx:0,ry:0,b0:!1,b1:!1,lt:!1,rt:!1},a.input.keyboard={w:!1,a:!1,s:!1,d:!1,space:!1,lctrl:!1},a.input.mouse={x:0,y:0,mx:0,my:0,lb:!1,rb:!1},a.input.touch=new Map,i(window,"focus",e=>{}),i(window,"blur",e=>{}),i(window,"resize",e=>{}),i(window,"gamepadconnected",e=>{a.input.gamepad.index=e.gamepad.index,a.input.mode=E}),i(window,"gamepaddisconnected",e=>{a.input.gamepad.index===e.gamepad.index&&(a.input.gamepad.index=null)}),i(document,"keydown",e=>{O(a.input.keyboard,e.code,!0)&&(a.input.mode=x,e.preventDefault())}),i(document,"keyup",e=>{O(a.input.keyboard,e.code,!1)&&(a.input.mode=x,e.preventDefault())}),i(document.body,"contextmenu",e=>{e.preventDefault()}),i(document.body,"mousedown",e=>{M(a.input.mouse,e)&&(a.input.mode=x,e.preventDefault())}),i(document.body,"mouseup",e=>{M(a.input.mouse,e)&&(a.input.mode=x,e.preventDefault())}),i(document.body,"mousemove",e=>{M(a.input.mouse,e)&&(a.input.mode=x,e.preventDefault())}),i(document.body,"touchstart",e=>{for(const t of e.changedTouches)a.input.touch.set(t.identifier,{x:t.clientX,y:t.clientY,sx:t.clientX,sy:t.clientY});a.input.mode=v}),i(document.body,"touchend",e=>{for(const t of e.changedTouches)a.input.touch.delete(t.identifier);a.input.mode=v}),i(document.body,"touchcancel",e=>{for(const t of e.changedTouches)a.input.touch.delete(t.identifier);a.input.mode=v}),i(document.body,"touchmove",e=>{for(const t of e.changedTouches){const o=a.input.touch.get(t.identifier);o&&(o.x=t.clientX,o.y=t.clientY)}a.input.mode=v})},O=(e,t,o)=>{switch(t){case"KeyW":e.w=o;break;case"KeyA":e.a=o;break;case"KeyS":e.s=o;break;case"KeyD":e.d=o;break;case"Space":e.space=o;break;case"ControlLeft":e.lctrl=o;break;default:return!1}return!0},M=(e,t)=>(e.mx+=t.movementX||0,e.my+=t.movementY||0,e.x=t.x,e.y=t.y,e.lb=(t.buttons&1)!=0,e.rb=(t.buttons&2)!=0,!0),ne=e=>{const t=performance.now();e.deltaTime=(t-e.prevTime)/1e3,e.prevTime=t},se=e=>{if(e.gamepad.index!==null){const o=navigator.getGamepads()[e.gamepad.index];e.gamepad.lx=Math.trunc(o.axes[0]*4)/4,e.gamepad.ly=Math.trunc(o.axes[1]*4)/4,e.gamepad.rx=Math.trunc(o.axes[2]*4)/4,e.gamepad.ry=Math.trunc(o.axes[3]*4)/4,e.gamepad.b0=o.buttons[0].value>=.5,e.gamepad.b1=o.buttons[1].value>=.5,e.gamepad.lt=o.buttons[6].value>=.5,e.gamepad.rt=o.buttons[7].value>=.5,!!(e.gamepad.lx||e.gamepad.ly||e.gamepad.rx||e.gamepad.ry||e.gamepad.b0||e.gamepad.b1||e.gamepad.lt||e.gamepad.rt)&&(e.mode=E)}},ae=e=>{const t=e.mode;if(t===E)e.moveX=e.gamepad.lx,e.moveY=-e.gamepad.ly,e.cameraX=-e.gamepad.rx,e.cameraY=-e.gamepad.ry,e.jump=!e.jumpButton&&e.gamepad.b0,e.sneak=!e.sneakButton&&e.gamepad.b1,e.jumpButton=e.gamepad.b0,e.sneakButton=e.gamepad.b1;else if(t===x)e.moveX=e.keyboard.a?-1:e.keyboard.d?1:0,e.moveY=e.keyboard.w?1:e.keyboard.s?-1:0,e.mouse.lb?(e.cameraX=-e.mouse.mx,e.cameraY=-e.mouse.my):(e.cameraX=0,e.cameraY=0),e.jump=!e.jumpButton&&e.keyboard.space,e.sneak=!e.sneakButton&&e.keyboard.lctrl,e.jumpButton=e.keyboard.space,e.sneakButton=e.keyboard.lctrl;else if(t===v){e.moveX=0,e.moveY=0,e.cameraX=0,e.cameraY=0;for(const o of e.touch.values())o.sx<window.innerWidth/2?(e.moveX=o.x-o.sx,e.moveY=-(o.y-o.sy)):(e.cameraX=-(o.x-o.sx),e.cameraY=-(o.y-o.sy))}else e.moveX=0,e.moveY=0,e.cameraX=0,e.cameraY=0;[e.moveX,e.moveY]=I(e.moveX,e.moveY),[e.cameraX,e.cameraY]=I(e.cameraX,e.cameraY)},ce=e=>{const t=o=>Math.trunc(o/2);e.mx=t(e.mx),e.my=t(e.my)},le=()=>{ne(a.timer),se(a.input),ae(a.input),ce(a.input.mouse)};var r=null;const de=()=>{r=document.getElementById("main").getContext("webgl2")},Y=0,B=1,N=2,b=3,me=e=>{let t=r.createTexture();return r.bindTexture(r.TEXTURE_2D,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e),r.bindTexture(r.TEXTURE_2D,null),t},ie=(e,t,o)=>{const n=document.createElement("canvas");if(!n)return null;n.width=t,n.height=o;const s=n.getContext("2d");return s?(s.fillStyle="white",s.textAlign="center",s.textBaseline="middle",s.font="24px monospace",s.fillText(e,n.width/2,n.height/2),n):null},C=(e,t)=>{const o=r.createShader(e);return r.shaderSource(o,t),r.compileShader(o),r.getShaderParameter(o,r.COMPILE_STATUS)?o:(r.deleteShader(o),null)},ue=(e,t)=>{const o=r.createProgram();return r.attachShader(o,e),r.attachShader(o,t),r.linkProgram(o),r.getProgramParameter(o,r.LINK_STATUS)?o:(r.deleteProgram(o),null)},V=(e,t)=>{let o=r.createBuffer();return r.bindBuffer(e,o),r.bufferData(e,t,r.STATIC_DRAW),o},y=(e,t,o,n,s,l)=>{r.enableVertexAttribArray(e),r.vertexAttribPointer(e,t,o,n,s,l)},he=()=>{const e=window.innerWidth;e!==r.canvas.width&&(r.canvas.width=e);const t=window.innerHeight;t!==r.canvas.height&&(r.canvas.height=t)},fe=()=>{r.viewport(0,0,r.canvas.width,r.canvas.height),r.clearColor(0,0,0,1),r.clearDepth(1),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT)},S=(e,t)=>{r.enable(r.CULL_FACE),e?(r.enable(r.DEPTH_TEST),r.depthFunc(r.LEQUAL)):r.disable(r.DEPTH_TEST),t?(r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA)):(r.disable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA))},k=(e,t)=>{t=t||0;const o=e.iv[t*3+0],n=e.iv[t*3+1],s=e.iv[t*3+2],l=[null,r.POINTS,r.LINES,r.TRIANGLES];e.i?r.drawElements(l[o],s,r.UNSIGNED_SHORT,2*n):r.drawArrays(l[o],n,s)};var ge=null;const _e=()=>{ge=new AudioContext};const xe=e=>{if(e.vao=r.createVertexArray(),r.bindVertexArray(e.vao),e.b&&(e.b=V(r.ARRAY_BUFFER,D(e.b)),e.bv))for(let t=0;t<e.bv.length;t+=2)switch(e.bv[t]){case Y:y(Y,3,r.FLOAT,!1,0,e.bv[t+1]);break;case B:y(B,3,r.HALF_FLOAT,!1,0,e.bv[t+1]);break;case N:y(N,4,r.UNSIGNED_BYTE,!0,0,e.bv[t+1]);break;case b:y(b,2,r.HALF_FLOAT,!1,0,e.bv[t+1]);break}return e.i&&(e.i=V(r.ELEMENT_ARRAY_BUFFER,D(e.i))),r.bindVertexArray(null),e},we=e=>{if(e.vs=C(r.VERTEX_SHADER,e.vs),e.fs=C(r.FRAGMENT_SHADER,e.fs),e.prog=ue(e.vs,e.fs),e.u){const t={};for(let o of e.u)t[o]=r.getUniformLocation(e.prog,o);e.u=t}if(e.ub){const t={};let o=0;for(let n of e.ub){const s=r.getUniformBlockIndex(e.prog,n);r.uniformBlockBinding(e.prog,s,o),t[n]=o,o+=1}e.ub=t}return e},pe=e=>(e.texture=me(ie(e.text,e.width,e.height)),e),h={index:null,pack:[]},ve=()=>h.index!=null&&h.pack.length>0,Te=()=>{fetch("data/index.json").then(t=>t.json()).then(t=>{h.index=t})},Ae=e=>{const t="data/pack"+e+".json";fetch(t).then(o=>o.json()).then(o=>{o.mesh&&(o.mesh=o.mesh.map(n=>xe(n))),o.texture&&(o.texture=o.texture.map(n=>pe(n))),o.shader&&(o.shader=o.shader.map(n=>we(n))),h.pack[e]=o})},L=e=>h.pack[0].mesh[e];const R=e=>h.pack[0].shader[e];var c={cam:{vp:new Float32Array(16),o:new Float32Array(16)},pos:{x:0,y:0,ha:0,va:0,h:1.75},world:{w:0,h:0,s:[]}};const Ee=()=>{c.world.w=64,c.world.h=64,c.world.s.length=0,c.world.s.length=c.world.w*c.world.h;for(let e=0;e<c.world.s.length;++e){const t=1+Math.floor(Math.random()*10);c.world.s[e]=[],c.world.s[e].push(oe(1,t))}c.pos.x=.5,c.pos.y=.5},H=(e,t)=>(e=Math.floor(e),t=Math.floor(t),e<0||c.world.w<=e||t<0||c.world.h<=t?null:c.world.s[e+t*c.world.h]),w=(e,t)=>{const o=H(e,t);if(!o)return 0;let n=0;for(const s of o){const[l,d]=X(s);n+=d}return n},ye=(e,t,o,n)=>{let s=e+o,l=t+n;const d=Math.floor(e),m=Math.floor(t),u=w(d+0,m+0),g=w(d-1,m+0),f=w(d+1,m+0),_=w(d+0,m-1),z=w(d+0,m+1),T=.25;return Math.abs(u-g)>1&&(s=Math.max(s,d+T)),Math.abs(u-f)>1&&(s=Math.min(s,d-T+1)),Math.abs(u-_)>1&&(l=Math.max(l,m+T)),Math.abs(u-z)>1&&(l=Math.min(l,m-T+1)),[s,l]},Me=()=>{const e=a.timer.deltaTime,t=90;c.pos.ha+=t*e*a.input.cameraX,c.pos.va+=t*e*a.input.cameraY;const o=2,n=p(c.pos.ha-90),s=p(c.pos.ha),l=a.input.moveX,d=a.input.moveY,m=l*Math.cos(n)+d*Math.cos(s),u=l*Math.sin(n)+d*Math.sin(s),g=o*e*m,f=o*e*u;[c.pos.x,c.pos.y]=ye(c.pos.x,c.pos.y,g,f)},Se=()=>{const e=window.innerWidth,t=window.innerHeight,o=p(30),n=.1,s=1e3,l=q(c.pos.ha,c.pos.va),d=w(c.pos.x,c.pos.y),m=P(c.pos.x,c.pos.y,d);m[1]+=c.pos.h;const u=j(m,l),f=Z(m,u,[0,1,0]),_=ee(o,e/t,n,s);c.cam.vp.set(J(f,_)),c.cam.o.set(te(e,t,0,1))},ke=()=>{Me(),Se()},Le=()=>{he(),fe()},Re=(e,t,o,n)=>{const s=H(o,n);if(!s)return;let l=0;for(const d of s){const[m,u]=X(d);for(let g=0;g<u;++g){const f=P(o,n,l),_=new Float32Array(16);_.set(G(f[0],f[1],f[2])),r.uniformMatrix4fv(e.u.w,!1,_),k(t),++l}}},De=()=>{S(!0,!1);const e=R(h.index.data.mesh_pc);if(!e)return;r.useProgram(e.prog),r.uniformMatrix4fv(e.u.vp,!1,c.cam.vp);const t=L(h.index.data.stack);if(!!t){r.bindVertexArray(t.vao);for(let o=0;o<c.world.w;++o)for(let n=0;n<c.world.h;++n)Re(e,t,o,n)}},Ie=()=>{S(!0,!1);const e=R(h.index.data.mesh_pc);if(!e)return;r.useProgram(e.prog),r.uniformMatrix4fv(e.u.vp,!1,c.cam.vp);const t=L(h.index.data.debug_grid);if(!t)return;r.bindVertexArray(t.vao);const o=new Float32Array(16);o.set(G(0,0,0)),r.uniformMatrix4fv(e.u.w,!1,o),k(t)},Ue=()=>{S(!1,!0);const e=R(h.index.data.mesh_pc);if(!e)return;r.useProgram(e.prog),r.uniformMatrix4fv(e.u.vp,!1,c.cam.o);const t=L(h.index.data.reticle);if(!t)return;r.bindVertexArray(t.vao);const o=new Float32Array(16);o.set(Q(4,4,1)),r.uniformMatrix4fv(e.u.w,!1,o),k(t)},Fe=()=>{Le(),De(),Ie(),Ue()};i(window,"load",()=>{de(),_e(),re(),Ee(),Te(),Ae(0);const e=()=>{le(),ve()&&(ke(),Fe()),requestAnimationFrame(e)};e()});})();
