(()=>{const U=e=>{const t=window.atob(e),o=new ArrayBuffer(t.length),n=new DataView(o);for(let c=0;c<t.length;++c)n.setUint8(c,t.charCodeAt(c));return o};const x=e=>e/180*Math.PI,q=(e,t)=>Math.sqrt(e*e+t*t),D=(e,t)=>{const o=q(e,t);return o!=0?[e/o,t/o]:[0,0]};const w=(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],J=e=>{const t=w(e,e);return Math.sqrt(t)},Q=(e,t)=>[e[0]+t[0],e[1]+t[1],e[2]+t[2]],Z=(e,t)=>[e[0]-t[0],e[1]-t[1],e[2]-t[2]];const b=e=>{const t=J(e);return[e[0]/t,e[1]/t,e[2]/t]},I=(e,t)=>[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]],j=(e,t)=>{const o=x(e),n=x(t);return[Math.cos(n)*Math.cos(o),Math.cos(n)*Math.sin(o),Math.sin(n)]},F=(e,t,o)=>[e*2,t*2,o*.5];const ee=(e,t)=>[e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15]],te=(e,t,o)=>[1,0,0,0,0,1,0,0,0,0,1,0,e,t,o,1],oe=(e,t,o)=>[e,0,0,0,0,t,0,0,0,0,o,0,0,0,0,1],se=(e,t,o)=>{const n=b(Z(t,e)),c=b(I(o,n)),l=I(n,c),i=w(e,c),d=w(e,l),u=w(e,n);return[c[0],l[0],n[0],0,c[1],l[1],n[1],0,c[2],l[2],n[2],0,-i,-d,-u,1]},ne=(e,t,o,n)=>{const c=1/Math.tan(e),l=c/t,i=n/(n-o),d=-(i*o);return[l,0,0,0,0,c,0,0,0,0,i,1,0,0,d,0]},re=(e,t,o,n)=>{const c=2/e,l=2/t,i=1/(n-o),d=o/(o-n);return[c,0,0,0,0,l,0,0,0,0,i,0,0,0,d,1]},M=(e,t)=>e<<0|t<<16,v=e=>[e>>0&65535,e>>16&65535],y=0,p=1,T=2;var a=null;const m=(e,t,o)=>{e.addEventListener(t,o)},ce=()=>{const e=document.body;e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.msUserSelect="none",e.style.mozUserSelect="none"},ae=()=>{const e=document.body;e.style.touchAction="none"},le=()=>{ce(),ae(),a={},a.timer={prevTime:performance.now(),deltaTime:0},a.input={mode:y,moveX:0,moveY:0,cameraX:0,cameraY:0,act:!1,sub:!1,actButton:!1,subButton:!1},a.input.gamepad={index:null,lx:0,ly:0,rx:0,ry:0,b0:!1,b1:!1,lt:!1,rt:!1},a.input.keyboard={w:!1,a:!1,s:!1,d:!1,up:!1,left:!1,down:!1,right:!1,space:!1,lctrl:!1},a.input.mouse={x:0,y:0,mx:0,my:0,lb:!1,rb:!1,mb:!1},a.input.touch=new Map,m(window,"focus",e=>{}),m(window,"blur",e=>{}),m(window,"resize",e=>{}),m(window,"gamepadconnected",e=>{a.input.gamepad.index=e.gamepad.index,a.input.mode=y}),m(window,"gamepaddisconnected",e=>{a.input.gamepad.index===e.gamepad.index&&(a.input.gamepad.index=null)}),m(document,"keydown",e=>{G(a.input.keyboard,e.code,!0)&&(a.input.mode=p,e.preventDefault())}),m(document,"keyup",e=>{G(a.input.keyboard,e.code,!1)&&(a.input.mode=p,e.preventDefault())}),m(document.body,"contextmenu",e=>{e.preventDefault()}),m(document.body,"mousedown",e=>{L(a.input.mouse,e)&&(a.input.mode=p,e.preventDefault())}),m(document.body,"mouseup",e=>{L(a.input.mouse,e)&&(a.input.mode=p,e.preventDefault())}),m(document.body,"mousemove",e=>{L(a.input.mouse,e)&&(a.input.mode=p,e.preventDefault())}),m(document.body,"touchstart",e=>{for(const t of e.changedTouches)a.input.touch.set(t.identifier,{x:t.clientX,y:t.clientY,sx:t.clientX,sy:t.clientY});a.input.mode=T}),m(document.body,"touchend",e=>{for(const t of e.changedTouches)a.input.touch.delete(t.identifier);a.input.mode=T}),m(document.body,"touchcancel",e=>{for(const t of e.changedTouches)a.input.touch.delete(t.identifier);a.input.mode=T}),m(document.body,"touchmove",e=>{for(const t of e.changedTouches){const o=a.input.touch.get(t.identifier);o&&(o.x=t.clientX,o.y=t.clientY)}a.input.mode=T})},G=(e,t,o)=>{switch(t){case"KeyW":e.w=o;break;case"KeyA":e.a=o;break;case"KeyS":e.s=o;break;case"KeyD":e.d=o;break;case"ArrowUp":e.up=o;break;case"ArrowLeft":e.left=o;break;case"ArrowDown":e.down=o;break;case"ArrowRight":e.right=o;break;case"Space":e.space=o;break;case"ControlLeft":e.lctrl=o;break;default:return!1}return!0},L=(e,t)=>(e.mx+=t.movementX||0,e.my+=t.movementY||0,e.x=t.x,e.y=t.y,e.lb=(t.buttons&1)!=0,e.rb=(t.buttons&2)!=0,e.mb=(t.buttons&4)!=0,!0),ie=e=>{const t=performance.now();e.deltaTime=(t-e.prevTime)/1e3,e.prevTime=t},de=e=>{if(e.gamepad.index!==null){const o=navigator.getGamepads()[e.gamepad.index];e.gamepad.lx=Math.trunc(o.axes[0]*4)/4,e.gamepad.ly=Math.trunc(o.axes[1]*4)/4,e.gamepad.rx=Math.trunc(o.axes[2]*4)/4,e.gamepad.ry=Math.trunc(o.axes[3]*4)/4,e.gamepad.b0=o.buttons[0].value>=.5,e.gamepad.b1=o.buttons[1].value>=.5,e.gamepad.lt=o.buttons[6].value>=.5,e.gamepad.rt=o.buttons[7].value>=.5,!!(e.gamepad.lx||e.gamepad.ly||e.gamepad.rx||e.gamepad.ry||e.gamepad.b0||e.gamepad.b1||e.gamepad.lt||e.gamepad.rt)&&(e.mode=y)}},me=e=>{const t=e.mode;if(t===y)e.moveX=e.gamepad.lx,e.moveY=-e.gamepad.ly,e.cameraX=e.gamepad.rx,e.cameraY=-e.gamepad.ry,e.act=!e.actButton&&e.gamepad.b0,e.sub=!e.subButton&&e.gamepad.b1,e.actButton=e.gamepad.b0,e.subButton=e.gamepad.b1;else if(t===p)e.moveX=e.keyboard.a?-1:e.keyboard.d?1:0,e.moveY=e.keyboard.w?1:e.keyboard.s?-1:0,e.cameraX=e.keyboard.right?1:e.keyboard.left?-1:0,e.cameraY=e.keyboard.up?1:e.keyboard.down?-1:0,e.mouse.mb&&(e.cameraX=e.mouse.mx,e.cameraY=-e.mouse.my),e.act=!e.actButton&&e.mouse.lb,e.sub=!e.subButton&&e.mouse.rb,e.actButton=e.mouse.lb,e.subButton=e.mouse.rb;else if(t===T){e.moveX=0,e.moveY=0,e.cameraX=0,e.cameraY=0;for(const o of e.touch.values())o.sx<window.innerWidth/2?(e.moveX=o.x-o.sx,e.moveY=-(o.y-o.sy)):(e.cameraX=o.x-o.sx,e.cameraY=-(o.y-o.sy))}else e.moveX=0,e.moveY=0,e.cameraX=0,e.cameraY=0;[e.moveX,e.moveY]=D(e.moveX,e.moveY),[e.cameraX,e.cameraY]=D(e.cameraX,e.cameraY)},ue=e=>{const t=o=>Math.trunc(o/2);e.mx=t(e.mx),e.my=t(e.my)},fe=()=>{ie(a.timer),de(a.input),me(a.input),ue(a.input.mouse)},he=e=>{const t=localStorage.getItem(e);return t==null?null:JSON.parse(t)},ge=(e,t)=>{const o=JSON.stringify(t);localStorage.setItem(e,o)};var s=null;const _e=()=>{s=document.getElementById("main").getContext("webgl2")},P=0,X=1,O=2,Y=3,pe=e=>{let t=s.createTexture();return s.bindTexture(s.TEXTURE_2D,t),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,e),s.bindTexture(s.TEXTURE_2D,null),t},xe=(e,t,o)=>{const n=document.createElement("canvas");if(!n)return null;n.width=t,n.height=o;const c=n.getContext("2d");return c?(c.fillStyle="white",c.textAlign="center",c.textBaseline="middle",c.font="24px monospace",c.fillText(e,n.width/2,n.height/2),n):null},B=(e,t)=>{const o=s.createShader(e);return s.shaderSource(o,t),s.compileShader(o),s.getShaderParameter(o,s.COMPILE_STATUS)?o:(s.deleteShader(o),null)},Te=(e,t)=>{const o=s.createProgram();return s.attachShader(o,e),s.attachShader(o,t),s.linkProgram(o),s.getProgramParameter(o,s.LINK_STATUS)?o:(s.deleteProgram(o),null)},N=(e,t)=>{let o=s.createBuffer();return s.bindBuffer(e,o),s.bufferData(e,t,s.STATIC_DRAW),o},E=(e,t,o,n,c,l)=>{s.enableVertexAttribArray(e),s.vertexAttribPointer(e,t,o,n,c,l)},Ae=()=>{const e=window.innerWidth;e!==s.canvas.width&&(s.canvas.width=e);const t=window.innerHeight;t!==s.canvas.height&&(s.canvas.height=t)},we=()=>{s.viewport(0,0,s.canvas.width,s.canvas.height),s.clearColor(0,0,0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)},C=(e,t)=>{s.enable(s.CULL_FACE),e?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST),t?(s.enable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA)):(s.disable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA))},V=(e,t)=>{t=t||0;const o=e.iv[t*3+0],n=e.iv[t*3+1],c=e.iv[t*3+2],l=[null,s.POINTS,s.LINES,s.TRIANGLES];e.i?s.drawElements(l[o],c,s.UNSIGNED_SHORT,2*n):s.drawArrays(l[o],n,c)};var ve=null;const ye=()=>{ve=new AudioContext};const Ee=e=>{if(e.vao=s.createVertexArray(),s.bindVertexArray(e.vao),e.b&&(e.b=N(s.ARRAY_BUFFER,U(e.b)),e.bv))for(let t=0;t<e.bv.length;t+=2)switch(e.bv[t]){case P:E(P,3,s.FLOAT,!1,0,e.bv[t+1]);break;case X:E(X,3,s.HALF_FLOAT,!1,0,e.bv[t+1]);break;case O:E(O,4,s.UNSIGNED_BYTE,!0,0,e.bv[t+1]);break;case Y:E(Y,2,s.HALF_FLOAT,!1,0,e.bv[t+1]);break}return e.i&&(e.i=N(s.ELEMENT_ARRAY_BUFFER,U(e.i))),s.bindVertexArray(null),e},ke=e=>{if(e.vs=B(s.VERTEX_SHADER,e.vs),e.fs=B(s.FRAGMENT_SHADER,e.fs),e.prog=Te(e.vs,e.fs),e.u){const t={};for(let o of e.u)t[o]=s.getUniformLocation(e.prog,o);e.u=t}if(e.ub){const t={};let o=0;for(let n of e.ub){const c=s.getUniformBlockIndex(e.prog,n);s.uniformBlockBinding(e.prog,c,o),t[n]=o,o+=1}e.ub=t}return e},Se=e=>(e.texture=pe(xe(e.text,e.width,e.height)),e),f={index:null,pack:[]},Me=()=>f.index!=null&&f.pack.length>0,Le=()=>{fetch("data/index.json").then(t=>t.json()).then(t=>{f.index=t})},Re=e=>{const t="data/pack"+e+".json";fetch(t).then(o=>o.json()).then(o=>{o.mesh&&(o.mesh=o.mesh.map(n=>Ee(n))),o.texture&&(o.texture=o.texture.map(n=>Se(n))),o.shader&&(o.shader=o.shader.map(n=>ke(n))),f.pack[e]=o})},H=()=>f.index&&f.index.ui,z=e=>f.pack[0]&&f.pack[0].mesh[e];const $=e=>f.pack[0]&&f.pack[0].shader[e],W=e=>f.pack[0]&&f.pack[0].stack.find(t=>t.id==e);var r={cam:{vp:new Float32Array(16),o:new Float32Array(16)},init:!1,pos:{x:0,y:0,ha:0,va:0,h:0,eyeh:1.75},stack:{w:0,h:0,a:[]}};const k=(e,t)=>(e=Math.floor(e),t=Math.floor(t),e<0||r.stack.w<=e||t<0||r.stack.h<=t?null:r.stack.a[e+t*r.stack.h]),R=(e,t)=>{const o=k(e,t);if(!o)return 0;let n=0;for(const c of o){const[l,i]=v(c),d=W(l);!d||(n+=i*d.height)}return n},Ue=()=>{const e=H();if(!!e)for(let t of e);},De=()=>{r.init||(Ie()||be(),r.init=!0)},be=()=>{r.stack.w=64,r.stack.h=64,r.stack.a.length=0,r.stack.a.length=r.stack.w*r.stack.h;for(let e=0;e<r.stack.a.length;++e){const t=1+Math.floor(Math.random()*10);r.stack.a[e]=[],r.stack.a[e].push(M(1,t))}r.pos.x=.5,r.pos.y=.5},Ie=()=>{const e=he("data0");return e?(e.pos&&(r.pos=e.pos),e.stack&&(r.stack=e.stack),!0):!1},K=()=>{const e={};e.pos=r.pos,e.stack=r.stack,ge("data0",e)},S=(e,t,o,n)=>{const c=R(e,t),l=R(e+o,t+n);return Math.abs(c-l)>1},Fe=(e,t,o,n)=>{let c=e+o,l=t+n;const i=Math.floor(e),d=Math.floor(t),u=.25;return S(i,d,-1,0)&&(c=Math.max(c,i+u)),S(i,d,1,0)&&(c=Math.min(c,i-u+1)),S(i,d,0,-1)&&(l=Math.max(l,d+u)),S(i,d,0,1)&&(l=Math.min(l,d-u+1)),[c,l]},Ge=()=>{const e=a.timer.deltaTime,t=90;r.pos.ha+=t*e*a.input.cameraX,r.pos.va+=t*e*a.input.cameraY,r.pos.va=Math.max(-60,Math.min(r.pos.va,80));const o=2,n=x(r.pos.ha+90),c=x(r.pos.ha),l=a.input.moveX,i=a.input.moveY,d=l*Math.cos(n)+i*Math.cos(c),u=l*Math.sin(n)+i*Math.sin(c),h=o*e*d,_=o*e*u;[r.pos.x,r.pos.y]=Fe(r.pos.x,r.pos.y,h,_);const g=R(r.pos.x,r.pos.y);if(Math.abs(g-r.pos.h)<=2){const A=g-r.pos.h;r.pos.h+=10*e*A}else r.pos.h=g},Pe=()=>{const e=window.innerWidth,t=window.innerHeight,o=x(30),n=.1,c=1e3,l=j(r.pos.ha,r.pos.va),i=F(r.pos.x,r.pos.y,r.pos.h);i[2]+=r.pos.eyeh;const d=Q(i,l),h=se(i,d,[0,0,1]),_=ne(o,e/t,n,c);r.cam.vp.set(ee(h,_)),r.cam.o.set(re(e,t,0,1))},Xe=()=>{if(a.input.act){const e=k(r.pos.x,r.pos.y);if(e&&e.length>0){let[t,o]=v(e[e.length-1]);o+=1,e[e.length-1]=M(t,o)}K()}if(a.input.sub){const e=k(r.pos.x,r.pos.y);if(e&&e.length>0){let[t,o]=v(e[e.length-1]);o-=1,o>0?e[e.length-1]=M(t,o):e.pop()}K()}},Oe=()=>{Ge(),Pe(),Xe()},Ye=()=>{Ae(),we()},Be=()=>{C(!0,!1);for(let e=0;e<r.stack.w;++e)for(let t=0;t<r.stack.h;++t){const o=k(e,t);if(!o)return;let n=0;for(const c of o){const[l,i]=v(c),d=W(l);if(!d)continue;const u=$(d.shader);if(!u)continue;const h=z(d.mesh);if(!!h){s.useProgram(u.prog),s.uniformMatrix4fv(u.u.vp,!1,r.cam.vp),s.bindVertexArray(h.vao);for(let _=0;_<i;++_){const g=F(e,t,n),A=new Float32Array(16);A.set(te(g[0],g[1],g[2])),s.uniformMatrix4fv(u.u.w,!1,A),V(h),n+=d.height}}}}},Ne=()=>{C(!1,!0);for(let e of H()){const t=$(e.shader);if(!t)return;s.useProgram(t.prog),s.uniformMatrix4fv(t.u.vp,!1,r.cam.o);const o=z(e.mesh);if(!o)return;s.bindVertexArray(o.vao);const n=new Float32Array(16);n.set(oe(e.width,e.height,1)),s.uniformMatrix4fv(t.u.w,!1,n),V(o)}},Ce=()=>{Ye(),Be(),Ne()};m(window,"load",()=>{_e(),ye(),le(),Le(),Re(0);const e=()=>{fe(),Ue(),Me()&&(De(),Oe(),Ce()),requestAnimationFrame(e)};e()});})();
