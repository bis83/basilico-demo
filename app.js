(()=>{const y=(e,t,n)=>{e.addEventListener(t,n)},M=()=>document.getElementById("canvas"),k=()=>document.getElementById("message"),ee=()=>{M().requestPointerLock()},R=()=>document.pointerLockElement===M(),I=e=>{const t=k();t.style.display="",t.textContent=e},te=()=>{const e=k();e.style.display="none"};const v=e=>e!==void 0,ne=(e,t)=>Math.floor(e/t),oe=(e,t)=>(e%t+t)%t,g=e=>e/180*Math.PI;const U=(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],re=e=>{const t=U(e,e);return Math.sqrt(t)},se=(e,t)=>[e[0]+t[0],e[1]+t[1],e[2]+t[2]],ce=(e,t)=>[e[0]-t[0],e[1]-t[1],e[2]-t[2]];const A=e=>{const t=re(e);return[e[0]/t,e[1]/t,e[2]/t]},T=(e,t)=>[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]],O=(e,t)=>{const n=g(e),o=g(t);return[Math.cos(o)*Math.cos(n),Math.sin(o),Math.cos(o)*Math.sin(n)]},ie=()=>[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],ae=(e,t)=>[e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15]],fe=e=>{const t=e[0]*e[5]-e[1]*e[4],n=e[0]*e[6]-e[2]*e[4],o=e[0]*e[7]-e[3]*e[4],r=e[1]*e[6]-e[2]*e[5],s=e[1]*e[7]-e[3]*e[5],c=e[2]*e[7]-e[3]*e[6],i=e[8]*e[13]-e[9]*e[12],d=e[8]*e[14]-e[10]*e[12],l=e[8]*e[15]-e[11]*e[12],m=e[9]*e[14]-e[10]*e[13],u=e[9]*e[15]-e[11]*e[13],f=e[10]*e[15]-e[11]*e[14];let a=t*f-n*u+o*m+r*l-s*d+c*i;return a?(a=1/a,[(e[5]*f-e[6]*u+e[7]*m)*a,(e[2]*u-e[1]*f-e[3]*m)*a,(e[13]*c-e[14]*s+e[15]*r)*a,(e[10]*s-e[9]*c-e[11]*r)*a,(e[6]*l-e[4]*f-e[7]*d)*a,(e[0]*f-e[2]*l+e[3]*d)*a,(e[14]*o-e[12]*c-e[15]*n)*a,(e[8]*c-e[10]*o+e[11]*n)*a,(e[4]*u-e[5]*l+e[7]*i)*a,(e[1]*l-e[0]*u-e[3]*i)*a,(e[12]*s-e[13]*o+e[15]*t)*a,(e[9]*o-e[8]*s-e[11]*t)*a,(e[5]*d-e[4]*m-e[6]*i)*a,(e[0]*m-e[1]*d+e[2]*i)*a,(e[13]*n-e[12]*r-e[14]*t)*a,(e[8]*r-e[9]*n+e[10]*t)*a]):ie()};const de=(e,t,n,o)=>{e[12]=t,e[13]=n,e[14]=o},le=(e,t)=>{const n=g(e),o=Math.sin(n),r=Math.cos(n);return[r,0,o,0,0,1,0,0,-o,0,r,0,0,0,0,1]};const ue=(e,t,n)=>{const o=A(ce(t,e)),r=A(T(n,o)),s=T(o,r),c=U(e,r),i=U(e,s),d=U(e,o);return[r[0],s[0],o[0],0,r[1],s[1],o[1],0,r[2],s[2],o[2],0,-c,-i,-d,1]},me=(e,t,n,o)=>{const r=1/Math.tan(e),s=r/t,c=o/(o-n),i=-(c*n);return[s,0,0,0,0,r,0,0,0,0,c,1,0,0,i,0]};const he=async(e,t)=>{e.adapter=await navigator.gpu.requestAdapter(),e.device=await e.adapter.requestDevice(),e.canvasFormat=navigator.gpu.getPreferredCanvasFormat(),e.canvas=M(),e.context=e.canvas.getContext("webgpu"),e.context.configure({device:e.device,format:e.canvasFormat,alphaMode:"opaque"});const n=e.device;if(e.buffer)for(let r=0;r<e.buffer.length;++r){const s=e.buffer[r],c=await Ie(t[s.embed]),i=n.createBuffer({size:c.length,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.INDEX,mappedAtCreation:!0}),d=new DataView(i.getMappedRange());for(let l=0;l<c.length;++l)d.setUint8(l,c[l]);i.unmap(),e.buffer[r]=i}if(e.shader)for(let r=0;r<e.shader.length;++r){const s=e.shader[r],c=await De(t[s.embed]),i=n.createShaderModule({code:c});e.shader[r]=i}e.bindGroupLayout=[],e.pipelineLayout=[],e.pipeline=[],e.sampler=[],e.bindGroup=[],e.cbuffer=[],e.gbuffer=[];const o=(r,s,c)=>{e.cbuffer[r]=n.createBuffer({size:s,usage:c|GPUBufferUsage.COPY_DST})};o(0,512,GPUBufferUsage.UNIFORM),o(1,229376,GPUBufferUsage.STORAGE),o(2,65536,GPUBufferUsage.VERTEX),o(3,40960,GPUBufferUsage.INDIRECT),o(4,49152,GPUBufferUsage.VERTEX),o(5,16384,GPUBufferUsage.VERTEX),e.sampler[0]=n.createSampler({magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"}),e.bindGroupLayout[0]=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}]}),e.bindGroupLayout[1]=n.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"depth"}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:5,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]}),e.pipelineLayout[0]=n.createPipelineLayout({bindGroupLayouts:[e.bindGroupLayout[0]]}),e.pipelineLayout[1]=n.createPipelineLayout({bindGroupLayouts:[e.bindGroupLayout[1]]}),e.bindGroup[0]=n.createBindGroup({layout:e.bindGroupLayout[0],entries:[{binding:0,resource:{buffer:e.cbuffer[0]}},{binding:1,resource:{buffer:e.cbuffer[1]}}]}),we(e)},be=(e,t)=>{for(let n=0;n<e.id.length;++n)if(e.id[n].name===t)return n;return-1},ye=(e,t)=>{const n=e.device,o=new Float32Array(68);{const r=t.camera,s=e.canvas.width/e.canvas.height,c=g(r.fov),[i,d,l,m,u]=E(r.offset,0,0,0,0,0),f=O(m,u),a=[i,d,l],h=se(a,f),w=ue(a,h,[0,1,0]),B=me(c,s,r.near,r.far),S=ae(w,B),V=fe(S);o.set(S,0),o.set(V,16),o.set(w,32),o.set(a,48)}{const r=t.light,[s,c,i,d,l]=E(r.offset,0,0,0,0,0),m=G(r.color,0,0,0,0),u=G(r.ambient0,0,0,0,0),f=G(r.ambient1,0,0,0,0),a=O(d,l);o.set(a,52),o.set(m,56),o.set(u,60),o.set(f,64)}n.queue.writeBuffer(e.cbuffer[0],0,o)},ve=(e,t)=>{const n=e.device;if(!t.lines||t.lines.length<=0)return 0;const o=new Float32Array(t.lines.length*3),r=new Uint8Array(t.lines.length*4);for(let s=0;s<t.lines.length;++s){const c=t.lines[s];o[s*3+0]=c.pos[0],o[s*3+1]=c.pos[1],o[s*3+2]=c.pos[2],r[s*4+0]=c.color[0],r[s*4+1]=c.color[1],r[s*4+2]=c.color[2],r[s*4+3]=c.color[3]}return n.queue.writeBuffer(e.cbuffer[4],0,o),n.queue.writeBuffer(e.cbuffer[5],0,r),t.lines.length},pe=(e,t,n)=>{const o=e.device,r=[];r.length=e.mesh.length;for(let f=0;f<r.length;++f)r[f]=[];const s=new Float32Array(28),c=4*28;let i=0;if(t.room)for(const f of t.room){const a=Xe(n,f.name);if(a)for(let h=0;h<a.indices.length;++h){const P=a.node[a.indices[h]];if(!P)continue;const w=oe(h,a.divisor),B=ne(h,a.divisor),[S,V,D,z,q]=E(f.offset,w*a.unit,0,B*a.unit,0,0);for(const N of P.mesh){const x=a.mesh[N];if(!x)continue;const $=be(e,x.name);if($<0)continue;for(const Z of e.id[$].mesh)r[Z].push(i);const[X,j,H,W,Y]=E(x.offset,S,V,D,z,q),L=le(W,Y);de(L,X,j,H);const J=G(x.factor0,1,1,1,1),K=G(x.factor1,1,1,1,0),Q=G(x.factor2,0,0,0,0);s.set(L,0),s.set(J,16),s.set(K,20),s.set(Q,24),o.queue.writeBuffer(e.cbuffer[1],i*c,s),i+=1}}}const d=[];let l=0,m=0;const u=new Uint32Array(5);for(let f=0;f<r.length;++f){if(r[f].length<=0)continue;const a=e.mesh[f],h=r[f].length;o.queue.writeBuffer(e.cbuffer[2],l*4,new Uint32Array(r[f])),u[0]=a.count,u[1]=h,u[2]=0,u[3]=0,u[4]=0,o.queue.writeBuffer(e.cbuffer[3],m,u),d.push({id:f,first:l,offset:m}),l+=h,m+=20}return d},_e=e=>{const t=e.device,n=e.canvas;if(n.width!==n.clientWidth||n.height!==n.clientHeight){n.width=n.clientWidth,n.height=n.clientHeight;const s=i=>{v(e.gbuffer[i])&&(e.gbuffer[i].destroy(),delete e.gbuffer[i])};s(0),s(1),s(2),s(3),s(4);const c=i=>{v(e.bindGroup[i])&&delete e.bindGroup[i]};c(1),c(2),c(3)}const o=(s,c)=>{v(e.gbuffer[s])||(e.gbuffer[s]=t.createTexture({size:[n.width,n.height],format:c,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}))};o(0,"depth32float"),o(1,"rgb10a2unorm"),o(2,"rgba8unorm"),o(3,"rgba8unorm"),o(4,"rgba16float");const r=(s,c,i,d,l)=>{v(e.bindGroup[s])||(e.bindGroup[s]=t.createBindGroup({layout:e.bindGroupLayout[1],entries:[{binding:0,resource:{buffer:e.cbuffer[0]}},{binding:1,resource:e.gbuffer[c].createView()},{binding:2,resource:e.gbuffer[i].createView()},{binding:3,resource:e.gbuffer[d].createView()},{binding:4,resource:e.gbuffer[l].createView()},{binding:5,resource:e.sampler[0]}]}))};r(1,0,1,2,3),r(2,0,1,1,1),r(3,0,4,4,4)},we=e=>{const t=e.device;e.pipeline[0]=t.createRenderPipeline({layout:e.pipelineLayout[0],vertex:{module:e.shader[0],entryPoint:"VS",buffers:[{arrayStride:4,attributes:[{format:"uint32",offset:0,shaderLocation:0}],stepMode:"instance"},{arrayStride:12,attributes:[{format:"float32x3",offset:0,shaderLocation:1}]},{arrayStride:12,attributes:[{format:"float32x3",offset:0,shaderLocation:2}]}]},fragment:{module:e.shader[0],entryPoint:"FS",targets:[{format:"rgb10a2unorm"},{format:"rgba8unorm"},{format:"rgba8unorm"},{format:"rgba16float"}]},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth32float"},primitive:{cullMode:"back",frontFace:"cw"}}),e.pipeline[1]=t.createRenderPipeline({layout:e.pipelineLayout[1],vertex:{module:e.shader[1],entryPoint:"VS",buffers:[]},fragment:{module:e.shader[1],entryPoint:"FS_SSAO",targets:[{format:"rgba8unorm",blend:{color:{operation:"min",srcFactor:"one",dstFactor:"one"},alpha:{}},writeMask:GPUColorWrite.RED}]}}),e.pipeline[2]=t.createRenderPipeline({layout:e.pipelineLayout[1],vertex:{module:e.shader[1],entryPoint:"VS",buffers:[]},fragment:{module:e.shader[1],entryPoint:"FS_HDR",targets:[{format:"rgba16float",blend:{color:{operation:"add",srcFactor:"one",dstFactor:"one"},alpha:{}}}]},depthStencil:{depthWriteEnabled:!1,depthCompare:"not-equal",format:"depth32float"}}),e.pipeline[3]=t.createRenderPipeline({layout:e.pipelineLayout[1],vertex:{module:e.shader[1],entryPoint:"VS",buffers:[]},fragment:{module:e.shader[1],entryPoint:"FS_HDRSky",targets:[{format:"rgba16float",blend:{color:{operation:"add",srcFactor:"one",dstFactor:"one"},alpha:{}}}]},depthStencil:{depthWriteEnabled:!1,depthCompare:"equal",format:"depth32float"}}),e.pipeline[4]=t.createRenderPipeline({layout:e.pipelineLayout[1],vertex:{module:e.shader[1],entryPoint:"VS",buffers:[]},fragment:{module:e.shader[1],entryPoint:"FS_HDR2LDR",targets:[{format:e.canvasFormat}]},depthStencil:{depthWriteEnabled:!1,depthCompare:"always",format:"depth32float"}}),e.pipeline[5]=t.createRenderPipeline({layout:e.pipelineLayout[0],vertex:{module:e.shader[2],entryPoint:"VS",buffers:[{arrayStride:12,attributes:[{format:"float32x3",offset:0,shaderLocation:0}]},{arrayStride:4,attributes:[{format:"unorm8x4",offset:0,shaderLocation:1}]}]},fragment:{module:e.shader[2],entryPoint:"FS",targets:[{format:e.canvasFormat}]},depthStencil:{depthWriteEnabled:!1,depthCompare:"less",format:"depth32float"},primitive:{topology:"line-list"}})},Se=e=>{_e(e)},xe=(e,t,n)=>{ye(e,t);const o=pe(e,t,n),r=ve(e,t),s=e.device,c=s.createCommandEncoder();Ge(c,e,o),ge(c,e),Pe(c,e),Be(c,e,r),s.queue.submit([c.finish()])},Ge=(e,t,n)=>{const o=e.beginRenderPass({depthStencilAttachment:{view:t.gbuffer[0].createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"},colorAttachments:[{view:t.gbuffer[1].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"},{view:t.gbuffer[2].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"},{view:t.gbuffer[3].createView(),clearValue:{r:1,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"},{view:t.gbuffer[4].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}]});for(const r of n){o.setPipeline(t.pipeline[0]),o.setBindGroup(0,t.bindGroup[0]),o.setVertexBuffer(0,t.cbuffer[2],r.first*4);const s=t.mesh[r.id];if(s.vb0){const[c,i,d]=s.vb0;o.setVertexBuffer(1,t.buffer[c],i,d)}if(s.vb1){const[c,i,d]=s.vb1;o.setVertexBuffer(2,t.buffer[c],i,d)}if(s.ib){const[c,i,d]=s.ib;o.setIndexBuffer(t.buffer[c],"uint16",i,d)}o.drawIndexedIndirect(t.cbuffer[3],r.offset)}o.end()},ge=(e,t)=>{const n=e.beginRenderPass({colorAttachments:[{view:t.gbuffer[3].createView(),loadOp:"load",storeOp:"store"}]});n.setPipeline(t.pipeline[1]),n.setBindGroup(0,t.bindGroup[2]),n.draw(4),n.end()},Pe=(e,t)=>{const n=e.beginRenderPass({depthStencilAttachment:{view:t.gbuffer[0].createView(),depthReadOnly:!0},colorAttachments:[{view:t.gbuffer[4].createView(),loadOp:"load",storeOp:"store"}]});n.setPipeline(t.pipeline[2]),n.setBindGroup(0,t.bindGroup[1]),n.draw(4),n.setPipeline(t.pipeline[3]),n.draw(4),n.end()},Be=(e,t,n)=>{const o=e.beginRenderPass({depthStencilAttachment:{view:t.gbuffer[0].createView(),depthReadOnly:!0},colorAttachments:[{view:t.context.getCurrentTexture().createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}]});o.setPipeline(t.pipeline[4]),o.setBindGroup(0,t.bindGroup[3]),o.draw(4),n&&(o.setPipeline(t.pipeline[5]),o.setBindGroup(0,t.bindGroup[0]),o.setVertexBuffer(0,t.cbuffer[4]),o.setVertexBuffer(1,t.cbuffer[5]),o.draw(n)),o.end()},p=(e,t,n)=>{n=n||0;const o=e[t];o&&!o.hold&&(o.value=Math.max(0,n))},_=(e,t,n,o)=>{n=n||0,o=o||!1;const r=e[t];r&&(r.value=Math.max(0,n),r.hold=o)},F=(e,t)=>{const n=e[t];return n?n.value:0},Re=e=>{if(!e)return!1;for(const t of e.buttons)if(t.value>.5)return!0;for(const t of e.axes)if(Math.abs(t)>.5)return!0;return!1},Ue=e=>{const t=()=>{for(const r in e.keyboard)_(e.map,e.keyboard[r],0,!1);for(const r of e.mouse.button)_(e.map,r,0,!1)},n=(r,s,c)=>{if(!R())return;const i=e.keyboard[r.code];i&&(_(e.map,i,s,c),r.preventDefault(),e.last=-1)},o=(r,s,c)=>{if(!R())return;const i=e.mouse.button[r.button];i&&(_(e.map,i,s,c),r.preventDefault(),e.last=-1)};y(document.body,"contextmenu",r=>{r.preventDefault()}),y(window,"blur",r=>{t()}),y(document,"click",r=>{R()||(ee(),t())}),y(document,"keydown",r=>{n(r,1,!0)}),y(document,"keyup",r=>{n(r,0,!1)}),y(document,"mousedown",r=>{o(r,1,!0)}),y(document,"mouseup",r=>{o(r,0,!1)}),y(document,"mousemove",r=>{if(!R())return;const s=.25,c=e.mouse.movementX;c&&(p(e.map,c[0],-r.movementX*s),p(e.map,c[1],r.movementX*s));const i=e.mouse.movementY;i&&(p(e.map,i[0],-r.movementY*s),p(e.map,i[1],r.movementY*s)),r.preventDefault(),e.last=-1})},Ee=(e,t)=>{{const n=e.timer,o=F(e.map,n.time),r=F(e.map,n.frameCount),s=(t-o)/1e3;_(e.map,n.time,t,!0),_(e.map,n.deltaTime,s,!0),_(e.map,n.frameCount,r+1,!0)}{const n=navigator.getGamepads();for(let r=0;r<n.length;++r)if(Re(n[r])){e.last=r;break}const o=n[e.last];if(o){const r=e.gamepad;for(let s=0;s<o.buttons.length;++s){const c=r.buttons[s];c&&p(e.map,c,o.buttons[s].value)}for(let s=0;s<o.axes.length;++s){const c=r.axes[s];if(!c)continue;const i=Math.trunc(o.axes[s]*4)/4;p(e.map,c[0],-i),p(e.map,c[1],i)}}}},Ve=e=>{for(const t in e.map)p(e.map,t,0)},Fe=e=>{if(e.func)for(const t in e.func)e.func[t].target==="app"&&Me(e,t)},Me=(e,t)=>{e.view.func=e.view.func||[],e.view.func.push({name:t,branch:-1,action:-1})},$e=(e,t,n,o)=>!0,Le=(e,t,n)=>{if(v(t.branch[n.branch]))return t.branch[n.branch];for(let o=0;o<t.branch.length;++o)if($e(e,t,n,o))return n.branch=o,n.action=0,t.branch[o];return null},Ae=(e,t,n,o)=>{for(;;){const r=n.action[o.action];if(r){const s=e.exec[r];s&&s(e),o.action+=1}else{o.branch=-1,o.action=-1;break}}},Te=(e,t)=>{const n=e.func[t.name];if(!n)return;const o=Le(e,n,t);o&&Ae(e,n,o,t)},Oe=e=>{if(e.view.func)for(const t of e.view.func)Te(e,t)},Ce=(e,t)=>{e.lines=[];for(const n of t)e.lines.push({pos:n.from,color:n.color}),e.lines.push({pos:n.to,color:n.color})},E=(e,t,n,o,r,s)=>(e&&(t+=e.x||0,n+=e.y||0,o+=e.z||0,r+=e.ha||0,s+=e.va||0),[t,n,o,r,s]),G=(e,t,n,o,r)=>(e&&(v(e.r)&&(t=e.r),v(e.g)&&(n=e.g),v(e.r)&&(o=e.b),v(e.a)&&(r=e.a)),[t,n,o,r]),ke=(e,t)=>{e.loading+=1,(async()=>{const r=await(await fetch("app.json")).json();Object.assign(e,r),e.gpu&&await he(e.gpu,e.embed),e.signal&&Ue(e.signal),e.exec={},Object.assign(e.exec,t),Fe(e),delete e.embed,e.loading-=1})()},Ie=async e=>{const t=window.atob(e),n=new Uint8Array(t.length);for(let s=0;s<t.length;++s)n[s]=t.charCodeAt(s);const o=new Blob([n]).stream().pipeThrough(new DecompressionStream("deflate-raw")),r=await new Response(o).arrayBuffer();return new Uint8Array(r)},De=async e=>{const t=window.atob(e),n=new Uint8Array(t.length);for(let s=0;s<t.length;++s)n[s]=t.charCodeAt(s);const o=new Blob([n]).stream().pipeThrough(new DecompressionStream("deflate-raw"));return await new Response(o).text()},ze=async e=>{if(!navigator.gpu){I("ERROR: WebGPU not supported.");return}const t={loading:0};ke(t,e);const n=o=>{qe(t)&&(Ee(t.signal,o),Se(t.gpu),Oe(t),xe(t.gpu,t.view,t),Ve(t.signal)),requestAnimationFrame(n)};requestAnimationFrame(n)},qe=e=>e.loading<=0,Ne=(e,t)=>e.json[t],Xe=(e,t)=>e.room[t],b=(e,t)=>F(e.signal.map,t);let C=!1;const je=e=>{C||(te(),Object.assign(e.view,Ne(e,"sample")),We(e),C=!0)},He=e=>{const t=e.view,n=t.camera,o=b(e,"dt"),r=[0,0];r[0]+=-b(e,"l0"),r[0]+=b(e,"l1"),r[1]+=b(e,"l2"),r[1]+=-b(e,"l3");const s=[0,0];s[0]+=-b(e,"r0"),s[0]+=b(e,"r1"),s[1]+=b(e,"r2"),s[1]+=-b(e,"r3");const c=b(e,"b1");if(s){const u=-s[0],f=s[1];n.offset.ha+=90*o*u,n.offset.va+=90*o*f,n.offset.va=Math.max(-60,Math.min(n.offset.va,80))}if(r){const m=c?4:2,u=g(n.offset.ha+90),f=g(n.offset.ha),a=-r[0],h=r[1],P=a*Math.cos(u)+h*Math.cos(f),w=a*Math.sin(u)+h*Math.sin(f),B=m*o*P,S=m*o*w;n.offset.x+=B,n.offset.z+=S}b(e,"a2")&&(n.offset.y-=.75*o),b(e,"a3")&&(n.offset.y+=.75*o);const l=t.light;l.offset.ha+=45*o};y(window,"load",()=>{I("Welcome Basilico."),ze({setup:je,update:He})});const We=e=>{const t=[];t.push({from:[-50,0,0],to:[50,0,0],color:[255,0,0,255]}),t.push({from:[0,0,-50],to:[0,0,50],color:[0,0,255,255]}),Ce(e.view,t)};})();
