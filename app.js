(()=>{const P=e=>{const t=window.atob(e),o=new ArrayBuffer(t.length),n=new DataView(o);for(let c=0;c<t.length;++c)n.setUint8(c,t.charCodeAt(c));return o};const w=e=>e/180*Math.PI,W=(e,t)=>Math.sqrt(e*e+t*t),G=(e,t)=>{const o=W(e,t);return o!=0?[e/o,t/o]:[0,0]};const A=(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],K=e=>{const t=A(e,e);return Math.sqrt(t)},q=(e,t)=>[e[0]+t[0],e[1]+t[1],e[2]+t[2]],J=(e,t)=>[e[0]-t[0],e[1]-t[1],e[2]-t[2]];const X=e=>{const t=K(e);return[e[0]/t,e[1]/t,e[2]/t]},b=(e,t)=>[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]],Q=(e,t)=>{const o=w(e),n=w(t);return[Math.cos(n)*Math.cos(o),Math.sin(n),Math.cos(n)*Math.sin(o)]},O=(e,t,o)=>[e*2,o*.5,t*2];const Z=(e,t)=>[e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15]],Y=(e,t,o)=>[1,0,0,0,0,1,0,0,0,0,1,0,e,t,o,1],j=(e,t,o)=>[e,0,0,0,0,t,0,0,0,0,o,0,0,0,0,1],ee=(e,t,o)=>{const n=X(J(t,e)),c=X(b(o,n)),l=b(n,c),d=A(e,c),i=A(e,l),h=A(e,n);return[c[0],l[0],n[0],0,c[1],l[1],n[1],0,c[2],l[2],n[2],0,-d,-i,-h,1]},te=(e,t,o,n)=>{const c=1/Math.tan(e),l=c/t,d=n/(n-o),i=-(d*o);return[l,0,0,0,0,c,0,0,0,0,d,1,0,0,i,0]},oe=(e,t,o,n)=>{const c=2/e,l=2/t,d=1/(n-o),i=o/(o-n);return[c,0,0,0,0,l,0,0,0,0,d,0,0,0,i,1]},R=(e,t)=>e<<0|t<<16,y=e=>[e>>0&65535,e>>16&65535],E=0,x=1,v=2;var a=null;const m=(e,t,o)=>{e.addEventListener(t,o)},re=()=>{a={},a.timer={prevTime:performance.now(),deltaTime:0},a.input={mode:E,moveX:0,moveY:0,cameraX:0,cameraY:0,act:!1,sub:!1,actButton:!1,subButton:!1},a.input.gamepad={index:null,lx:0,ly:0,rx:0,ry:0,b0:!1,b1:!1,lt:!1,rt:!1},a.input.keyboard={w:!1,a:!1,s:!1,d:!1,space:!1,lctrl:!1},a.input.mouse={x:0,y:0,mx:0,my:0,lb:!1,rb:!1},a.input.touch=new Map,m(window,"focus",e=>{}),m(window,"blur",e=>{}),m(window,"resize",e=>{}),m(window,"gamepadconnected",e=>{a.input.gamepad.index=e.gamepad.index,a.input.mode=E}),m(window,"gamepaddisconnected",e=>{a.input.gamepad.index===e.gamepad.index&&(a.input.gamepad.index=null)}),m(document,"keydown",e=>{B(a.input.keyboard,e.code,!0)&&(a.input.mode=x,e.preventDefault())}),m(document,"keyup",e=>{B(a.input.keyboard,e.code,!1)&&(a.input.mode=x,e.preventDefault())}),m(document.body,"contextmenu",e=>{e.preventDefault()}),m(document.body,"mousedown",e=>{k(a.input.mouse,e)&&(a.input.mode=x,e.preventDefault())}),m(document.body,"mouseup",e=>{k(a.input.mouse,e)&&(a.input.mode=x,e.preventDefault())}),m(document.body,"mousemove",e=>{k(a.input.mouse,e)&&(a.input.mode=x,e.preventDefault())}),m(document.body,"touchstart",e=>{for(const t of e.changedTouches)a.input.touch.set(t.identifier,{x:t.clientX,y:t.clientY,sx:t.clientX,sy:t.clientY});a.input.mode=v}),m(document.body,"touchend",e=>{for(const t of e.changedTouches)a.input.touch.delete(t.identifier);a.input.mode=v}),m(document.body,"touchcancel",e=>{for(const t of e.changedTouches)a.input.touch.delete(t.identifier);a.input.mode=v}),m(document.body,"touchmove",e=>{for(const t of e.changedTouches){const o=a.input.touch.get(t.identifier);o&&(o.x=t.clientX,o.y=t.clientY)}a.input.mode=v})},B=(e,t,o)=>{switch(t){case"KeyW":e.w=o;break;case"KeyA":e.a=o;break;case"KeyS":e.s=o;break;case"KeyD":e.d=o;break;case"Space":e.space=o;break;case"ControlLeft":e.lctrl=o;break;default:return!1}return!0},k=(e,t)=>(e.mx+=t.movementX||0,e.my+=t.movementY||0,e.x=t.x,e.y=t.y,e.lb=(t.buttons&1)!=0,e.rb=(t.buttons&2)!=0,!0),ne=e=>{const t=performance.now();e.deltaTime=(t-e.prevTime)/1e3,e.prevTime=t},se=e=>{if(e.gamepad.index!==null){const o=navigator.getGamepads()[e.gamepad.index];e.gamepad.lx=Math.trunc(o.axes[0]*4)/4,e.gamepad.ly=Math.trunc(o.axes[1]*4)/4,e.gamepad.rx=Math.trunc(o.axes[2]*4)/4,e.gamepad.ry=Math.trunc(o.axes[3]*4)/4,e.gamepad.b0=o.buttons[0].value>=.5,e.gamepad.b1=o.buttons[1].value>=.5,e.gamepad.lt=o.buttons[6].value>=.5,e.gamepad.rt=o.buttons[7].value>=.5,!!(e.gamepad.lx||e.gamepad.ly||e.gamepad.rx||e.gamepad.ry||e.gamepad.b0||e.gamepad.b1||e.gamepad.lt||e.gamepad.rt)&&(e.mode=E)}},ce=e=>{const t=e.mode;if(t===E)e.moveX=e.gamepad.lx,e.moveY=-e.gamepad.ly,e.cameraX=-e.gamepad.rx,e.cameraY=-e.gamepad.ry,e.act=!e.actButton&&e.gamepad.b0,e.sub=!e.subButton&&e.gamepad.b1,e.actButton=e.gamepad.b0,e.subButton=e.gamepad.b1;else if(t===x)e.moveX=e.keyboard.a?-1:e.keyboard.d?1:0,e.moveY=e.keyboard.w?1:e.keyboard.s?-1:0,e.mouse.lb?(e.cameraX=-e.mouse.mx,e.cameraY=-e.mouse.my):(e.cameraX=0,e.cameraY=0),e.act=!e.actButton&&e.keyboard.space,e.sub=!e.subButton&&e.keyboard.lctrl,e.actButton=e.keyboard.space,e.subButton=e.keyboard.lctrl;else if(t===v){e.moveX=0,e.moveY=0,e.cameraX=0,e.cameraY=0;for(const o of e.touch.values())o.sx<window.innerWidth/2?(e.moveX=o.x-o.sx,e.moveY=-(o.y-o.sy)):(e.cameraX=-(o.x-o.sx),e.cameraY=-(o.y-o.sy))}else e.moveX=0,e.moveY=0,e.cameraX=0,e.cameraY=0;[e.moveX,e.moveY]=G(e.moveX,e.moveY),[e.cameraX,e.cameraY]=G(e.cameraX,e.cameraY)},ae=e=>{const t=o=>Math.trunc(o/2);e.mx=t(e.mx),e.my=t(e.my)},le=()=>{ne(a.timer),se(a.input),ce(a.input),ae(a.input.mouse)};var r=null;const de=()=>{r=document.getElementById("main").getContext("webgl2")},N=0,C=1,V=2,H=3,ie=e=>{let t=r.createTexture();return r.bindTexture(r.TEXTURE_2D,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e),r.bindTexture(r.TEXTURE_2D,null),t},me=(e,t,o)=>{const n=document.createElement("canvas");if(!n)return null;n.width=t,n.height=o;const c=n.getContext("2d");return c?(c.fillStyle="white",c.textAlign="center",c.textBaseline="middle",c.font="24px monospace",c.fillText(e,n.width/2,n.height/2),n):null},z=(e,t)=>{const o=r.createShader(e);return r.shaderSource(o,t),r.compileShader(o),r.getShaderParameter(o,r.COMPILE_STATUS)?o:(r.deleteShader(o),null)},ue=(e,t)=>{const o=r.createProgram();return r.attachShader(o,e),r.attachShader(o,t),r.linkProgram(o),r.getProgramParameter(o,r.LINK_STATUS)?o:(r.deleteProgram(o),null)},$=(e,t)=>{let o=r.createBuffer();return r.bindBuffer(e,o),r.bufferData(e,t,r.STATIC_DRAW),o},M=(e,t,o,n,c,l)=>{r.enableVertexAttribArray(e),r.vertexAttribPointer(e,t,o,n,c,l)},he=()=>{const e=window.innerWidth;e!==r.canvas.width&&(r.canvas.width=e);const t=window.innerHeight;t!==r.canvas.height&&(r.canvas.height=t)},fe=()=>{r.viewport(0,0,r.canvas.width,r.canvas.height),r.clearColor(0,0,0,1),r.clearDepth(1),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT)},D=(e,t)=>{r.enable(r.CULL_FACE),e?(r.enable(r.DEPTH_TEST),r.depthFunc(r.LEQUAL)):r.disable(r.DEPTH_TEST),t?(r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA)):(r.disable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA))},I=(e,t)=>{t=t||0;const o=e.iv[t*3+0],n=e.iv[t*3+1],c=e.iv[t*3+2],l=[null,r.POINTS,r.LINES,r.TRIANGLES];e.i?r.drawElements(l[o],c,r.UNSIGNED_SHORT,2*n):r.drawArrays(l[o],n,c)};var ge=null;const _e=()=>{ge=new AudioContext};const xe=e=>{if(e.vao=r.createVertexArray(),r.bindVertexArray(e.vao),e.b&&(e.b=$(r.ARRAY_BUFFER,P(e.b)),e.bv))for(let t=0;t<e.bv.length;t+=2)switch(e.bv[t]){case N:M(N,3,r.FLOAT,!1,0,e.bv[t+1]);break;case C:M(C,3,r.HALF_FLOAT,!1,0,e.bv[t+1]);break;case V:M(V,4,r.UNSIGNED_BYTE,!0,0,e.bv[t+1]);break;case H:M(H,2,r.HALF_FLOAT,!1,0,e.bv[t+1]);break}return e.i&&(e.i=$(r.ELEMENT_ARRAY_BUFFER,P(e.i))),r.bindVertexArray(null),e},pe=e=>{if(e.vs=z(r.VERTEX_SHADER,e.vs),e.fs=z(r.FRAGMENT_SHADER,e.fs),e.prog=ue(e.vs,e.fs),e.u){const t={};for(let o of e.u)t[o]=r.getUniformLocation(e.prog,o);e.u=t}if(e.ub){const t={};let o=0;for(let n of e.ub){const c=r.getUniformBlockIndex(e.prog,n);r.uniformBlockBinding(e.prog,c,o),t[n]=o,o+=1}e.ub=t}return e},we=e=>(e.texture=ie(me(e.text,e.width,e.height)),e),u={index:null,pack:[]},ve=()=>u.index!=null&&u.pack.length>0,Te=()=>{fetch("data/index.json").then(t=>t.json()).then(t=>{u.index=t})},Ae=e=>{const t="data/pack"+e+".json";fetch(t).then(o=>o.json()).then(o=>{o.mesh&&(o.mesh=o.mesh.map(n=>xe(n))),o.texture&&(o.texture=o.texture.map(n=>we(n))),o.shader&&(o.shader=o.shader.map(n=>pe(n))),u.pack[e]=o})},U=e=>u.pack[0].mesh[e];const F=e=>u.pack[0].shader[e];var s={cam:{vp:new Float32Array(16),o:new Float32Array(16)},pos:{x:0,y:0,ha:0,va:0,h:0,eyeh:1.75},world:{w:0,h:0,s:[]}};const ye=()=>{s.world.w=64,s.world.h=64,s.world.s.length=0,s.world.s.length=s.world.w*s.world.h;for(let e=0;e<s.world.s.length;++e){const t=1+Math.floor(Math.random()*10);s.world.s[e]=[],s.world.s[e].push(R(1,t))}s.pos.x=.5,s.pos.y=.5},S=(e,t)=>(e=Math.floor(e),t=Math.floor(t),e<0||s.world.w<=e||t<0||s.world.h<=t?null:s.world.s[e+t*s.world.h]),p=(e,t)=>{const o=S(e,t);if(!o)return 0;let n=0;for(const c of o){const[l,d]=y(c);n+=d}return n},Ee=(e,t,o,n)=>{let c=e+o,l=t+n;const d=Math.floor(e),i=Math.floor(t),h=p(d+0,i+0),g=p(d-1,i+0),f=p(d+1,i+0),_=p(d+0,i-1),L=p(d+0,i+1),T=.25;return Math.abs(h-g)>1&&(c=Math.max(c,d+T)),Math.abs(h-f)>1&&(c=Math.min(c,d-T+1)),Math.abs(h-_)>1&&(l=Math.max(l,i+T)),Math.abs(h-L)>1&&(l=Math.min(l,i-T+1)),[c,l]},Me=()=>{const e=a.timer.deltaTime,t=90;s.pos.ha+=t*e*a.input.cameraX,s.pos.va+=t*e*a.input.cameraY;const o=2,n=w(s.pos.ha-90),c=w(s.pos.ha),l=a.input.moveX,d=a.input.moveY,i=l*Math.cos(n)+d*Math.cos(c),h=l*Math.sin(n)+d*Math.sin(c),g=o*e*i,f=o*e*h;[s.pos.x,s.pos.y]=Ee(s.pos.x,s.pos.y,g,f);const _=p(s.pos.x,s.pos.y);if(Math.abs(_-s.pos.h)>2)s.pos.h=_;else{const L=_-s.pos.h;s.pos.h+=10*e*L}},Se=()=>{const e=window.innerWidth,t=window.innerHeight,o=w(30),n=.1,c=1e3,l=Q(s.pos.ha,s.pos.va),d=O(s.pos.x,s.pos.y,s.pos.h);d[1]+=s.pos.eyeh;const i=q(d,l),g=ee(d,i,[0,1,0]),f=te(o,e/t,n,c);s.cam.vp.set(Z(g,f)),s.cam.o.set(oe(e,t,0,1))},Le=()=>{if(a.input.act){const e=S(s.pos.x,s.pos.y);if(e&&e.length>0){let[t,o]=y(e[e.length-1]);o+=1,e[e.length-1]=R(t,o)}}if(a.input.sub){const e=S(s.pos.x,s.pos.y);if(e&&e.length>0){let[t,o]=y(e[e.length-1]);o-=1,o>0?e[e.length-1]=R(t,o):e.pop()}}},Re=()=>{Me(),Se(),Le()},ke=()=>{he(),fe()},De=(e,t,o,n)=>{const c=S(o,n);if(!c)return;let l=0;for(const d of c){const[i,h]=y(d);for(let g=0;g<h;++g){const f=O(o,n,l),_=new Float32Array(16);_.set(Y(f[0],f[1],f[2])),r.uniformMatrix4fv(e.u.w,!1,_),I(t),++l}}},Ie=()=>{D(!0,!1);const e=F(u.index.data.mesh_pc);if(!e)return;r.useProgram(e.prog),r.uniformMatrix4fv(e.u.vp,!1,s.cam.vp);const t=U(u.index.data.stack);if(!!t){r.bindVertexArray(t.vao);for(let o=0;o<s.world.w;++o)for(let n=0;n<s.world.h;++n)De(e,t,o,n)}},Ue=()=>{D(!0,!1);const e=F(u.index.data.mesh_pc);if(!e)return;r.useProgram(e.prog),r.uniformMatrix4fv(e.u.vp,!1,s.cam.vp);const t=U(u.index.data.debug_grid);if(!t)return;r.bindVertexArray(t.vao);const o=new Float32Array(16);o.set(Y(0,0,0)),r.uniformMatrix4fv(e.u.w,!1,o),I(t)},Fe=()=>{D(!1,!0);const e=F(u.index.data.mesh_pc);if(!e)return;r.useProgram(e.prog),r.uniformMatrix4fv(e.u.vp,!1,s.cam.o);const t=U(u.index.data.reticle);if(!t)return;r.bindVertexArray(t.vao);const o=new Float32Array(16);o.set(j(4,4,1)),r.uniformMatrix4fv(e.u.w,!1,o),I(t)},Pe=()=>{ke(),Ie(),Ue(),Fe()};m(window,"load",()=>{de(),_e(),re(),ye(),Te(),Ae(0);const e=()=>{le(),ve()&&(Re(),Pe()),requestAnimationFrame(e)};e()});})();
