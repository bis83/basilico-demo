(()=>{const G=e=>{const t=window.atob(e),o=new ArrayBuffer(t.length),r=new DataView(o);for(let n=0;n<t.length;++n)r.setUint8(n,t.charCodeAt(n));return o},H=e=>new Float32Array(G(e));const M=e=>e/180*Math.PI,z=(e,t)=>Math.sqrt(e*e+t*t),U=(e,t)=>{const o=z(e,t);return o!=0?[e/o,t/o]:[0,0]},R=()=>new Float32Array(3),k=(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],K=e=>Math.sqrt(k(e,e));const O=(e,t,o,r)=>{e.set([t,o,r])},W=(e,t,o)=>{e.set([t[0]+o[0],t[1]+o[1],t[2]+o[2]])},q=(e,t,o)=>{e.set([t[0]-o[0],t[1]-o[1],t[2]-o[2]])},F=e=>{const t=K(e);e.set([e[0]/t,e[1]/t,e[2]/t])},C=(e,t,o)=>{e.set([t[1]*o[2]-t[2]*o[1],t[2]*o[0]-t[0]*o[2],t[0]*o[1]-t[1]*o[0]])},J=(e,t,o)=>{const r=M(t),n=M(o);e.set([Math.cos(n)*Math.cos(r),Math.sin(n),Math.cos(n)*Math.sin(r)])},P=()=>new Float32Array(16),Q=(e,t)=>{e.set(t)};const Z=(e,t)=>{const o=[e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15]];e.set(o)};const $=(e,t,o,r)=>{const n=R();q(n,o,t),F(n);const s=R();C(s,r,n),F(s);const c=R();C(c,n,s);const i=k(t,s),u=k(t,c),m=k(t,n);e.set([s[0],c[0],n[0],0,s[1],c[1],n[1],0,s[2],c[2],n[2],0,-i,-u,-m,1])},j=(e,t,o,r,n)=>{const s=1/Math.tan(t),c=s/o,i=n/(n-r),u=-(i*r);e.set([c,0,0,0,0,s,0,0,0,0,i,1,0,0,u,0])},g=(e,t,o,r,n)=>{const s=2/t,c=2/o,i=1/(n-r),u=r/(r-n);e.set([s,0,0,0,0,c,0,0,0,0,i,0,0,0,u,1])},b=(e,t,o)=>{e.addEventListener(t,o)};const ee=()=>document.getElementById("main").getContext("webgl2"),te=e=>{const t=window.innerWidth;t!==e.canvas.width&&(e.canvas.width=t);const o=window.innerHeight;o!==e.canvas.height&&(e.canvas.height=o)},ne=e=>{e.viewport(0,0,e.canvas.width,e.canvas.height),e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)},oe=(e,t,o)=>{e.enable(e.CULL_FACE),t?(e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL)):e.disable(e.DEPTH_TEST),o?(e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)):(e.disable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA))},re=()=>{const e=new AudioContext;return b(document.body,"click",t=>{e.resume()}),e};const se=e=>{const t=0,o=1,r=2,n=3,s=[null,e.POINTS,e.LINES,e.TRIANGLES],c=(a,T)=>{let h=e.createBuffer();return e.bindBuffer(a,h),e.bufferData(a,T,e.STATIC_DRAW),h},i=(a,T,h,x,y,S)=>{e.enableVertexAttribArray(a),e.vertexAttribPointer(a,T,h,x,y,S)},u=a=>{if(!a.b)return null;const T=c(e.ARRAY_BUFFER,G(a.b));if(a.bv)for(let h=0;h<a.bv.length;h+=2)switch(a.bv[h]){case t:i(t,3,e.FLOAT,!1,0,a.bv[h+1]);break;case o:i(o,3,e.HALF_FLOAT,!1,0,a.bv[h+1]);break;case r:i(r,4,e.UNSIGNED_BYTE,!0,0,a.bv[h+1]);break;case n:i(n,2,e.HALF_FLOAT,!1,0,a.bv[h+1]);break}return T},m=a=>a.i?c(e.ELEMENT_ARRAY_BUFFER,G(a.i)):null;return a=>{let T=e.createVertexArray();e.bindVertexArray(T);let h=u(a),x=m(a);e.bindVertexArray(null);const y=()=>{e.bindVertexArray(T)},S=f=>{f=f||0;const E=a.iv[f*3+0],p=a.iv[f*3+1],w=a.iv[f*3+2];x?e.drawElements(s[E],w,e.UNSIGNED_SHORT,2*p):e.drawArrays(s[E],p,w)};return{name:a.name,use:y,draw:S}}},ce=e=>{const t=n=>{let s=e.createTexture();return e.bindTexture(e.TEXTURE_2D,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n),e.bindTexture(e.TEXTURE_2D,null),s},o=(n,s,c)=>{const i=document.createElement("canvas");if(!i)return null;i.width=s,i.height=c;const u=i.getContext("2d");return u?(u.fillStyle="white",u.textAlign="center",u.textBaseline="middle",u.font="24px monospace",u.fillText(n,i.width/2,i.height/2),i):null};return n=>{let s=t(o(n.text,n.width,n.height));const c=u=>{!s||(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,s),e.uniform1i(u,0))};return{name:n.name,bind:c}}},ae=e=>{const t=(n,s)=>{const c=e.createShader(n);return e.shaderSource(c,s),e.compileShader(c),e.getShaderParameter(c,e.COMPILE_STATUS)?c:(e.deleteShader(c),null)},o=(n,s)=>{const c=e.createProgram();return e.attachShader(c,n),e.attachShader(c,s),e.linkProgram(c),e.getProgramParameter(c,e.LINK_STATUS)?c:(e.deleteProgram(c),null)};return n=>{const s=t(e.VERTEX_SHADER,n.vertex_shader);if(!s)return null;const c=t(e.FRAGMENT_SHADER,n.fragment_shader);if(!c)return null;const i=o(s,c);if(!i)return null;const u={name:n.name,use:()=>{e.useProgram(i)}};for(let m of n.uniform)u[m]=e.getUniformLocation(i,m);return u}},ie=e=>e,ue=e=>(e.prop&&(e.prop=e.prop.map(t=>(t.matrix=t.matrix?H(t.matrix):null,t))),e),de=(e,t)=>{const o=[],r=(u,m)=>{for(const l of o){if(!l[u])continue;const a=l[u].find(T=>T.name===m);if(!!a)return a}return null},n=se(e),s=ce(e),c=ae(e);return{draw:u=>r("draw",u),mesh:u=>r("mesh",u),texture:u=>r("texture",u),shader:u=>r("shader",u),action:{load:u=>{const m="data/"+u+".json";fetch(m).then(l=>l.json()).then(l=>{l.update&&(l.update=l.update.map(a=>ie(a))),l.draw&&(l.draw=l.draw.map(a=>ue(a))),l.mesh&&(l.mesh=l.mesh.map(a=>n(a))),l.texture&&(l.texture=l.texture.map(a=>s(a))),l.shader&&(l.shader=l.shader.map(a=>c(a))),o.push(l)})}}}},I=0,v=1,D=2,le=()=>{let e=I,t={x:0,y:0,mx:0,my:0,lb:!1,rb:!1},o={w:!1,a:!1,s:!1,d:!1,space:!1},r={lx:0,ly:0,rx:0,ry:0,b0:!1,b1:!1,lt:!1,rt:!1},n=null;const s=()=>{t.mx=t.mx/2,Math.abs(t.mx)<1&&(t.mx=0),t.my=t.my/2,Math.abs(t.my)<1&&(t.my=0)},c=(d,A)=>{switch(d){case"KeyW":o.w=A;break;case"KeyA":o.a=A;break;case"KeyS":o.s=A;break;case"KeyD":o.d=A;break;case"Space":o.space=A;break;default:return!1}return!0},i=()=>{if(n!==null){const A=navigator.getGamepads()[n];r.lx=Math.trunc(A.axes[0]*4)/4,r.ly=Math.trunc(A.axes[1]*4)/4,r.rx=Math.trunc(A.axes[2]*4)/4,r.ry=Math.trunc(A.axes[3]*4)/4,r.b0=A.buttons[0].value>=.5,r.b1=A.buttons[1].value>=.5,r.lt=A.buttons[6].value>=.5,r.rt=A.buttons[7].value>=.5,!!(r.lx||r.ly||r.rx||r.ry||r.b0||r.b1||r.lt||r.rt)&&(e=I)}},u=d=>{},m=d=>{n=d.gamepad.index,e=I},l=d=>{n===d.gamepad.index&&(n=null)},a=d=>{c(d.code,!0)&&(e=v,d.preventDefault())},T=d=>{c(d.code,!1)&&(e=v,d.preventDefault())},h=d=>{t.x=d.x,t.y=d.y,t.lb=(d.buttons&1)!=0,t.rb=(d.buttons&2)!=0,e=v,d.preventDefault()},x=d=>{t.x=d.x,t.y=d.y,t.lb=(d.buttons&1)!=0,t.rb=(d.buttons&2)!=0,e=v,d.preventDefault()},y=d=>{t.mx+=d.movementX||0,t.my+=d.movementY||0,t.x=d.x,t.y=d.y,t.lb=(d.buttons&1)!=0,t.rb=(d.buttons&2)!=0,e=v,d.preventDefault()},S=d=>{e=D},L=d=>{e=D},f=d=>{e=D};let E=0,p=0,w=0,_=0;const N=()=>{E=0,p=0,w=0,_=0},B=()=>{E=r.lx,p=-r.ly,w=-r.rx,_=-r.ry},X=()=>{document.pointerLockElement===document.body?(E=o.a?-1:o.d?1:0,p=o.w?1:o.s?-1:0,w=-t.mx,_=-t.my):N()},Y=()=>{},V=()=>{[E,p]=U(E,p),[w,_]=U(w,_)};return{mode:()=>e,moveX:()=>E,moveY:()=>p,cameraX:()=>w,cameraY:()=>_,action:{blur:u,gamepadconnected:m,gamepaddisconnected:l,keydown:a,keyup:T,mousedown:h,mouseup:x,mousemove:y,touchstart:S,touchmove:L,touchend:f,tick:()=>{i(),e===I?B():e===v?X():e===D?Y():N(),V(),s()}}}};const me=()=>{let e="",t=[0,0,0],o=[0,0];return{scene:()=>e,position:()=>t,angle:()=>o,action:{scene:r=>{e=r},position:(r,n,s)=>{t=[r,n,s]},angle:(r,n)=>{o=[r,n]}}}},he=()=>{let e=performance.now(),t=0;const o=()=>{const f=performance.now();t=(f-e)/1e3,e=f};let r=!0;const n=f=>{r=f},s=R(),c=R(),i=R(),u=R(),m=M(30),l=.1,a=1e3,T=P(),h=P(),x=P(),y=P(),S=()=>{const f=window.innerWidth,E=window.innerHeight;$(T,c,i,u),j(h,m,f/E,l,a),Q(x,T),Z(x,h),g(y,f,E,0,1)};return{deltaTime:()=>t,pause:()=>r,viewProj:()=>x,ortho:()=>y,action:{pause:n,camera:(f,E,p,w,_)=>{J(s,w,_),O(c,f,E,p),O(i,f,E,p),W(i,i,s),O(u,0,1,0),S()},tick:o}}},fe=({data:e,save:t,gamepad:o})=>{e.action.load("core");const r={START:{SCENE:"sample",POSITION:[parseFloat("2"),parseFloat("0"),parseFloat("2")],ANGLE:[parseFloat("0"),parseFloat("0")]}};t.action.scene(r.START.SCENE),t.action.position(r.START.POSITION[0],r.START.POSITION[1],r.START.POSITION[2]),t.action.angle(r.START.ANGLE[0],r.START.ANGLE[1]),b(window,"focus",n=>{}),b(window,"blur",n=>{o.action.blur(n)}),b(window,"resize",n=>{}),b(window,"gamepadconnected",n=>{o.action.gamepadconnected(n)}),b(window,"gamepaddisconnected",n=>{o.action.gamepaddisconnected(n)}),b(document,"pointerlockchange",n=>{document.pointerLockElement===null&&o.mode()===v}),b(document,"pointerlockerror",n=>{}),b(document,"keydown",n=>{o.action.keydown(n)}),b(document,"keyup",n=>{o.action.keyup(n)}),b(document.body,"click",n=>{o.mode()===v&&document.pointerLockElement!==document.body&&document.body.requestPointerLock()}),b(document.body,"mousedown",n=>{o.action.mousedown(n)}),b(document.body,"mouseup",n=>{o.action.mouseup(n)}),b(document.body,"mousemove",n=>{o.action.mousemove(n)}),b(document.body,"touchstart",n=>{o.action.touchstart(n)}),b(document.body,"touchmove",n=>{o.action.touchmove(n)}),b(document.body,"touchend",n=>{o.action.touchend(n)})},Te=({frame:e,gamepad:t})=>{e.action.tick(),t.action.tick()},be=({save:e,gamepad:t,frame:o})=>{const r=o.deltaTime();let[n,s]=e.angle(),[c,i,u]=e.position();const m=t.cameraX(),l=t.cameraY(),a=t.moveX(),T=t.moveY(),h=90,x=h*r*m,y=h*r*l;n+=x,s+=y;const S=4,L=M(n-90),f=M(n),E=S*r*(a*Math.cos(L)+T*Math.cos(f)),p=S*r*(a*Math.sin(L)+T*Math.sin(f));c+=E,u+=p,e.action.angle(n,s),e.action.position(c,i,u)},Ee=({save:e,frame:t})=>{const o=1.75,[r,n,s]=e.position(),[c,i]=e.angle();t.action.camera(r,n+o,s,c,i)},pe=({gl:e})=>{te(e),ne(e)},Ae=({gl:e,data:t,save:o,frame:r})=>{oe(e,!0,!1);let n=t.draw(o.scene());if(!n)return;const s=t.shader("mesh_pnc");if(!!s){s.use(),e.uniformMatrix4fv(s.vp,!1,r.viewProj());for(const c of n.prop){const i=t.mesh(c.mesh);if(!i)continue;i.use();const u=c.matrix.length/16;for(let m=0;m<u;++m){const l=c.matrix.slice(m*16,m*16+16);e.uniformMatrix4fv(s.w,!1,l),i.draw()}}}};b(window,"load",()=>{const e=ee(),t=re(),o={gl:e,audio:t,data:de(e,t),gamepad:le(),frame:he(),save:me()};fe(o);const r=()=>{Te(o),be(o),Ee(o)},n=()=>{pe(o),Ae(o)},s=()=>{r(),n(),requestAnimationFrame(s)};s()});})();
