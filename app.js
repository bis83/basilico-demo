(()=>{const B=e=>{const t=window.atob(e),n=new ArrayBuffer(t.length),o=new DataView(n);for(let r=0;r<t.length;++r)o.setUint8(r,t.charCodeAt(r));return n};const D=e=>e/180*Math.PI,se=(e,t)=>Math.sqrt(e*e+t*t),y=(e,t)=>{const n=se(e,t);return n!=0?[e/n,t/n]:[0,0]};const re=([e,t],n,o,r,c)=>n<=e&&e<=o&&r<=t&&t<=c,O=(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],ce=e=>{const t=O(e,e);return Math.sqrt(t)},ie=(e,t)=>[e[0]+t[0],e[1]+t[1],e[2]+t[2]],le=(e,t)=>[e[0]-t[0],e[1]-t[1],e[2]-t[2]];const X=e=>{const t=ce(e);return[e[0]/t,e[1]/t,e[2]/t]},Y=(e,t)=>[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]],ue=(e,t)=>{const n=D(e),o=D(t);return[Math.cos(o)*Math.cos(n),Math.cos(o)*Math.sin(n),Math.sin(o)]},Q=(e,t,n)=>[e*2,t*2,n*.5],ae=()=>[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],fe=(e,t)=>[e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15]],de=e=>{const t=e[0]*e[5]-e[1]*e[4],n=e[0]*e[6]-e[2]*e[4],o=e[0]*e[7]-e[3]*e[4],r=e[1]*e[6]-e[2]*e[5],c=e[1]*e[7]-e[3]*e[5],l=e[2]*e[7]-e[3]*e[6],a=e[8]*e[13]-e[9]*e[12],h=e[8]*e[14]-e[10]*e[12],E=e[8]*e[15]-e[11]*e[12],A=e[9]*e[14]-e[10]*e[13],x=e[9]*e[15]-e[11]*e[13],T=e[10]*e[15]-e[11]*e[14];let d=t*T-n*x+o*A+r*E-c*h+l*a;return d?(d=1/d,[(e[5]*T-e[6]*x+e[7]*A)*d,(e[2]*x-e[1]*T-e[3]*A)*d,(e[13]*l-e[14]*c+e[15]*r)*d,(e[10]*c-e[9]*l-e[11]*r)*d,(e[6]*E-e[4]*T-e[7]*h)*d,(e[0]*T-e[2]*E+e[3]*h)*d,(e[14]*o-e[12]*l-e[15]*n)*d,(e[8]*l-e[10]*o+e[11]*n)*d,(e[4]*x-e[5]*E+e[7]*a)*d,(e[1]*E-e[0]*x-e[3]*a)*d,(e[12]*c-e[13]*o+e[15]*t)*d,(e[9]*o-e[8]*c-e[11]*t)*d,(e[5]*h-e[4]*A-e[6]*a)*d,(e[0]*A-e[1]*h+e[2]*a)*d,(e[13]*n-e[12]*r-e[14]*t)*d,(e[8]*r-e[9]*n+e[10]*t)*d]):ae()},Z=(e,t,n)=>[1,0,0,0,0,1,0,0,0,0,1,0,e,t,n,1],_e=(e,t,n,o)=>{e[12]=t,e[13]=n,e[14]=o},he=(e,t,n)=>[e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1],me=(e,t,n)=>{const o=X(le(t,e)),r=X(Y(n,o)),c=Y(o,r),l=O(e,r),a=O(e,c),h=O(e,o);return[r[0],c[0],o[0],0,r[1],c[1],o[1],0,r[2],c[2],o[2],0,-l,-a,-h,1]},Ee=(e,t,n,o)=>{const r=1/Math.tan(e),c=r/t,l=o/(o-n),a=-(l*n);return[c,0,0,0,0,r,0,0,0,0,l,1,0,0,a,0]},Ae=(e,t,n,o)=>{const r=2/e,c=2/t,l=1/(o-n),a=n/(n-o);return[r,0,0,0,0,c,0,0,0,0,l,0,0,0,a,1]};var i=null;const m=(e,t,n)=>{e.addEventListener(t,n)},xe=()=>{const e=document.body;e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.msUserSelect="none",e.style.mozUserSelect="none"},we=()=>{const e=document.body;e.style.touchAction="none"},ve=()=>{xe(),we(),i={},i.mode=0,i.timer={prevTime:performance.now(),deltaTime:0},i.gamepad={index:null,lx:0,ly:0,rx:0,ry:0,b0:!1,b1:!1,b8:!1,b9:!1,lt:!1,rt:!1},i.keyboard={w:!1,a:!1,s:!1,d:!1,up:!1,left:!1,down:!1,right:!1,z:!1,x:!1,space:!1,lctrl:!1,esc:!1},i.touch=new Map,i.click=[],m(window,"focus",e=>{}),m(window,"blur",e=>{}),m(window,"resize",e=>{}),m(window,"gamepadconnected",e=>{i.gamepad.index=e.gamepad.index,i.mode=1}),m(window,"gamepaddisconnected",e=>{i.gamepad.index===e.gamepad.index&&(i.gamepad.index=null)}),m(document,"keydown",e=>{C(i.keyboard,e.code,!0)&&(i.mode=2,e.preventDefault())}),m(document,"keyup",e=>{C(i.keyboard,e.code,!1)&&(i.mode=2,e.preventDefault())}),m(document.body,"contextmenu",e=>{e.preventDefault()}),m(document.body,"pointerdown",e=>{i.touch.set(e.pointerId,{x:e.clientX,y:e.clientY,sx:e.clientX,sy:e.clientY,time:performance.now()}),i.mode=0}),m(document.body,"pointerup",e=>{ge(e.pointerId),i.touch.delete(e.pointerId),i.mode=0}),m(document.body,"pointerout",e=>{i.touch.delete(e.pointerId),i.mode=0}),m(document.body,"pointermove",e=>{const t=i.touch.get(e.pointerId);t&&(t.x=e.clientX,t.y=e.clientY,i.mode=0)})},C=(e,t,n)=>{switch(t){case"KeyW":e.w=n;break;case"KeyA":e.a=n;break;case"KeyS":e.s=n;break;case"KeyD":e.d=n;break;case"ArrowUp":e.up=n;break;case"ArrowLeft":e.left=n;break;case"ArrowDown":e.down=n;break;case"ArrowRight":e.right=n;break;case"KeyZ":e.z=n;break;case"KeyX":e.x=n;break;case"Space":e.space=n;break;case"ControlLeft":e.lctrl=n;break;case"Escape":e.esc=n;break;default:return!1}return!0},ge=e=>{const t=i.touch.get(e);t&&performance.now()-t.time<250&&i.click.push({x:t.x,y:t.y})},Te=(e,t)=>{e.deltaTime=(t-e.prevTime)/1e3,e.prevTime=t},pe=e=>{if(e.index!==null){const n=navigator.getGamepads()[e.index];e.lx=Math.trunc(n.axes[0]*4)/4,e.ly=Math.trunc(n.axes[1]*4)/4,e.rx=Math.trunc(n.axes[2]*4)/4,e.ry=Math.trunc(n.axes[3]*4)/4,e.b0=n.buttons[0].value>=.5,e.b1=n.buttons[1].value>=.5,e.b8=n.buttons[8].value>=.5,e.b9=n.buttons[9].value>=.5,e.lt=n.buttons[6].value>=.5,e.rt=n.buttons[7].value>=.5,!!(e.lx||e.ly||e.rx||e.ry||e.b0||e.b1||e.b8||e.b9||e.lt||e.rt)&&(i.mode=1)}},ye=e=>{Te(i.timer,e),pe(i.gamepad)},Me=()=>{i.click.length=0},De=e=>{const t=localStorage.getItem(e);return t==null?null:JSON.parse(t)},Re=(e,t)=>{const n=JSON.stringify(t);localStorage.setItem(e,n)};var s=null;const Pe=()=>{s=document.getElementById("main").getContext("webgl2")},H=(e,t)=>{let n=s.createTexture();return s.bindTexture(s.TEXTURE_2D,n),t==0&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST)),t==1&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR)),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,e),s.bindTexture(s.TEXTURE_2D,null),n},Se=(e,t,n)=>{const o=document.createElement("canvas");if(!o)return null;o.width=t,o.height=n;const r=o.getContext("2d");return r?(r.fillStyle="white",r.textAlign="center",r.textBaseline="middle",r.font="24px monospace",r.fillText(e,o.width/2,o.height/2),o):null},V=(e,t)=>{const n=s.createShader(e);return s.shaderSource(n,t),s.compileShader(n),s.getShaderParameter(n,s.COMPILE_STATUS)?n:(s.deleteShader(n),null)},Oe=(e,t)=>{const n=s.createProgram();return s.attachShader(n,e),s.attachShader(n,t),s.linkProgram(n),s.getProgramParameter(n,s.LINK_STATUS)?n:(s.deleteProgram(n),null)},$=(e,t)=>{let n=s.createBuffer();return s.bindBuffer(e,n),s.bufferData(e,t,s.STATIC_DRAW),n},P=(e,t,n,o,r,c)=>{s.enableVertexAttribArray(e),s.vertexAttribPointer(e,t,n,o,r,c)},ke=()=>{const e=window.innerWidth;e!==s.canvas.width&&(s.canvas.width=e);const t=window.innerHeight;t!==s.canvas.height&&(s.canvas.height=t)},Ge=()=>{s.viewport(0,0,s.canvas.width,s.canvas.height),s.clearColor(0,0,0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)},Ie=(e,t)=>{s.enable(s.CULL_FACE),e?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST),t?(s.enable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA)):(s.disable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA))},Le=(e,t)=>{t=t||0;const n=e.iv[t*3+0],o=e.iv[t*3+1],r=e.iv[t*3+2],c=[null,s.POINTS,s.LINES,s.TRIANGLES];e.i?s.drawElements(c[n],r,s.UNSIGNED_SHORT,2*o):s.drawArrays(c[n],o,r)},be=(e,t)=>{s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,e.texture),s.uniform1i(t,0)};var Ue=null;const Ne=()=>{Ue=new AudioContext};const K=0,z=1,W=2,q=3,Fe=e=>{if(e.vao=s.createVertexArray(),s.bindVertexArray(e.vao),e.b&&(e.b=$(s.ARRAY_BUFFER,B(e.b)),e.bv))for(let t=0;t<e.bv.length;t+=2)switch(e.bv[t]){case K:P(K,3,s.FLOAT,!1,0,e.bv[t+1]);break;case z:P(z,3,s.HALF_FLOAT,!1,0,e.bv[t+1]);break;case W:P(W,4,s.UNSIGNED_BYTE,!0,0,e.bv[t+1]);break;case q:P(q,2,s.HALF_FLOAT,!1,0,e.bv[t+1]);break}return e.i&&(e.i=$(s.ELEMENT_ARRAY_BUFFER,B(e.i))),s.bindVertexArray(null),e},Be=e=>{if(e.vs=V(s.VERTEX_SHADER,e.vs),e.fs=V(s.FRAGMENT_SHADER,e.fs),e.prog=Oe(e.vs,e.fs),e.u){const t={};for(let n of e.u)t[n]=s.getUniformLocation(e.prog,n);e.u=t}if(e.ub){const t={};let n=0;for(let o of e.ub){const r=s.getUniformBlockIndex(e.prog,o);s.uniformBlockBinding(e.prog,r,n),t[o]=n,n+=1}e.ub=t}return e};let G=0;const Xe=e=>{if(e.cvs)e.texture=H(Se(e.cvs.text,e.cvs.width,e.cvs.height),e.s);else{e.texture=null;const t=new Image;t.onload=()=>{e.texture=H(t,e.s),G-=1},t.src="img/"+e.src,G+=1}return e},w={index:null,pack:[]},Ye=()=>{fetch("data/index.json").then(t=>t.json()).then(t=>{w.index=t})},Ce=e=>{const t="data/pack"+e+".json";fetch(t).then(n=>n.json()).then(n=>{n.mesh&&(n.mesh=n.mesh.map(o=>Fe(o))),n.texture&&(n.texture=n.texture.map(o=>Xe(o))),n.shader&&(n.shader=n.shader.map(o=>Be(o))),w.pack[e]=n})},g=(e,t)=>{if(t<0)return null;const n=w.index[e];if(!n)return null;const o=n[t];if(!o)return null;const r=w.pack[o.p];return r?r[e][o.i]:null},j=e=>g("view",e),He=e=>g("mesh",e),Ve=e=>g("texture",e),$e=e=>g("shader",e),Ke=e=>g("draw",e),I=e=>g("tile",e),ee=e=>g("ui",e),ze=e=>g("event",e),We=e=>w.index.view.findIndex(t=>t.n===e),qe=e=>w.index.tile.findIndex(t=>t.n===e),Je=e=>w.index.ui.findIndex(t=>t.n===e),te=()=>!(w.index===null||w.pack.length<=0||G>0),f={view:null,slot:null,cam:{eye:[0,0,0],vp:new Float32Array(16),ivp:new Float32Array(16),o:new Float32Array(16)},m:new Float32Array(16)},ne=()=>{f.slot=null,f.view=w.index.initial_view},Qe=e=>{const t=We(e);t<0||(f.view=t)},Ze=()=>{f.view===null&&ne()},je=()=>{const e=window.innerWidth,t=window.innerHeight,n=D(30),o=.1,r=1e3,c=ue(u.ha,u.va),l=Q(u.x,u.y,u.h);l[2]+=u.eyeh;const a=ie(l,c),E=me(l,a,[0,0,1]),A=Ee(n,e/t,o,r),x=fe(E,A);f.cam.vp.set(x),f.cam.ivp.set(de(x)),f.cam.o.set(Ae(e,t,0,1)),f.cam.eye=l},p=[],L=e=>{const t=Je(e);if(t<0)return null;const n=p[t];return n?n.value:null},et=0,k=0,M=1,U=(e,t)=>{const n=window.innerWidth,o=window.innerHeight,r=window.devicePixelRatio,c=n/2+(e.offset[0]-e.width/2)*r,l=n/2+(e.offset[0]+e.width/2)*r,a=o/2+(e.offset[1]-e.height/2)*r,h=o/2+(e.offset[1]+e.height/2)*r;return re(t,c,l,a,h)},tt=(e,t)=>{const n=i.mode;if(n===0){let o=!1;const r=i.click;for(let c of r)if(U(t,[c.x,c.y])){o=!0;break}o?(e.value=!0,e.state=M):(e.value=!1,e.state=k)}else n===1?i.gamepad[t.gamepad]?e.state!==M?(e.value=!0,e.state=M):e.value=!1:(e.value=!1,e.state=k):n===2&&(i.keyboard[t.keyboard]?e.state!==M?(e.value=!0,e.state=M):e.value=!1:(e.value=!1,e.state=k))},nt=(e,t)=>{const n=i.mode;if(n===0){e.value=[0,0];for(const o of i.touch.values())if(U(t,[o.sx,o.sy])){const r=o.x-o.sx,c=-(o.y-o.sy);e.value=y(r,c);break}}else if(n===1){const o=i.gamepad;e.value=y(o.lx,-o.ly)}else if(n===2){const o=i.keyboard,r=o.a?-1:o.d?1:0,c=o.w?1:o.s?-1:0;e.value=y(r,c)}},ot=(e,t)=>{const n=i.mode;if(n===0){e.value=[0,0];for(const o of i.touch.values())if(U(t,[o.sx,o.sy])){const r=o.x-o.sx,c=-(o.y-o.sy);e.value=y(r,c);break}}else if(n===1){const o=i.gamepad;e.value=y(o.rx,-o.ry)}else if(n===2){const o=i.keyboard,r=o.right?1:o.left?-1:0,c=o.up?1:o.down?-1:0;e.value=y(r,c)}},st=e=>{for(const t of p)t&&(t.value=null);for(let t of e.ui){const n=ee(t);if(!n)continue;p[t]||(p[t]={m:new Float32Array(16),value:null,state:et});const o=p[t];switch(n.interact){case 1:tt(o,n);break;case 2:nt(o,n);break;case 3:ot(o,n);break;default:break}const r=window.devicePixelRatio,c=he(n.width/2*r,n.height/2*r,1);_e(c,n.offset[0]*r,-n.offset[1]*r,0),o.m.set(c)}},_={w:0,h:0,a:[],b:[]},N=(e,t)=>(e=Math.floor(e),t=Math.floor(t),e<0||_.w<=e||t<0||_.h<=t?-1:e+t*_.h),R=(e,t)=>_.a[N(e,t)],rt=(e,t)=>_.b[N(e,t)],b=(e,t)=>{let n=0;const o=R(e,t);if(o){const c=I(o.no);c&&(n+=c.height*o.count)}const r=rt(e,t);if(r){const c=I(r.no);c&&(n+=c.height)}return n},ct=(e,t)=>R(e,t)==null,S=(e,t,n,o)=>{if(ct(e+n,t+o))return!0;const r=b(e,t),c=b(e+n,t+o);return Math.abs(r-c)>1},it=(e,t)=>{_.w=e,_.h=t,_.a=[],_.a.length=e*t,_.b=[],_.b.length=e*t},lt=(e,t,n)=>{const o=N(e,t);o<0||(_.a[o]={no:n,count:1})},ut=e=>e,at=e=>e,u={x:0,y:0,ha:0,va:0,h:0,eyeh:1.75},v={},ft=e=>{for(let t of e.event){const n=ze(t);if(!n)continue;let o=!1;switch(n.trigger){case 0:o=!0;break;case 1:o=L(n.target);break}if(o)for(const r of n.action){const c=v[r[0]];if(!c)continue;const l=r.slice(1);c(...l)}}},dt=()=>{_.w=0,_.h=0,_.a.length=0,u.x=0,u.y=0,u.ha=0,u.va=0},_t=()=>{if(!f.slot)return!1;const e=De(f.slot);return e?(e.pos&&Object.assign(u,e.pos),e.tile&&Object.assign(_,at(e.tile)),!0):!1},ht=()=>{if(!f.slot)return;const e={};e.pos=u,e.tile=ut(_),Re(f.slot,e)},mt=()=>{ke(),Ge()},F=(e,t,n)=>{const o=Ke(e);if(!o)return;Ie(o.depth,o.alpha);const r=$e(o.shader);if(!r)return;s.useProgram(r.prog);const c=He(o.mesh);if(!c)return;s.bindVertexArray(c.vao),s.uniformMatrix4fv(r.u.vp,!1,o.ortho?f.cam.o:f.cam.vp);const l=Ve(o.texture);l&&be(l,r.u.tex0);for(let a=0;a<t;++a)n(r.u,a),Le(c)},Et=()=>{for(let e=0;e<_.w;++e)for(let t=0;t<_.h;++t){const n=R(e,t);if(!n)continue;const o=I(n.no);!o||F(o.draw,n.count,(r,c)=>{const l=Q(e,t,c*o.height);f.m.set(Z(l[0],l[1],l[2])),s.uniformMatrix4fv(r.w,!1,f.m)})}},At=e=>{for(let t of e.ui){const n=ee(t);if(!n)continue;const o=p[t];!o||F(n.draw,1,(r,c)=>{s.uniformMatrix4fv(r.w,!1,o.m)})}},xt=e=>{F(e.skybox,1,(t,n)=>{f.m.set(Z(...f.cam.eye)),s.uniformMatrix4fv(t.w,!1,f.m)})},wt=e=>{xt(e),e.draw3d&&Et(),At(e)},vt=()=>{Pe(),Ne(),ve(),Ye(),Ce(0)},gt=e=>{if(ye(e),te()){Ze();const t=j(f.view);if(!t)return;st(t),ft(t)}je(),Me()},Tt=()=>{if(mt(),te()){const e=j(f.view);if(!e)return;wt(e)}};m(window,"load",()=>{vt();const e=t=>{gt(t),Tt(),requestAnimationFrame(e)};e()});v.nextview=e=>{Qe(e)};v.resetview=()=>{ne()};v.newgame=e=>{f.slot=e,dt()};v.loadgame=e=>{f.slot=e,_t()};v.savegame=()=>{ht()};const J=(e,t,n,o)=>{let r=e+n,c=t+o;const l=Math.floor(e),a=Math.floor(t),h=.25;return S(l,a,-1,0)&&(r=Math.max(r,l+h)),S(l,a,1,0)&&(r=Math.min(r,l-h+1)),S(l,a,0,-1)&&(c=Math.max(c,a+h)),S(l,a,0,1)&&(c=Math.min(c,a-h+1)),[r,c]},pt=(e,t)=>{const n=i.timer.deltaTime,o=L(t);o&&(u.ha+=90*n*o[0],u.va+=90*n*o[1],u.va=Math.max(-60,Math.min(u.va,80)));const r=L(e);if(r){const a=D(u.ha+90),h=D(u.ha),E=r[0],A=r[1],x=E*Math.cos(a)+A*Math.cos(h),T=E*Math.sin(a)+A*Math.sin(h),d=2*n*x,oe=2*n*T;[u.x,u.y]=J(u.x,u.y,d,oe)}else[u.x,u.y]=J(u.x,u.y,0,0);const c=b(u.x,u.y);if(Math.abs(c-u.h)<=2){const l=c-u.h;u.h+=10*n*l}else u.h=c};v.fpsmove=(e,t)=>{pt(e,t)};v.makeworld=()=>{const e=qe("tile");it(64,64);for(let t=24;t<=40;++t)for(let n=24;n<=40;++n)lt(t,n,e);u.x=_.w/2+.5,u.y=_.h/2+.5};v.pushtile=()=>{const e=R(u.x,u.y);!e||(e.count+=1)};v.poptile=()=>{const e=R(u.x,u.y);!e||e.count<=1||(e.count-=1)};})();
